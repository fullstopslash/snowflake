# Cursor Rules for NixOS Multi-Host Repository

## Git Workflow
- Use **jujutsu (jj)** as the git frontend instead of git commands
- When making commits, use `jj commit` instead of `git commit`
- Use `jj status` to check repository status
- Use `jj log` to view commit history

## NixOS Build Workflow
- Use **nh** for NixOS builds instead of nixos-rebuild
- Prefer `nh os switch` over `nixos-rebuild switch`
- Use `nh os switch --flake .#nixos` for flake-based builds
- Use `nh os switch --flake .#hostname` for specific hosts

## Repository Structure
- This is a multi-host NixOS repository with modular roles
- Hosts are in `/hosts/` directory
- Roles are in `/roles/` directory
- Each host imports specific roles as needed
- Hardware-specific settings go in `hosts/[hostname]/hardware.nix`

## Code Style Preferences
- Use descriptive commit messages with jujutsu
- When suggesting commands, prefer jj over git
- When suggesting builds, prefer nh over nixos-rebuild
- Always test configurations with `nix flake check` before building

## Shell Script Standards
- **ALWAYS** use `#!/usr/bin/env sh` for shell scripts (POSIX compliant)
- **NEVER** use `#!/bin/bash` - prefer portable POSIX shell
- Use POSIX-compliant syntax: `[` instead of `[[`, `case` instead of regex
- Use `printf` instead of `echo -e` for colored output
- Use `>/dev/null 2>&1` instead of `&> /dev/null`
- Avoid bash-specific features like `local`, `[[`, `&>` redirection
- Test scripts with `dash` or `sh` to ensure POSIX compliance

## Nix Code Formatting
- **ALWAYS** format .nix files with `alejandra` before committing
- Run `alejandra .` to format all .nix files in the repository
- Ensure consistent formatting across all Nix configurations
- Format files immediately after making changes, before committing

## Safety Rules for System Changes
- **ONLY make the specific changes requested** - no additional modifications
- **NEVER modify system functionality without explicit permission** - preserve all existing configurations exactly as they are
- **Focus ONLY on code quality improvements** (formatting, removing unused arguments, fixing linter warnings)
- **Preserve all existing configurations** - mount points, services, packages, etc. stay exactly as they are
- **Be extremely conservative** - when in doubt, ask before making changes
- **Test changes thoroughly** before suggesting them
- **Respect the existing system architecture** - don't change fundamental aspects like NFS vs Samba, mount points, etc.

## Common Commands
- Check flake: `nix flake check`
- Build configuration: `nix build .#nixosConfigurations.nixos.config.system.build.toplevel`
- Switch to new config: `nh os switch --flake .#nixos`
- Check status: `jj status`
- View logs: `jj log`

## Automated Code Quality
- **ALWAYS** run `nix flake check` before committing
- **ALWAYS** run `statix check` to catch style issues
- **ALWAYS** run `deadnix` to find unused code
- **ALWAYS** run `alejandra .` to format code
- **NEVER** commit with linting warnings
- **ALWAYS** test configurations with `nix eval` before building 