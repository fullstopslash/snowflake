# Plan 16-02: Jujutsu VCS Integration for SOPS Workflows

## Objective

Add Jujutsu (jj) support to all SOPS-related VCS operations (bootstrap, rekey, key updates) while maintaining git compatibility. Create a VCS abstraction layer that respects the user's preferred version control system.

## Context

**From Research** (`16-01-FINDINGS.md`):
- Bootstrap script uses `git add/commit/push` in nix-secrets
- Justfile `rekey` command uses `git add/commit/push`
- Scripts/helpers.sh SOPS functions use git commands
- User prefers Jujutsu with collocated repo

**User Requirements**:
- "all instances of 'git' should also take into account using jj"
- "a collocated repo is the way to go"
- Support both git and jj via environment variable

**Architectural Pattern**:
- Create abstraction layer in scripts/
- Single source of truth for VCS operations
- Environment variable `VCS_TYPE` controls behavior
- Default to jj, fall back to git if needed

## Tasks

### 1. Create VCS Abstraction Layer

**File**: `scripts/vcs-helpers.sh`

```bash
#!/usr/bin/env bash
# VCS abstraction for git/jujutsu compatibility
# Usage: source this file before VCS operations
#        Set VCS_TYPE=git or VCS_TYPE=jj (default: jj)

VCS_TYPE=${VCS_TYPE:-jj}

# Add files to staging (git) or mark for commit (jj)
vcs_add() {
  if [ "$VCS_TYPE" = "jj" ]; then
    # Jujutsu automatically tracks all changes in working copy
    # No explicit add needed
    :
  else
    git add "$@"
  fi
}

# Commit changes with message
vcs_commit() {
  local message="$1"
  if [ "$VCS_TYPE" = "jj" ]; then
    jj commit -m "$message"
  else
    git commit -m "$message"
  fi
}

# Push to remote
vcs_push() {
  local remote="${1:-origin}"
  local branch="${2:-}"

  if [ "$VCS_TYPE" = "jj" ]; then
    # jj git push pushes current change to tracking remote
    jj git push
  else
    if [ -n "$branch" ]; then
      git push "$remote" "$branch"
    else
      git push "$remote"
    fi
  fi
}

# Pull from remote (for updates)
vcs_pull() {
  if [ "$VCS_TYPE" = "jj" ]; then
    jj git fetch
  else
    git pull "$@"
  fi
}

# Check if repo is clean (no uncommitted changes)
vcs_is_clean() {
  if [ "$VCS_TYPE" = "jj" ]; then
    # Check if working copy has changes
    jj status | grep -q "Working copy changes:" && return 1 || return 0
  else
    [ -z "$(git status --porcelain)" ]
  fi
}

# Get current branch/change ID
vcs_current_ref() {
  if [ "$VCS_TYPE" = "jj" ]; then
    jj log -r @ --no-graph -T 'change_id'
  else
    git rev-parse --abbrev-ref HEAD
  fi
}
```

### 2. Update Justfile Rekey Command

**File**: `justfile` (around line 490-499)

**Current**:
```just
rekey: sops-rekey
  cd ../nix-secrets && git add -u && (git commit -m "chore: rekey" || true) && git push
```

**Updated**:
```just
# Rekey all SOPS secrets after updating .sops.yaml
rekey: sops-rekey
  #!/usr/bin/env bash
  set -e
  cd ../nix-secrets
  source ../nix-config/scripts/vcs-helpers.sh
  vcs_add -u
  vcs_commit "chore: rekey" || true
  vcs_push
```

Also update other SOPS-related justfile commands:
- `sops-update-host-age-key`
- `sops-add-creation-rules`
- Any other commands that touch nix-secrets repo

### 3. Update Bootstrap Script

**File**: `scripts/bootstrap-nixos.sh`

**Locations to Update** (based on findings):
- Line ~311-318: After updating .sops.yaml and creating rules
- Line ~455-460: Final commit and push of changes

**Pattern**:
```bash
# Source VCS helpers
source "$(dirname "$0")/vcs-helpers.sh"

# In nix-secrets directory
cd "$SECRETS_DIR"
vcs_add .sops.yaml sops/
vcs_commit "feat: add host $HOSTNAME keys and creation rules"
vcs_push
```

**Consider**: Add `--vcs-type` flag to bootstrap script
```bash
while getopts "n:d:k:v:" opt; do
  case $opt in
    v) export VCS_TYPE="$OPTARG" ;;
    # ... other options
  esac
done
```

### 4. Update SOPS Helper Functions

**File**: `scripts/helpers.sh`

**Functions to Update** (lines 60-292):
- `sops_update_age_key` - Updates .sops.yaml, needs commit
- `sops_add_shared_creation_rules` - Adds rules, needs commit
- `sops_add_host_creation_rules` - Adds rules, needs commit
- `sops_setup_user_age_key` - Creates keys and secrets, needs commit

**Pattern for Each**:
```bash
sops_update_age_key() {
  # ... existing key update logic ...

  # Commit changes
  source "$(dirname "$0")/vcs-helpers.sh"
  cd "$SECRETS_DIR"
  vcs_add .sops.yaml
  vcs_commit "feat: update age key for $hostname"
  vcs_push
}
```

### 5. Documentation Update

**File**: `docs/addnewhost.md`

Add section explaining VCS abstraction:

```markdown
## Version Control System

This configuration supports both Git and Jujutsu for managing the nix-secrets repository.

**Using Jujutsu (default)**:
```bash
export VCS_TYPE=jj  # or omit, jj is default
./scripts/bootstrap-nixos.sh -n newhost ...
```

**Using Git**:
```bash
export VCS_TYPE=git
./scripts/bootstrap-nixos.sh -n newhost ...
```

The VCS abstraction layer (`scripts/vcs-helpers.sh`) handles the differences transparently.
```

## Success Criteria

- [ ] VCS helpers created at `scripts/vcs-helpers.sh`
- [ ] Justfile rekey command uses vcs_* functions
- [ ] Bootstrap script uses vcs_* functions for all commits/pushes
- [ ] Helper functions in scripts/helpers.sh updated
- [ ] Environment variable `VCS_TYPE` controls behavior
- [ ] Default is jj, git works when VCS_TYPE=git
- [ ] Documentation updated in docs/addnewhost.md
- [ ] Test bootstrap with jj on nix-secrets repo
- [ ] Test rekey with both jj and git

## Files to Modify

- `scripts/vcs-helpers.sh` (create)
- `justfile` (rekey and related commands)
- `scripts/bootstrap-nixos.sh` (commit/push calls)
- `scripts/helpers.sh` (SOPS functions)
- `docs/addnewhost.md` (VCS documentation)

## Files to Reference

- `.planning/phases/16-sops-key-management/16-01-FINDINGS.md` - Current VCS usage
- `scripts/helpers.sh:60-292` - SOPS helper functions
- `justfile:490-530` - SOPS management commands

## Testing Plan

1. **Test with Jujutsu**:
   ```bash
   # In nix-secrets repo, ensure it's a jj collocated repo
   cd ../nix-secrets
   jj git fetch  # Should work

   # Test rekey
   cd ../nix-config
   just rekey  # Should use jj

   # Verify commit in jj
   cd ../nix-secrets
   jj log -r @
   ```

2. **Test with Git**:
   ```bash
   export VCS_TYPE=git
   just rekey

   # Verify commit in git
   cd ../nix-secrets
   git log -1
   ```

3. **Test Bootstrap** (on test VM):
   ```bash
   VCS_TYPE=jj ./scripts/bootstrap-nixos.sh -n testhost ...
   # Check nix-secrets for jj commit
   ```

## Integration Points

- **Bootstrap**: All key generation and .sops.yaml updates
- **Justfile**: Rekey and key management commands
- **Helpers**: SOPS utility functions
- **Nix-secrets repo**: Must support both jj and git (collocated)

## Future Enhancements (Not in This Plan)

- VCS abstraction for nix-config repo itself
- Support for other VCS systems (fossil, mercurial, etc.)
- VCS-specific features (jj squash, git rebase, etc.)

## Notes

- Jujutsu collocated repo means .git/ and .jj/ coexist
- `jj git push` syncs to git remote, works with GitHub
- Git fallback ensures compatibility with existing workflows
- VCS_TYPE can be set in shell profile for persistent preference
