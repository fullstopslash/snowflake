# Plan 16-01: SOPS Key Enforcement Module

## Objective

Create a NixOS module that enforces SOPS/age key hygiene at system activation time, validating key permissions, format, and secret availability. This module integrates with the existing `hostSpec.hasSecrets` pattern and follows filesystem-driven module discovery.

## Context

**From Research** (`16-01-FINDINGS.md`):
- Current SOPS setup has no runtime validation
- No enforcement of key file permissions (should be 600)
- No verification that secrets decrypted successfully
- No format validation for age keys
- Bootstrap creates keys correctly, but no ongoing enforcement

**Architectural Alignment**:
- Create module at `modules/security/sops-enforcement.nix`
- Auto-enable when `hostSpec.hasSecrets = true`
- Use `lib.mkDefault` for all options (role/host overridable)
- Follow existing activation script patterns (like golden generation module)

## Tasks

### 1. Create SOPS Enforcement Module

**File**: `modules/security/sops-enforcement.nix`

**Options Structure**:
```nix
{
  options.myModules.security.sops-enforcement = {
    enable = lib.mkEnableOption "SOPS key enforcement and validation";

    validateKeyPermissions = lib.mkOption {
      type = lib.types.bool;
      default = true;
      description = "Validate and fix permissions on age and SSH keys";
    };

    validateSecretDecryption = lib.mkOption {
      type = lib.types.bool;
      default = true;
      description = "Verify secrets decrypted to /run/secrets successfully";
    };

    requiredSecretCount = lib.mkOption {
      type = lib.types.nullOr lib.types.int;
      default = null;
      description = "Minimum number of secrets expected (null = any count > 0)";
    };
  };
}
```

**Implementation**:
1. **Assertions** for SSH host key existence
2. **Activation Script** `sopsKeyValidation`:
   - Check `/var/lib/sops-nix/key.txt` is mode 600, fix if not
   - Check `/etc/ssh/ssh_host_ed25519_key` is mode 600, fix if not
   - Verify ownership (root:root or root:keys)
3. **Systemd Service** `sops-verification.service`:
   - Runs after `sops-nix.service`
   - Verifies `/run/secrets/` exists and contains secrets
   - Fails if no secrets found (when hasSecrets = true)
   - Logs secret count for monitoring

**Auto-Enable**:
```nix
config = lib.mkIf config.hostSpec.hasSecrets {
  myModules.security.sops-enforcement.enable = lib.mkDefault true;
};
```

### 2. Integrate with Module Discovery

**File**: `modules/security/default.nix`

Create if doesn't exist, or update to import enforcement module:
```nix
{ lib, ... }:
{
  imports = lib.custom.scanPaths ./.;
}
```

This ensures `sops-enforcement.nix` is auto-discovered by the filesystem-driven module system.

### 3. Test on Griefling VM

**Steps**:
1. Rebuild griefling VM: `just vm-rebuild griefling`
2. SSH into VM and verify enforcement:
   ```bash
   # Check activation script ran
   sudo journalctl -u nixos-activation | grep sopsKeyValidation

   # Check sops-verification service
   systemctl status sops-verification.service

   # Verify key permissions
   stat -c "%a %U:%G" /var/lib/sops-nix/key.txt
   stat -c "%a %U:%G" /etc/ssh/ssh_host_ed25519_key

   # Check secrets exist
   sudo ls -la /run/secrets/
   ```
3. Test permission fixing:
   ```bash
   # Break permissions
   sudo chmod 644 /var/lib/sops-nix/key.txt

   # Rebuild (should fix automatically)
   sudo nixos-rebuild test

   # Verify fixed
   stat -c "%a" /var/lib/sops-nix/key.txt  # Should be 600
   ```

## Success Criteria

- [ ] Module created at `modules/security/sops-enforcement.nix`
- [ ] Module auto-enables when `hostSpec.hasSecrets = true`
- [ ] Activation script validates and fixes key permissions
- [ ] Systemd service verifies secret decryption
- [ ] Griefling VM rebuild succeeds with enforcement active
- [ ] Manual permission corruption is auto-fixed on rebuild
- [ ] Module follows lib.mkDefault pattern for all options

## Files to Modify

- `modules/security/sops-enforcement.nix` (create)
- `modules/security/default.nix` (create or verify imports)

## Files to Reference

- `modules/common/sops.nix` - Base SOPS configuration
- `modules/system/boot/golden-generation.nix` - Activation script pattern
- `modules/common/host-spec.nix` - hasSecrets option
- `roles/form-server.nix` - Example role for testing

## Integration Points

- **hostSpec**: Uses `config.hostSpec.hasSecrets` to auto-enable
- **SOPS**: Runs after sops-nix generates keys and decrypts secrets
- **Activation**: Part of system activation, runs on every rebuild
- **Roles**: Can override `validateKeyPermissions` via `lib.mkForce` if needed

## Future Enhancements (Not in This Plan)

- Key age tracking (timestamp when key was generated)
- Alerting when keys are old (for rotation reminder)
- Validation of `.sops.yaml` creation rules
- User age key format validation

## Notes

- This module is **enforcement only**, not key generation
- Bootstrap process already creates keys correctly
- This ensures ongoing hygiene as system evolves
- Follows explicit-over-implicit principle (no hidden fixes, logs warnings)
