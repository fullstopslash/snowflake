# Plan 16-03: Key Rotation Foundation

## Objective

Build the infrastructure for manual and future automated SOPS/age key rotation. This includes key age tracking, rotation helper functions, justfile commands for manual rotation, and documentation of the zero-downtime rotation process. Does NOT include full automation (scheduled rotation) - that's future work.

## Context

**From Research** (`16-01-FINDINGS.md`):
- No key rotation exists currently
- `generateKey = true` runs once at boot, never again
- TODO.md:371 mentions "Automatic scheduled sops rotate" as future work
- Manual rotation would require 8-step process with potential downtime

**Architectural Goal**:
- Track when keys were generated (for rotation policy)
- Provide rotation helpers in scripts/
- Create justfile commands for manual rotation
- Document zero-downtime rotation flow
- Lay groundwork for future automation (Phase 17 or later)

**Zero-Downtime Principle**:
1. Add new key alongside old key
2. Rekey with both keys
3. Deploy new key
4. Verify new key works
5. Remove old key
6. Rekey without old key

## Tasks

### 1. Add Key Age Tracking

**File**: `modules/common/sops.nix`

Add metadata secret to track key generation date:

```nix
sops.secrets = lib.mkIf config.hostSpec.hasSecrets {
  # Track when host age key was generated (for rotation scheduling)
  "sops/key-metadata" = {
    sopsFile = "${sopsFolder}/${config.networking.hostName}.yaml";
    mode = "0400";
    # Content in secret: { "generated_at": "2025-12-15", "rotated_at": null }
  };
};

# Activation script to create metadata if missing
system.activationScripts.sopsKeyMetadata = lib.mkIf config.hostSpec.hasSecrets ''
  KEY_METADATA="/run/secrets/sops/key-metadata"
  KEY_FILE="/var/lib/sops-nix/key.txt"

  if [ -f "$KEY_FILE" ] && [ ! -f "$KEY_METADATA" ]; then
    # Key exists but no metadata - likely pre-existing system
    # Get key file creation date as best estimate
    KEY_DATE=$(stat -c %Y "$KEY_FILE")
    KEY_DATE_ISO=$(date -d "@$KEY_DATE" +%Y-%m-%d)

    echo "Warning: No key metadata found. Estimated generation date: $KEY_DATE_ISO"
    echo "Run 'just sops-init-key-metadata' to add tracking to nix-secrets"
  fi
'';
```

**Helper to Add Metadata**:

**File**: `scripts/helpers.sh`

```bash
# Initialize key metadata for existing host
sops_init_key_metadata() {
  local hostname="${1:-$(hostname)}"
  local secrets_dir="${2:-../nix-secrets}"
  local host_yaml="$secrets_dir/sops/$hostname.yaml"

  if [ ! -f "$host_yaml" ]; then
    echo "Error: Host YAML not found: $host_yaml" >&2
    return 1
  fi

  # Get current key file date or use today
  local key_date
  if [ -f /var/lib/sops-nix/key.txt ]; then
    key_date=$(stat -c %Y /var/lib/sops-nix/key.txt)
    key_date=$(date -d "@$key_date" +%Y-%m-%d)
  else
    key_date=$(date +%Y-%m-%d)
  fi

  # Add metadata secret to host YAML
  sops -e -i --set '["sops"]["key-metadata"]' "{\"generated_at\": \"$key_date\", \"rotated_at\": null}" "$host_yaml"

  echo "Added key metadata to $host_yaml"
  echo "Generated at: $key_date"
}
```

### 2. Create Key Rotation Helper Functions

**File**: `scripts/sops-rotate.sh` (new file)

```bash
#!/usr/bin/env bash
# SOPS/age key rotation helpers
# Zero-downtime rotation process

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/helpers.sh"
source "$SCRIPT_DIR/vcs-helpers.sh"

# Step 1: Generate new age key on host
sops_rotate_generate_new_key() {
  local hostname="${1:?hostname required}"
  local new_key_path="${2:-/tmp/new-age-key.txt}"

  echo "==> Generating new age key for $hostname..."
  ssh "$hostname" "age-keygen -o $new_key_path"

  # Get public key
  local new_pubkey
  new_pubkey=$(ssh "$hostname" "age-keygen -y $new_key_path")

  echo "New public key: $new_pubkey"
  echo "$new_pubkey"
}

# Step 2: Add new key to .sops.yaml (keeping old key)
sops_rotate_add_new_key() {
  local hostname="${1:?hostname required}"
  local new_pubkey="${2:?new public key required}"
  local secrets_dir="${3:-../nix-secrets}"

  echo "==> Adding new key for $hostname to .sops.yaml..."

  cd "$secrets_dir"

  # Add new key with _new suffix
  yq eval ".keys.hosts += [\"&${hostname}_new\", \"$new_pubkey\"]" -i .sops.yaml

  # Add to creation rules (both old and new keys)
  # This is complex - might need manual editing
  echo "Warning: Creation rules may need manual update to include both keys"
  echo "Edit .sops.yaml and add *${hostname}_new to existing creation_rules"

  vcs_add .sops.yaml
  vcs_commit "feat: add new rotation key for $hostname"
}

# Step 3: Rekey all secrets with both old and new keys
sops_rotate_rekey_dual() {
  local secrets_dir="${1:-../nix-secrets}"

  echo "==> Rekeying secrets with both old and new keys..."
  cd "$secrets_dir"

  # Run standard rekey (now includes both keys)
  just rekey
}

# Step 4: Deploy new key to host
sops_rotate_deploy_new_key() {
  local hostname="${1:?hostname required}"
  local new_key_path="${2:-/tmp/new-age-key.txt}"

  echo "==> Deploying new key to $hostname..."

  # Backup old key
  ssh "$hostname" "sudo cp /var/lib/sops-nix/key.txt /var/lib/sops-nix/key.txt.old"

  # Deploy new key
  ssh "$hostname" "sudo tee /var/lib/sops-nix/key.txt > /dev/null" < <(ssh "$hostname" "cat $new_key_path")
  ssh "$hostname" "sudo chmod 600 /var/lib/sops-nix/key.txt"
  ssh "$hostname" "sudo chown root:root /var/lib/sops-nix/key.txt"

  echo "New key deployed. Old key backed up to key.txt.old"
}

# Step 5: Verify new key works
sops_rotate_verify() {
  local hostname="${1:?hostname required}"

  echo "==> Verifying new key works on $hostname..."

  # Rebuild to decrypt with new key
  ssh "$hostname" "sudo nixos-rebuild test"

  # Check sops-nix service
  if ssh "$hostname" "systemctl is-active sops-nix.service" > /dev/null; then
    echo "✓ sops-nix.service is active"
  else
    echo "✗ sops-nix.service failed!"
    return 1
  fi

  # Check secrets exist
  local secret_count
  secret_count=$(ssh "$hostname" "sudo find /run/secrets -type f | wc -l")

  if [ "$secret_count" -gt 0 ]; then
    echo "✓ Secrets decrypted successfully ($secret_count secrets)"
  else
    echo "✗ No secrets found!"
    return 1
  fi

  echo "==> Verification passed!"
}

# Step 6: Remove old key from .sops.yaml
sops_rotate_remove_old_key() {
  local hostname="${1:?hostname required}"
  local secrets_dir="${2:-../nix-secrets}"

  echo "==> Removing old key for $hostname from .sops.yaml..."

  cd "$secrets_dir"

  # This requires manual editing or complex yq
  echo "Warning: Manual step required"
  echo "Edit .sops.yaml and:"
  echo "  1. Remove old &$hostname key line"
  echo "  2. Rename &${hostname}_new to &$hostname"
  echo "  3. Update creation_rules to use renamed anchor"
  echo ""
  echo "Press Enter when done..."
  read -r

  vcs_add .sops.yaml
  vcs_commit "feat: complete rotation for $hostname, remove old key"
}

# Step 7: Final rekey without old key
sops_rotate_final_rekey() {
  local secrets_dir="${1:-../nix-secrets}"

  echo "==> Final rekey with only new key..."
  cd "$secrets_dir"
  just rekey
}

# All-in-one rotation function (interactive)
sops_rotate_host() {
  local hostname="${1:?hostname required}"

  echo "===================================================="
  echo "SOPS Key Rotation for $hostname"
  echo "This is a zero-downtime process with verification"
  echo "===================================================="
  echo ""

  # Step 1
  echo "Step 1/7: Generate new key"
  local new_pubkey
  new_pubkey=$(sops_rotate_generate_new_key "$hostname")
  echo ""

  # Step 2
  echo "Step 2/7: Add new key to .sops.yaml"
  sops_rotate_add_new_key "$hostname" "$new_pubkey"
  echo ""

  # Step 3
  echo "Step 3/7: Rekey with both keys"
  sops_rotate_rekey_dual
  echo ""

  # Step 4
  echo "Step 4/7: Deploy new key to host"
  sops_rotate_deploy_new_key "$hostname"
  echo ""

  # Step 5
  echo "Step 5/7: Verify new key works"
  if ! sops_rotate_verify "$hostname"; then
    echo ""
    echo "ERROR: Verification failed!"
    echo "Rollback: ssh $hostname 'sudo mv /var/lib/sops-nix/key.txt.old /var/lib/sops-nix/key.txt'"
    return 1
  fi
  echo ""

  # Step 6
  echo "Step 6/7: Remove old key from .sops.yaml"
  sops_rotate_remove_old_key "$hostname"
  echo ""

  # Step 7
  echo "Step 7/7: Final rekey"
  sops_rotate_final_rekey
  echo ""

  echo "===================================================="
  echo "Rotation complete for $hostname!"
  echo "Update key metadata:"
  echo "  sops -e -i --set '[\"sops\"][\"key-metadata\"][\"rotated_at\"]' '\"$(date +%Y-%m-%d)\"' ../nix-secrets/sops/$hostname.yaml"
  echo "===================================================="
}
```

### 3. Add Justfile Commands

**File**: `justfile`

Add rotation commands:

```just
# Initialize key metadata for existing host
sops-init-key-metadata HOST:
  @echo "Initializing key metadata for {{HOST}}..."
  bash -c "source scripts/helpers.sh && sops_init_key_metadata {{HOST}}"

# Rotate SOPS key for host (interactive, zero-downtime)
sops-rotate HOST:
  @echo "Starting key rotation for {{HOST}}..."
  bash scripts/sops-rotate.sh sops_rotate_host {{HOST}}

# Check age of all host keys
sops-check-key-age:
  #!/usr/bin/env bash
  set -e
  echo "Host Key Age Report"
  echo "==================="
  cd ../nix-secrets/sops
  for yaml in *.yaml; do
    hostname="${yaml%.yaml}"
    if [ "$hostname" != "shared" ]; then
      if sops -d "$yaml" | grep -q "key-metadata"; then
        generated=$(sops -d "$yaml" | yq '.sops.key-metadata.generated_at')
        rotated=$(sops -d "$yaml" | yq '.sops.key-metadata.rotated_at')
        echo "$hostname: generated=$generated, last_rotated=$rotated"
      else
        echo "$hostname: no metadata"
      fi
    fi
  done
```

### 4. Update Bootstrap to Include Metadata

**File**: `scripts/bootstrap-nixos.sh`

After creating host YAML, add metadata:

```bash
# After user age key setup, before rekey
info "Adding key metadata..."
sops -e -i --set '["sops"]["key-metadata"]' "{\"generated_at\": \"$(date +%Y-%m-%d)\", \"rotated_at\": null}" "$SECRETS_DIR/sops/$HOSTNAME.yaml"
```

### 5. Documentation

**File**: `docs/sops-rotation.md` (new)

```markdown
# SOPS Key Rotation Guide

## Overview

This guide covers manual SOPS/age key rotation with zero downtime. The process ensures secrets remain accessible during rotation by temporarily encrypting with both old and new keys.

## When to Rotate

Key rotation policy (recommendations):
- **Production servers**: Every 90 days
- **Development hosts**: Every 180 days
- **VMs/testing**: On rebuild (ephemeral)
- **Compromise**: Immediately

Check key age:
```bash
just sops-check-key-age
```

## Rotation Process

### Automated (Recommended)

```bash
# Interactive rotation with verification
just sops-rotate hostname
```

This runs all 7 steps with verification at each stage.

### Manual Step-by-Step

If automated rotation fails or you need more control:

1. **Generate new key**:
   ```bash
   ssh hostname "age-keygen -o /tmp/new-age-key.txt"
   NEW_PUBKEY=$(ssh hostname "age-keygen -y /tmp/new-age-key.txt")
   echo $NEW_PUBKEY
   ```

2. **Add to .sops.yaml** (keep old key):
   ```bash
   cd ../nix-secrets
   # Edit .sops.yaml, add new key with &hostname_new anchor
   # Add to creation_rules for shared.yaml and hostname.yaml
   ```

3. **Rekey with both keys**:
   ```bash
   just rekey
   ```

4. **Deploy new key**:
   ```bash
   ssh hostname "sudo cp /var/lib/sops-nix/key.txt /var/lib/sops-nix/key.txt.old"
   cat /tmp/new-age-key.txt | ssh hostname "sudo tee /var/lib/sops-nix/key.txt"
   ssh hostname "sudo chmod 600 /var/lib/sops-nix/key.txt"
   ```

5. **Verify**:
   ```bash
   ssh hostname "sudo nixos-rebuild test"
   ssh hostname "systemctl status sops-nix.service"
   ssh hostname "sudo ls /run/secrets/"
   ```

6. **Remove old key** from .sops.yaml:
   ```bash
   cd ../nix-secrets
   # Edit .sops.yaml
   # Remove old &hostname line
   # Rename &hostname_new to &hostname
   ```

7. **Final rekey**:
   ```bash
   just rekey
   ```

8. **Update metadata**:
   ```bash
   sops -e -i --set '["sops"]["key-metadata"]["rotated_at"]' '"$(date +%Y-%m-%d)"' ../nix-secrets/sops/hostname.yaml
   ```

## Rollback

If verification fails after deploying new key:

```bash
ssh hostname "sudo mv /var/lib/sops-nix/key.txt.old /var/lib/sops-nix/key.txt"
ssh hostname "sudo nixos-rebuild test"
```

## Future: Automated Rotation

Scheduled rotation via systemd timer is planned but not yet implemented.
See `.planning/phases/17-sops-automation/` (future work).
```

## Success Criteria

- [ ] Key metadata tracking added to modules/common/sops.nix
- [ ] Activation script warns if metadata missing
- [ ] Helper function `sops_init_key_metadata` created
- [ ] Rotation script created at `scripts/sops-rotate.sh`
- [ ] All 7 rotation steps implemented as functions
- [ ] Justfile commands added: `sops-rotate`, `sops-init-key-metadata`, `sops-check-key-age`
- [ ] Bootstrap script adds metadata to new hosts
- [ ] Documentation created at `docs/sops-rotation.md`
- [ ] Test rotation on griefling VM successfully

## Files to Create

- `scripts/sops-rotate.sh` - Rotation helper functions
- `docs/sops-rotation.md` - Rotation guide

## Files to Modify

- `modules/common/sops.nix` - Add metadata secret and activation script
- `scripts/helpers.sh` - Add `sops_init_key_metadata` function
- `scripts/bootstrap-nixos.sh` - Add metadata to new hosts
- `justfile` - Add rotation commands

## Files to Reference

- `.planning/phases/16-sops-key-management/16-01-FINDINGS.md` - Current state
- `modules/common/sops.nix` - SOPS configuration
- `scripts/helpers.sh` - Existing SOPS helpers

## Testing Plan

1. **Initialize metadata** for existing host:
   ```bash
   just sops-init-key-metadata griefling
   # Verify metadata in ../nix-secrets/sops/griefling.yaml
   ```

2. **Test rotation** on griefling:
   ```bash
   just sops-rotate griefling
   # Follow prompts, verify each step
   ```

3. **Verify rotation** worked:
   ```bash
   ssh griefling "sudo systemctl status sops-nix.service"
   ssh griefling "sudo ls -la /run/secrets/"
   just sops-check-key-age  # Should show rotated_at date
   ```

4. **Test rollback**:
   ```bash
   # During rotation, after step 4, before removing old key:
   ssh griefling "sudo mv /var/lib/sops-nix/key.txt.old /var/lib/sops-nix/key.txt"
   ssh griefling "sudo nixos-rebuild test"
   # Should still work (secrets encrypted with both keys)
   ```

## Integration Points

- **VCS Helpers**: Uses vcs-helpers.sh for commits (Plan 16-02)
- **Enforcement**: Rotation updates metadata, enforcement can check age
- **Bootstrap**: New hosts get metadata from day 1
- **Justfile**: Commands integrate with existing SOPS workflow

## Future Enhancements (Not in This Plan)

- **Automated rotation**: Systemd timer triggers rotation
- **Multi-host coordination**: Rotate all hosts in sequence
- **Alerting**: Notify when keys approaching rotation deadline
- **Rotation policy**: Define in hostSpec per role

## Notes

- This plan focuses on **manual rotation infrastructure**
- Provides building blocks for future automation
- Zero-downtime approach prevents service disruptions
- Metadata enables rotation policy enforcement later
- Step 6 (remove old key) may need manual .sops.yaml editing
