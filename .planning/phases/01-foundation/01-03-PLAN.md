---
phase: 01-foundation
plan: 03
type: execute
---

<objective>
Wire up nh for rebuilds, verify disko integration, and test the complete foundation builds correctly.

Purpose: Ensure the development workflow (nh) and disk management (disko) are properly integrated.
Output: Working nh rebuild commands, disko available, verified build of current host.
</objective>

<execution_context>
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/templates/summary.md
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/references/checkpoints.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@flake.nix
@shell.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify nh integration for rebuilds</name>
  <files>shell.nix, flake.nix</files>
  <action>
Ensure nh (nix-helper) is available and works with the flake:

1. Check if nh is in devShell dependencies (shell.nix):
   - If not present, add it to the devShell packages
   - nh should be available as `pkgs.nh`

2. Verify the flake structure works with nh commands:
   - `nh os switch .` should be able to find configurations
   - `nh os build .` should work for dry-run builds

3. The flake must expose nixosConfigurations in a way nh understands:
   - Standard nixosConfigurations.{hostname} pattern (already done in Plan 1)

4. If shell.nix doesn't include nh, update it:
   ```nix
   { pkgs, ... }:
   {
     default = pkgs.mkShell {
       packages = with pkgs; [
         nh
         # ... other dev tools
       ];
     };
   }
   ```

Do NOT actually run `nh os switch` - just verify it's available and configured.
  </action>
  <verify>nix develop -c nh --version returns version info</verify>
  <done>nh available in devShell, flake structure compatible with nh commands</done>
</task>

<task type="auto">
  <name>Task 2: Verify disko module integration</name>
  <files>flake.nix</files>
  <action>
Ensure disko is properly wired up for declarative disk management:

1. Verify disko input exists in flake.nix (should already be there):
   ```nix
   disko = {
     url = "github:nix-community/disko";
     inputs.nixpkgs.follows = "nixpkgs";
   };
   ```

2. Ensure disko module is importable in host configurations:
   - Either import in common modules, or document that hosts should import it
   - Pattern: `inputs.disko.nixosModules.disko`

3. Verify disko is passed through specialArgs so hosts can access it:
   ```nix
   specialArgs = { inherit inputs outputs lib; };
   ```

4. Do NOT create any disko configurations yet - just verify the plumbing works.

5. Test that a host could use disko by checking the module is available:
   ```bash
   nix eval .#nixosConfigurations.{hostname}.options.disko --json 2>/dev/null
   ```

If disko module isn't being imported by default, that's fine - hosts can import it individually.
The key is that inputs.disko is available via specialArgs.
  </action>
  <verify>nix eval '.#nixosConfigurations.griefling.options.disko' shows disko options (if griefling imports it) OR confirm inputs.disko is passed</verify>
  <done>disko input available, module importable by hosts that need it</done>
</task>

<task type="auto">
  <name>Task 3: Test foundation build</name>
  <files>none (verification only)</files>
  <action>
Run a dry-build to verify the complete foundation works:

1. Run flake check:
   ```bash
   nix flake check --no-build
   ```

2. Test building the current host (likely griefling or malphas):
   ```bash
   nix build .#nixosConfigurations.griefling.config.system.build.toplevel --dry-run
   ```
   (Use whichever host exists in hosts/nixos/)

3. Verify packages output:
   ```bash
   nix flake show --json | jq '.packages'
   ```

4. If any errors occur, fix them before proceeding.

Document any issues found and their resolutions in the summary.
  </action>
  <verify>All three commands complete without errors</verify>
  <done>Flake check passes, host builds (dry-run), packages accessible</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 1 foundation: multi-arch flake, clean lib/overlays, nh/disko integration</what-built>
  <how-to-verify>
    1. Run: nix flake show
       - Verify packages for x86_64-linux, aarch64-linux, x86_64-darwin listed
       - Verify nixosConfigurations shows your hosts

    2. Run: nix develop -c nh --version
       - Verify nh is available

    3. Run: nix build .#nixosConfigurations.{your-host}.config.system.build.toplevel --dry-run
       - Replace {your-host} with actual hostname (griefling, malphas, etc.)
       - Verify no evaluation errors

    4. Optionally: nh os build . --dry
       - Verify nh can find and build configurations
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 1, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `nix flake check --no-build` passes
- [ ] `nix flake show` displays all expected outputs
- [ ] nh is available in devShell
- [ ] disko input is accessible
- [ ] At least one host builds without evaluation errors
</verification>

<success_criteria>
- Phase 1 Foundation complete
- Multi-architecture support in place
- lib and overlays consolidated
- nh available for rebuilds
- disko ready for disk configuration
- Existing hosts still work
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`

This summary should include:
- All three plans' accomplishments
- Any architectural decisions made
- Known issues or future improvements identified
- Confirmation that Phase 1 is complete and ready for Phase 2 (Role System)
</output>
