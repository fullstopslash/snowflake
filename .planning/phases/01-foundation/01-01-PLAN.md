---
phase: 01-foundation
plan: 01
type: execute
---

<objective>
Refactor flake.nix for multi-architecture support with a clean, unified mkHost helper.

Purpose: Enable the flake to build hosts for x86_64-linux, aarch64-linux (Pi, tablets), and x86_64-darwin (T2 MacBook) from a single codebase.
Output: A flake.nix with forAllSystems pattern and architecture-aware host generation.
</objective>

<execution_context>
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@flake.nix
@~/nix/flake.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add forAllSystems pattern for multi-arch support</name>
  <files>flake.nix</files>
  <action>
Refactor flake.nix to support multiple architectures:

1. Define supported systems list:
   ```nix
   supportedSystems = [
     "x86_64-linux"
     "aarch64-linux"
     "x86_64-darwin"
   ];
   ```

2. Create forAllSystems helper:
   ```nix
   forAllSystems = nixpkgs.lib.genAttrs supportedSystems;
   ```

3. Update packages, formatter, checks, and devShells outputs to use forAllSystems.

4. Keep the existing nixpkgs-stable and nixpkgs-unstable inputs - they're useful.

5. Remove the hardcoded `system = "x86_64-linux"` from ~/nix/flake.nix patterns.

Do NOT change nixosConfigurations yet - that's the next task.
Preserve existing inputs (home-manager, sops-nix, disko, stylix, etc.).
  </action>
  <verify>nix flake check --no-build completes without errors about system definitions</verify>
  <done>forAllSystems pattern in place, packages/formatter/devShells work for all architectures</done>
</task>

<task type="auto">
  <name>Task 2: Create architecture-aware mkHost helper</name>
  <files>flake.nix</files>
  <action>
Replace the current nixosConfigurations generation with a cleaner mkHost pattern:

1. Create mkHost function that:
   - Takes hostname as argument
   - Reads system architecture from host's default.nix (via hostSpec.system or a new convention)
   - Falls back to x86_64-linux if not specified
   - Passes specialArgs with inputs, outputs, lib

2. The function should:
   ```nix
   mkHost = hostname: let
     # Try to read system from host config, default to x86_64-linux
     hostPath = ./hosts/${hostname};
     # For now, detect based on hostname patterns or explicit config
     system = "x86_64-linux"; # Will be overridable per-host
   in nixpkgs.lib.nixosSystem {
     inherit system;
     specialArgs = { inherit inputs outputs lib; };
     modules = [
       ./hosts/${hostname}
       # Common modules, overlays, etc.
     ];
   };
   ```

3. Keep auto-discovery of hosts from hosts/ directory (the builtins.readDir pattern is good).

4. For Darwin hosts (future), prepare the pattern but comment out nix-darwin integration for now.

Do NOT add darwin hosts yet - just prepare the structure.
Keep the existing griefling special-case handling for unstable nixpkgs if it exists.
  </action>
  <verify>nix flake show displays nixosConfigurations for existing hosts without errors</verify>
  <done>mkHost helper works, existing hosts still build, architecture is configurable per-host</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `nix flake check --no-build` passes
- [ ] `nix flake show` displays all outputs correctly
- [ ] Existing host configurations still accessible via `nix build .#nixosConfigurations.{hostname}.config.system.build.toplevel --dry-run`
</verification>

<success_criteria>
- forAllSystems pattern implemented for packages, formatter, checks, devShells
- mkHost helper function creates nixosConfigurations
- Architecture is parameterizable (even if all current hosts are x86_64-linux)
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
