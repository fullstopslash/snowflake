---
phase: 09-vikunja-sync-fixes
plan: 02
title: Project Validation in Title Fallback
status: pending
---

# Plan 09-02: Project Validation in Title Fallback

Fix HIGH priority issue #3: Title-based fallback matching can link wrong tasks across projects.

## Goal

When the annotation race condition fix finds a task by title, verify the task's project matches before linking with `vikunja_id`.

## Context

### The Problem

The race condition fix at lines 307-313 finds tasks by title when `vikunja_id` lookup fails:

```python
if not existing_uuid and title:
    existing_uuid = find_tw_task_by_description(tw, title, project_title)
    if existing_uuid and vikunja_id and event == "task.created":
        log(f"Found TW task {existing_uuid} by title, adding missing vikunja_id:{vikunja_id}")
        annotate_vikunja_id(existing_uuid, vikunja_id)
```

While `find_tw_task_by_description()` filters by project, the result isn't validated. If TW's project name differs slightly from Vikunja's (capitalization, spaces), we might:
1. Find a task in the wrong project
2. Link it with the wrong `vikunja_id`
3. Create sync corruption

### Example Scenario

1. TW has task "Review PR" in project "work"
2. Vikunja has task "Review PR" in project "Work" (capitalized)
3. Webhook arrives for Vikunja task
4. `find_tw_task_by_description(tw, "Review PR", "Work")` returns None (project mismatch)
5. Falls through to create new task... OR
6. If project normalization is added later, wrong task gets linked

## Changes

### File: `pkgs/vikunja-sync/vikunja-direct.py`

#### 1. Validate project match after title lookup

```python
# For task.created events, if we couldn't find by vikunja_id but find by title,
# this is likely the annotation race condition - the TW task exists but hasn't
# been annotated yet. We should update it and add the annotation.
if not existing_uuid and title:
    existing_uuid = find_tw_task_by_description(tw, title, project_title)
    if existing_uuid and vikunja_id and event == "task.created":
        # Verify project actually matches before linking
        found_task = tw.export_task(existing_uuid)
        if found_task and found_task.get("project") == project_title:
            # Found task by title during a create event - this is the race condition
            # Add the missing vikunja_id annotation to prevent future duplicates
            log(f"Found TW task {existing_uuid} by title, adding missing vikunja_id:{vikunja_id}")
            annotate_vikunja_id(existing_uuid, vikunja_id)
        else:
            # Project mismatch - don't link, let it create a new task
            log(f"Title match {existing_uuid} has wrong project ({found_task.get('project') if found_task else 'unknown'} != {project_title}), not linking")
            existing_uuid = None
```

#### 2. Add case-insensitive project comparison (optional hardening)

Consider normalizing project names for comparison:

```python
def normalize_project(name: str) -> str:
    """Normalize project name for comparison."""
    return name.lower().strip() if name else ""

# In handle_webhook:
if found_task and normalize_project(found_task.get("project", "")) == normalize_project(project_title):
    # ...
```

**Decision**: Skip normalization for now. Keep strict matching to avoid false positives.

## Verification

1. **Test case 1**: TW task "Test" in project "inbox", Vikunja webhook for "Test" in project "inbox" - should link
2. **Test case 2**: TW task "Test" in project "work", Vikunja webhook for "Test" in project "inbox" - should NOT link, should create new task
3. **Test case 3**: No TW task "Test" anywhere, Vikunja webhook for "Test" - should create new task

## Checklist

- [ ] Add project validation after title-based lookup in `handle_webhook()`
- [ ] Add log message for project mismatch cases
- [ ] Clear `existing_uuid` on mismatch to trigger task creation
- [ ] Verify NixOS rebuild succeeds
- [ ] Manual test: create tasks with same title in different projects

## Rollback

Revert the project validation check. The current behavior is "mostly works" - this is a hardening fix.
