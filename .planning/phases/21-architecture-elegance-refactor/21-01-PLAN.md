# Phase 21-01: Architecture Elegance Refactor

## Objective

Refactor the NixOS configuration to strictly enforce architectural boundaries between hosts, roles, and modules. Move test-specific configuration overrides from host files into the appropriate role layer, ensuring host definitions remain minimal and clearly express their intent.

## Context

@file:hosts/sorrow/default.nix
@file:hosts/torment/default.nix
@file:hosts/griefling/default.nix
@file:hosts/malphas/default.nix
@file:hosts/misery/default.nix
@file:roles/task-test.nix
@file:modules/common/auto-upgrade.nix
@file:modules/system/boot/golden-generation.nix

## Background

### Current Architecture Principles

The codebase follows a three-tier architecture:

1. **Modules** (`/modules`): Granular settings, software lists, and reusable configuration pieces
2. **Roles** (`/roles`): Meta-layer combining modules and providing overrides for specific tasks/hardware forms
3. **Hosts** (`/hosts`): Minimal configuration for specific machines - hardware-configuration.nix, role selection, and host-specific quirks only

### Problem

Current state violates these principles:
- **hosts/sorrow/default.nix** (lines 56-86): Contains test-specific `autoUpgrade` and `goldenGeneration` overrides
- **hosts/torment/default.nix** (lines 50-80): Duplicate test-specific overrides
- **hosts/griefling/default.nix** (lines 39-48): Test-specific `goldenGeneration` overrides

These configurations are:
1. **Inelegant**: Host files contain ~30 lines of override code that obscures their primary purpose
2. **Duplicated**: Same override pattern repeated across multiple test hosts
3. **Misplaced**: Test-specific settings belong in the `task-test.nix` role, not individual hosts
4. **Not properly abstracted**: All these hosts use `roles = ["test"]` but must repeat the test configuration

### Desired Architecture

**Hosts** should be minimal and express intent:
```nix
# Sorrow - Minimal Headless Test VM
{
  imports = [ ./hardware-configuration.nix ];

  disks = { ... };
  roles = [ "vmHeadless" "test" ];
  host = { ... };

  # ONLY host-specific exceptions here (like encryption.tpm.enable)
}
```

**Roles** should contain task-specific overrides:
```nix
# roles/task-test.nix
config = lib.mkIf (builtins.elem "test" config.roles) {
  # All test-specific configuration here
  myModules.services.autoUpgrade = { ... };
  myModules.system.boot.goldenGeneration = { ... };
}
```

## Current State Analysis

### Module Definitions

Both modules are properly defined with full option sets:

- **modules/common/auto-upgrade.nix**: Provides `myModules.services.autoUpgrade` with options:
  - `enable`, `mode`, `schedule`, `buildBeforeSwitch`
  - `validationChecks`, `onValidationFailure`
  - Already supports all configuration needed by test hosts

- **modules/system/boot/golden-generation.nix**: Provides `myModules.system.boot.goldenGeneration` with options:
  - `enable`, `validateServices`, `autoPinAfterBoot`
  - Already supports all configuration needed by test hosts

### Role Configuration

**roles/task-test.nix** currently has:
- Basic `goldenGeneration` config (lines 32-36) with `mkDefault` values
- Missing `autoUpgrade` configuration entirely
- Pattern shows proper use of role-level overrides

### Host Violations

**hosts/sorrow/default.nix** and **hosts/torment/default.nix**:
```nix
# Lines 56-74: autoUpgrade overrides
myModules.services.autoUpgrade = {
  enable = true;
  mode = "local";
  schedule = "hourly";
  buildBeforeSwitch = true;
  validationChecks = [ ... ];
  onValidationFailure = "rollback";
};

# Lines 76-86: goldenGeneration overrides
myModules.system.boot.goldenGeneration = {
  enable = true;
  validateServices = [ ... ];
  autoPinAfterBoot = true;
};
```

These should move to `roles/task-test.nix`.

## Tasks

### Task 1: Audit all hosts for architectural violations

**Purpose**: Systematically identify all hosts with module overrides that belong in roles

**Actions**:
1. Search for `myModules` in all host default.nix files
2. Categorize each override:
   - **Legitimate host-specific** (e.g., `host.encryption.tpm.enable` for TPM on specific hardware)
   - **Should be in role** (e.g., test-specific autoUpgrade settings)
   - **Should be in module** (e.g., new module options needed)
3. Document findings

**Verification**:
```bash
# Find all myModules references in hosts
grep -rn "myModules\." hosts/*/default.nix

# Identify which are role-appropriate
grep -rn "myModules\.services\.autoUpgrade" hosts/*/default.nix
grep -rn "myModules\.system\.boot\.goldenGeneration" hosts/*/default.nix
```

**Success Criteria**:
- Complete list of violations documented
- Clear categorization: host-specific vs role-appropriate vs needs new module option

### Task 2: Move test autoUpgrade config to task-test.nix role

**Purpose**: Centralize test-specific autoUpgrade settings in the test role

**Actions**:
1. Add `autoUpgrade` configuration to `roles/task-test.nix`:
   ```nix
   # Auto-upgrade for rapid testing iteration
   myModules.services.autoUpgrade = {
     enable = lib.mkDefault true;
     mode = lib.mkDefault "local";
     schedule = lib.mkDefault "hourly";
     buildBeforeSwitch = lib.mkDefault true;
     validationChecks = lib.mkDefault [
       "systemctl --quiet is-enabled sshd"
       "systemctl --quiet is-enabled tailscaled"
     ];
     onValidationFailure = lib.mkDefault "rollback";
   };
   ```

2. Use `lib.mkDefault` to allow host-level overrides if needed
3. Add documentation explaining the test-specific settings

**File**: `roles/task-test.nix`

**Verification**:
```bash
# Verify autoUpgrade config exists in role
grep -A 10 "myModules.services.autoUpgrade" roles/task-test.nix

# Build test
nix build .#nixosConfigurations.sorrow.config.system.build.toplevel --dry-run
```

**Success Criteria**:
- `task-test.nix` contains complete autoUpgrade configuration
- Uses `lib.mkDefault` for all values (allows host overrides)
- Includes comments explaining test-specific rationale

### Task 3: Update goldenGeneration config in task-test.nix

**Purpose**: Enhance existing goldenGeneration config to match test host needs

**Current state** (roles/task-test.nix lines 31-36):
```nix
myModules.system.boot.goldenGeneration = {
  enable = lib.mkDefault true;
  validateServices = lib.mkDefault [ "sshd.service" ];
  autoPinAfterBoot = lib.mkDefault false; # Manual pinning only for test VMs
};
```

**Actions**:
1. Update `validateServices` to include tailscaled:
   ```nix
   validateServices = lib.mkDefault [
     "sshd.service"
     "tailscaled.service"
   ];
   ```

2. Change `autoPinAfterBoot` to `true` to match test host pattern:
   ```nix
   autoPinAfterBoot = lib.mkDefault true;
   ```

3. Add comment explaining the test-specific configuration:
   ```nix
   # Golden generation configuration for test VMs
   # Auto-pin after successful boot to test golden generation workflow
   myModules.system.boot.goldenGeneration = {
     enable = lib.mkDefault true;
     validateServices = lib.mkDefault [
       "sshd.service"
       "tailscaled.service"
     ];
     autoPinAfterBoot = lib.mkDefault true; # Auto-pin for testing golden generation workflow
   };
   ```

**File**: `roles/task-test.nix`

**Verification**:
```bash
# Verify updated config
grep -A 8 "goldenGeneration" roles/task-test.nix
```

**Success Criteria**:
- `validateServices` includes both sshd and tailscaled
- `autoPinAfterBoot` set to true with explanatory comment
- Uses `lib.mkDefault` for all values

### Task 4: Remove autoUpgrade overrides from sorrow

**Purpose**: Simplify sorrow host by removing configuration now in role

**Actions**:
1. Remove lines 49-74 from `hosts/sorrow/default.nix` (entire AUTO-UPGRADE section)
2. Keep comments indicating configuration comes from role:
   ```nix
   # ========================================
   # AUTO-UPGRADE & GOLDEN GENERATION
   # ========================================
   # Configured via task-test.nix role
   # - Hourly auto-upgrade for rapid testing iteration
   # - Build validation and rollback on failure
   # - Golden generation auto-pinning after successful boot
   ```

**File**: `hosts/sorrow/default.nix`

**Verification**:
```bash
# Should not contain myModules.services.autoUpgrade
! grep -q "myModules.services.autoUpgrade" hosts/sorrow/default.nix

# Build test
nix build .#nixosConfigurations.sorrow.config.system.build.toplevel --dry-run
```

**Success Criteria**:
- No `myModules.services.autoUpgrade` block in host file
- Optional brief comment indicating config comes from role
- Build succeeds

### Task 5: Remove goldenGeneration overrides from sorrow

**Purpose**: Simplify sorrow host by removing configuration now in role

**Actions**:
1. Remove lines 76-86 from `hosts/sorrow/default.nix` (entire GOLDEN GENERATION section)
2. Configuration now inherited from `task-test.nix` role

**File**: `hosts/sorrow/default.nix`

**Verification**:
```bash
# Should not contain myModules.system.boot.goldenGeneration
! grep -q "myModules.system.boot.goldenGeneration" hosts/sorrow/default.nix

# Verify host file is now minimal
wc -l hosts/sorrow/default.nix  # Should be ~50 lines instead of ~87
```

**Success Criteria**:
- No `myModules.system.boot.goldenGeneration` block in host file
- Host file reduced to ~50 lines (minimal and elegant)
- Build succeeds

### Task 6: Remove overrides from torment

**Purpose**: Apply same simplification to torment host

**Actions**:
1. Remove lines 50-68 from `hosts/torment/default.nix` (AUTO-UPGRADE section)
2. Remove lines 70-80 from `hosts/torment/default.nix` (GOLDEN GENERATION section)
3. Add single comment block indicating config comes from role (optional):
   ```nix
   # ========================================
   # AUTO-UPGRADE & GOLDEN GENERATION
   # ========================================
   # Configured via task-test.nix role
   ```

**File**: `hosts/torment/default.nix`

**Verification**:
```bash
# No module overrides for these features
! grep -q "myModules.services.autoUpgrade" hosts/torment/default.nix
! grep -q "myModules.system.boot.goldenGeneration" hosts/torment/default.nix

# Build test
nix build .#nixosConfigurations.torment.config.system.build.toplevel --dry-run
```

**Success Criteria**:
- Host file simplified to ~50 lines
- No test-specific module overrides
- Build succeeds

### Task 7: Audit and fix griefling

**Purpose**: Simplify griefling by removing goldenGeneration override

**Current state** (hosts/griefling/default.nix lines 39-48):
```nix
myModules.system.boot.goldenGeneration = {
  enable = true;
  validateServices = [
    "sshd.service"
    # Removed tailscaled - not enabled in VM role
  ];
  autoPinAfterBoot = true;
};
```

**Problem**: Griefling uses "test" role but overrides goldenGeneration with different validateServices

**Actions**:
1. Check if griefling has tailscale enabled:
   ```bash
   grep -rn "tailscale" hosts/griefling/default.nix
   grep -rn "tailscale" roles/form-vm.nix
   ```

2. If tailscale is NOT enabled, this is a legitimate host-specific override (keep it with comment)
3. If tailscale IS enabled, remove the override (use role defaults)

**File**: `hosts/griefling/default.nix`

**Verification**:
```bash
# Build test
nix build .#nixosConfigurations.griefling.config.system.build.toplevel --dry-run
```

**Success Criteria**:
- Griefling either:
  - Uses role defaults (if tailscale enabled), OR
  - Has documented host-specific override (if tailscale disabled)
- Build succeeds

### Task 8: Verify misery and malphas

**Purpose**: Ensure other test VMs follow proper architecture

**Actions**:
1. Review `hosts/misery/default.nix`:
   - Check for module overrides (lines 44-52 show goldenGeneration)
   - Determine if override is host-specific or should use role defaults

2. Review `hosts/malphas/default.nix`:
   - Verify it's properly minimal (appears to be)
   - Document as good example

**Files**:
- `hosts/misery/default.nix`
- `hosts/malphas/default.nix`

**Verification**:
```bash
# Build tests
nix build .#nixosConfigurations.misery.config.system.build.toplevel --dry-run
nix build .#nixosConfigurations.malphas.config.system.build.toplevel --dry-run
```

**Success Criteria**:
- Misery either simplified or documented as legitimate exception
- Malphas verified as good example
- All builds succeed

### Task 9: Audit all roles for architectural compliance

**Purpose**: Ensure all roles follow proper patterns

**Actions**:
1. Review all `roles/form-*.nix` files:
   - Should contain: hardware settings, boot config, module selections
   - Should use: `lib.mkDefault` for overridable settings
   - Should NOT: contain task-specific overrides

2. Review all `roles/task-*.nix` files:
   - Should contain: task-specific module selections and overrides
   - Should use: `lib.mkDefault` for all settings
   - Should NOT: contain hardware/boot config

3. Document any violations or improvements needed

**Verification**:
```bash
# Check for task-specific config in form roles (should be minimal)
grep -rn "myModules" roles/form-*.nix | grep -v "mkDefault"

# Check for hardware config in task roles (should be minimal)
grep -rn "boot\." roles/task-*.nix
grep -rn "hardware\." roles/task-*.nix
```

**Success Criteria**:
- Clear separation: form roles = hardware, task roles = software/config
- All roles use `lib.mkDefault` appropriately
- Documentation of any necessary exceptions

### Task 10: Comprehensive build verification

**Purpose**: Ensure all changes maintain working configurations

**Actions**:
1. Build all test VMs:
   ```bash
   nix build .#nixosConfigurations.sorrow.config.system.build.toplevel
   nix build .#nixosConfigurations.torment.config.system.build.toplevel
   nix build .#nixosConfigurations.griefling.config.system.build.toplevel
   nix build .#nixosConfigurations.misery.config.system.build.toplevel
   nix build .#nixosConfigurations.malphas.config.system.build.toplevel
   ```

2. Build at least one production host to ensure no regressions:
   ```bash
   nix build .#nixosConfigurations.<production-host>.config.system.build.toplevel
   ```

3. Verify no evaluation errors or warnings

**Verification**:
```bash
# All builds should succeed
nix flake check --all-systems
```

**Success Criteria**:
- All test VMs build successfully
- At least one production host builds successfully
- No new warnings or evaluation errors
- Flake check passes

## Verification Strategy

### Architectural Compliance

**Before refactor:**
```bash
# Count lines with module overrides in hosts
grep -c "myModules\." hosts/*/default.nix | grep -v ":0"
```

**After refactor:**
```bash
# Should be significantly reduced, only host-specific exceptions remain
grep -c "myModules\." hosts/*/default.nix | grep -v ":0"

# Verify role has the config
grep -c "myModules.services.autoUpgrade" roles/task-test.nix  # Should be >0
```

### Functional Equivalence

Test VMs should have IDENTICAL behavior before and after:

```bash
# Compare config before and after refactor
nix eval .#nixosConfigurations.sorrow.config.myModules.services.autoUpgrade --json > before.json
# (make changes)
nix eval .#nixosConfigurations.sorrow.config.myModules.services.autoUpgrade --json > after.json
diff before.json after.json  # Should be empty or only show mkDefault changes
```

### Code Quality

```bash
# Host files should be minimal
for host in sorrow torment griefling misery malphas; do
  echo "$host: $(wc -l < hosts/$host/default.nix) lines"
done

# Compare before/after
```

## Success Criteria

### Architectural Alignment

1. **Hosts**: Minimal and express intent clearly
   - Only hardware-configuration.nix import
   - Clear role selection
   - Host identity (hostname, user)
   - ONLY host-specific exceptions with clear justification

2. **Roles**: Complete task/form definitions
   - `task-test.nix` contains ALL test-specific config
   - No duplication across hosts
   - Uses `lib.mkDefault` for overridable settings

3. **Modules**: Reusable and well-documented
   - No changes needed (already properly structured)

### Concrete Metrics

- ✅ `hosts/sorrow/default.nix`: ~50 lines (down from ~87)
- ✅ `hosts/torment/default.nix`: ~50 lines (down from ~81)
- ✅ `roles/task-test.nix`: Contains both autoUpgrade and goldenGeneration config
- ✅ All test VMs build successfully
- ✅ No functional regressions (same system behavior)

### Documentation

- ✅ Updated comments in roles explaining test-specific config
- ✅ Optional brief comments in hosts pointing to role config
- ✅ This PLAN.md documents the architectural principles

## Risks and Mitigations

### Risk: Breaking test VM functionality

**Mitigation**:
- Use `lib.mkDefault` in role (allows host overrides if needed)
- Test builds after each change
- Compare evaluated config before/after

### Risk: Missing host-specific edge cases

**Mitigation**:
- Careful audit in Task 1 and Task 7
- Document any legitimate host-specific needs
- Keep host overrides if justified (e.g., griefling without tailscale)

### Risk: Circular dependencies or evaluation errors

**Mitigation**:
- Test builds incrementally
- Follow established role patterns (mkDefault, proper conditionals)
- Run `nix flake check` after changes

## Output

Create `21-01-SUMMARY.md` documenting:
- All files modified with specific line changes
- Before/after line counts for each host
- Build verification results
- Any architectural exceptions documented
- Lessons learned for maintaining architectural boundaries

## Future Phases

This refactor establishes patterns for:
- **Phase 21-02**: Audit and refactor other task roles (development, mediacenter)
- **Phase 21-03**: Create role composition guide
- **Phase 21-04**: Automated architectural compliance checks
