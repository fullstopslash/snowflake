# Phase 23: Eliminate modules/common/host.nix

## Objective

Systematically eliminate `/modules/common/host.nix` by migrating its 40+ options to their architecturally correct locations (modules, roles, or universal settings), thereby enforcing proper separation of concerns and eliminating architectural violations.

## Context

**Current Architecture Files:**
- `/home/rain/nix-config/modules/common/host.nix` - 385 lines defining host.* namespace
- `/home/rain/nix-config/modules/common/universal.nix` - Universal settings for all hosts
- `/home/rain/nix-config/roles/common.nix` - Universal role baseline
- `/home/rain/nix-config/modules/selection.nix` - Module selection system
- `/home/rain/nix-config/modules/theming/stylix.nix` - Theming system
- `/home/rain/nix-config/home-manager/xdg.nix` - XDG defaults using host options

**Key Consumers:**
- `/home/rain/nix-config/modules/users/default.nix` - Uses identity options heavily
- `/home/rain/nix-config/modules/services/networking/ssh.nix` - Uses identity + behavioral flags
- `/home/rain/nix-config/modules/disks/luks-tpm-unlock.nix` - Uses encryption options
- `/home/rain/nix-config/modules/services/desktop/common.nix` - Uses secretCategories
- `/home/rain/nix-config/home-manager/desktops/waybar.nix` - Uses hardware options

## Background

The `host.nix` file was created as a centralized location for host-specific configuration, but has grown to violate architectural boundaries:

**Violations:**
1. **Preferences in common layer**: `theme`, `wallpaper`, `defaultBrowser`, `defaultEditor` should be module options
2. **Derived anti-patterns**: `useWayland`, `isDevelopment`, `isMinimal` are computed from `modules.*` selections, creating coupling
3. **Role concerns in common**: `secretCategories` is set by roles but defined centrally
4. **Mixed abstraction levels**: Identity (legitimate), hardware (legitimate), preferences (wrong layer), and derived (anti-pattern) coexist

**Proper Architecture:**
- **Modules** should define their own options (e.g., `myModules.theming.stylix.wallpaper`)
- **Roles** should set defaults for their domain (e.g., desktop role sets desktop secret categories)
- **Hosts** should only specify identity (hostname, username, hardware facts)
- **Universal.nix** should contain truly universal identity (email, domain from secrets)

## Option Categorization

### Category A: Core Identity (Keep, but relocate to universal.nix)
**Rationale**: These are fundamental host identity that ALL hosts need

- `hostName` - Required by all hosts (move to universal.nix, still set by hosts)
- `primaryUsername` - User identity (already in universal.nix)
- `email`, `domain`, `userFullName`, `handle` - User identity (already in universal.nix from secrets)
- `networking` - Network identity (already in universal.nix from secrets)
- `home` - Derived from primaryUsername (keep computation in universal.nix)
- `users` - List of users (keep, needed for user management)

**Action**: Consolidate in `/home/rain/nix-config/modules/common/universal.nix`

### Category B: Platform/Architecture (Keep in specialized module)
**Rationale**: Core system properties needed for cross-platform support

- `architecture` - System architecture (x86_64-linux, etc.) - Keep, set by roles
- `nixpkgsVariant` - Which nixpkgs to use (stable/unstable) - Keep, set by roles
- `useCustomPkgs` - Derived from nixpkgsVariant - Keep, computed
- `isDarwin` - Platform detection - Keep, needed for cross-platform

**Action**: Create `/home/rain/nix-config/modules/common/platform.nix` for these options

### Category C: Hardware Capabilities (Keep minimal, move to hardware module)
**Rationale**: True hardware facts that modules need to query

- `wifi` - Hardware has wifi (needed by networking modules) - **KEEP**
- `persistFolder` - Impermanence path (needed by disk modules) - **KEEP**
- `encryption.tpm` - TPM configuration (needed by disk modules) - **KEEP**
- `hdr` - Display HDR support - **DEPRECATE** (unused, only in waybar)
- `scaling` - Display scaling - **DEPRECATE** (unused, only in waybar)

**Action**:
- Keep essential hardware facts in new `/home/rain/nix-config/modules/common/hardware.nix`
- Remove unused `hdr` and `scaling` (waybar can have its own options if needed)

### Category D: Preferences (ELIMINATE - Move to module options)
**Rationale**: These are module-specific preferences, not host identity

- `theme` - **MOVE to** `myModules.theming.stylix.theme`
- `wallpaper` - **MOVE to** `myModules.theming.stylix.wallpaper`
- `defaultBrowser` - **MOVE to** `myModules.apps.xdg.defaultBrowser`
- `defaultEditor` - **MOVE to** `myModules.apps.xdg.defaultEditor`
- `defaultDesktop` - **MOVE to** `myModules.apps.xdg.defaultDesktop`
- `isAutoStyled` - **REMOVE** (unused dead code)
- `useNeovimTerminal` - **REMOVE** (unused dead code)

**Action**: Create module options where they're actually used

### Category E: Behavioral Preferences (Move to modules)
**Rationale**: These are feature flags, not identity

- `isWork` - **MOVE to** `myModules.services.networking.ssh.workMode` (only used for work SSH hosts)
- `useYubikey` - **MOVE to** `myModules.services.security.yubikey.enable` (module already exists)
- `voiceCoding` - **MOVE to** `myModules.apps.accessibility.talon.enable` (create module)

**Action**: Create appropriate module options

### Category F: Derived Anti-Patterns (ELIMINATE - Use modules.* directly)
**Rationale**: These create coupling and are anti-patterns. Consumers should check `modules.*` directly.

- `isMinimal` - Derived from modules.* - **ELIMINATE**
- `useWayland` - Derived from modules.* - **ELIMINATE**
- `useWindowManager` - Derived from modules.* - **ELIMINATE**
- `isDevelopment` - Derived from modules.* - **ELIMINATE**

**Action**: Update consumers to check `config.modules.apps.window-managers` etc. directly

### Category G: Role-Managed Flags (Move to roles)
**Rationale**: Set by roles, should be role options

- `isHeadless` - **MOVE to role flags** (form-vm-headless sets this)
- `isProduction` - **MOVE to role flags** (form-vm sets false, others true)
- `isMobile` - **MOVE to role flags** (form-laptop/tablet set this)
- `hasSecrets` - **MOVE to role flags** (all non-ISO hosts need this)
- `useAtticCache` - **MOVE to role flags** (universal default, VMs can override)

**Action**: Define as role-level options in `/home/rain/nix-config/roles/default.nix`

### Category H: Secret Categories (Move to SOPS module)
**Rationale**: SOPS-specific organization, belongs with SOPS config

- `secretCategories.{base, desktop, server, network, cli}` - **MOVE to** `sops.categories.*`

**Action**: Refactor to `/home/rain/nix-config/modules/common/sops.nix` with role-based defaults

## Migration Tasks

### Task 1: Create Replacement Module Options

**Purpose**: Establish new homes for migrated options before removing host.nix

**Actions**:

1. **Create `/home/rain/nix-config/modules/common/platform.nix`**:
   ```nix
   options.system = {
     architecture = lib.mkOption {
       type = lib.types.str;
       description = "System architecture (x86_64-linux, aarch64-linux, etc.)";
     };
     nixpkgsVariant = lib.mkOption {
       type = lib.types.enum [ "stable" "unstable" ];
       default = "stable";
       description = "Which nixpkgs input to use";
     };
     useCustomPkgs = lib.mkOption {
       type = lib.types.bool;
       default = config.system.nixpkgsVariant != "stable";
       description = "Whether to use alternate nixpkgs";
     };
     isDarwin = lib.mkOption {
       type = lib.types.bool;
       default = false;
       description = "Darwin platform flag";
     };
   };
   ```

2. **Create `/home/rain/nix-config/modules/common/hardware.nix`**:
   ```nix
   options.hardware.host = {
     wifi = lib.mkOption {
       type = lib.types.bool;
       default = false;
       description = "Hardware has wifi capability";
     };
     persistFolder = lib.mkOption {
       type = lib.types.str;
       default = "";
       description = "Impermanence persist folder path";
     };
     encryption.tpm = { ... }; # Move from host.nix
   };
   ```

3. **Extend `/home/rain/nix-config/modules/theming/stylix.nix`**:
   - Already has `theme`, `wallpaper` options - just need to update consumers

4. **Create `/home/rain/nix-config/modules/apps/xdg.nix`** (or extend existing):
   ```nix
   options.myModules.apps.xdg = {
     defaultBrowser = lib.mkOption {
       type = lib.types.str;
       default = "firefox";
       description = "Default web browser";
     };
     defaultEditor = lib.mkOption {
       type = lib.types.str;
       default = "nvim";
       description = "Default text editor";
     };
     defaultDesktop = lib.mkOption {
       type = lib.types.str;
       default = "Hyprland";
       description = "Default desktop session";
     };
   };
   ```

5. **Update `/home/rain/nix-config/modules/common/sops.nix`**:
   ```nix
   options.sops.categories = {
     base = lib.mkOption { type = lib.types.bool; default = true; };
     desktop = lib.mkOption { type = lib.types.bool; default = false; };
     server = lib.mkOption { type = lib.types.bool; default = false; };
     network = lib.mkOption { type = lib.types.bool; default = false; };
     cli = lib.mkOption { type = lib.types.bool; default = false; };
   };
   ```

**Verification**:
```bash
# Verify new modules load
nix eval .#nixosConfigurations.griefling.options.system.architecture
nix eval .#nixosConfigurations.griefling.options.hardware.host
nix eval .#nixosConfigurations.griefling.options.myModules.apps.xdg
```

**Success Criteria**:
- All replacement modules created and importable
- New options have proper types and defaults
- No build errors

### Task 2: Update Roles to Use New Options

**Purpose**: Migrate role-level defaults to new option locations

**Actions**:

1. **Update `/home/rain/nix-config/roles/form-desktop.nix`**:
   ```nix
   # OLD:
   host = {
     architecture = lib.mkDefault "x86_64-linux";
     wifi = lib.mkDefault false;
     secretCategories.desktop = lib.mkDefault true;
   };

   # NEW:
   system.architecture = lib.mkDefault "x86_64-linux";
   hardware.host.wifi = lib.mkDefault false;
   sops.categories.desktop = lib.mkDefault true;
   ```

2. **Update all form-* role files** similarly (vm, laptop, server, pi, tablet, darwin)

3. **Update `/home/rain/nix-config/roles/common.nix`**:
   ```nix
   # Move identity defaults if not already in universal.nix
   identity = {
     primaryUsername = lib.mkDefault "rain";
     handle = lib.mkDefault "fullstopslash";
   };
   ```

**Verification**:
```bash
# Verify roles apply correctly
nix eval .#nixosConfigurations.griefling.config.system.architecture
nix eval .#nixosConfigurations.griefling.config.sops.categories.desktop
```

**Success Criteria**:
- All roles updated to use new option paths
- Role defaults apply correctly
- No references to old `host.*` options in roles

### Task 3: Update Module Consumers

**Purpose**: Update all modules that reference `config.host.*` to use new locations

**Actions**:

1. **Update `/home/rain/nix-config/modules/users/default.nix`**:
   ```nix
   # OLD: config.host.primaryUsername, config.host.users, config.host.hasSecrets
   # NEW: config.identity.primaryUsername, config.identity.users, config.sops.enable
   ```

2. **Update `/home/rain/nix-config/modules/services/networking/ssh.nix`**:
   ```nix
   # OLD: config.host.useYubikey, config.host.hasSecrets, config.host.isWork
   # NEW: config.myModules.services.security.yubikey.enable, config.sops.enable,
   #      config.myModules.services.networking.ssh.workMode
   ```

3. **Update `/home/rain/nix-config/modules/disks/luks-tpm-unlock.nix`**:
   ```nix
   # OLD: config.host.encryption.tpm, config.host.persistFolder, config.host.hasSecrets
   # NEW: config.hardware.host.encryption.tpm, config.hardware.host.persistFolder, config.sops.enable
   ```

4. **Update `/home/rain/nix-config/modules/services/desktop/common.nix`**:
   ```nix
   # OLD: config.host.secretCategories.desktop
   # NEW: config.sops.categories.desktop
   ```

5. **Update `/home/rain/nix-config/home-manager/xdg.nix`**:
   ```nix
   # OLD: config.host.defaultBrowser, config.host.defaultEditor
   # NEW: config.myModules.apps.xdg.defaultBrowser, config.myModules.apps.xdg.defaultEditor
   ```

6. **Eliminate derived option consumers** - Update to check modules.* directly:
   ```nix
   # OLD: config.host.isMinimal
   # NEW: (config.modules.apps.desktop == [] && config.modules.apps.window-managers == [])

   # OLD: config.host.useWayland
   # NEW: (builtins.elem "hyprland" config.modules.apps.window-managers || ...)
   ```

**Verification**:
```bash
# Search for remaining host.* references
grep -r "config\.host\." modules/ --include="*.nix" | grep -v "host.nix"

# Build test all hosts
nix build .#nixosConfigurations.griefling.config.system.build.toplevel --dry-run
nix build .#nixosConfigurations.sorrow.config.system.build.toplevel --dry-run
```

**Success Criteria**:
- All module consumers updated
- No references to `config.host.*` outside of host.nix itself
- All test builds succeed

### Task 4: Update Host Configurations

**Purpose**: Update host default.nix files to use new option paths

**Actions**:

1. **Update identity in hosts** (already mostly correct):
   ```nix
   # /home/rain/nix-config/hosts/griefling/default.nix
   identity = {  # Was: host = {
     hostName = "griefling";
     primaryUsername = "rain";
   };
   ```

2. **Update hardware in hosts**:
   ```nix
   # /home/rain/nix-config/hosts/sorrow/default.nix
   hardware.host = {  # Was: host = {
     persistFolder = "/persist";
     encryption.tpm.enable = true;
   };
   ```

3. **Remove preference overrides** (should be in modules):
   ```nix
   # DELETE from hosts - belongs in module configs:
   # host.theme = "dracula";
   # host.wallpaper = ...;

   # REPLACE with:
   myModules.theming.stylix.theme = "dracula";
   myModules.theming.stylix.wallpaper = ...;
   ```

**Verification**:
```bash
# Verify host configs are minimal
wc -l hosts/*/default.nix  # Should be ~30-50 lines each

# Verify no old host.* options
grep "host\." hosts/*/default.nix
```

**Success Criteria**:
- All hosts use new option paths
- Host files remain minimal (~40 lines)
- No deprecated `host.*` options in hosts

### Task 5: Remove host.nix and Update Imports

**Purpose**: Delete the file and clean up import paths

**Actions**:

1. **Verify zero references**:
   ```bash
   # Should return ONLY the host.nix file itself
   grep -r "config\.host\." --include="*.nix"
   grep -r "options\.host\." --include="*.nix"
   ```

2. **Remove file**:
   ```bash
   git rm modules/common/host.nix
   ```

3. **Update imports** if `modules/common/default.nix` explicitly imported it:
   ```nix
   # /home/rain/nix-config/modules/common/default.nix
   # Remove ./host.nix from imports if present
   ```

4. **Add new module imports**:
   ```nix
   # /home/rain/nix-config/modules/common/default.nix
   imports = [
     ./platform.nix
     ./hardware.nix
     ./identity.nix  # If created separately
     # ... existing imports
   ];
   ```

**Verification**:
```bash
# Build all hosts to verify nothing broke
nix flake check
```

**Success Criteria**:
- `host.nix` deleted
- All imports updated
- All builds succeed
- No runtime errors

### Task 6: Update Documentation and Templates

**Purpose**: Update templates and documentation to reflect new architecture

**Actions**:

1. **Update `/home/rain/nix-config/hosts/TEMPLATE.nix`** (if exists):
   ```nix
   # Show new option structure
   identity = { hostName = "..."; primaryUsername = "..."; };
   hardware.host = { wifi = true; };
   system.architecture = "x86_64-linux";
   ```

2. **Update README.md** if it documents host options

3. **Update any architecture documentation**

**Verification**:
- Documentation accurately reflects new structure
- Templates use new option paths

**Success Criteria**:
- All docs updated
- Templates show best practices
- No references to deprecated `host.*` namespace

## Verification Checklist

Before declaring phase complete:

- [ ] All replacement modules created and tested
- [ ] All roles updated to new option paths
- [ ] All module consumers updated
- [ ] All hosts updated and building successfully
- [ ] `host.nix` deleted
- [ ] Zero references to `config.host.*` namespace in codebase
- [ ] All hosts build successfully: `nix flake check`
- [ ] Documentation updated
- [ ] Host configurations remain minimal (< 50 lines)

## Success Criteria

**Functional**:
- All NixOS configurations build without errors
- All hosts boot successfully
- All features work identically to before refactor

**Architectural**:
- Proper separation: identity in universal, hardware in hardware module, preferences in specific modules
- No derived anti-patterns (modules check `modules.*` directly)
- Role concerns properly encapsulated in roles
- Host files minimal (identity + hardware facts only)

**Code Quality**:
- Zero references to deprecated `host.*` namespace
- All options properly typed with descriptions
- Clear documentation of new architecture

## Rollback Plan

If issues arise during migration:

1. **Incremental Migration**: Migrate one category at a time, keeping host.nix until all consumers updated
2. **Compatibility Shim**: Temporarily keep host.nix with options that alias to new locations:
   ```nix
   # Temporary backwards compatibility
   options.host.wifi = lib.mkOption {
     default = config.hardware.host.wifi;
     description = "DEPRECATED: Use hardware.host.wifi";
   };
   ```
3. **Gradual Deprecation**: Mark old options as deprecated, warn on use, remove after 1-2 release cycles

## Risk Assessment

**High Risk**:
- Identity options (`primaryUsername`, `users`) - Used in 21+ files
  - Mitigation: Thorough testing, incremental migration, compatibility aliases

**Medium Risk**:
- Platform options (`architecture`, `nixpkgsVariant`) - Used in flake and roles
  - Mitigation: Update flake.nix alongside roles

**Low Risk**:
- Derived options - Consumers already have access to underlying `modules.*`
- Preferences - Used in 1-2 files each, easy to update
- Secret categories - Used in 1 file

## Timeline Estimate

- Task 1 (Create modules): 2-3 hours
- Task 2 (Update roles): 1-2 hours
- Task 3 (Update consumers): 3-4 hours (most time-consuming)
- Task 4 (Update hosts): 1 hour
- Task 5 (Remove host.nix): 30 minutes
- Task 6 (Documentation): 1 hour

**Total**: 8-11 hours of focused work

## Dependencies

**Blocks**: No known dependencies

**Blocked By**: None - this refactor is self-contained

**Related Phases**:
- Phase 12: Unified module selection (provides `modules.*` to replace derived options)
- Phase 21: Architecture elegance refactor (similar goals, different scope)

## Critical Files

1. `/home/rain/nix-config/modules/common/host.nix` (385 lines) - File to eliminate
2. `/home/rain/nix-config/modules/common/universal.nix` (117 lines) - Identity consolidation target
3. `/home/rain/nix-config/modules/users/default.nix` (88 lines) - Heavy identity consumer
4. `/home/rain/nix-config/roles/form-desktop.nix` (99 lines) - Representative role
5. `/home/rain/nix-config/modules/theming/stylix.nix` (166 lines) - Preference migration target
