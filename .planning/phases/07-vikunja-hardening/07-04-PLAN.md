---
phase: 07-vikunja-hardening
plan: 04
type: execute
---

<objective>
Harden Python sync scripts with proper annotations, file locking, and user-specific paths.

Purpose: The vikunja-direct Python scripts can create duplicate tasks when run concurrently, and title-match updates don't annotate the vikunja_id back to TaskWarrior. Log paths are hardcoded to /tmp.
Output: Robust Python scripts with file locking, vikunja_id annotations, and user-specific log paths.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@pkgs/vikunja-sync/vikunja-direct.py
@pkgs/vikunja-sync/vikunja_common.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add file locking to prevent duplicate task creation</name>
  <files>pkgs/vikunja-sync/vikunja-direct.py</files>
  <action>
  Add flock-based locking to the `hook` command to prevent concurrent executions from creating duplicate tasks.

  Use Python's `fcntl.flock()` for POSIX-compatible locking:

  ```python
  import fcntl
  import os

  def acquire_lock():
      """Acquire exclusive lock for sync operations."""
      lock_dir = os.environ.get('XDG_RUNTIME_DIR', f'/run/user/{os.getuid()}')
      lock_file = os.path.join(lock_dir, 'vikunja-direct.lock')
      lock_fd = open(lock_file, 'w')
      try:
          fcntl.flock(lock_fd, fcntl.LOCK_EX | fcntl.LOCK_NB)
          return lock_fd
      except BlockingIOError:
          return None  # Another process has the lock
  ```

  In the hook command:
  1. Try to acquire lock at start
  2. If lock unavailable, queue the UUID for retry and exit
  3. Release lock when done (automatic on file close)

  This prevents:
  - Duplicate task creation from rapid consecutive hook calls
  - Race conditions between webhook and hook processing
  </action>
  <verify>Test by running two hook commands simultaneously; verify only one creates the task</verify>
  <done>Hook command uses file locking to serialize sync operations</done>
</task>

<task type="auto">
  <name>Task 2: Add vikunja_id annotation on title-match updates</name>
  <files>pkgs/vikunja-sync/vikunja-direct.py</files>
  <action>
  When a task is matched by title (no existing vikunja_id), the script should annotate the TaskWarrior task with the Vikunja ID after successful sync.

  Current behavior: Task syncs to Vikunja but TW task never gets the vikunja_id UDA.

  Fix: After successful creation or title-match in Vikunja, call:
  ```python
  def annotate_vikunja_id(tw_uuid: str, vikunja_id: int):
      """Add vikunja_id UDA to TaskWarrior task."""
      import subprocess
      # Set VIKUNJA_SYNC_RUNNING to prevent hook recursion
      env = os.environ.copy()
      env['VIKUNJA_SYNC_RUNNING'] = '1'
      subprocess.run(
          ['task', tw_uuid, 'modify', f'vikunja_id:{vikunja_id}'],
          env=env,
          check=True,
          capture_output=True
      )
  ```

  Apply this:
  1. After creating new task in Vikunja (get ID from response)
  2. After finding existing task by title match

  This ensures:
  - Future syncs use direct ID lookup (faster)
  - Bidirectional sync works correctly
  - No orphaned tasks without vikunja_id
  </action>
  <verify>Create task in TW without vikunja_id, sync, verify vikunja_id UDA is set</verify>
  <done>Title-matched tasks get vikunja_id annotated back to TaskWarrior</done>
</task>

<task type="auto">
  <name>Task 3: Use user-specific log paths</name>
  <files>pkgs/vikunja-sync/vikunja-direct.py, pkgs/vikunja-sync/vikunja_common.py</files>
  <action>
  Change hardcoded `/tmp/vikunja-direct.log` to user-specific location.

  In vikunja_common.py or vikunja-direct.py, add log path resolution:

  ```python
  def get_log_path() -> str:
      """Get user-specific log path."""
      home = os.environ.get('HOME', os.path.expanduser('~'))
      state_dir = os.path.join(home, '.local', 'state', 'vikunja-sync')
      os.makedirs(state_dir, exist_ok=True)
      return os.path.join(state_dir, 'direct.log')
  ```

  Update all logging to use this path:
  - Main script logging
  - Error logging
  - Debug output

  Benefits:
  - Multi-user safety
  - Proper permissions (not world-readable)
  - Consistent with XDG Base Directory spec
  - Matches the queue file location from 07-01

  Also update any references in vikunja-sync.nix hook scripts that write to /tmp/vikunja-direct.log.
  </action>
  <verify>Run vikunja-direct, verify log written to ~/.local/state/vikunja-sync/direct.log</verify>
  <done>All logs written to user-specific state directory</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Python scripts have file locking via fcntl.flock()
- [ ] Title-matched tasks get vikunja_id annotated
- [ ] Log path is ~/.local/state/vikunja-sync/direct.log
- [ ] No /tmp/ references remain in Python scripts
- [ ] All scripts still pass syntax check (`python -m py_compile`)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Concurrent hook calls don't create duplicates
- vikunja_id is always set after sync
- Logs are in user-specific directory
</success_criteria>

<output>
After completion, create `.planning/phases/07-vikunja-hardening/07-04-SUMMARY.md`
</output>
