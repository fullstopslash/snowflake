---
phase: 07-vikunja-hardening
plan: 03
type: execute
---

<objective>
Improve webhook service resilience with proper payload handling and timeouts.

Purpose: Currently, webhook payloads are deleted via ExecStartPost before the user service can retry on failure. Services lack timeouts, allowing hung processes. Concurrent webhooks can create duplicate tasks.
Output: Resilient webhook handling with payload queueing, service timeouts, and concurrency protection.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@roles/vikunja-webhook.nix
@roles/vikunja-sync.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix webhook payload loss on processing failure</name>
  <files>roles/vikunja-webhook.nix</files>
  <action>
  Current issue (line ~270-271):
  ```nix
  ExecStart = "${vikunjaDirectPkg}/bin/vikunja-direct webhook ${queueDir}/%i";
  ExecStartPost = "${pkgs.coreutils}/bin/rm -f ${queueDir}/%i";
  ```

  The payload is deleted even if ExecStart fails. Fix by:

  1. Remove ExecStartPost entirely
  2. Move deletion INTO the vikunja-direct webhook handler (only after successful processing)
  3. OR use ExecStopPost with ConditionResult=success

  Recommended approach - move deletion to success path:
  ```nix
  ExecStart = "${pkgs.bash}/bin/bash -c '${vikunjaDirectPkg}/bin/vikunja-direct webhook ${queueDir}/%i && rm -f ${queueDir}/%i'";
  ```

  This ensures:
  - Payload preserved on failure for debugging/retry
  - Only deleted after successful processing
  - Failed payloads can be manually reprocessed
  </action>
  <verify>Trigger a webhook, kill the service mid-processing, verify payload file still exists</verify>
  <done>Webhook payloads only deleted after successful processing</done>
</task>

<task type="auto">
  <name>Task 2: Add service timeouts to prevent hung processes</name>
  <files>roles/vikunja-webhook.nix, roles/vikunja-sync.nix</files>
  <action>
  Add timeouts to all oneshot services that make network calls:

  In vikunja-webhook.nix, `vikunja-webhook-process@` service:
  ```nix
  serviceConfig = {
    Type = "oneshot";
    TimeoutStartSec = 60;  # Add this
    # ...
  };
  ```

  In vikunja-sync.nix, add to these services:
  - `vikunja-sync` (if enableReconciliation)
  - `vikunja-reconcile`
  - `vikunja-sync-project`
  - `vikunja-sync-retry`

  Use 60 seconds for webhook processing, 300 seconds (5 min) for full sync operations.

  This prevents:
  - Hung API calls blocking the service indefinitely
  - Accumulation of stuck processes
  - systemd showing service as "activating" forever
  </action>
  <verify>Check generated service files include TimeoutStartSec; `systemctl show vikunja-webhook-process@test --property=TimeoutStartUSec`</verify>
  <done>All network-calling services have appropriate timeouts</done>
</task>

<task type="auto">
  <name>Task 3: Add timeout wrapper to background hook processes</name>
  <files>roles/vikunja-sync.nix</files>
  <action>
  The setsid background processes in hooks have no timeout:
  ```sh
  setsid sh -c '
    ...
    echo "$1" | "$3" hook >> ...
    ...
  ' _ ...
  ```

  Add timeout wrapper using coreutils timeout:
  ```sh
  setsid sh -c '
    ...
    timeout 30 sh -c "echo \"\$1\" | \"\$2\" hook" _ "$1" "$2" >> ...
    ...
  ' _ ...
  ```

  Apply to both on-add-vikunja and on-modify-vikunja hooks.

  Use 30 seconds for individual task sync (should complete in <5s normally).

  This prevents:
  - Orphaned background processes accumulating
  - Individual hung syncs blocking the queue
  - Resource exhaustion from stuck processes
  </action>
  <verify>Inspect generated hook scripts for `timeout 30` wrapper around vikunja-direct calls</verify>
  <done>All background sync processes have 30-second timeout</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `nix eval` on both modules succeeds
- [ ] vikunja-webhook-process@ service has TimeoutStartSec = 60
- [ ] All sync services have appropriate TimeoutStartSec
- [ ] Hook background processes wrapped with `timeout 30`
- [ ] Webhook payload deletion is conditional on success
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No payload loss on webhook processing failure
- All services have defined timeouts
- Background processes cannot hang indefinitely
</success_criteria>

<output>
After completion, create `.planning/phases/07-vikunja-hardening/07-03-SUMMARY.md`
</output>
