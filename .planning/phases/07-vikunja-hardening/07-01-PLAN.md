---
phase: 07-vikunja-hardening
plan: 01
type: execute
---

<objective>
Harden the queue file handling to prevent race conditions and data loss.

Purpose: The retry queue file (`/tmp/vikunja-sync-queue.txt`) has critical race conditions where concurrent writes can corrupt data or lose UUIDs. Additionally, `processQueueScript` uses bash syntax but runs under `/bin/sh`.
Output: Race-free queue operations with proper file locking, POSIX-compliant scripts, and user-specific paths.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@roles/vikunja-sync.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add flock-based locking to processQueueScript</name>
  <files>roles/vikunja-sync.nix</files>
  <action>
  Modify `processQueueScript` (around line 22-41) to use flock for atomic queue access:

  1. Create a lock file at `/run/user/$(id -u)/vikunja-sync-queue.lock`
  2. Use `flock -n 9` to acquire exclusive lock (non-blocking, skip if locked)
  3. Wrap the entire queue processing in the lock
  4. Use `pkgs.util-linux` for flock (add to script dependencies)

  The lock prevents:
  - Multiple retry processors running simultaneously
  - Hooks writing while processor is reading/deleting

  Pattern:
  ```sh
  LOCK_FILE="/run/user/$(id -u)/vikunja-sync-queue.lock"
  exec 9>"$LOCK_FILE"
  flock -n 9 || exit 0  # Another process has lock, skip
  # ... process queue ...
  ```
  </action>
  <verify>Run `flock --version` to confirm util-linux available; inspect generated script</verify>
  <done>processQueueScript uses flock for exclusive access, skips gracefully if locked</done>
</task>

<task type="auto">
  <name>Task 2: Convert processQueueScript to POSIX shell</name>
  <files>roles/vikunja-sync.nix</files>
  <action>
  The script uses bash-specific `[[ ]]` syntax but `writeShellScript` produces `/bin/sh` shebang.

  Convert all bash-isms to POSIX:
  - `[[ ! -f "$QUEUE_FILE" ]]` → `[ ! -f "$QUEUE_FILE" ]`
  - `[[ ! -s "$QUEUE_FILE" ]]` → `[ ! -s "$QUEUE_FILE" ]`
  - `[[ -z "$uuid" ]]` → `[ -z "$uuid" ]`
  - `[[ -n "$uuid" ]]` → `[ -n "$uuid" ]`

  Also ensure the shebang is explicit: use `pkgs.writeShellScript` with POSIX-only constructs.
  </action>
  <verify>Run `shellcheck` on the generated script or manually verify no `[[ ]]` remains</verify>
  <done>Script is fully POSIX-compliant, no bash-specific syntax</done>
</task>

<task type="auto">
  <name>Task 3: Use user-specific queue and log paths</name>
  <files>roles/vikunja-sync.nix</files>
  <action>
  Change hardcoded `/tmp/` paths to user-specific locations:

  1. Queue file: `/run/user/$(id -u)/vikunja-sync-queue.txt` or `${homeDir}/.local/state/vikunja-sync/queue.txt`
  2. Log file: `${homeDir}/.local/state/vikunja-sync/direct.log`
  3. Lock file: `/run/user/$(id -u)/vikunja-sync.lock`

  Benefits:
  - Multi-user safety (no collision)
  - Proper permissions (not world-readable)
  - Survives /tmp cleanup on some systems

  Add `systemd.tmpfiles.rules` to create the state directory:
  ```nix
  "d ${homeDir}/.local/state/vikunja-sync 0750 ${username} users -"
  ```

  Update ALL references to these paths:
  - processQueueScript
  - on-add-vikunja hook
  - on-modify-vikunja hook
  - Network dispatcher script
  </action>
  <verify>Check generated scripts use user-specific paths; verify tmpfiles rule creates directory on rebuild</verify>
  <done>All queue/log paths are user-specific, directory created via tmpfiles</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `nix eval` on the module succeeds (no syntax errors)
- [ ] Generated processQueueScript contains `flock` call
- [ ] No `[[ ]]` syntax in any generated scripts
- [ ] Paths reference user-specific locations, not `/tmp/`
- [ ] tmpfiles rule present for state directory
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Race condition in queue file eliminated via flock
- Scripts are POSIX-compliant
- Paths are user-specific and secure
</success_criteria>

<output>
After completion, create `.planning/phases/07-vikunja-hardening/07-01-SUMMARY.md`
</output>
