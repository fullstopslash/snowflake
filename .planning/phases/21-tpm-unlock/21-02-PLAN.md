---
phase: 21-tpm-unlock
type: execute
---

<objective>
Implement TPM2 automatic unlock for bcachefs native encryption using nixpkgs bcachefs.nix patterns and Clevis, tested on new VM "anguish".

Purpose: Unblock Phase 21 by leveraging the working bcachefs.nix module implementation from nixpkgs (verified working at FOSDEM 2024). Apply the 3 critical fixes identified in research to align with production-ready patterns.

Output: Working bcachefs native encryption with TPM auto-unlock on "anguish" VM, with fallback to manual password, ready for deployment to other hosts.
</objective>

<execution_context>
@~/.claude/plugins/cache/taches-cc-resources/taches-cc-resources/1.0.0/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/cache/taches-cc-resources/taches-cc-resources/1.0.0/skills/create-plans/templates/summary.md
@~/.claude/plugins/cache/taches-cc-resources/taches-cc-resources/1.0.0/skills/create-plans/references/checkpoints.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/20-bcachefs-native-encryption/20-01-FINDINGS.md
@modules/disks/bcachefs-unlock.nix
@modules/disks/default.nix
@modules/common/host.nix
@hosts/sorrow/default.nix
@justfile

Research findings: Two agents completed comprehensive analysis showing:
1. nixpkgs bcachefs.nix has working Clevis TPM integration
2. FOSDEM 2024 demonstrated production-ready implementation
3. Three fixes needed: tpm_crb module, boot.initrd.systemd.contents, pre-install token generation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create anguish VM host configuration</name>
  <files>hosts/anguish/default.nix, hosts/anguish/hardware-configuration.nix</files>
  <action>
Create new VM host "anguish" for testing bcachefs native encryption + TPM:

1. Create directory: mkdir -p hosts/anguish

2. Create hosts/anguish/default.nix with:
   - Host name: anguish
   - Primary username: rain
   - Roles: ["vmHeadless", "test"]
   - Disk layout: "bcachefs-encrypt-impermanence" (native encryption)
   - Device: /dev/vda
   - Persist folder: /persist
   - TPM enabled: host.encryption.tpm.enable = true
   - TPM PCRs: "0+7" (boot components + Secure Boot state)

3. Create minimal hardware-configuration.nix:
   - Boot loader: systemd-boot
   - Kernel modules for VM + TPM
   - Import from ../common if patterns exist

4. Add anguish to flake.nix outputs (nixosConfigurations.anguish)

5. Update justfile VM_SSH_PORTS map:
   - Add: ["anguish"]="22225"

Follow the pattern from sorrow/griefling but use bcachefs-encrypt layout instead of LUKS.
  </action>
  <verify>
nix flake check passes (anguish evaluates without errors)
nix build .#nixosConfigurations.anguish.config.system.build.toplevel succeeds
Configuration uses bcachefs-encrypt-impermanence layout
host.encryption.tpm.enable = true
  </verify>
  <done>
- hosts/anguish/ directory created
- Configuration uses native bcachefs encryption
- TPM enabled via hostSpec
- Evaluates and builds successfully
- Registered in flake.nix and justfile
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply nixpkgs patterns to bcachefs-unlock.nix</name>
  <files>modules/disks/bcachefs-unlock.nix</files>
  <action>
Fix the three critical issues identified in research to align with nixpkgs bcachefs.nix:

**Fix 1: Add TPM kernel module**
In boot.initrd.availableKernelModules (around line 76-95), add:
```nix
boot.initrd.availableKernelModules = [
  "bcachefs"
  "sha256"
  "tpm_crb"  # Critical for TPM support - was missing
];
```

**Fix 2: Use boot.initrd.systemd.contents instead of boot.initrd.secrets**
Replace the boot.initrd.secrets block (lines 255-262) with:
```nix
boot.initrd.systemd.contents = lib.mkIf (tpmEnabled && builtins.pathExists clevisTokenPersist) {
  "${clevisTokenInitrd}".source = clevisTokenPersist;
};
```

This avoids the evaluation-time path existence check that broke boot.initrd.secrets.

**Fix 3: Disable auto-enrollment service**
The bcachefs-tpm-auto-enroll service (lines 287-361) has a chicken-and-egg problem:
- Token must exist BEFORE first boot for initrd to include it
- Service generates token AFTER first boot

Comment out or wrap the entire service in:
```nix
# NOTE: Auto-enrollment disabled - token must be generated during installation
# See justfile: bcachefs-setup-tpm command for manual token generation
# systemd.services.bcachefs-tpm-auto-enroll = lib.mkIf false {
```

Keep the service code for reference but disable it. Token generation will happen during installation instead.

**Verify unlock script logic** (lines 80-104):
- Ensure keyctl link @u @s is called first (correct)
- Clevis decrypt pipeline looks good
- Fallback to interactive prompt is correct
- No changes needed here
  </action>
  <verify>
nix flake check passes
Build anguish: nix build .#nixosConfigurations.anguish.config.system.build.toplevel
Check initrd includes tpm_crb: nix eval .#nixosConfigurations.anguish.config.boot.initrd.availableKernelModules | grep tpm_crb
Verify boot.initrd.systemd.contents used instead of boot.initrd.secrets
Auto-enrollment service disabled
  </verify>
  <done>
- tpm_crb kernel module added to initrd
- boot.initrd.systemd.contents replaces boot.initrd.secrets
- Auto-enrollment service disabled with explanation
- Unlock script logic verified correct
- Configuration builds without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Update justfile bcachefs-setup-tpm for pre-install token generation</name>
  <files>justfile</files>
  <action>
The bcachefs-setup-tpm recipe (lines 709-764) currently expects to run on a booted system. Update it to support running during installation (before first boot):

Add a new parameter to support running from installer context:

```bash
# Generate TPM token for bcachefs encryption (installation or post-boot)
# Usage:
#   just bcachefs-setup-tpm HOST        # Post-boot (on running system)
#   just bcachefs-setup-tpm HOST /mnt   # During install (from installer)
bcachefs-setup-tpm HOST MOUNT_ROOT="":
    #!/usr/bin/env bash
    set -euo pipefail

    # Determine if running during install or on live system
    if [ -n "{{MOUNT_ROOT}}" ]; then
        echo "ðŸ” Generating TPM token during installation (mount root: {{MOUNT_ROOT}})"
        PERSIST_FOLDER="{{MOUNT_ROOT}}/persist"
        IS_INSTALL=true
    else
        echo "ðŸ” Generating TPM token on running system"
        PERSIST_FOLDER=$(nix eval --raw .#nixosConfigurations.{{HOST}}.config.host.persistFolder 2>/dev/null)
        IS_INSTALL=false
    fi

    # [rest of existing logic, adjusted for PERSIST_FOLDER]
    # Use sops exec-env to get password
    # Generate token: echo "$DISK_PASSWORD" | clevis encrypt tpm2 '{"pcr_ids":"{{PCR_IDS}}"}' > "$TOKEN_FILE"
    # Set permissions: chmod 600, chown root:root
```

This allows calling it during nixos-anywhere installation AND on a running system.

Update the vm-fresh recipe to call bcachefs-setup-tpm after installation but before first boot for anguish.
  </action>
  <verify>
Recipe accepts both invocation patterns
Can be called during installation: just bcachefs-setup-tpm anguish /mnt
Can be called post-boot: just bcachefs-setup-tpm anguish
Recipe uses correct path based on invocation context
  </verify>
  <done>
- bcachefs-setup-tpm updated to support installation context
- Dual-mode operation (install vs post-boot) working
- Documentation updated with both usage patterns
  </done>
</task>

<task type="auto">
  <name>Task 4: Fresh install anguish VM with TPM emulation</name>
  <files>quickemu/anguish-test.qcow2, quickemu/anguish-tpm/</files>
  <action>
Deploy anguish VM with bcachefs native encryption and TPM emulation:

1. Ensure vm-start recipe includes TPM emulation for anguish (should already be there from sorrow pattern)

2. Start fresh VM creation:
   ```bash
   just vm-fresh anguish
   ```

3. The vm-fresh recipe should:
   - Generate SSH host key locally
   - Derive age key from SSH key
   - Register age key in nix-secrets
   - Rekey all secrets
   - Update nix-secrets flake input
   - Run nixos-anywhere with bcachefs-encrypt layout
   - **NEW**: Generate Clevis TPM token during installation:
     ```bash
     # After nixos-anywhere mounts /mnt but before reboot
     sops exec-env shared.yaml 'echo $DISK_PASSWORD | ssh root@anguish-installer "clevis encrypt tpm2 '{\"pcr_ids\":\"7\"}'" > /mnt/persist/etc/clevis/bcachefs-root.jwe'
     chmod 600 /mnt/persist/etc/clevis/bcachefs-root.jwe
     ```

4. Monitor installation for:
   - Successful disk formatting with bcachefs encryption
   - Age key registration
   - Token generation
   - First boot completion

If vm-fresh doesn't yet generate token during install, do it manually:
- Wait for first boot (will require manual password)
- SSH to anguish
- Run: just bcachefs-setup-tpm anguish
- Rebuild and reboot

The goal is to get the token in place BEFORE the first automated reboot.
  </action>
  <verify>
VM boots to password prompt (expected on first boot without token)
After token generated, VM reboots automatically without password prompt
TPM emulation working: ls quickemu/anguish-tpm/
Token exists: ssh -p 22225 rain@127.0.0.1 'ls -la /persist/etc/clevis/bcachefs-root.jwe'
  </verify>
  <done>
- anguish VM installed with bcachefs native encryption
- TPM emulator initialized
- Clevis token generated and placed in /persist/etc/clevis/
- First manual boot completed (password entered)
- Token in place for automatic unlock testing
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Fresh anguish VM with bcachefs native encryption, TPM emulation, and Clevis token in place.

Installation process:
- Used bcachefs-encrypt-impermanence layout
- Generated age key and registered in nix-secrets
- Created TPM token (either during install or on first boot)
- Token stored in /persist/etc/clevis/bcachefs-root.jwe

Ready for automatic unlock testing.
  </what-built>
  <how-to-verify>
1. Check VM is accessible: ssh -p 22225 rain@127.0.0.1

2. Verify token exists and has correct permissions:
   ```bash
   ssh -p 22225 rain@127.0.0.1 'ls -la /persist/etc/clevis/bcachefs-root.jwe'
   # Should show: -rw------- 1 root root [size] [date] bcachefs-root.jwe
   ```

3. Verify token is valid JWE:
   ```bash
   ssh -p 22225 rain@127.0.0.1 'sudo cat /persist/etc/clevis/bcachefs-root.jwe | jq .'
   # Should parse as JSON
   ```

4. Check TPM emulator running:
   ```bash
   ls quickemu/anguish-tpm/
   # Should show tpm2-*.dat files
   ```

5. Verify system booted with bcachefs encryption:
   ```bash
   ssh -p 22225 rain@127.0.0.1 'mount | grep bcachefs'
   # Should show encrypted bcachefs mounts
   ```
  </how-to-verify>
  <resume-signal>Type "ready" when VM is installed and verified, or describe issues</resume-signal>
</task>

<task type="auto">
  <name>Task 5: Test automatic TPM unlock</name>
  <files>None (testing task)</files>
  <action>
Test that TPM automatic unlock works on anguish:

1. Rebuild anguish to include updated initrd with token:
   ```bash
   ssh -p 22225 rain@127.0.0.1 'cd ~/nix-config && git pull && nh os boot'
   ```

2. Reboot the VM:
   ```bash
   ssh -p 22225 rain@127.0.0.1 'sudo reboot'
   ```

3. Watch the boot process (via quickemu SDL window or serial console):
   - Should NOT see password prompt
   - Should see bcachefs unlock messages
   - Should boot directly to login

4. Wait for SSH to become available again (30-60 seconds)

5. Verify successful automatic unlock:
   ```bash
   ssh -p 22225 rain@127.0.0.1 'journalctl -b | grep -i "bcachefs\|clevis\|tpm"'
   ```

Look for messages indicating:
- Clevis decrypt succeeded
- bcachefs unlock succeeded
- No password prompt
- Normal boot continuation

If automatic unlock fails:
- Note the error messages
- System should fall back to password prompt
- Enter password manually to continue boot
- Capture logs for debugging
  </action>
  <verify>
Success criteria:
- VM reboots without password prompt
- SSH becomes available without manual intervention
- journalctl shows successful Clevis TPM unlock
- No errors in systemd journal for unlock process
- System fully operational after automatic boot
  </verify>
  <done>
- Automatic TPM unlock verified working on anguish
- Boot completes without user intervention
- Logs show successful Clevis decrypt â†’ bcachefs unlock pipeline
- System accessible and functional after auto-unlock
  </done>
</task>

<task type="auto">
  <name>Task 6: Test fallback to manual password</name>
  <files>None (testing task)</files>
  <action>
Verify the fallback mechanism works when TPM is unavailable:

**Test 1: Remove token file**

1. SSH to anguish and backup the token:
   ```bash
   ssh -p 22225 rain@127.0.0.1 'sudo mv /persist/etc/clevis/bcachefs-root.jwe /persist/etc/clevis/bcachefs-root.jwe.bak'
   ```

2. Rebuild to update initrd without token:
   ```bash
   ssh -p 22225 rain@127.0.0.1 'sudo nixos-rebuild boot'
   ```

3. Reboot:
   ```bash
   ssh -p 22225 rain@127.0.0.1 'sudo reboot'
   ```

4. Observe boot (via SDL window):
   - Should prompt for disk password
   - Clevis should report token not found
   - Fallback to systemd-ask-password should engage

5. Enter password: "changeme" (or current SOPS password)

6. Verify system boots normally after manual unlock

7. Restore token:
   ```bash
   ssh -p 22225 rain@127.0.0.1 'sudo mv /persist/etc/clevis/bcachefs-root.jwe.bak /persist/etc/clevis/bcachefs-root.jwe'
   ```

**Test 2: Verify fallback logs**

Check journalctl for fallback behavior:
```bash
ssh -p 22225 rain@127.0.0.1 'journalctl -b | grep -A 5 -B 5 "clevis\|bcachefs unlock"'
```

Should show:
- Clevis decrypt attempt
- Clevis failure (token not found)
- Fallback to interactive prompt
- Successful unlock with manual password
  </action>
  <verify>
- Password prompt appears when token removed
- Manual password entry successfully unlocks filesystem
- System boots normally after manual unlock
- Fallback mechanism confirmed working
- No boot hangs or errors
- Logs show proper fallback behavior
  </verify>
  <done>
- Fallback to manual password verified working
- Token removal triggers interactive prompt
- System boots successfully with manual unlock
- Fallback mechanism reliable and user-friendly
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete TPM automatic unlock system for bcachefs native encryption, with verified fallback.

Components tested:
- Automatic TPM unlock (Clevis + TPM emulation)
- Fallback to interactive password prompt
- Token management (generation, placement, permissions)
- Integration with nixpkgs bcachefs.nix patterns

Both unlock paths (automatic and manual) verified working on anguish VM.
  </what-built>
  <how-to-verify>
Review test results from Tasks 5 and 6:

**Automatic unlock (Task 5):**
- [ ] VM reboots without password prompt
- [ ] System accessible via SSH after reboot
- [ ] journalctl shows successful Clevis decrypt
- [ ] No errors in unlock process

**Manual fallback (Task 6):**
- [ ] Token removal triggers password prompt
- [ ] Manual password successfully unlocks
- [ ] System boots normally with fallback
- [ ] Logs show proper fallback behavior

**Overall verification:**
- [ ] Both unlock methods work reliably
- [ ] No regressions in bcachefs functionality
- [ ] TPM emulation stable and repeatable
- [ ] Ready to document and commit

If any tests failed, describe the issues found.
  </how-to-verify>
  <resume-signal>Type "approved" if all tests passed, or describe issues</resume-signal>
</task>

<task type="auto">
  <name>Task 7: Update ROADMAP and commit changes</name>
  <files>.planning/ROADMAP.md, modules/disks/bcachefs-unlock.nix, hosts/anguish/, justfile</files>
  <action>
Update ROADMAP.md to mark Phase 21 complete:

1. Change Phase 21 status from **[BLOCKED]** to completed (checkbox marked)

2. Update Phase 21 description:
   ```markdown
   - [x] **Phase 21: TPM Unlock** - TPM2 automatic unlock for bcachefs with Clevis, manual fallback
   ```

3. Remove the **[BLOCKED]** marker and blocking issues section

4. Add note about solution:
   ```markdown
   ### Phase 21: TPM Unlock
   **Goal**: TPM2 automatic unlock for bcachefs native encryption using Clevis
   **Depends on**: Phase 20 (Bcachefs Native Encryption)
   **Status**: Complete (2 plans)

   Plans:
   - [ ] 21-01: Initial attempt (blocked by boot.initrd.secrets limitations)
   - [x] 21-02: Revised implementation using nixpkgs patterns (successful)

   **Solution**: Applied nixpkgs bcachefs.nix patterns:
   - Added tpm_crb kernel module for TPM support
   - Used boot.initrd.systemd.contents instead of boot.initrd.secrets
   - Generate token during installation (not post-boot)
   - Verified on anguish VM with TPM emulation
   ```

Commit all changes:
```bash
git add -A
git commit -m "feat(encryption): bcachefs TPM unlock using nixpkgs patterns

Unblock Phase 21 by implementing TPM automatic unlock using the working
patterns from nixpkgs bcachefs.nix module (verified at FOSDEM 2024).

Changes:
- Add tpm_crb kernel module to initrd (critical for TPM)
- Use boot.initrd.systemd.contents instead of boot.initrd.secrets
- Disable auto-enrollment service (token generated during install)
- Update bcachefs-setup-tpm for installation context
- Create anguish VM for testing bcachefs native encryption

Testing on anguish VM:
- Automatic TPM unlock: âœ“ working
- Manual fallback: âœ“ working
- Both unlock paths verified reliable

Phase 21-02 complete. Native encryption + TPM now production-ready.
"
```

Do NOT push yet (wait for final approval).
  </action>
  <verify>
- ROADMAP.md shows Phase 21 complete
- Blocking status removed
- git status shows all changes staged
- Commit message accurately describes changes
- Ready to push after final approval
  </verify>
  <done>
- ROADMAP.md updated to reflect Phase 21 completion
- All changes committed with detailed message
- Ready for final push
  </done>
</task>

<task type="auto">
  <name>Task 8: Create Phase 21-02 SUMMARY</name>
  <files>.planning/phases/21-tpm-unlock/21-02-SUMMARY.md</files>
  <action>
Create comprehensive SUMMARY.md documenting the successful implementation:

```markdown
# Phase 21 Plan 2: TPM Unlock Summary

**Unblocked Phase 21 using nixpkgs bcachefs.nix patterns - TPM automatic unlock working**

## Accomplishments

Successfully implemented TPM2 automatic unlock for bcachefs native encryption by leveraging nixpkgs bcachefs.nix module patterns:

1. **Applied three critical fixes** identified through research:
   - Added `tpm_crb` kernel module to `boot.initrd.availableKernelModules`
   - Replaced `boot.initrd.secrets` with `boot.initrd.systemd.contents` (avoids eval-time path check)
   - Disabled auto-enrollment service (token now generated during installation)

2. **Created anguish test VM** with bcachefs native encryption:
   - Layout: bcachefs-encrypt-impermanence
   - TPM emulation via swtpm
   - Fresh test environment for validation

3. **Updated justfile bcachefs-setup-tpm** for dual-mode operation:
   - Supports installation context: `just bcachefs-setup-tpm anguish /mnt`
   - Supports post-boot context: `just bcachefs-setup-tpm anguish`
   - Generates Clevis JWE token with SOPS password

4. **Verified both unlock paths**:
   - âœ… Automatic TPM unlock: System boots without password prompt
   - âœ… Manual fallback: Password prompt appears when token unavailable
   - âœ… Both paths reliable and repeatable

## Files Created/Modified

**Created:**
- `hosts/anguish/` - New VM for bcachefs native encryption testing
- `hosts/anguish/default.nix` - VM config with bcachefs-encrypt layout
- `hosts/anguish/hardware-configuration.nix` - Minimal hardware config

**Modified:**
- `modules/disks/bcachefs-unlock.nix` - Applied nixpkgs patterns (tpm_crb, systemd.contents, disabled auto-enrollment)
- `justfile` - Updated bcachefs-setup-tpm for installation context, added anguish SSH port
- `flake.nix` - Registered anguish in nixosConfigurations
- `.planning/ROADMAP.md` - Marked Phase 21 complete, removed [BLOCKED] status

## Decisions Made

**Why nixpkgs patterns succeeded where custom implementation failed:**

The original 21-01 plan attempted a custom systemd service but hit fundamental NixOS limitations:
- `boot.initrd.secrets` can't copy runtime-generated tokens (path must exist at eval time)
- `boot.initrd.systemd.extraBin` didn't actually include binaries in initrd
- Auto-enrollment service created chicken-and-egg problem (token needed before boot, but generated after)

The revised approach uses proven patterns from nixpkgs bcachefs.nix:
- `boot.initrd.systemd.contents` works with conditional path existence
- `tpm_crb` module enables TPM hardware access in initrd
- Token generation during installation (via justfile) ensures availability for first boot

**Testing approach:**
- Used anguish VM with TPM emulation (swtpm)
- Verified both automatic and manual unlock paths
- Confirmed repeatable and reliable operation

## Issues Encountered

**Issue 1: boot.initrd.secrets path existence check**
- **Problem**: `builtins.pathExists` fails during evaluation if path doesn't exist yet
- **Solution**: Wrapped in `lib.mkIf` with conditional check, switched to `boot.initrd.systemd.contents`

**Issue 2: Auto-enrollment timing**
- **Problem**: Service runs after boot, but token needed before boot
- **Solution**: Disabled auto-enrollment, moved token generation to installation phase

**Issue 3: Missing TPM kernel module**
- **Problem**: TPM hardware inaccessible in initrd without tpm_crb
- **Solution**: Added to `boot.initrd.availableKernelModules` based on nixpkgs patterns

All issues resolved by aligning with nixpkgs bcachefs.nix implementation.

## Testing Results

**Automatic TPM Unlock Test:**
```bash
# Rebuild with token in place
ssh -p 22225 rain@127.0.0.1 'nh os boot && sudo reboot'

# Result: System boots without password prompt
# journalctl shows: Clevis decrypt â†’ bcachefs unlock â†’ successful boot
```

**Manual Fallback Test:**
```bash
# Remove token and rebuild
ssh -p 22225 rain@127.0.0.1 'sudo mv /persist/etc/clevis/bcachefs-root.jwe{,.bak} && nh os boot && sudo reboot'

# Result: Password prompt appears, manual unlock successful
# journalctl shows: Clevis failed â†’ fallback to systemd-ask-password â†’ manual unlock
```

Both paths verified working reliably on anguish VM with TPM emulation.

## Next Phase Readiness

**Phase 21 complete and unblocked!**

Bcachefs native encryption with TPM automatic unlock is now production-ready using nixpkgs patterns. The implementation:
- Works with TPM emulation (VMs) and real TPM hardware (physical hosts)
- Provides robust fallback to manual password
- Integrates with existing hostSpec configuration (host.encryption.tpm.enable)
- Follows proven patterns from nixpkgs and FOSDEM 2024 demonstration

**Ready for production deployment** on hosts that benefit from bcachefs native encryption (e.g., servers with TPM that need authenticated encryption features).

**Recommended next steps:**
1. Test on physical hardware with real TPM 2.0
2. Deploy to production hosts if bcachefs native encryption desired
3. Continue to Phase 22 (Home Manager Cleanup)

**Note**: LUKS + bcachefs remains a valid alternative for hosts that prefer mature tooling (systemd-cryptenroll, FIDO2, etc). Both approaches now fully supported.
```

Write this content to 21-02-SUMMARY.md.
  </action>
  <verify>
- SUMMARY.md exists in .planning/phases/21-tpm-unlock/
- Documents successful implementation with nixpkgs patterns
- Explains why this approach worked vs 21-01
- Includes testing results for both unlock paths
- Clearly states phase complete and production-ready
  </verify>
  <done>
- 21-02-SUMMARY.md created with comprehensive documentation
- Success criteria met
- Implementation details captured
- Ready for reference in future work
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] nix flake check passes without errors
- [ ] anguish builds successfully: nix build .#nixosConfigurations.anguish.config.system.build.toplevel
- [ ] anguish VM created with bcachefs native encryption
- [ ] TPM emulation working (quickemu/anguish-tpm/ exists)
- [ ] Clevis token generated and in place (/persist/etc/clevis/bcachefs-root.jwe)
- [ ] Automatic TPM unlock verified (boots without password)
- [ ] Manual fallback verified (password prompt when token removed)
- [ ] ROADMAP.md updated to show Phase 21 complete
- [ ] All changes committed with descriptive message
- [ ] 21-02-SUMMARY.md created with full documentation
</verification>

<success_criteria>
- All tasks completed successfully
- All verification checks pass
- anguish VM running with bcachefs native encryption
- Both unlock paths (TPM automatic + manual fallback) verified working
- Implementation uses proven nixpkgs patterns
- ROADMAP shows Phase 21 unblocked and complete
- Comprehensive documentation in SUMMARY.md
- Ready for production deployment
- Phase 21 no longer blocking progress
</success_criteria>

<output>
After completion, this plan creates `.planning/phases/21-tpm-unlock/21-02-SUMMARY.md` documenting the successful unblocking of Phase 21.

The summary will include:
- How nixpkgs patterns solved the problems
- Three critical fixes applied (tpm_crb, systemd.contents, installation-time token)
- Testing results from anguish VM (both automatic and manual unlock)
- Decisions made and rationale
- Issues encountered and solutions
- Production readiness statement
</output>
