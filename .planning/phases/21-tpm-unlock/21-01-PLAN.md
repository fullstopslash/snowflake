---
phase: 21-tpm-unlock
type: execute
---

<objective>
Implement TPM2 automatic unlock for bcachefs native encryption using Clevis with fallback to interactive password prompt.

Purpose: Enable unattended server boot while maintaining encryption-at-rest security, with per-host control via existing hostSpec configuration (host.encryption.tpm.enable).

Output: Fully functional TPM unlock for bcachefs encrypted systems, tested on sorrow VM with automatic boot and manual fallback verified.
</objective>

<execution_context>
@~/.claude/plugins/cache/taches-cc-resources/taches-cc-resources/1.0.0/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/cache/taches-cc-resources/taches-cc-resources/1.0.0/skills/create-plans/templates/summary.md
@~/.claude/plugins/cache/taches-cc-resources/taches-cc-resources/1.0.0/skills/create-plans/references/checkpoints.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/20-bcachefs-native-encryption/20-01-FINDINGS.md
@modules/disks/bcachefs-unlock.nix
@modules/common/host.nix
@hosts/sorrow/default.nix
@justfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement custom initrd systemd service for TPM unlock</name>
  <files>modules/disks/bcachefs-unlock.nix</files>
  <action>
Add boot.initrd.systemd.services.bcachefs-tpm-unlock service to bcachefs-unlock.nix (only when tpmEnabled is true). The service must:

1. Run before sysroot.mount and any bcachefs filesystem mounts
2. Detect encrypted bcachefs root device (via /dev/disk/by-label or UUID)
3. Attempt Clevis TPM unlock first:
   - Run: clevis decrypt < ${clevisTokenPath} | bcachefs unlock /dev/device
   - Capture exit code
4. If Clevis fails (exit non-zero) OR clevisTokenPath doesn't exist:
   - Fall back to systemd-ask-password prompt
   - Run: bcachefs unlock /dev/device (will prompt interactively)
5. Link kernel keyrings before unlock: keyctl link @u @s
6. Set proper systemd unit dependencies:
   - DefaultDependencies = "no"
   - before = ["sysroot.mount"]
   - Type = "oneshot"
   - RemainAfterExit = true

Use the pattern from Phase 20 FINDINGS (lines 674-710) as base structure.

Add Clevis package to boot.initrd.extraUtilsCommands when TPM enabled.

IMPORTANT: Do NOT use boot.initrd.clevis.devices configuration (LUKS-only, doesn't work for bcachefs). We're implementing a custom service instead.

Keep existing warning messages. Update the TODO comment at lines 58-61 to reference this implementation.
  </action>
  <verify>
nix flake check passes (no evaluation errors).
Build sorrow configuration: nix build .#nixosConfigurations.sorrow.config.system.build.toplevel
Check that initrd contains clevis binary: nix-store -qR result/initrd | grep clevis
  </verify>
  <done>
- bcachefs-unlock.nix contains custom systemd service for TPM unlock
- Service only enabled when tpmEnabled is true
- Clevis package included in initrd
- No evaluation errors
- Initrd contains required binaries (clevis, bcachefs-tools, keyctl)
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate TPM token for sorrow test VM</name>
  <files>/persist/etc/clevis/bcachefs-root.jwe (on VM after boot)</files>
  <action>
Since sorrow VM isn't deployed yet with TPM support, we'll need to deploy first with interactive unlock, then generate the token on the running system.

Steps:
1. Deploy sorrow with current implementation: just vm-fresh sorrow
2. Boot VM and enter disk password manually when prompted
3. Wait for VM to finish booting and become SSH accessible
4. SSH to VM (port 22223)
5. Generate TPM token using: sudo just bcachefs-setup-tpm sorrow
   - This will retrieve password from SOPS (on host) and generate JWE token
   - Token will be stored in /persist/etc/clevis/bcachefs-root.jwe
6. Rebuild system on VM: sudo nixos-rebuild boot
7. Reboot VM to test automatic unlock

NOTE: The VM might not have actual TPM hardware. If `just bcachefs-setup-tpm` fails due to missing TPM, this is expected for QEMU VM without TPM emulation. In that case, document the limitation and skip to manual fallback testing in Task 4.

If TPM is required for testing, we may need to update the quickemu VM script to enable TPM emulation (--tpm flag or similar).
  </action>
  <verify>
After generating token:
- File exists: /persist/etc/clevis/bcachefs-root.jwe (on VM)
- File has correct permissions: 600, owned by root:root
- File contains valid JWE JSON structure: cat /persist/etc/clevis/bcachefs-root.jwe | jq .
  </verify>
  <done>
- TPM token generated and stored in persist folder
OR
- Documented that VM lacks TPM hardware and manual testing only is possible
  </done>
</task>

<task type="checkpoint:decision" gate="blocking">
  <decision>How to handle VM TPM testing</decision>
  <context>
The sorrow VM test environment may not have TPM 2.0 hardware available. QEMU can emulate TPM with swtpm, but this requires additional setup in the quickemu VM launch script.

We have three options for testing TPM unlock:
  </context>
  <options>
    <option id="skip-tpm-test">
      <name>Skip TPM testing, verify manual fallback only</name>
      <pros>Fastest path forward. Manual fallback is the critical safety mechanism. TPM unlock can be tested on real hardware later. Implementation is sound based on nixpkgs patterns.</pros>
      <cons>Won't verify TPM unlock works end-to-end before merging. Risk of subtle bugs in Clevis integration.</cons>
    </option>
    <option id="add-tpm-emulation">
      <name>Add TPM emulation to quickemu VM script</name>
      <pros>Complete end-to-end testing in VM. Verifies both TPM unlock and fallback. Higher confidence before deployment to real hardware.</pros>
      <cons>Additional setup work. Requires swtpm package, QEMU TPM configuration, and script modifications. May introduce complexity to VM infrastructure.</cons>
    </option>
    <option id="test-on-real-hardware">
      <name>Deploy to real hardware (griefling) for testing</name>
      <pros>Tests on actual TPM 2.0 hardware. Most realistic validation. Griefling has TPM and is reinstallable.</pros>
      <cons>Higher risk deployment. Griefling is working production-ish system. Would need to backup/prepare for potential boot failure.</cons>
    </option>
  </options>
  <resume-signal>Select: skip-tpm-test, add-tpm-emulation, or test-on-real-hardware</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Test automatic TPM unlock (if TPM available)</name>
  <files>None (testing task)</files>
  <action>
If TPM testing is available (either via emulation or real hardware):

1. Ensure TPM token is generated and in place (/persist/etc/clevis/bcachefs-root.jwe)
2. Rebuild system to include updated initrd with TPM unlock service
3. Reboot system
4. Observe boot process:
   - Should NOT prompt for password
   - Should automatically unlock via TPM
   - Should boot to login prompt without intervention
5. Verify system booted successfully: check SSH access, check systemd services

Monitor boot logs for the unlock service:
- journalctl -u bcachefs-tpm-unlock (or whatever the service name is)
- Check for successful Clevis decrypt and bcachefs unlock messages

If automatic unlock fails:
- Capture error messages from boot log
- System should fall back to interactive password prompt
- Enter password manually to continue boot
- Investigate failure (missing token, TPM not available, wrong PCR values, etc.)
  </action>
  <verify>
Success criteria:
- System boots without password prompt
- journalctl shows successful TPM unlock: "bcachefs unlock succeeded"
- No errors in systemd journal for unlock service
- System fully operational after automatic unlock
  </verify>
  <done>
- Automatic TPM unlock working, OR
- Documented failure reason and confirmed fallback works
  </done>
</task>

<task type="auto">
  <name>Task 4: Test fallback to interactive password</name>
  <files>None (testing task)</files>
  <action>
Test that the fallback mechanism works when TPM unlock fails:

Method 1 - Remove token file:
1. SSH to test system
2. Backup and remove the Clevis token: sudo mv /persist/etc/clevis/bcachefs-root.jwe /persist/etc/clevis/bcachefs-root.jwe.bak
3. Rebuild initrd: sudo nixos-rebuild boot
4. Reboot system
5. Should prompt for disk password at boot
6. Enter password, system should boot normally
7. Restore token: sudo mv /persist/etc/clevis/bcachefs-root.jwe.bak /persist/etc/clevis/bcachefs-root.jwe

Method 2 - Test with TPM disabled host:
1. Create a test host config or temporarily set host.encryption.tpm.enable = false in sorrow config
2. Rebuild and deploy
3. Should prompt for password (no TPM unlock attempt)
4. Verify manual unlock works

Verify boot logs show:
- Clevis decrypt failed (if token removed) OR
- Clevis not attempted (if TPM disabled)
- Fallback to systemd-ask-password
- Successful unlock with manual password
- Normal boot completion
  </action>
  <verify>
- Fallback password prompt appears when Clevis unavailable
- Manual password entry successfully unlocks filesystem
- System boots normally after manual unlock
- No errors or stuck boot processes
  </verify>
  <done>
- Fallback to interactive unlock verified working
- Both TPM-disabled and token-missing scenarios tested
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
TPM automatic unlock for bcachefs encryption with manual fallback.

Implemented custom initrd systemd service that:
- Attempts Clevis TPM unlock first (when enabled and token exists)
- Falls back to interactive password prompt on failure
- Integrates with existing hostSpec configuration
  </what-built>
  <how-to-verify>
Based on which testing path was chosen in Task 2 decision:

If TPM testing was performed:
1. Review boot logs showing successful automatic unlock
2. Verify system boots without user intervention
3. Verify fallback works when token removed
4. Confirm both unlock paths are functional

If TPM testing was skipped:
1. Review implementation against Phase 20 FINDINGS patterns
2. Verify interactive unlock still works (manual password entry)
3. Confirm systemd service structure matches nixpkgs bcachefs.nix patterns
4. Acknowledge TPM testing deferred to real hardware deployment

In both cases:
- Verify no evaluation errors in configuration
- Verify initrd contains required binaries (clevis, bcachefs-tools)
- Verify hostSpec integration works (per-host enable/disable)
  </how-to-verify>
  <resume-signal>Type "approved" if verification passed, or describe issues found</resume-signal>
</task>

<task type="auto">
  <name>Task 5: Update documentation and commit changes</name>
  <files>modules/disks/bcachefs-unlock.nix, hosts/sorrow/default.nix</files>
  <action>
Update documentation in bcachefs-unlock.nix:
- Remove or update the TODO comment (lines 58-61) to reflect the completed implementation
- Update module header documentation to describe the TPM unlock workflow
- Ensure warning messages accurately reflect the current behavior

Verify all changes:
1. Run nix flake check to ensure no evaluation errors
2. Review git diff to confirm all changes are intentional
3. Ensure no debugging code or temporary changes remain

Commit the changes:
1. Stage files: git add modules/disks/bcachefs-unlock.nix
2. Create commit with message:
   ```
   feat(encryption): implement TPM unlock for bcachefs

   Add custom initrd systemd service for bcachefs + Clevis TPM unlock.
   - Automatic TPM unlock when host.encryption.tpm.enable = true
   - Fallback to interactive password prompt if TPM fails
   - Per-host configuration via hostSpec
   - Clevis package included in initrd when TPM enabled

   Service attempts Clevis decrypt -> bcachefs unlock pipeline first.
   On failure, falls back to systemd-ask-password for manual entry.
   Handles kernel keyring linking for proper key sharing.

   Phase 21 - TPM Unlock implementation
   ```
3. Do NOT push yet (wait for final approval)
  </action>
  <verify>
- git status shows clean working directory (or only expected changes)
- git log shows commit with proper message
- nix flake check passes
- No evaluation errors
  </verify>
  <done>
- Documentation updated and accurate
- Changes committed locally
- Ready for push after final approval
  </done>
</task>

<task type="auto">
  <name>Task 6: Create Phase 21 SUMMARY</name>
  <files>.planning/phases/21-tpm-unlock/21-01-SUMMARY.md</files>
  <action>
Create SUMMARY.md following the template structure:

# Phase 21 Plan 1: TPM Unlock Summary

**TPM automatic unlock for bcachefs encryption with robust manual fallback**

## Accomplishments
[List what was implemented]
- Custom initrd systemd service for bcachefs + Clevis TPM unlock
- Integration with existing hostSpec configuration
- Automatic fallback to interactive password when TPM unavailable
- [Testing results - whether TPM tested or manual only]

## Files Created/Modified
- `modules/disks/bcachefs-unlock.nix` - Added boot.initrd.systemd service for TPM unlock
- [Any other files modified]

## Decisions Made
[Document the TPM testing decision from Task 2 checkpoint]

## Issues Encountered
[Document any issues found during implementation/testing]

## Next Phase Readiness
Phase 21 complete. TPM unlock functional with per-host configuration via hostSpec.
[Note if full TPM testing deferred to real hardware deployment]

Include specific details from testing results, any workarounds needed, and lessons learned.
  </action>
  <verify>
- SUMMARY.md exists in .planning/phases/21-tpm-unlock/
- Follows template structure
- Accurately documents what was accomplished
- Notes any deferred testing or known limitations
  </verify>
  <done>
- SUMMARY.md created with accurate implementation details
- Testing results documented
- Phase outcome clearly stated
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] nix flake check passes without errors
- [ ] sorrow builds successfully: nix build .#nixosConfigurations.sorrow.config.system.build.toplevel
- [ ] Initrd contains required binaries (clevis, bcachefs-tools, keyutils)
- [ ] Manual password unlock works (verified via testing)
- [ ] TPM unlock works (if TPM testing performed) OR documented as deferred
- [ ] hostSpec integration works (per-host enable/disable)
- [ ] No regressions in non-TPM configurations
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Custom initrd systemd service implemented and functional
- Fallback to interactive unlock verified working
- Per-host TPM configuration via hostSpec operational
- Documentation updated and accurate
- Changes committed and ready for deployment
- Either full TPM testing completed OR deferral documented with reasoning
</success_criteria>

<output>
After completion, create `.planning/phases/21-tpm-unlock/21-01-SUMMARY.md`:

# Phase 21 Plan 1: TPM Unlock Summary

**[Substantive one-liner - what was accomplished]**

## Accomplishments
- Custom initrd systemd service for bcachefs + Clevis
- TPM unlock with fallback to interactive prompt
- Per-host configuration via hostSpec
- [Testing approach and results]

## Files Created/Modified
- `modules/disks/bcachefs-unlock.nix` - TPM unlock service implementation
- [Others as applicable]

## Decisions Made
[TPM testing approach decision and rationale]

## Issues Encountered
[Any implementation challenges, bugs fixed, workarounds needed]

## Next Phase Readiness
Phase 21 complete. [Note any follow-up needed for TPM testing on real hardware]
</output>
