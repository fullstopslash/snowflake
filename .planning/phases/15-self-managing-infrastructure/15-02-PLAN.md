# Plan 15-02: Pre-Update Validation

## Goal
Extend the auto-upgrade module to build updates before switching, with validation checks and rollback capability on build failures.

## Context
From ROADMAP Phase 15:
- Currently auto-upgrade pulls and switches immediately (risky)
- Need to build first, validate, THEN switch
- Need rollback if build fails
- Depends on: Plan 15-01 (golden generation for rollback target)

## Current Auto-Upgrade Flow
From `modules/common/auto-upgrade.nix`:
```
1. Git pull
2. nixos-rebuild switch
3. Done
```

## Proposed Safe Flow
```
1. Git pull
2. nixos-rebuild build (don't switch yet!)
3. Run validation checks
4. If all pass → nixos-rebuild switch
5. If any fail → rollback git, notify, keep current config
```

## Implementation Steps

### 1. Update Auto-Upgrade Module
**File**: `modules/common/auto-upgrade.nix`

Add options:
```nix
buildBeforeSwitch = lib.mkOption {
  type = lib.types.bool;
  default = true;
  description = "Build and validate before switching";
};

validationChecks = lib.mkOption {
  type = lib.types.listOf lib.types.str;
  default = [];
  description = "Shell commands to run for validation (must exit 0)";
  example = [
    "nix flake check"
    "test -f /etc/nixos/configuration.nix"
  ];
};

onValidationFailure = lib.mkOption {
  type = lib.types.enum [ "rollback" "notify" "ignore" ];
  default = "rollback";
  description = "Action on validation failure";
};
```

Update service script:
```bash
# After git pull
old_commit=$(git rev-parse HEAD)

# Build first (don't switch)
if ! nixos-rebuild build; then
  echo "Build failed, rolling back"
  git reset --hard "$old_commit"
  exit 1
fi

# Run validation checks
for check in ${lib.concatStringsSep " " cfg.validationChecks}; do
  if ! eval "$check"; then
    echo "Validation failed: $check"
    case ${cfg.onValidationFailure} in
      rollback)
        git reset --hard "$old_commit"
        exit 1
        ;;
      notify)
        # Send notification but continue
        ;;
      ignore)
        ;;
    esac
  fi
done

# All checks passed, now switch
nixos-rebuild switch
```

### 2. Add Pre-Commit Hook for Local Validation
**File**: `.git/hooks/pre-commit` (generated by module)

```bash
#!/usr/bin/env bash
# Validate Nix configuration before committing
set -e

echo "Running pre-commit validation..."

# Check syntax
nix-instantiate --parse ./flake.nix > /dev/null

# Try building (dry-run)
nixos-rebuild dry-build

echo "Pre-commit validation passed"
```

### 3. Role-Specific Configuration

**Servers** (`roles/form-server.nix`):
```nix
myModules.common.autoUpgrade = {
  enable = true;
  buildBeforeSwitch = true;
  validationChecks = [
    # Ensure critical services are defined
    "systemctl --quiet is-enabled sshd"
  ];
  onValidationFailure = "rollback";
};
```

**Development/Test** (`roles/task-development.nix`, `roles/task-test.nix`):
```nix
myModules.common.autoUpgrade = {
  enable = true;
  buildBeforeSwitch = true;
  validationChecks = [];  # Less restrictive
  onValidationFailure = "notify";
};
```

### 4. Testing Plan

1. Deploy to griefling
2. Make a good change → commit → push
3. Wait for auto-upgrade (or trigger manually)
4. Verify it builds then switches
5. Make a breaking change (syntax error) → commit → push
6. Wait for auto-upgrade
7. Verify it builds, fails validation, rolls back git
8. Check system is still on old working config

## Success Criteria
- [ ] Build-before-switch option works
- [ ] Validation checks run and gate switching
- [ ] Git rollback works on validation failure
- [ ] Pre-commit hook prevents bad commits
- [ ] Servers use strict validation
- [ ] Dev/test use lenient validation

## Follow-up
- Plan 15-03 will add boot-time rollback
- Consider adding notification system (email/ntfy)
