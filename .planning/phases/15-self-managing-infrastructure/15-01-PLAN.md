---
phase: 15-self-managing-infrastructure
plan: 15-01
title: Golden Boot Entry Module
depends_on:
  - Phase 6 (Auto-upgrade module)
  - Phase 14 (Role system)
status: not_started
---

# Plan 15-01: Golden Boot Entry Module

## Objective

Implement automatic golden generation pinning with fast boot validation using systemd-boot boot counting and boot-complete.target. Protect known-good generations from garbage collection and enable automatic rollback on boot failure.

## Success Criteria

- [ ] Boot counting enabled in server and pi roles with automatic rollback
- [ ] Golden generation automatically pinned after successful boot validation
- [ ] Boot validation checks SSH and Tailscale services (extensible design)
- [ ] Hosts can add host-specific service validations
- [ ] Manual commands available for golden generation management
- [ ] Golden generation survives garbage collection
- [ ] Tested and verified in griefling VM
- [ ] Documentation added to README or docs

## Research Findings Reference

See [15-01-FINDINGS.md](./15-01-FINDINGS.md) for comprehensive research on:
- systemd-boot boot counting (merged 2024, NixOS 24.05+)
- boot-complete.target for fast validation (seconds, not hours)
- GC root management with nix-store --add-root
- Community best practices

**Key insight**: Use native systemd boot assessment instead of 24h uptime validation.

## Implementation Steps

### Step 1: Create Golden Generation Module

**File**: `modules/system/boot/golden-generation.nix`

Create module with:
- Enable option: `myModules.system.boot.goldenGeneration.enable`
- Validation services option: `myModules.system.boot.goldenGeneration.validateServices` (list of service names)
- Auto-pin option: `myModules.system.boot.goldenGeneration.autoPinAfterBoot` (default true)
- Manual override option: `myModules.system.boot.goldenGeneration.skipNextPin` (default false)

**Components**:

1. **Boot counting configuration**:
   ```nix
   boot.loader.systemd-boot.bootCounting = lib.mkIf cfg.enable {
     enable = lib.mkDefault true;
     tries = lib.mkDefault 2;
   };
   ```

2. **Validation service** (runs before boot-complete.target):
   - Check all services in `validateServices` list are active
   - Use `systemctl is-active` for each service
   - Fail if any critical service is not running
   - Add as dependency of boot-complete.target

3. **Golden pinning service** (runs after boot-complete.target):
   - Check if `skipNextPin` is true, skip if so
   - Get current generation number
   - Create/update `/nix/var/nix/gcroots/golden-generation` symlink
   - Log generation number that was pinned
   - Run once per boot

4. **Manual management commands** (add to environment.systemPackages):
   - `pin-golden`: Pin current generation manually
   - `show-golden`: Display current golden generation
   - `unpin-golden`: Remove golden GC root
   - `rollback-to-golden`: Switch to golden generation

**Design pattern**: Follow existing module structure:
- Options in `options.myModules.system.boot.goldenGeneration.*`
- All config wrapped in `config = lib.mkIf cfg.enable { ... };`
- Use `lib.mkDefault` for role-configurable values
- Services use `pkgs.writeShellScript` for logic

### Step 2: Add to Module Selection System

**File**: `modules/system/boot/default.nix`

Add import for golden-generation.nix if it doesn't auto-import via scanPaths.

Verify module is discoverable via:
```nix
modules.system.boot = [ "golden-generation" ];
```

### Step 3: Enable in Server and Pi Roles

**Files**: `roles/form-server.nix`, `roles/form-pi.nix`

Add to each role:
```nix
{
  # Enable golden generation module
  modules.system.boot = lib.mkDefault [ "golden-generation" ];

  # Configure validation services (repo-wide defaults)
  myModules.system.boot.goldenGeneration = {
    enable = lib.mkDefault true;
    validateServices = lib.mkDefault [
      "sshd.service"
      "tailscaled.service"
    ];
    autoPinAfterBoot = lib.mkDefault true;
  };
}
```

**Extensibility**: Hosts can extend validateServices:
```nix
# In host config
myModules.system.boot.goldenGeneration.validateServices = lib.mkDefault [
  "sshd.service"
  "tailscaled.service"
  "syncthing.service"  # Host-specific
];
```

Or override completely:
```nix
myModules.system.boot.goldenGeneration.validateServices = lib.mkForce [
  "sshd.service"  # Minimal validation
];
```

### Step 4: Create Manual Management Commands

**File**: `modules/system/boot/golden-generation.nix` (scripts section)

Create wrapper scripts as derivations:

```nix
let
  pinGoldenCmd = pkgs.writeShellScriptBin "pin-golden" ''
    set -euo pipefail
    CURRENT=$(readlink /nix/var/nix/profiles/system | grep -oP '\d+$')
    sudo ${pkgs.nix}/bin/nix-store --add-root /nix/var/nix/gcroots/golden-generation \
      --indirect --realise "/nix/var/nix/profiles/system-$CURRENT-link"
    echo "✓ Pinned generation $CURRENT as golden"
  '';

  showGoldenCmd = pkgs.writeShellScriptBin "show-golden" ''
    if [ -L /nix/var/nix/gcroots/golden-generation ]; then
      GOLDEN=$(readlink /nix/var/nix/gcroots/golden-generation)
      echo "Golden generation: $GOLDEN"
    else
      echo "No golden generation pinned"
      exit 1
    fi
  '';

  unpinGoldenCmd = pkgs.writeShellScriptBin "unpin-golden" ''
    if [ -L /nix/var/nix/gcroots/golden-generation ]; then
      sudo rm /nix/var/nix/gcroots/golden-generation
      echo "✓ Unpinned golden generation"
    else
      echo "No golden generation to unpin"
      exit 1
    fi
  '';

  rollbackToGoldenCmd = pkgs.writeShellScriptBin "rollback-to-golden" ''
    set -euo pipefail
    if [ ! -L /nix/var/nix/gcroots/golden-generation ]; then
      echo "Error: No golden generation pinned"
      exit 1
    fi

    GOLDEN_PATH=$(readlink /nix/var/nix/gcroots/golden-generation)
    echo "Rolling back to: $GOLDEN_PATH"
    sudo nix-env --profile /nix/var/nix/profiles/system --set "$GOLDEN_PATH"
    sudo "$GOLDEN_PATH/bin/switch-to-configuration" switch
    echo "✓ Rolled back to golden generation"
  '';
in
{
  config = lib.mkIf cfg.enable {
    environment.systemPackages = [
      pinGoldenCmd
      showGoldenCmd
      unpinGoldenCmd
      rollbackToGoldenCmd
    ];
  };
}
```

### Step 5: Test in Griefling VM

**Verification steps**:

1. **Enable module in griefling**:
   ```nix
   # hosts/griefling/default.nix
   # Already has roles.vm, which should enable golden generation
   # Or explicitly enable for testing:
   myModules.system.boot.goldenGeneration.enable = true;
   ```

2. **Build and deploy**:
   ```bash
   nh os build -H griefling
   # Deploy to VM (via ssh or vm-rebuild)
   ```

3. **Test boot counting**:
   - Reboot VM
   - Check systemd journal: `journalctl -u systemd-bless-boot.service`
   - Verify boot counting file updated: `ls /boot/loader/entries/`
   - Look for `nixos-generation-XXX+2.conf` pattern

4. **Test validation service**:
   - Check validation ran: `systemctl status golden-boot-validation.service`
   - Verify SSH validated: Look for "is-active sshd.service" in logs
   - Verify Tailscale validated: Look for "is-active tailscaled.service" in logs

5. **Test golden pinning**:
   - Check service ran: `systemctl status pin-golden-generation.service`
   - Verify GC root created: `ls -la /nix/var/nix/gcroots/golden-generation`
   - Verify it points to current generation: `readlink /nix/var/nix/gcroots/golden-generation`

6. **Test manual commands**:
   ```bash
   show-golden        # Should show current pinned generation
   pin-golden         # Should update to current generation
   unpin-golden       # Should remove GC root
   pin-golden         # Pin again
   rollback-to-golden # Should switch to golden generation
   ```

7. **Test GC protection**:
   ```bash
   # Create a new generation
   sudo nixos-rebuild test

   # Try to collect garbage
   sudo nix-collect-garbage -d

   # Verify golden generation still exists
   show-golden
   ls /nix/var/nix/gcroots/golden-generation
   ```

8. **Test boot failure simulation** (optional, advanced):
   - Temporarily break SSH service in config
   - Deploy and reboot
   - Verify boot validation fails
   - Verify boot counting decrements
   - After 2 failures, verify automatic rollback to previous generation

### Step 6: Documentation

**File**: Update relevant documentation (README.md or create docs/boot-validation.md)

Document:
- Purpose of golden generation system
- How boot validation works (boot-complete.target)
- Manual commands available
- How to extend validation services per-host
- How to skip golden pinning for testing (set skipNextPin = true)
- Manual override workflow

## Integration with Existing Systems

### Auto-Upgrade Module (Phase 6)

Golden generation works seamlessly with auto-upgrade:

```
Daily auto-upgrade workflow:
1. git pull new changes
2. nh os switch (rebuild and activate)
3. Reboot if kernel/initrd changed
4. Boot counting protects (2 tries)
5. Validation service checks SSH + Tailscale
6. boot-complete.target reached
7. systemd-bless-boot.service marks boot good
8. pin-golden-generation.service creates GC root
9. Golden generation updated to current
```

If step 5 fails → boot counting decrements → after 2 tries → rollback to previous generation.

### Role System

Boot counting and golden pinning enabled by default in:
- **Server role**: Critical for headless systems
- **Pi role**: Critical for remote/embedded systems

Optional for:
- **Desktop role**: Manual boot menu access is easy
- **Laptop role**: Manual boot menu access is easy
- **VM role**: Can enable for testing

### Module Selection System

Follows existing pattern:
```nix
modules.system.boot = [ "golden-generation" ];
```

With overrides:
```nix
myModules.system.boot.goldenGeneration = {
  validateServices = lib.mkDefault [ "sshd.service" "custom.service" ];
  autoPinAfterBoot = lib.mkForce false;  # Disable auto-pin
  skipNextPin = true;  # Skip next boot's pin (testing)
};
```

## Files to Create/Modify

### New Files
- `modules/system/boot/golden-generation.nix` - Main module implementation

### Modified Files
- `roles/form-server.nix` - Enable golden generation, set default validation services
- `roles/form-pi.nix` - Enable golden generation, set default validation services
- `roles/form-vm.nix` (optional) - Enable for testing if desired
- `hosts/griefling/default.nix` (optional) - Explicit enable for testing
- Documentation file (README.md or new docs/boot-validation.md)

## Rollback Plan

If golden generation module causes issues:

1. **Boot menu fallback**: Always available, press Space during boot
2. **Disable module**: Set `myModules.system.boot.goldenGeneration.enable = false;` in host config
3. **Remove validation**: Set `validateServices = [];` to skip validation
4. **Manual GC root removal**: `sudo rm /nix/var/nix/gcroots/golden-generation`

Boot counting itself can be disabled per-host:
```nix
boot.loader.systemd-boot.bootCounting.enable = lib.mkForce false;
```

## Open Questions / Decisions Made

1. ✅ **Golden generation rotation**: Single golden generation (simpler, sufficient)
2. ✅ **Validation scope**: SSH + Tailscale with extensible design
3. ✅ **Manual override**: Include `skipNextPin` option for flexibility
4. ✅ **Testing strategy**: Test in griefling VM before server/pi deployment
5. ⚠️ **Boot counting stability**: Will verify in testing (feature merged 2024, should be stable)

## Timeline Estimate

Not providing timeline per user preference. Steps are sequential dependencies:
- Step 1-2: Create module (prerequisite for testing)
- Step 3: Enable in roles (prerequisite for deployment)
- Step 4: Manual commands (can parallel with Step 1)
- Step 5: Testing (validates everything works)
- Step 6: Documentation (finalizes the implementation)

## Notes

- Boot validation happens in **seconds to minutes**, not 24 hours
- systemd-boot boot counting is **native NixOS** (merged 2024)
- GC protection is **automatic** via /nix/var/nix/gcroots/
- Manual rollback is **always available** via boot menu
- Design follows **existing module patterns** for consistency
- Extensibility via **list-based service selection** like modules system
