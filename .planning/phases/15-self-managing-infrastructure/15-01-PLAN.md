# Plan 15-01: Golden Boot Entry Module

## Goal
Implement a "golden generation" system that pins known-good NixOS generations and protects them from garbage collection. This provides a stable rollback target if future updates fail.

## Context
From ROADMAP Phase 15:
- Need automatic pinning of stable configurations (after 24h uptime)
- Need manual pinning capability for admins
- Need GC protection for golden generations
- This is prerequisite for automatic rollback (Plan 15-03)

## Implementation Steps

### 1. Create Golden Generation Module
**File**: `modules/system/boot/golden-generation.nix`

```nix
# Golden boot generation management
# Automatically pins stable generations as "golden" and protects from GC
{ config, lib, pkgs, ... }:
let
  cfg = config.myModules.system.boot.goldenGeneration;
  stateDir = "/var/lib/golden-generation";

  # Script to pin current generation as golden
  pinGoldenScript = pkgs.writeShellScript "pin-golden-generation" ''
    set -euo pipefail

    # Get current generation number
    current=$(readlink /nix/var/nix/profiles/system | grep -oP 'system-\K[0-9]+')

    # Create state directory
    mkdir -p ${stateDir}

    # Save golden generation number
    echo "$current" > ${stateDir}/golden-generation-number

    # Add GC root to protect from deletion
    ln -sfn /nix/var/nix/profiles/system-$current-link \
      /nix/var/nix/gcroots/auto/golden-generation

    echo "Golden generation pinned: $current"
  '';

  # Script to show current golden generation
  showGoldenScript = pkgs.writeShellScript "show-golden-generation" ''
    if [ -f ${stateDir}/golden-generation-number ]; then
      golden=$(cat ${stateDir}/golden-generation-number)
      echo "Golden Generation: $golden"

      if [ -L /nix/var/nix/gcroots/auto/golden-generation ]; then
        echo "GC Protection: Active"
      else
        echo "GC Protection: Missing (run pin-golden to restore)"
      fi
    else
      echo "No golden generation pinned yet"
      exit 1
    fi
  '';

  # Auto-pin service (runs after stable uptime)
  autoPinService = lib.mkIf cfg.autoPin {
    systemd.timers.golden-auto-pin = {
      description = "Auto-pin golden generation after stable uptime";
      wantedBy = [ "timers.target" ];
      timerConfig = {
        OnBootSec = cfg.autoPinDelay;
        Unit = "golden-auto-pin.service";
      };
    };

    systemd.services.golden-auto-pin = {
      description = "Auto-pin current generation as golden";
      serviceConfig = {
        Type = "oneshot";
        ExecStart = "${pinGoldenScript}";
      };
    };
  };

in
{
  options.myModules.system.boot.goldenGeneration = {
    enable = lib.mkEnableOption "Golden generation management";

    autoPin = lib.mkOption {
      type = lib.types.bool;
      default = true;
      description = "Automatically pin generation after stable uptime";
    };

    autoPinDelay = lib.mkOption {
      type = lib.types.str;
      default = "24h";
      description = "Delay before auto-pinning (systemd time format)";
    };
  };

  config = lib.mkIf cfg.enable {
    # Merge auto-pin services if enabled
    inherit (autoPinService) systemd;

    # Add commands to system packages
    environment.systemPackages = [
      (pkgs.writeShellScriptBin "pin-golden" ''
        exec ${pinGoldenScript} "$@"
      '')
      (pkgs.writeShellScriptBin "show-golden" ''
        exec ${showGoldenScript} "$@"
      '')
    ];

    # Create state directory
    systemd.tmpfiles.rules = [
      "d ${stateDir} 0755 root root -"
    ];
  };
}
```

### 2. Update Module Selection
**File**: `modules/selection.nix`

Add to imports:
```nix
./system/boot/golden-generation.nix
```

### 3. Enable for Appropriate Roles

**Servers** (`roles/form-server.nix`):
```nix
myModules.system.boot.goldenGeneration = {
  enable = true;
  autoPin = true;
  autoPinDelay = "24h";
};
```

**Pi devices** (`roles/form-pi.nix`):
```nix
myModules.system.boot.goldenGeneration = {
  enable = true;
  autoPin = true;
  autoPinDelay = "24h";
};
```

**Test VMs** (`roles/task-test.nix`):
```nix
myModules.system.boot.goldenGeneration = {
  enable = true;
  autoPin = false;  # Manual pinning only for test VMs
};
```

### 4. Testing Plan

1. Deploy to griefling (test VM)
2. Verify commands exist: `pin-golden`, `show-golden`
3. Test manual pinning: `sudo pin-golden`
4. Verify GC root created: `ls -la /nix/var/nix/gcroots/auto/`
5. Test showing golden: `show-golden`
6. Run GC: `sudo nix-collect-garbage -d`
7. Verify golden generation still exists

## Success Criteria
- [ ] Module created and compiles
- [ ] Commands `pin-golden` and `show-golden` work
- [ ] GC root protects pinned generation
- [ ] Auto-pin works on servers/pi (after 24h)
- [ ] Manual pin works on test VMs
- [ ] Golden generation survives GC

## Follow-up
- Plan 15-02 will add build validation
- Plan 15-03 will add automatic rollback to golden on boot failure
