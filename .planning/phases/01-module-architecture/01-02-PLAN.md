---
phase: 01-module-architecture
plan: 02
type: execute
---

<objective>
Reorganize modules into three-tier structure: common (auto-applied), opt-in (subscribe), host-specific.

Purpose: Create clear separation between modules that apply to all hosts vs those hosts must explicitly import.
Output: New directory structure with roles categorized into `modules/common/` and `modules/opt-in/`.
</objective>

<execution_context>
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/01-module-architecture/01-01-SUMMARY.md
@flake.nix
@roles/universal.nix
@roles/desktop.nix
@hosts/malphas/default.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create module directory structure</name>
  <files>modules/common/default.nix, modules/opt-in/default.nix</files>
  <action>
Create the three-tier module structure:

```
modules/
├── host-spec.nix          # (already exists from 01-01)
├── common/                 # Auto-applied to ALL hosts
│   ├── default.nix        # Imports all common modules
│   └── (modules moved here)
├── opt-in/                 # Hosts must explicitly import
│   ├── default.nix        # Exports all opt-in modules for easy import
│   └── (modules moved here)
└── (existing modules stay for now: sops.nix, etc.)
```

Create `modules/common/default.nix` that will import all modules in the common directory.
Create `modules/opt-in/default.nix` that exports an attrset of all opt-in modules (so hosts can do `modules.opt-in.desktop`).

Do NOT move any files yet - just create the structure and placeholder default.nix files.
  </action>
  <verify>directories exist, default.nix files exist in both</verify>
  <done>Module directory structure created with default.nix files</done>
</task>

<task type="auto">
  <name>Task 2: Move universal/core roles to modules/common/</name>
  <files>modules/common/*, roles/universal.nix</files>
  <action>
Identify and move roles that should apply to ALL hosts (including servers, minimal installs):

Move to `modules/common/`:
- `roles/universal.nix` → `modules/common/universal.nix` (core system settings)

Update `modules/common/default.nix` to import these modules.

These modules will be auto-imported by the flake for every host. They should contain:
- Basic system hardening
- Core services (journald, fstrim, etc.)
- Nix configuration
- Essential packages

Do NOT move desktop-specific, server-specific, or optional modules here. When in doubt, leave it as opt-in.
  </action>
  <verify>modules/common/universal.nix exists, modules/common/default.nix imports it</verify>
  <done>Universal role moved to common, default.nix updated</done>
</task>

<task type="auto">
  <name>Task 3: Organize opt-in roles</name>
  <files>modules/opt-in/default.nix</files>
  <action>
Update `modules/opt-in/default.nix` to export references to existing roles that hosts can import.

Structure the opt-in default.nix as:
```nix
{
  # Desktop environments
  desktop = ../roles/desktop.nix;
  hyprland = ../roles/hyprland.nix;
  plasma = ../roles/plasma.nix;

  # Development
  development = ../roles/development.nix;

  # Media
  gaming = ../roles/gaming.nix;
  media = ../roles/media.nix;

  # etc...
}
```

This creates a registry of available opt-in modules without moving files yet. The actual roles stay in `roles/` for now - we're creating a clean interface.

Include ALL current roles except universal.nix (which moved to common).
  </action>
  <verify>modules/opt-in/default.nix exports paths to all roles in roles/ directory</verify>
  <done>Opt-in registry created with all available roles</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `modules/common/` directory exists with default.nix
- [ ] `modules/opt-in/` directory exists with default.nix
- [ ] `modules/common/universal.nix` exists (moved from roles/)
- [ ] `modules/common/default.nix` imports universal.nix
- [ ] `modules/opt-in/default.nix` exports all role paths
- [ ] No broken imports (roles/ still contains most files)
</verification>

<success_criteria>
- All tasks completed
- Directory structure established
- Common modules auto-importable
- Opt-in registry complete
- Existing functionality preserved (malphas still builds)
</success_criteria>

<output>
After completion, create `.planning/phases/01-module-architecture/01-02-SUMMARY.md`
</output>
