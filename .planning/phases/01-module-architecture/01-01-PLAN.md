---
phase: 01-module-architecture
plan: 01
type: execute
---

<objective>
Create the host-spec module that enables declarative host differentiation.

Purpose: Establish the foundation for hosts to declare their characteristics (isDesktop, isServer, isDarwin, etc.) so modules can conditionally apply configuration based on host type.
Output: Working `modules/host-spec.nix` integrated into flake.nix with typed options.
</objective>

<execution_context>
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@flake.nix
@hosts/malphas/default.nix
Reference pattern (do not copy verbatim, adapt to this repo's style):
@~/nix-config/modules/common/host-spec.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create host-spec module with typed options</name>
  <files>modules/host-spec.nix</files>
  <action>
Create `modules/host-spec.nix` with NixOS module options for host differentiation.

Include these options under `hostSpec`:
- `hostname` (string) - Set automatically by flake
- `system` (string) - Architecture (x86_64-linux, aarch64-linux, aarch64-darwin)
- `stateVersion` (string) - NixOS state version
- `isDesktop` (bool, default false) - Desktop workstation with GUI
- `isServer` (bool, default false) - Headless server
- `isLaptop` (bool, default false) - Portable with battery
- `isDarwin` (bool, default false) - macOS host
- `isMinimal` (bool, default false) - Minimal installation (ISO, containers)
- `hasWifi` (bool, default false) - Has wireless capability
- `primaryUser` (string) - Primary username for the host

Use `lib.mkOption` with proper types from `lib.types`. Add descriptions for each option.

Do NOT add assertions yet - keep this simple for the first iteration. Do NOT copy the nix-config pattern verbatim - adapt to this repo's simpler style (no home-manager integration, no impermanence).
  </action>
  <verify>File exists at modules/host-spec.nix, contains options.hostSpec with all listed options</verify>
  <done>host-spec.nix created with all typed options and descriptions</done>
</task>

<task type="auto">
  <name>Task 2: Wire host-spec into flake.nix mkHost function</name>
  <files>flake.nix</files>
  <action>
Modify the `mkHost` function in flake.nix to:

1. Import `./modules/host-spec.nix` in the modules list
2. Set `hostSpec.hostname` automatically from the hostname parameter
3. Set `hostSpec.system` from the system variable
4. Set `hostSpec.stateVersion` from the existing stateVersion variable

The mkHost function should pass these values so hosts don't need to set them manually. Individual hosts can still override other hostSpec options in their default.nix.

Keep existing functionality (overlays, inputs passing, etc.) - only ADD the host-spec integration.
  </action>
  <verify>grep for "host-spec" in flake.nix shows import, grep for "hostSpec" shows configuration</verify>
  <done>flake.nix imports host-spec module and sets hostname/system/stateVersion automatically</done>
</task>

<task type="auto">
  <name>Task 3: Verify flake evaluates correctly</name>
  <files>None (verification only)</files>
  <action>
Run `nix flake check` to verify the flake still evaluates correctly with the new host-spec module.

If there are errors, fix them. Common issues:
- Missing `lib` in module arguments (add it)
- Type mismatches (check lib.types usage)
- Circular imports (should not happen with this simple structure)

Also run `nix eval .#nixosConfigurations.malphas.config.hostSpec` to verify the hostSpec options are accessible and have correct defaults.
  </action>
  <verify>`nix flake check` passes, `nix eval` shows hostSpec values</verify>
  <done>Flake evaluates without errors, hostSpec accessible on malphas configuration</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `modules/host-spec.nix` exists with all specified options
- [ ] `flake.nix` imports host-spec and sets automatic values
- [ ] `nix flake check` passes without errors
- [ ] `nix eval .#nixosConfigurations.malphas.config.hostSpec.hostname` returns "malphas"
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No evaluation errors
- hostSpec pattern established and working
</success_criteria>

<output>
After completion, create `.planning/phases/01-module-architecture/01-01-SUMMARY.md`
</output>
