---
phase: 01-module-architecture
plan: 03
type: execute
---

<objective>
Migrate malphas to the new module architecture and validate with live rebuild.

Purpose: Prove the new architecture works on a real host, establish the pattern for other hosts.
Output: malphas using new module structure, successfully rebuilt and running.
</objective>

<execution_context>
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/templates/summary.md
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/references/checkpoints.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/01-module-architecture/01-01-SUMMARY.md
@.planning/phases/01-module-architecture/01-02-SUMMARY.md
@flake.nix
@hosts/malphas/default.nix
@modules/common/default.nix
@modules/opt-in/default.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update flake.nix to auto-import common modules</name>
  <files>flake.nix</files>
  <action>
Modify `mkHost` in flake.nix to automatically import common modules for all hosts.

Add `./modules/common` to the modules list in mkHost, so every host gets common modules without explicit imports.

The modules list should now include:
1. nixpkgs overlay configuration (existing)
2. `./modules/host-spec.nix` (from 01-01)
3. `./modules/common` (NEW - auto-applies common modules)
4. Host-specific configuration `./hosts/${hostname}/default.nix` (existing)
5. Other existing imports (unresolved, hostname setting, stateVersion)

Keep all existing functionality intact.
  </action>
  <verify>grep flake.nix for "modules/common" shows import in mkHost</verify>
  <done>flake.nix auto-imports common modules for all hosts</done>
</task>

<task type="auto">
  <name>Task 2: Update malphas to use new architecture</name>
  <files>hosts/malphas/default.nix</files>
  <action>
Update malphas default.nix to:

1. Remove import of `../../roles/universal.nix` (now auto-applied via common)
2. Set hostSpec options for malphas:
   ```nix
   hostSpec = {
     isDesktop = true;
     hasWifi = false;  # Desktop, no wifi
     primaryUser = "rain";
   };
   ```
3. Keep all other role imports as-is (they're opt-in)

The imports should now be cleaner - no universal.nix, and host characteristics declared via hostSpec.

Do NOT change any other configuration - preserve all existing functionality.
  </action>
  <verify>hosts/malphas/default.nix has hostSpec config, no universal.nix import</verify>
  <done>malphas uses hostSpec and doesn't import universal.nix</done>
</task>

<task type="auto">
  <name>Task 3: Verify configuration builds</name>
  <files>None (verification only)</files>
  <action>
Run verification commands:

1. `nix flake check` - Ensure flake evaluates correctly
2. `nix build .#nixosConfigurations.malphas.config.system.build.toplevel --dry-run` - Verify build would succeed
3. `nix eval .#nixosConfigurations.malphas.config.hostSpec` - Verify hostSpec values are set correctly

If any errors occur, diagnose and fix them. Common issues:
- Missing imports (check paths)
- Module argument issues (ensure lib, config, pkgs available)
- Conflicting options (check for duplicate definitions)
  </action>
  <verify>All three commands succeed without errors</verify>
  <done>Configuration builds successfully in dry-run</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>New module architecture with malphas migrated - ready for live rebuild</what-built>
  <how-to-verify>
    Run the actual system rebuild on malphas:

    1. Review changes: `git diff` to see all modifications
    2. Build and switch: `sudo nixos-rebuild switch --flake .#malphas`
    3. Verify system boots and works normally
    4. Check: `nixos-rebuild list-generations` shows new generation

    If rebuild fails, capture the error output.
    If system behaves unexpectedly after switch, describe the issue.
  </how-to-verify>
  <resume-signal>Type "approved" if rebuild succeeded and system works, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] flake.nix auto-imports common modules
- [ ] malphas uses hostSpec configuration
- [ ] malphas doesn't import universal.nix directly
- [ ] `nix flake check` passes
- [ ] Dry-run build succeeds
- [ ] Live rebuild approved by user
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Live system rebuild successful
- malphas running on new architecture
- Phase 1 complete
</success_criteria>

<output>
After completion, create `.planning/phases/01-module-architecture/01-03-SUMMARY.md`:

# Phase 1 Plan 3: Malphas Migration Summary

**[One-liner about what was accomplished]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `flake.nix` - Added common module auto-import
- `hosts/malphas/default.nix` - Migrated to hostSpec pattern

## Decisions Made
[Any decisions made during execution]

## Issues Encountered
[Problems and resolutions]

## Next Step
Phase 1 complete, ready for Phase 2: Disko Integration
</output>
