# Plan 17-01: LUKS Full Disk Encryption Migration

## Objective

Migrate all non-VM hosts from unencrypted disks to LUKS full disk encryption using the existing `btrfs-luks-impermanence` disko configuration. This protects age keys, secrets, and system state at rest from physical device theft.

**Priority**: FUTURE - Marked for later implementation
**Security Impact**: HIGH - Prevents cold boot attacks and physical key extraction

## Context

**Current State**:
- Age keys stored unencrypted at `/var/lib/sops-nix/key.txt` (mode 600)
- Hosts use `layout = "btrfs"` (no encryption)
- Physical device theft = full secret compromise
- Infrastructure exists but not deployed

**From Security Analysis** (conversation 2025-12-15):
- You do NOT have a YubiKey currently
- YubiKey should be optional future enhancement, not requirement
- Glass-key recovery is essential (homelab priority)
- Must support unattended boot for servers

**Available Infrastructure**:
- `modules/disks/btrfs-luks-impermanence-disk.nix` - LUKS + impermanence config
- Supports FIDO2 unlock (YubiKey) via `fido2-device=auto`
- Bootstrap script handles disk setup
- Disko manages partitioning

**Reference Files**:
- `modules/disks/btrfs-luks-impermanence-disk.nix` - LUKS configuration
- `hosts/TEMPLATE.nix` - Shows disk config options
- `scripts/bootstrap-nixos.sh` - Disk password handling

## Tasks

### 1. Audit Current Host Disk Configurations

**Type**: Investigation
**Files**: `hosts/*/default.nix`

**Action**:
1. List all hosts with their current disk layouts
2. Identify which hosts need LUKS (exclude VMs)
3. Document current partition schemes
4. Check if any hosts already use LUKS

**Verify**:
```bash
# Find all host disk configs
grep -r "disks.*layout" hosts/*/default.nix

# Check for existing LUKS usage
grep -r "luks" hosts/*/default.nix
```

**Done when**:
- [ ] All hosts catalogued with current disk layout
- [ ] VMs identified and excluded from LUKS requirement
- [ ] Physical hosts (desktop, laptop, server) identified for migration
- [ ] Document created: `.planning/phases/17-physical-security/host-disk-audit.md`

### 2. Create LUKS Configuration Options

**Type**: Module Enhancement
**Files**:
- `modules/disks/btrfs-luks-impermanence-disk.nix` (modify)
- `modules/disks/default.nix` (verify options)

**Action**:
1. Review current LUKS config - remove YubiKey as hard requirement
2. Make FIDO2 enrollment optional via boolean flag
3. Add options for:
   - `luksFido2Enable` (default: false) - YubiKey unlock
   - `luksPasswordFile` (required) - Passphrase for unlock
   - `luksAllowDiscards` (default: true) - SSD trim support
4. Document bootstrap password handling
5. Ensure fallback to password-only unlock works

**Verify**:
```nix
# Example host config should work without YubiKey
disks = {
  enable = true;
  layout = "btrfs-luks-impermanence";
  device = "/dev/nvme0n1";
  luksFido2Enable = false;  # No YubiKey required
  withSwap = true;
  swapSize = "16";
};
```

**Done when**:
- [ ] LUKS works with password-only unlock
- [ ] FIDO2 support is optional, controlled by flag
- [ ] Build succeeds with LUKS enabled
- [ ] Disko config validates without YubiKey package

### 3. Create Backup & Migration Procedure

**Type**: Documentation
**Files**: `docs/luks-migration.md` (create)

**Action**:
Write comprehensive migration guide covering:

1. **Pre-Migration Checklist**:
   - Full system backup (rsync, timeshift, etc.)
   - Verify nix-config and nix-secrets are committed and pushed
   - Test glass-key recovery procedure
   - Document current partition layout
   - Prepare bootable USB with NixOS installer

2. **Migration Steps** (per host):
   - Boot from USB installer
   - Run bootstrap script with LUKS layout
   - Restore /persist data from backup
   - Verify boot and secret decryption
   - Test passphrase unlock

3. **Rollback Procedure**:
   - Boot from USB
   - Reinstall with previous layout
   - Restore from backup
   - Verify system functional

4. **Post-Migration Verification**:
   - Check LUKS encryption active: `lsblk -f`
   - Verify age key protected: `stat /var/lib/sops-nix/key.txt`
   - Test secret decryption: `ls /run/secrets/`
   - Confirm unattended boot works
   - Document passphrase storage (password manager)

**Verify**:
```bash
# After migration, verify LUKS active
lsblk -f | grep crypto_LUKS

# Check age key inside encrypted volume
df -h /var/lib/sops-nix/
```

**Done when**:
- [ ] Migration guide is comprehensive and tested
- [ ] Backup procedures documented
- [ ] Rollback procedure validated
- [ ] Post-migration checks defined
- [ ] Passphrase management guidance provided

### 4. Create Per-Host Migration Plans

**Type**: Planning
**Files**: `.planning/phases/17-physical-security/host-migrations/*.md` (create)

**Action**:
For each physical host identified in Task 1:

1. Create individual migration plan file
2. Document host-specific considerations:
   - Current disk device (`/dev/nvme0n1`, `/dev/sda`, etc.)
   - Partition scheme changes
   - Data to preserve from /persist
   - Estimated downtime
   - Testing requirements
3. Order hosts by migration priority:
   - Test on non-critical host first
   - Production hosts last
4. Define success criteria per host

**Example** (`host-migrations/malphas.md`):
```markdown
# Malphas LUKS Migration

**Device**: /dev/nvme0n1
**Current Layout**: btrfs (unencrypted)
**Target Layout**: btrfs-luks-impermanence
**Priority**: Medium (desktop, can tolerate downtime)

## Preserve
- /persist/home/rain/.ssh/
- /persist/passwords/ (if exists)

## Migration Window
- Weekend preferred
- 2-hour estimated downtime
- Backup completed: [date]

## Success Criteria
- Boots with passphrase unlock
- Secrets decrypt correctly
- User data intact
- Services functional
```

**Done when**:
- [ ] Migration plan created for each physical host
- [ ] Hosts ordered by priority
- [ ] Per-host success criteria defined
- [ ] Downtime windows estimated

### 5. Test LUKS on Test Host/VM

**Type**: Validation
**Files**:
- `hosts/griefling/default.nix` (test VM - optional)
- Create test host config if needed

**Action**:
1. If possible, test LUKS on a VM or test host first
2. Enable LUKS layout in test host config
3. Build and deploy
4. Verify:
   - Boot process requires passphrase
   - Age key is inside encrypted volume
   - Secrets decrypt correctly
   - Impermanence works (/ wipes on reboot)
5. Document any issues encountered
6. Test password-only unlock (no FIDO2)

**Verify**:
```bash
# On test host after LUKS deployment
cryptsetup status encrypted-nixos
lsblk -f | grep crypto_LUKS
stat /var/lib/sops-nix/key.txt
ls /run/secrets/
```

**Done when**:
- [ ] LUKS tested on non-production system
- [ ] Password unlock verified working
- [ ] Age key confirmed protected
- [ ] Secrets decrypt correctly
- [ ] Issues documented and resolved
- [ ] Migration procedure validated

### 6. Add Optional YubiKey Support (Future)

**Type**: Enhancement (Optional, Future Work)
**Files**:
- `modules/disks/btrfs-luks-impermanence-disk.nix`
- `docs/yubikey-enrollment.md` (create)

**Action**:
Document how to add YubiKey unlock AFTER initial LUKS deployment:

1. **Prerequisites**:
   - YubiKey 5 or later with FIDO2
   - yubikey-manager installed
   - System booted and unlocked with password

2. **Enrollment Steps**:
   ```bash
   # Enroll YubiKey for LUKS unlock
   sudo systemd-cryptenroll --fido2-device=auto /dev/nvme0n1p2

   # Verify enrollment
   sudo cryptsetup luksDump /dev/nvme0n1p2
   ```

3. **Multi-Factor Unlock**:
   - Password OR YubiKey (either works)
   - Can have multiple YubiKeys enrolled
   - Password remains as backup

4. **Update host config**:
   ```nix
   disks = {
     luksFido2Enable = true;  # Enable YubiKey support
   };
   ```

**Verify**:
```bash
# Check FIDO2 token enrolled
sudo cryptsetup luksDump /dev/nvme0n1p2 | grep -A5 "Token"
```

**Done when**:
- [ ] YubiKey enrollment procedure documented
- [ ] Tested on one host (when YubiKey available)
- [ ] Fallback to password verified working
- [ ] Multiple YubiKey support documented

## Success Criteria

- [ ] All physical hosts identified and catalogued
- [ ] LUKS configuration supports password-only unlock (no YubiKey required)
- [ ] Migration procedure documented and tested
- [ ] Per-host migration plans created
- [ ] At least one host successfully migrated to LUKS (or test validated)
- [ ] Age keys confirmed protected inside encrypted volume
- [ ] Unattended boot works (password entry at boot only)
- [ ] Glass-key recovery still functional with LUKS
- [ ] Optional YubiKey support documented for future use

## Files to Create/Modify

**Create**:
- `docs/luks-migration.md` - Migration procedure
- `docs/yubikey-enrollment.md` - Optional YubiKey setup
- `.planning/phases/17-physical-security/host-disk-audit.md` - Audit results
- `.planning/phases/17-physical-security/host-migrations/*.md` - Per-host plans

**Modify**:
- `modules/disks/btrfs-luks-impermanence-disk.nix` - Make FIDO2 optional
- `modules/disks/default.nix` - Add LUKS options
- `hosts/*/default.nix` - Update disk configs (during migration)

## Files to Reference

- `modules/disks/btrfs-luks-impermanence-disk.nix:32-44` - Current LUKS config
- `modules/disks/default.nix` - Disk options
- `hosts/TEMPLATE.nix:64-71` - Disk configuration example
- `scripts/bootstrap-nixos.sh` - Bootstrap with LUKS

## Notes

**This is FUTURE WORK - Do not implement now.**

- Migration requires physical access to each host
- Estimated 1-2 hours downtime per host
- Test on non-critical host first
- Keep backups until LUKS validated
- Passphrase must be stored securely (password manager)
- YubiKey is optional enhancement, not requirement
- Glass-key recovery takes priority over zero-trust

**Security Properties After Migration**:
- ✅ Cold boot attack prevented (disk encrypted when off)
- ✅ Age keys encrypted at rest
- ✅ Physical theft of powered-off device = safe
- ❌ Hot boot attack not prevented (stolen while running = exposed)
- ❌ RAM dump attacks not prevented (secrets in memory)
- ✅ Glass-key recovery still works (LUKS passphrase stored securely)
