# Plan 17-02: Device Stolen Response Runbook

## Objective

Create a comprehensive incident response runbook for physical device compromise (theft, loss, confiscation). The runbook provides step-by-step procedures to minimize damage, rotate credentials, and restore security after a device is stolen.

**Priority**: FUTURE - Marked for later implementation (but review BEFORE deployment)
**Security Impact**: CRITICAL - Determines recovery time and exposure window

## Context

**Threat Model**:
- Attacker steals physical device (laptop, desktop)
- Attacker extracts `/var/lib/sops-nix/key.txt` (age private key)
- Attacker clones `nix-secrets` repo from GitHub
- Attacker can decrypt ALL historical secrets encrypted for that key
- New secrets (post-rotation) are safe

**Attack Timeline**:
```
T+0:     Device stolen, attacker extracts age key
T+1h:    You notice theft, begin response
T+2h:    Attacker clones nix-secrets, decrypts all secrets
T+4h:    You complete key rotation, new secrets encrypted
Result:  Old secrets exposed, new secrets safe, services disrupted
```

**Response Goals**:
1. Minimize exposure window (< 1 hour response time)
2. Rotate all compromised credentials
3. Revoke device access to infrastructure
4. Monitor for unauthorized access
5. Restore secure operations

**Reference Files**:
- `scripts/sops-rotate.sh` - Key rotation infrastructure (Phase 16-03)
- `justfile` - SOPS management commands
- `docs/sops-rotation.md` - Rotation procedures
- `.planning/phases/16-sops-key-management/16-03-PLAN.md` - Rotation design

## Tasks

### 1. Create Immediate Response Checklist (T+0 to T+15min)

**Type**: Documentation
**Files**: `docs/incident-response/device-stolen.md` (create)

**Action**:
Write the critical first-response checklist (execute in order):

1. **Confirm Theft** (0-5 min):
   - Verify device is actually stolen (not misplaced)
   - Identify which device: hostname, role, secrets access
   - Check last-seen time (Tailscale, logs)
   - Document: When stolen, where, circumstances

2. **Immediate Network Isolation** (5-10 min):
   - Tailscale: Disable device from admin console
   - Revoke SSH authorized_keys if exposed
   - Check if device is online (Tailscale, ping)
   - If online: Monitor for anomalous activity

3. **Alert Team/Family** (if applicable) (10-15 min):
   - Notify anyone else with secrets access
   - Coordinate simultaneous response
   - Assign tasks if multiple people available

4. **Gather Device Info**:
   - Hostname: `[device-name]`
   - Age key fingerprint: `age1...`
   - SSH host key: `ssh-ed25519 AAAA...`
   - Secrets encrypted for this key: `[list]`
   - Services running: `[list]`

**Verify**:
```bash
# Check device status
tailscale status | grep [device-name]

# Check which secrets use this key
cd nix-secrets
grep "age1..." .sops.yaml
```

**Done when**:
- [ ] Immediate response checklist is clear and actionable
- [ ] Device identification steps documented
- [ ] Network isolation commands ready
- [ ] Info gathering template created

### 2. Create Key Rotation Procedure (T+15min to T+1h)

**Type**: Documentation
**Files**: `docs/incident-response/device-stolen.md` (continue)

**Action**:
Document the key rotation workflow:

1. **Remove Compromised Key from .sops.yaml** (15-20 min):
   ```bash
   cd nix-secrets

   # Backup current config
   cp .sops.yaml .sops.yaml.backup

   # Edit .sops.yaml - remove compromised key
   # Remove line with age1[stolen-key]
   sops .sops.yaml

   # Or programmatically
   yq '.keys = [.keys[] | select(.age != "age1[stolen-key]")]' .sops.yaml > .sops.yaml.new
   mv .sops.yaml.new .sops.yaml
   ```

2. **Rekey All Secrets** (20-40 min):
   ```bash
   # Using existing rotation infrastructure
   cd nix-config
   just rekey

   # This runs sops-rekey on all secret files
   # Commits changes to nix-secrets
   # Pushes to remote
   ```

3. **Verify Rekeying** (40-45 min):
   ```bash
   cd nix-secrets

   # Check that stolen key cannot decrypt
   sops -d sops/[hostname].yaml
   # Should fail if stolen key removed

   # Check remaining hosts can still decrypt
   # Test on one host
   ssh [other-host] "sudo ls /run/secrets/"
   ```

4. **Deploy to All Hosts** (45-60 min):
   ```bash
   # Trigger rebuild on all hosts
   # Auto-update system will pull changes

   # Or manually trigger
   just deploy-all  # If command exists

   # Or per-host
   ssh [host] "sudo nixos-rebuild switch --flake ~/nix-config"
   ```

**Done when**:
- [ ] Key removal procedure documented
- [ ] Rekey commands clear and tested
- [ ] Verification steps defined
- [ ] Deployment procedure documented
- [ ] Uses existing rotation infrastructure

### 3. Create Secret Rotation Checklist (T+1h to T+4h)

**Type**: Documentation
**Files**: `docs/incident-response/device-stolen.md` (continue)

**Action**:
Document credential rotation for each secret type:

1. **Tailscale Auth Keys**:
   ```bash
   # Revoke old auth keys
   tailscale logout --force [device]

   # Generate new auth key
   # Via admin console or API

   # Update secret in nix-secrets
   cd nix-secrets
   sops sops/shared.yaml
   # Update tailscale_auth_key value
   ```

2. **API Tokens** (priority order):
   - GitHub Personal Access Tokens
   - Cloud provider tokens (if any)
   - Service API keys (Stripe, etc.)
   - Webhook secrets

   For each:
   ```bash
   # 1. Revoke old token via provider console
   # 2. Generate new token
   # 3. Update in nix-secrets
   sops sops/[hostname].yaml
   # Update token value
   ```

3. **Service Passwords**:
   - Database passwords
   - Admin passwords
   - Service account passwords

   ```bash
   # Update password in service
   # Update in nix-secrets
   sops sops/[hostname].yaml
   ```

4. **SSH Keys** (if stored in secrets):
   ```bash
   # Generate new SSH key
   ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519_new

   # Update authorized_keys on all targets
   # Update secret in nix-secrets
   ```

5. **GPG Keys** (if stored in secrets):
   - Revoke old key
   - Generate new key
   - Update in secrets

**Priority Matrix**:
| Secret Type | Rotation Priority | Exposure Impact |
|-------------|------------------|-----------------|
| Tailscale auth | CRITICAL (1h) | Full network access |
| API tokens | HIGH (2h) | Service compromise |
| Database passwords | HIGH (2h) | Data breach |
| SSH keys | MEDIUM (4h) | Server access |
| Service passwords | MEDIUM (4h) | Service disruption |
| GPG keys | LOW (24h) | Email compromise |

**Done when**:
- [ ] Rotation checklist covers all secret types
- [ ] Commands documented for each type
- [ ] Priority order defined
- [ ] Update procedures clear

### 4. Create Monitoring & Detection Procedures (T+0 to T+24h)

**Type**: Documentation
**Files**: `docs/incident-response/device-stolen.md` (continue)

**Action**:
Document how to monitor for unauthorized access:

1. **Immediate Monitoring** (T+0 to T+4h):
   ```bash
   # Tailscale activity logs
   tailscale status
   tailscale netcheck

   # Check for new connections
   # Admin console → Machines → Activity

   # SSH access logs
   ssh [host] "sudo journalctl -u sshd --since '1 hour ago'"

   # Failed authentication attempts
   ssh [host] "sudo journalctl | grep -i 'failed password'"
   ```

2. **Service-Specific Logs**:
   - GitHub: Check access log for PAT usage
   - Cloud providers: Check audit logs
   - Databases: Check connection logs
   - APIs: Check request logs

3. **Anomaly Detection**:
   - Unusual API calls
   - New SSH connections
   - Unexpected rebuilds
   - Secret decryption attempts
   - New device enrollments

4. **Continuous Monitoring** (T+4h to T+7d):
   - Daily log review for 7 days
   - Watch for delayed attacks
   - Monitor for lateral movement
   - Check for persistence mechanisms

**Alerting Setup** (optional, future):
   - Webhook on new Tailscale device
   - Email on failed SSH attempts
   - Slack/Discord notification on secret access
   - Automated log analysis

**Done when**:
- [ ] Monitoring procedures documented
- [ ] Log check commands provided
- [ ] Anomaly detection guidance written
- [ ] Timeline for monitoring defined

### 5. Create Post-Incident Review Template (T+7d)

**Type**: Documentation
**Files**: `docs/incident-response/device-stolen.md` (continue)

**Action**:
Document post-incident analysis process:

1. **Timeline Reconstruction**:
   - When was device stolen?
   - When was theft noticed?
   - Response time to key rotation?
   - When were all secrets rotated?

2. **Impact Assessment**:
   - What secrets were exposed?
   - Were they accessed by attacker?
   - What services were affected?
   - What data was compromised?

3. **Response Effectiveness**:
   - What went well?
   - What went poorly?
   - What would you do differently?
   - Were runbooks accurate?

4. **Improvements Needed**:
   - Update runbooks based on experience
   - Automate manual steps
   - Reduce response time
   - Add missing monitoring

5. **Prevention Measures**:
   - Should LUKS have been enabled?
   - Were secrets properly segmented?
   - Should rotation frequency increase?
   - Physical security improvements?

**Template** (`incident-reports/YYYY-MM-DD-device-stolen.md`):
```markdown
# Incident Report: Device Stolen

**Date**: YYYY-MM-DD
**Device**: [hostname]
**Reporter**: [name]

## Timeline
- T+0: Device stolen at [location]
- T+[Xh]: Theft noticed
- T+[Xh]: Response initiated
- T+[Xh]: Key rotated
- T+[Xh]: Secrets rotated
- T+[Xh]: All hosts secured

## Impact
- Secrets exposed: [list]
- Services affected: [list]
- Downtime: [duration]
- Evidence of access: [Y/N]

## Response Actions
- [x] Device isolated
- [x] Key rotated
- [x] Secrets rotated
- [x] Monitoring enabled

## Lessons Learned
- What worked: [...]
- What failed: [...]
- Improvements: [...]

## Prevention
- [ ] Enable LUKS on remaining hosts
- [ ] Reduce secret count
- [ ] Increase rotation frequency
- [ ] Add monitoring
```

**Done when**:
- [ ] Post-incident template created
- [ ] Analysis questions documented
- [ ] Improvement tracking defined
- [ ] Incident report format defined

### 6. Create Runbook Quick Reference Card

**Type**: Documentation
**Files**: `docs/incident-response/QUICK-REFERENCE.md` (create)

**Action**:
Create a one-page quick reference for emergency use:

```markdown
# DEVICE STOLEN - QUICK REFERENCE

## IMMEDIATE (0-15 min)
1. Disable Tailscale device
2. Check if device online
3. Identify hostname and key
4. Alert others (if applicable)

## KEY ROTATION (15-60 min)
```bash
cd nix-secrets
# Remove stolen key from .sops.yaml
sops .sops.yaml  # Delete age1[stolen-key] line
cd ../nix-config
just rekey  # Rekey all secrets
```

## SECRET ROTATION (1-4h)
Priority order:
1. Tailscale auth (1h)
2. API tokens (2h)
3. Database passwords (2h)
4. SSH keys (4h)

## MONITORING (0-7d)
```bash
# Check Tailscale logs
tailscale status
# Check SSH logs
ssh [host] "sudo journalctl -u sshd --since '1 hour ago'"
# Check for anomalies daily for 7 days
```

## FULL RUNBOOK
See: docs/incident-response/device-stolen.md

## EMERGENCY CONTACTS
- [Your contact info]
- [Backup contact if applicable]
```

**Print this and keep it accessible offline.**

**Done when**:
- [ ] Quick reference is one page
- [ ] Commands are copy-paste ready
- [ ] Priority order is clear
- [ ] Links to full runbook included

## Success Criteria

- [ ] Device stolen runbook is comprehensive and actionable
- [ ] Response time target is < 1 hour for key rotation
- [ ] All critical secrets have rotation procedures
- [ ] Monitoring procedures are defined
- [ ] Post-incident template created
- [ ] Quick reference card is printable
- [ ] Runbook tested on paper (walk through steps)
- [ ] Commands are validated and work
- [ ] Integration with existing rotation infrastructure (Plan 16-03)

## Files to Create

**Create**:
- `docs/incident-response/device-stolen.md` - Full runbook
- `docs/incident-response/QUICK-REFERENCE.md` - One-page emergency guide
- `docs/incident-response/incident-reports/` - Directory for post-incident reports

## Files to Reference

- `scripts/sops-rotate.sh` - Key rotation infrastructure
- `docs/sops-rotation.md` - Rotation procedures
- `justfile:490-530` - SOPS management commands
- `.planning/phases/16-sops-key-management/16-03-PLAN.md` - Rotation design

## Notes

**This is FUTURE WORK - Do not implement now.**

- Runbook should be accessible even if all devices are compromised
- Print quick reference and store securely
- Test runbook procedures periodically (quarterly drill)
- Update based on infrastructure changes
- Keep offline copy (paper) in secure location

**Response Time Targets**:
- Notice theft: < 30 minutes
- Begin response: < 15 minutes
- Key rotation: < 1 hour
- Critical secrets: < 2 hours
- All secrets: < 4 hours
- Monitoring: 7 days continuous

**Prevention is Better**:
- This runbook is damage control, not prevention
- Enable LUKS (Plan 17-01) to prevent key extraction
- Implement monitoring to detect theft faster
- Regular rotation reduces impact window
- Secret segmentation limits blast radius
