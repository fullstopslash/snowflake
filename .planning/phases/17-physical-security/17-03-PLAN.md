# Plan 17-03: Glass-Key Disaster Recovery System

## Objective

Implement a complete "break glass" disaster recovery system that allows rebuilding the entire infrastructure from nothing but offline physical backups. This is ESSENTIAL for a homelab where zero-trust external dependencies are unacceptable.

**Priority**: FUTURE - But CRITICAL to implement before production deployment
**Recovery Impact**: CRITICAL - Enables complete infrastructure rebuild from catastrophic loss

## Context

**Disaster Scenarios**:
1. **Total Infrastructure Loss**: All devices destroyed/stolen (fire, flood, etc.)
2. **Account Lockout**: GitHub account compromised, repos deleted
3. **Crypto Locked**: nix-secrets repo corrupted, keys lost
4. **Single Point of Failure**: Only one key, device fails

**Glass-Key Principle**:
> With only physical backup materials (paper, metal, USB), you can reconstruct:
> - All secrets (via age master key)
> - All configurations (via repo backups)
> - All hosts (via bootstrap scripts)
> - All services (via declarative configs)

**Homelab Priority**:
- Self-sovereignty > External dependencies
- Offline recovery > Cloud backup
- Physical control > Service availability
- Long-term resilience > Convenience

**Current State** (from conversation):
- You mentioned glass-keys should exist, but unclear if implemented
- Age keys exist per-host, but no master recovery key
- Secrets in nix-secrets repo (GitHub)
- No documented offline recovery procedure

**Reference Files**:
- `modules/common/sops.nix` - Age key configuration
- `scripts/bootstrap-nixos.sh` - Host bootstrap
- `docs/sops-rotation.md` - Key rotation
- `.sops.yaml` in nix-secrets - Key recipients

## Tasks

### 1. Create Master Age Key for Glass-Key Recovery

**Type**: Key Generation
**Files**:
- `docs/disaster-recovery/master-key-setup.md` (create)
- `.sops.yaml` in nix-secrets (modify)

**Action**:
1. **Generate Master Age Key**:
   ```bash
   # On secure machine (preferably air-gapped)
   age-keygen -o master-recovery-key.txt

   # Output:
   # Public key: age1[master-public-key]
   # (Private key written to master-recovery-key.txt)
   ```

2. **Add Master Key to .sops.yaml**:
   ```yaml
   keys:
     # Master recovery key - NEVER stored on any host
     - &master age1[master-public-key]

     # Per-host keys
     - &host1 age1[host1-key]
     - &host2 age1[host2-key]

   creation_rules:
     # All secrets encrypted for master key + host keys
     - path_regex: sops/.*\\.yaml$
       key_groups:
         - age:
           - *master
           - *host1
           - *host2
   ```

3. **Rekey All Secrets with Master Key**:
   ```bash
   cd nix-secrets
   # Master key now in .sops.yaml
   cd ../nix-config
   just rekey
   # All secrets now decryptable with master key
   ```

4. **Verify Master Key Can Decrypt**:
   ```bash
   # Test decryption with master key
   SOPS_AGE_KEY_FILE=~/master-recovery-key.txt \
     sops -d nix-secrets/sops/shared.yaml
   # Should decrypt successfully
   ```

**Security Properties**:
- Master key NEVER stored on any host
- Master key NEVER committed to git
- Master key stored only in glass-key backups
- All secrets decryptable with master key alone
- Loss of all host keys = recoverable via master key

**Done when**:
- [ ] Master age key generated
- [ ] Master key added to .sops.yaml
- [ ] All secrets rekeyed with master key
- [ ] Master key decryption tested
- [ ] Master key stored securely (pending Task 2)

### 2. Create Physical Glass-Key Backups

**Type**: Physical Backup Creation
**Files**:
- `docs/disaster-recovery/glass-key-creation.md` (create)
- `docs/disaster-recovery/glass-key-storage.md` (create)

**Action**:
Create multiple physical backup formats:

1. **Paper Backup (Primary)**:
   ```
   MASTER AGE KEY - DISASTER RECOVERY
   Created: YYYY-MM-DD

   Private Key:
   AGE-SECRET-KEY-1[rest-of-private-key-here]

   Public Key:
   age1[public-key-here]

   Recovery Instructions:
   1. Install NixOS with network
   2. Clone: git clone https://github.com/user/nix-config
   3. Save this key to: ~/master-recovery-key.txt
   4. Decrypt secrets: SOPS_AGE_KEY_FILE=~/master-recovery-key.txt sops -d ...
   5. See: docs/disaster-recovery/total-recovery.md

   STORE SECURELY - Can decrypt all secrets
   ```

   **Print Instructions**:
   - Use laser printer (inkjet fades)
   - Print 3 copies minimum
   - Laminate for water resistance
   - Store in fireproof safe
   - Consider safety deposit box for one copy

2. **Metal Backup (Long-Term)**:
   - Use metal letter stamps or engraving
   - Stainless steel plate (fire/water resistant)
   - Stamp private key only (public recoverable)
   - Store in separate secure location
   - Tested recovery time: ~10 years minimum

3. **USB Backup (Convenience)**:
   ```bash
   # Create encrypted USB backup
   # 1. Format USB drive
   # 2. Create encrypted container
   cryptsetup luksFormat /dev/sdX
   cryptsetup open /dev/sdX glass-key-backup

   # 3. Copy materials
   mkdir /mnt/glass-key
   mount /dev/mapper/glass-key-backup /mnt/glass-key

   cp master-recovery-key.txt /mnt/glass-key/
   cp -r nix-config/ /mnt/glass-key/
   cp -r nix-secrets/ /mnt/glass-key/

   # 4. Create recovery instructions
   cat > /mnt/glass-key/RECOVERY.md << 'EOF'
   # Disaster Recovery from USB Backup

   This USB contains:
   - master-recovery-key.txt (age private key)
   - nix-config/ (latest snapshot)
   - nix-secrets/ (latest snapshot)

   See RECOVERY.md for full instructions.
   EOF

   umount /mnt/glass-key
   cryptsetup close glass-key-backup
   ```

   **USB Security**:
   - LUKS encrypted
   - Strong passphrase (different from LUKS disk passphrase)
   - Update quarterly with latest configs
   - Store offline in secure location
   - Test recovery annually

4. **QR Code Backup (Alternative)**:
   - Generate QR code of private key
   - Print on paper backup
   - Allows phone camera scan for recovery
   - Faster than manual typing
   - Test scanning before storing

**Storage Strategy**:
- **Location 1**: Home safe (paper + USB)
- **Location 2**: Off-site secure location (paper + metal)
- **Location 3**: Trusted family/friend (paper, sealed envelope)
- **Never store**: Cloud, password managers, any network-accessible location

**Done when**:
- [ ] Paper backups created (minimum 3 copies)
- [ ] Metal backup created (optional, recommended)
- [ ] USB backup created and encrypted
- [ ] Storage locations documented (offline only)
- [ ] Recovery instructions printed with each backup
- [ ] Test recovery performed (Task 5)

### 3. Create Offline Repository Backups

**Type**: Configuration Backup
**Files**:
- `docs/disaster-recovery/repo-backup.md` (create)
- `scripts/create-glass-key-backup.sh` (create)

**Action**:
Create automated backup script for configs:

```bash
#!/usr/bin/env bash
# scripts/create-glass-key-backup.sh
# Creates offline backup bundle for disaster recovery

set -euo pipefail

BACKUP_DIR="${1:-$HOME/glass-key-backup-$(date +%Y%m%d)}"
MASTER_KEY="${2:-$HOME/master-recovery-key.txt}"

echo "Creating glass-key backup bundle..."
mkdir -p "$BACKUP_DIR"

# 1. Clone/copy configs
echo "Backing up nix-config..."
cp -r ~/nix-config "$BACKUP_DIR/"
cd "$BACKUP_DIR/nix-config"
git bundle create ../nix-config.bundle --all
cd -

echo "Backing up nix-secrets..."
cp -r ~/nix-secrets "$BACKUP_DIR/"
cd "$BACKUP_DIR/nix-secrets"
git bundle create ../nix-secrets.bundle --all
cd -

# 2. Copy master key
if [ -f "$MASTER_KEY" ]; then
  echo "Including master recovery key..."
  cp "$MASTER_KEY" "$BACKUP_DIR/master-recovery-key.txt"
else
  echo "WARNING: Master key not found at $MASTER_KEY"
  echo "Manual copy required!"
fi

# 3. Create recovery instructions
cat > "$BACKUP_DIR/RECOVERY.md" << 'EOF'
# Glass-Key Disaster Recovery

This bundle contains everything needed to rebuild from total loss.

## Contents
- nix-config/ - Full configuration repo
- nix-config.bundle - Git bundle (works without GitHub)
- nix-secrets/ - All encrypted secrets
- nix-secrets.bundle - Git bundle
- master-recovery-key.txt - Age key to decrypt all secrets
- RECOVERY.md - This file

## Recovery Steps

### 1. Install Base NixOS
1. Boot NixOS installer USB
2. Connect to network
3. Install minimal system:
   ```bash
   sudo nix-shell -p git age sops
   ```

### 2. Restore Repositories
```bash
# From git bundles (no GitHub needed)
git clone nix-config.bundle nix-config
git clone nix-secrets.bundle nix-secrets

# Or from GitHub (if available)
git clone https://github.com/[user]/nix-config
git clone https://github.com/[user]/nix-secrets
```

### 3. Decrypt Secrets
```bash
# Set master key
export SOPS_AGE_KEY_FILE=~/master-recovery-key.txt

# Test decryption
sops -d nix-secrets/sops/shared.yaml
```

### 4. Bootstrap First Host
```bash
cd nix-config
sudo ./scripts/bootstrap-nixos.sh -n [hostname] -d /dev/sda

# Follow bootstrap prompts
# Master key allows decrypting all secrets
```

### 5. Rebuild Infrastructure
- Bootstrap remaining hosts
- Restore services
- Verify secrets decrypt
- Update glass-key backups

See: nix-config/docs/disaster-recovery/total-recovery.md
EOF

# 4. Create verification checklist
cat > "$BACKUP_DIR/VERIFICATION.md" << 'EOF'
# Glass-Key Backup Verification

## Before Storing
- [ ] nix-config repo copied
- [ ] nix-secrets repo copied
- [ ] Git bundles created
- [ ] Master key included
- [ ] RECOVERY.md present
- [ ] All files readable

## Test Recovery (Annually)
- [ ] Boot test VM
- [ ] Clone from bundle
- [ ] Decrypt test secret
- [ ] Bootstrap test host
- [ ] Verify all secrets accessible

## Update Schedule
- [ ] Quarterly: Update USB backup
- [ ] Annually: Test full recovery
- [ ] After major changes: Re-snapshot
- [ ] After key rotation: New backups
EOF

# 5. Create backup manifest
cat > "$BACKUP_DIR/MANIFEST.txt" << EOF
Glass-Key Backup Manifest
Created: $(date)
Hostname: $(hostname)
User: $(whoami)

Contents:
$(find "$BACKUP_DIR" -type f -exec ls -lh {} \; | awk '{print $9, $5}')

Checksums (SHA256):
$(find "$BACKUP_DIR" -type f -exec sha256sum {} \;)

Git Status:
nix-config: $(cd ~/nix-config && git rev-parse HEAD)
nix-secrets: $(cd ~/nix-secrets && git rev-parse HEAD)
EOF

echo "✓ Glass-key backup created: $BACKUP_DIR"
echo "Next steps:"
echo "1. Copy to USB drive"
echo "2. Encrypt USB (cryptsetup)"
echo "3. Store securely offline"
echo "4. Update paper backups if keys changed"
```

**Usage**:
```bash
# Create backup bundle
./scripts/create-glass-key-backup.sh

# Copy to USB
cp -r ~/glass-key-backup-YYYYMMDD /mnt/usb/

# Verify
cd /mnt/usb/glass-key-backup-YYYYMMDD
bash VERIFICATION.md  # Follow checklist
```

**Done when**:
- [ ] Backup script created and tested
- [ ] Git bundles work without network
- [ ] Recovery instructions are complete
- [ ] Verification checklist created
- [ ] Automated backup tested end-to-end

### 4. Document Complete Recovery Procedure

**Type**: Documentation
**Files**: `docs/disaster-recovery/total-recovery.md` (create)

**Action**:
Write step-by-step total infrastructure recovery guide:

**Scenario**: "My house burned down, all devices lost, only glass-key backups remain"

**Recovery Procedure**:

1. **Acquire Hardware** (Day 1):
   - Purchase new machine
   - Create NixOS installer USB
   - Retrieve glass-key backups from off-site storage

2. **Install Base System** (Day 1):
   ```bash
   # Boot installer
   # Configure network
   # Install minimal NixOS
   nix-shell -p git age sops
   ```

3. **Restore Configurations** (Day 1):
   ```bash
   # Option A: From git bundles (offline)
   git clone /path/to/nix-config.bundle nix-config
   git clone /path/to/nix-secrets.bundle nix-secrets

   # Option B: From GitHub (if accessible)
   git clone https://github.com/user/nix-config
   git clone https://github.com/user/nix-secrets

   # Verify clones
   cd nix-config && git log -1
   cd ../nix-secrets && git log -1
   ```

4. **Decrypt Secrets with Master Key** (Day 1):
   ```bash
   # Copy master key from backup
   cp /path/to/master-recovery-key.txt ~/.
   chmod 600 ~/master-recovery-key.txt

   # Test decryption
   export SOPS_AGE_KEY_FILE=~/master-recovery-key.txt
   sops -d nix-secrets/sops/shared.yaml
   # Should show decrypted YAML
   ```

5. **Bootstrap First Host** (Day 1-2):
   ```bash
   cd nix-config

   # Run bootstrap with master key available
   sudo SOPS_AGE_KEY_FILE=~/master-recovery-key.txt \
     ./scripts/bootstrap-nixos.sh \
     -n [new-hostname] \
     -d /dev/nvme0n1

   # Bootstrap will:
   # - Generate NEW host age key
   # - Add to .sops.yaml
   # - Rekey secrets (still encrypted for master)
   # - Deploy system
   ```

6. **Verify First Host** (Day 2):
   ```bash
   # Check secrets decrypted
   sudo ls /run/secrets/

   # Check services running
   systemctl status

   # Check Tailscale connected
   tailscale status

   # Test SSH to self
   ssh localhost
   ```

7. **Rebuild Infrastructure** (Day 2-7):
   - Bootstrap remaining hosts using same procedure
   - Each gets new age key
   - All encrypted with master key
   - Services come online incrementally

8. **Update Glass-Key Backups** (Day 7):
   - New hosts = new .sops.yaml
   - Create fresh backup bundle
   - Update paper/metal backups if master key changed
   - Store securely

**Recovery Time Estimates**:
- Base system: 2-4 hours
- First host: 4-8 hours
- All hosts (5): 2-3 days
- Full services: 5-7 days

**Dependencies**:
- Network access (for Nix packages)
- Glass-key backups accessible
- Hardware available for purchase
- Time to rebuild (not instant)

**Done when**:
- [ ] Total recovery procedure documented
- [ ] Step-by-step instructions complete
- [ ] Recovery time estimated
- [ ] Dependencies identified
- [ ] Procedure tested (Task 5)

### 5. Test Disaster Recovery Procedure

**Type**: Validation
**Files**:
- `.planning/phases/17-physical-security/recovery-test-YYYY-MM-DD.md` (create)

**Action**:
Perform actual recovery test to validate procedure:

1. **Setup Test Environment**:
   - Create VM or use spare hardware
   - Do NOT use production systems
   - Simulate having only glass-key backups

2. **Test Recovery Steps**:
   ```bash
   # Start with clean VM
   # Boot NixOS installer

   # Step 1: Install minimal system
   nix-shell -p git age sops

   # Step 2: Clone from bundles
   git clone /path/to/nix-config.bundle nix-config
   git clone /path/to/nix-secrets.bundle nix-secrets

   # Step 3: Decrypt with master key
   export SOPS_AGE_KEY_FILE=/path/to/master-recovery-key.txt
   sops -d nix-secrets/sops/shared.yaml

   # Step 4: Bootstrap test host
   cd nix-config
   sudo SOPS_AGE_KEY_FILE=$SOPS_AGE_KEY_FILE \
     ./scripts/bootstrap-nixos.sh -n recovery-test -d /dev/vda

   # Step 5: Verify
   sudo ls /run/secrets/
   systemctl status
   ```

3. **Document Test Results**:
   - What worked?
   - What failed?
   - What was missing from documentation?
   - How long did it take?
   - What would improve procedure?

4. **Update Procedures**:
   - Fix documentation errors
   - Add missing steps
   - Clarify ambiguous instructions
   - Update time estimates

**Test Scenarios**:
- [ ] Clone from git bundle (no network)
- [ ] Clone from GitHub (with network)
- [ ] Decrypt with master key only
- [ ] Bootstrap with SOPS_AGE_KEY_FILE set
- [ ] Verify secrets decrypt on new host
- [ ] Services start correctly

**Done when**:
- [ ] Recovery test completed successfully
- [ ] Test documented with results
- [ ] Procedure updated based on findings
- [ ] Known issues documented
- [ ] Recovery time validated

### 6. Create Periodic Maintenance Schedule

**Type**: Documentation
**Files**: `docs/disaster-recovery/maintenance-schedule.md` (create)

**Action**:
Document ongoing maintenance for glass-key system:

**Quarterly (Every 3 months)**:
- [ ] Update USB backup with latest configs
- [ ] Verify git bundles are current
- [ ] Check paper backups for degradation
- [ ] Update MANIFEST.txt with new commits

**Annually (Every 12 months)**:
- [ ] Perform full recovery test
- [ ] Verify paper backups still legible
- [ ] Check metal backup for corrosion
- [ ] Test USB backup encryption
- [ ] Update storage locations if moved

**After Major Changes**:
- [ ] New host added → update backups
- [ ] Master key rotated → new paper backups
- [ ] .sops.yaml changed → new bundles
- [ ] Infrastructure redesign → test recovery

**Maintenance Commands**:
```bash
# Quarterly backup update
./scripts/create-glass-key-backup.sh
cp -r ~/glass-key-backup-$(date +%Y%m%d) /mnt/usb/

# Annual recovery test
# (Boot test VM, follow total-recovery.md)

# Verify checksums
cd /path/to/backup
sha256sum -c MANIFEST.txt
```

**Calendar Reminders**:
- January 1: Annual recovery test
- April 1: Quarterly backup
- July 1: Quarterly backup
- October 1: Quarterly backup

**Done when**:
- [ ] Maintenance schedule documented
- [ ] Calendar reminders set
- [ ] Maintenance commands provided
- [ ] Responsibility assigned (you)

## Success Criteria

- [ ] Master age key generated and secured
- [ ] All secrets encrypted with master key
- [ ] Paper backups created (minimum 3 copies)
- [ ] USB encrypted backup created
- [ ] Offline repository bundles work
- [ ] Recovery procedure fully documented
- [ ] Recovery test PASSED (critical)
- [ ] Maintenance schedule established
- [ ] Glass-key backups stored in multiple secure locations
- [ ] Can rebuild entire infrastructure from backups alone

## Files to Create

**Create**:
- `docs/disaster-recovery/master-key-setup.md` - Master key generation
- `docs/disaster-recovery/glass-key-creation.md` - Physical backup guide
- `docs/disaster-recovery/glass-key-storage.md` - Storage best practices
- `docs/disaster-recovery/repo-backup.md` - Repository backup guide
- `docs/disaster-recovery/total-recovery.md` - Complete recovery procedure
- `docs/disaster-recovery/maintenance-schedule.md` - Ongoing maintenance
- `scripts/create-glass-key-backup.sh` - Automated backup creation
- `.planning/phases/17-physical-security/recovery-test-YYYY-MM-DD.md` - Test results

**Modify**:
- `.sops.yaml` in nix-secrets - Add master key to all creation rules

## Files to Reference

- `modules/common/sops.nix` - Current age key setup
- `scripts/bootstrap-nixos.sh` - Bootstrap procedure
- `docs/sops-rotation.md` - Key rotation guide
- `.planning/phases/16-sops-key-management/` - SOPS infrastructure

## Notes

**This is FUTURE WORK - But CRITICAL before production.**

**Security Properties**:
- ✅ Total infrastructure loss = recoverable
- ✅ GitHub account loss = recoverable (bundles)
- ✅ All host keys lost = recoverable (master key)
- ✅ Encrypted secrets = readable with master key
- ✅ Offline recovery = no external dependencies

**Glass-Key Principle**:
> "If my house burns down and I only have what's in my safety deposit box, can I rebuild everything?"
>
> Answer must be: YES.

**Trade-offs**:
- Master key is single point of failure (but backed up extensively)
- Physical security required (fireproof safe, off-site storage)
- Manual maintenance needed (quarterly updates)
- Recovery time measured in days, not minutes
- BUT: Complete sovereignty and resilience

**Storage Security**:
- NEVER store master key digitally
- NEVER upload to cloud
- NEVER put in password manager
- NEVER store all copies in one location
- ALWAYS have off-site backup
- ALWAYS test recovery annually

**Future Enhancements** (not in this plan):
- Shamir secret sharing (split key into 3-of-5 shares)
- Encrypted seed phrase (BIP39 for key recovery)
- Dead man's switch (access if you disappear)
- Executor instructions (for estate planning)
