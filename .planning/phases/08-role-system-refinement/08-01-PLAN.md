# Plan 08-01: Create roles/common.nix and Refactor Role Structure

## Objective

Create a `roles/common.nix` that all roles inherit from, establishing universal baseline configuration. Refactor `roles/default.nix` to be a proper entry point that wires role options together.

## Context

@roles/default.nix - Currently just imports all roles
@roles/desktop.nix - Example of current role pattern
@hosts/common/core/default.nix - Current core config that roles should absorb

## Current State

- `roles/default.nix` only imports other roles, defines nothing
- Each role defines its own enable option and imports modules directly
- `hosts/common/core/default.nix` contains config that should be universal
- Hosts still manually import core modules

## Target State

- `roles/common.nix` contains universal config ALL hosts get
- `roles/default.nix` defines the `config.roles` option structure and imports common.nix
- Individual roles (desktop, laptop, etc.) extend common.nix via the role system
- Common role sets universal hostSpec defaults

## Tasks

### Task 1: Create roles/common.nix with universal config

**Type:** create
**Files:** `roles/common.nix`
**Action:**
- Create `roles/common.nix` with config that ALL roles inherit
- Move universal imports from `hosts/common/core/default.nix` that aren't platform-specific
- Set universal hostSpec defaults (primaryUsername, handle, secrets from nix-secrets)
- Include base module imports that every host needs

**Verify:**
```bash
# File exists and is valid nix
nix-instantiate --parse roles/common.nix
```

### Task 2: Refactor roles/default.nix as proper entry point

**Type:** modify
**Files:** `roles/default.nix`
**Action:**
- Import `common.nix` as the base
- Define the `config.roles` option as a proper module with submodule options
- Each role becomes a boolean option under `config.roles`
- Remove the simple import list, replace with proper module structure

**Verify:**
```bash
# File parses correctly
nix-instantiate --parse roles/default.nix
```

### Task 3: Update existing roles to work with new structure

**Type:** modify
**Files:** `roles/desktop.nix`, `roles/vm.nix`, `roles/laptop.nix`, `roles/server.nix`, `roles/pi.nix`, `roles/tablet.nix`, `roles/darwin.nix`
**Action:**
- Ensure each role works as a conditional extension of common.nix
- Roles should only add/override what's specific to that role type
- Keep the `lib.mkIf cfg.<role>` pattern for conditional config
- Roles set additional hostSpec values appropriate to their type

**Verify:**
```bash
# All roles parse
for f in roles/*.nix; do nix-instantiate --parse "$f"; done
```

## Verification

```bash
# Full flake check
nix flake check --no-build

# Test griefling builds (uses roles)
nix build .#nixosConfigurations.griefling.config.system.build.toplevel --dry-run

# Test malphas builds (uses roles.vm)
nix build .#nixosConfigurations.malphas.config.system.build.toplevel --dry-run
```

## Success Criteria

- [ ] `roles/common.nix` exists with universal baseline
- [ ] `roles/default.nix` properly defines role option structure
- [ ] All existing roles work with new structure
- [ ] griefling and malphas build successfully
- [ ] No duplicate imports between common and individual roles

## Output

Create `08-01-SUMMARY.md` documenting:
- New file structure
- What moved to common.nix
- Any adjustments made to existing roles
- Build verification results
