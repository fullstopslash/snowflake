# Plan 08-03: Refactor hostSpec - Roles Set Defaults

## Objective

Refactor `host-spec.nix` so that roles set most values automatically. Hosts should only need to specify: hostname, hardware quirks, and role selections.

## Context

@modules/common/host-spec.nix - Current hostSpec with ~50 options
@roles/common.nix - Common role (after 08-01)
@roles/desktop.nix - Example of role setting hostSpec values

## Current State

- `host-spec.nix` has many boolean flags: `isMinimal`, `isDevelopment`, `isMobile`, `useWayland`, etc.
- Hosts manually set these flags
- Some overlap: `isDevelopment` in hostSpec vs `roles.development`
- Roles already set some hostSpec values but inconsistently

## Target State

- Roles set ALL behavioral hostSpec values via lib.mkDefault
- Hosts only set identity values: `hostName`, `primaryUsername` (if non-default)
- Boolean flags derived from role membership
- `host-spec.nix` simplified to essential identity options
- Clear documentation of what roles set vs what hosts can override

## Tasks

### Task 1: Audit and categorize hostSpec options

**Type:** research
**Files:** `modules/common/host-spec.nix`
**Action:**
- Categorize each option:
  - **Identity**: hostName, primaryUsername, email, domain (host sets)
  - **Behavioral**: useWayland, isDevelopment, hasSecrets (role sets)
  - **Hardware**: wifi, hdr, scaling (host sets based on hardware)
- Document which role should set which behavioral option

**Verify:** Create categorization table in notes

### Task 2: Update roles to set behavioral hostSpec values

**Type:** modify
**Files:** `roles/common.nix`, `roles/desktop.nix`, `roles/laptop.nix`, `roles/server.nix`, `roles/vm.nix`
**Action:**
- `common.nix`: Set universal defaults (isProduction, hasSecrets)
- `desktop.nix`: Set useWayland, useWindowManager, isDevelopment
- `laptop.nix`: Set isMobile, wifi
- `server.nix`: Set isMinimal (optionally), server secret categories
- `vm.nix`: Set isMinimal, hasSecrets=false

All using `lib.mkDefault` so hosts can override with `lib.mkForce` if needed.

**Verify:**
```bash
nix flake check --no-build
```

### Task 3: Clean up host-spec.nix defaults

**Type:** modify
**Files:** `modules/common/host-spec.nix`
**Action:**
- Remove redundant defaults (roles provide them now)
- Add comments indicating "set by roles" vs "set by hosts"
- Consider deprecating options that are purely role-derived (isDevelopment when roles.development exists)
- Keep assertions for valid combinations

**Verify:**
```bash
nix-instantiate --parse modules/common/host-spec.nix
nix build .#nixosConfigurations.griefling.config.system.build.toplevel --dry-run
```

## Verification

```bash
# All hosts build
nix build .#nixosConfigurations.griefling.config.system.build.toplevel --dry-run
nix build .#nixosConfigurations.malphas.config.system.build.toplevel --dry-run

# Check that role-derived values work
nix eval .#nixosConfigurations.griefling.config.hostSpec.useWayland
# Should be true (from desktop role)
```

## Success Criteria

- [ ] Clear separation: identity (host) vs behavioral (role) options
- [ ] Roles set behavioral defaults consistently
- [ ] Host files don't need to set behavioral flags
- [ ] Existing hosts still work unchanged
- [ ] hostSpec better documented

## Output

Create `08-03-SUMMARY.md` documenting:
- Option categorization (identity vs behavioral vs hardware)
- Which role sets which options
- Any options deprecated or removed
