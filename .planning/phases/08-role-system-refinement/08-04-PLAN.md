# Plan 08-04: Migrate Hosts to Minimal Pattern

## Objective

Transform existing hosts (griefling, malphas) to the super-minimal pattern. A host config should be ~15-30 lines: hardware-configuration.nix import, role selection, hostname, and any hardware-specific quirks.

## Context

@hosts/nixos/griefling/default.nix - Currently 286 lines
@hosts/nixos/malphas/default.nix - Already fairly minimal (47 lines)
@roles/ - Role system (after 08-01, 08-02, 08-03)

## Current State

- `griefling`: 286 lines with many manual imports, hostSpec settings, and service configurations
- `malphas`: 47 lines, closer to minimal but still has some redundancy
- Hosts duplicate what roles should provide

## Target State

Griefling becomes:
```nix
{ lib, ... }:
{
  imports = [
    ./hardware-configuration.nix
    # Disk config if needed
  ];

  # Role selection - everything else follows from this
  roles.desktop = true;
  roles.development = true;

  # Identity only
  hostSpec.hostName = "griefling";

  # Hardware quirks only (VM-specific)
  boot.loader.systemd-boot.enable = true;
  boot.loader.efi.canTouchEfiVariables = true;

  system.stateVersion = "23.11";
}
```

~20 lines instead of 286.

## Tasks

### Task 1: Create template for minimal host

**Type:** create
**Files:** `hosts/nixos/template/default.nix`
**Action:**
- Create a template showing the minimal host pattern
- Document what goes in host vs what comes from roles
- Include comments explaining the pattern

**Verify:**
```bash
# Template should parse (won't build as it's not a real host)
nix-instantiate --parse hosts/nixos/template/default.nix
```

### Task 2: Refactor griefling to minimal pattern

**Type:** modify
**Files:** `hosts/nixos/griefling/default.nix`
**Action:**
- Remove ALL imports that roles provide
- Remove ALL hostSpec values that roles set
- Keep only: hardware-configuration, disk config, hostname, hardware quirks
- Use `roles.desktop = true` to get everything else
- Target: <30 lines

**Verify:**
```bash
nix build .#nixosConfigurations.griefling.config.system.build.toplevel --dry-run
```

### Task 3: Verify malphas stays minimal

**Type:** modify
**Files:** `hosts/nixos/malphas/default.nix`
**Action:**
- Review malphas against new pattern
- Remove any redundancy with roles.vm
- Should already be close to minimal
- Target: <25 lines

**Verify:**
```bash
nix build .#nixosConfigurations.malphas.config.system.build.toplevel --dry-run
```

## Verification

```bash
# Both hosts build and work
nix build .#nixosConfigurations.griefling.config.system.build.toplevel --dry-run
nix build .#nixosConfigurations.malphas.config.system.build.toplevel --dry-run

# Line count verification
wc -l hosts/nixos/griefling/default.nix  # Should be <30
wc -l hosts/nixos/malphas/default.nix    # Should be <25

# Full system test on griefling VM
just vm-rebuild griefling
```

## Success Criteria

- [ ] Template created documenting minimal host pattern
- [ ] griefling reduced from 286 lines to <30
- [ ] malphas cleaned up to <25 lines
- [ ] Both hosts build and boot correctly
- [ ] All functionality preserved (services, desktop, etc.)

## Output

Create `08-04-SUMMARY.md` documenting:
- Before/after line counts
- What was removed from each host
- The minimal host template pattern
- Any issues encountered and resolved
