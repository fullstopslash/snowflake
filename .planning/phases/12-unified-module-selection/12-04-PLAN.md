---
phase: 12-unified-module-selection
plan: 04
type: execute
---

<objective>
Migrate hosts to new syntax and validate the complete system works.

Purpose: Prove the unified selection system works end-to-end with real hosts.
Output: Updated host configs, validated builds, documented pattern.
</objective>

<execution_context>
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/12-unified-module-selection/12-01-SUMMARY.md
@.planning/phases/12-unified-module-selection/12-02-SUMMARY.md
@.planning/phases/12-unified-module-selection/12-03-SUMMARY.md
@hosts/malphas/default.nix
@hosts/griefling/default.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update malphas as reference host</name>
  <files>hosts/malphas/default.nix</files>
  <action>
Update malphas to demonstrate the new pattern. Show how a host can:
1. Use a role for defaults
2. Override specific module selections
3. Add host-specific modules

Example:
```nix
{ lib, ... }:
{
  imports = [
    ./hardware-configuration.nix
    ./audio-tuning.nix
  ];

  # Role provides default selections
  roles.desktop = true;
  roles.development = true;

  # Host-specific overrides
  modules = {
    # Override: use niri instead of default plasma+hyprland
    desktop = lib.mkForce [ "niri" "wayland" ];
    # Extend: add extra services
    services = [ "easyeffects" ];
  };

  # Identity
  hostSpec.hostName = "malphas";

  # Hardware specifics
  hostSpec.hdr = true;
  hostSpec.scaling = "1.5";
}
```

AVOID: Don't make the host overly complex - the point is to show the minimal, clean pattern.
  </action>
  <verify>nix build .#nixosConfigurations.malphas.config.system.build.toplevel --dry-run succeeds</verify>
  <done>malphas uses new selection syntax and builds correctly</done>
</task>

<task type="auto">
  <name>Task 2: Validate griefling minimal VM</name>
  <files>hosts/griefling/default.nix</files>
  <action>
Verify griefling (minimal VM) works with the new system:

```nix
{ ... }:
{
  imports = [ ./hardware-configuration.nix ];

  roles.vm = true;  # Sets modules.* to minimal defaults

  # Maybe add one thing for testing
  modules.services = [ "atuin" ];

  hostSpec.hostName = "griefling";
  hostSpec.hasSecrets = false;
}
```

The key validation: griefling should NOT get plasma, jellyfin, or other heavy packages.

Check the closure size:
```bash
nix path-info -rsSh .#nixosConfigurations.griefling.config.system.build.toplevel
```

AVOID: Don't add unnecessary modules - griefling is the minimal test case.
  </action>
  <verify>griefling closure does NOT contain plasma, kde, jellyfin packages; closure size significantly smaller than desktop</verify>
  <done>griefling validates minimal selection works correctly</done>
</task>

<task type="auto">
  <name>Task 3: Document the unified selection pattern</name>
  <files>hosts/TEMPLATE.nix</files>
  <action>
Create or update a template host file that documents the pattern:

```nix
# Host Template - Copy this for new hosts
#
# The module selection system:
# - Roles set default selections via lib.mkDefault
# - Hosts inherit from roles and can override
# - modules.* lists determine what software is installed
#
# Available selection categories:
# - modules.desktop: Window managers, desktop environments
# - modules.apps: Applications (media, browsers, gaming)
# - modules.services: System services (atuin, syncthing, pipewire)
# - modules.development: Dev tools (containers, latex, python)
# - modules.cli: CLI tools and shell config
#
# To see available modules for each category:
#   ls modules/services/desktop/  -> modules.desktop options
#   ls modules/apps/              -> modules.apps options
#
{ lib, ... }:
{
  imports = [ ./hardware-configuration.nix ];

  # Pick a role (sets sensible defaults)
  roles.desktop = true;  # or: vm, server, laptop, pi, tablet

  # Optional: task roles for additional capabilities
  # roles.development = true;
  # roles.mediacenter = true;

  # Override or extend module selections
  # modules.desktop = lib.mkForce [ "hyprland" ];  # Replace defaults
  # modules.services = [ "tailscale" ];            # Extend defaults

  # Required: host identity
  hostSpec.hostName = "your-hostname";

  # Optional: hardware specifics
  # hostSpec.wifi = true;
  # hostSpec.hdr = true;
  # hostSpec.scaling = "1.5";

  system.stateVersion = "24.05";
}
```

This serves as documentation AND a starting point for new hosts.
  </action>
  <verify>TEMPLATE.nix is valid nix syntax (nix-instantiate --parse)</verify>
  <done>Pattern documented in template file</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `nix flake check --no-build` passes for all hosts
- [ ] malphas builds successfully with new syntax
- [ ] griefling builds with minimal closure (no plasma/kde/jellyfin)
- [ ] TEMPLATE.nix documents the pattern clearly
- [ ] LSP autocompletion works for modules.* options
</verification>

<success_criteria>
- All tasks completed
- Both reference hosts work with new system
- Minimal host (griefling) stays minimal
- Pattern is documented and reproducible
- Phase 12 complete
</success_criteria>

<output>
After completion, create `.planning/phases/12-unified-module-selection/12-04-SUMMARY.md`
</output>
