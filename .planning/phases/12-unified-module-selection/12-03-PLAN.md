---
phase: 12-unified-module-selection
plan: 03
type: execute
---

<objective>
Migrate all roles to use the new modules.* selection syntax.

Purpose: Roles become "selection presets" using the same syntax as hosts, making the system unified and predictable.
Output: All role files updated to use `modules.desktop = lib.mkDefault [...]` pattern.
</objective>

<execution_context>
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/12-unified-module-selection/12-01-SUMMARY.md
@.planning/phases/12-unified-module-selection/12-02-SUMMARY.md
@roles/form-desktop.nix
@roles/form-laptop.nix
@roles/form-vm.nix
@roles/form-server.nix
@roles/form-pi.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert form-desktop.nix to selection syntax</name>
  <files>roles/form-desktop.nix</files>
  <action>
Replace individual `myModules.*.enable` lines with unified selections:

BEFORE:
```nix
myModules.desktop.plasma.enable = lib.mkDefault true;
myModules.apps.media.enable = lib.mkDefault true;
myModules.desktop.hyprland.enable = lib.mkDefault true;
myModules.desktop.wayland.enable = lib.mkDefault true;
myModules.displayManager.ly.enable = lib.mkDefault true;
myModules.services.atuin.enable = lib.mkDefault true;
# ... etc
```

AFTER:
```nix
# Module selections - hosts can override individual categories
modules = {
  desktop = lib.mkDefault [ "plasma" "hyprland" "wayland" ];
  displayManager = lib.mkDefault [ "ly" ];
  apps = lib.mkDefault [ "media" "gaming" "browsers" ];
  development = lib.mkDefault [ "latex" "document-processing" "containers" ];
  services = lib.mkDefault [ "atuin" "pipewire" ];
  cli = lib.mkDefault [ "tools" "shell" ];
};
```

Keep the hostSpec settings (secretCategories, etc.) - those are still role-specific.

AVOID: Don't remove ALL the old enables yet - some modules might not be wired into selection.nix. Add them to selection.nix as needed.
  </action>
  <verify>nix eval .#nixosConfigurations.malphas.config.modules.desktop shows expected list (if malphas uses desktop role)</verify>
  <done>form-desktop.nix uses modules.* selection syntax</done>
</task>

<task type="auto">
  <name>Task 2: Convert form-laptop.nix and form-tablet.nix</name>
  <files>roles/form-laptop.nix, roles/form-tablet.nix</files>
  <action>
Apply same pattern to laptop and tablet roles.

form-laptop.nix should be similar to desktop but with:
- Mobile-specific selections (battery management, wifi)
- `hostSpec.isMobile = lib.mkDefault true;` (keep this - it's hardware-based)

form-tablet.nix:
- Touch-friendly selections
- May have fewer development tools

Use `lib.mkDefault` for all selections so hosts can override.

AVOID: Don't duplicate large selection lists - if laptop is mostly same as desktop, consider having laptop extend/modify desktop selections (though this may require mkMerge patterns).
  </action>
  <verify>nix flake check --no-build passes with updated laptop/tablet roles</verify>
  <done>form-laptop.nix and form-tablet.nix use selection syntax</done>
</task>

<task type="auto">
  <name>Task 3: Convert minimal roles (vm, server, pi) and task roles</name>
  <files>roles/form-vm.nix, roles/form-server.nix, roles/form-pi.nix, roles/task-development.nix, roles/task-mediacenter.nix</files>
  <action>
Convert remaining roles:

form-vm.nix (minimal):
```nix
modules = {
  desktop = lib.mkDefault [];  # No desktop by default
  apps = lib.mkDefault [];
  services = lib.mkDefault [ "openssh" ];
  cli = lib.mkDefault [ "tools" ];
};
```

form-server.nix:
```nix
modules = {
  desktop = lib.mkDefault [];
  services = lib.mkDefault [ "openssh" "auto-upgrade" ];
  # Server-specific services
};
```

form-pi.nix: Similar to server but even more minimal.

task-development.nix:
```nix
modules.development = lib.mkDefault [ "containers" "latex" "python" "document-processing" ];
```

task-mediacenter.nix:
```nix
modules = {
  apps = lib.mkDefault [ "media" "jellyfin" ];
  services = lib.mkDefault [ "pipewire" ];
};
```

AVOID: Don't force empty lists - use lib.mkDefault [] so hosts can still add modules.
  </action>
  <verify>All role files use consistent modules.* pattern; nix flake check passes</verify>
  <done>All roles converted to selection syntax</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `nix flake check --no-build` passes
- [ ] All form-* roles use modules.* selection syntax
- [ ] All task-* roles use modules.* selection syntax
- [ ] Role composition still works (desktop + development)
- [ ] Selection syntax is consistent across all roles
</verification>

<success_criteria>
- All tasks completed
- Roles are now "selection presets" using unified syntax
- lib.mkDefault used throughout for overridability
- No build errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-unified-module-selection/12-03-SUMMARY.md`
</output>
