---
phase: 12-unified-module-selection
plan: 02
type: execute
---

<objective>
Simplify hostSpec by deriving behavioral options from module selections.

Purpose: Reduce redundancy - behavioral flags like `useWayland` and `isDevelopment` should be computed from what modules are selected, not set manually.
Output: Streamlined `host-spec.nix` with derived behavioral options.
</objective>

<execution_context>
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/12-unified-module-selection/12-01-SUMMARY.md
@modules/common/host-spec.nix
@modules/selection.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Identify behavioral options that can be derived</name>
  <files>modules/common/host-spec.nix</files>
  <action>
Review `host-spec.nix` BEHAVIORAL OPTIONS section. These can be derived from module selections:

- `useWayland` → true if modules.desktop contains any of: "hyprland", "niri", "wayland", "plasma" (plasma6 is wayland)
- `useWindowManager` → true if modules.desktop is non-empty
- `isDevelopment` → true if modules.development is non-empty
- `isMinimal` → true if modules.desktop AND modules.apps are both empty

Keep these as options but change their defaults to be computed:
```nix
useWayland = lib.mkOption {
  type = lib.types.bool;
  default = builtins.any (m: builtins.elem m config.modules.desktop) [ "hyprland" "niri" "wayland" "plasma" ];
  description = "Use Wayland (derived from desktop module selections, can override)";
};
```

AVOID: Don't remove these options entirely - hosts may need to override (e.g., force X11 even with plasma selected).
  </action>
  <verify>Review the updated defaults make sense for each behavioral option</verify>
  <done>Behavioral options have derived defaults based on module selections</done>
</task>

<task type="auto">
  <name>Task 2: Update host-spec.nix with derived defaults</name>
  <files>modules/common/host-spec.nix</files>
  <action>
Modify the BEHAVIORAL OPTIONS section:

```nix
# BEHAVIORAL OPTIONS - Derived from module selections
# These are computed from modules.* selections but can be overridden with lib.mkForce

useWayland = lib.mkOption {
  type = lib.types.bool;
  default = let
    waylandDesktops = [ "hyprland" "niri" "wayland" "plasma" ];
  in builtins.any (m: builtins.elem m config.modules.desktop) waylandDesktops;
  description = "Use Wayland display server (derived from modules.desktop selections)";
};

useWindowManager = lib.mkOption {
  type = lib.types.bool;
  default = config.modules.desktop != [];
  description = "Use graphical window manager (derived: true if any desktop modules selected)";
};

isDevelopment = lib.mkOption {
  type = lib.types.bool;
  default = config.modules.development != [];
  description = "Development tools enabled (derived: true if any development modules selected)";
};

isMinimal = lib.mkOption {
  type = lib.types.bool;
  default = config.modules.desktop == [] && config.modules.apps == [];
  description = "Minimal installation (derived: true if no desktop or apps selected)";
};
```

Update the comments to indicate these are now derived.

AVOID: Don't change `isMobile` - that's based on hardware form factor, not software selection.
  </action>
  <verify>nix eval .#nixosConfigurations.griefling.config.hostSpec.isMinimal returns expected value</verify>
  <done>hostSpec behavioral options compute from module selections</done>
</task>

<task type="auto">
  <name>Task 3: Add module selection reference to hostSpec documentation</name>
  <files>modules/common/host-spec.nix</files>
  <action>
Update the comment header in host-spec.nix to document the relationship:

```nix
# Specifications For Differentiating Hosts
#
# Option Categories:
# - IDENTITY: Host-specific values (hostName, primaryUsername) - set by hosts
# - HARDWARE: Physical capabilities (wifi, hdr, scaling) - set by hosts based on hardware
# - BEHAVIORAL: Derived from modules.* selections - rarely need manual override
# - PREFERENCES: User choices (theme, defaultBrowser) - set by hosts or roles
# - SECRET CATEGORIES: What secrets needed - set by roles
#
# See modules/selection.nix for the modules.* selection system.
```

This creates a clear mental model for users.
  </action>
  <verify>Comment header accurately describes the option categories</verify>
  <done>hostSpec documentation updated to explain derived behavioral options</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `nix flake check --no-build` passes
- [ ] Derived options compute correctly (test with empty vs populated modules.*)
- [ ] Existing host configs still build (backwards compatible)
- [ ] Documentation accurately describes the system
</verification>

<success_criteria>
- All tasks completed
- Behavioral options derive from module selections
- Manual override still possible with lib.mkForce
- No breaking changes to existing configs
</success_criteria>

<output>
After completion, create `.planning/phases/12-unified-module-selection/12-02-SUMMARY.md`
</output>
