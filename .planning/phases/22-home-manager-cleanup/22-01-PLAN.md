---
phase: 22-home-manager-cleanup
type: execute
---

<objective>
Reorganize home-manager to move desktop environment and browser installations to modules/apps/, keeping only settings that must be managed by home-manager.

Purpose: Align desktop/browser management with the module selection pattern used throughout the repo. Enable desktop environments and browsers to be enabled via myModules.apps.* like all other applications, while preserving home-manager for configuration that genuinely requires it (user-level dotfiles, XDG settings).

Output: Clean separation between package installation (modules/apps/) and user configuration (home-manager/), consistent with repo-wide patterns.
</objective>

<execution_context>
@~/.claude/plugins/cache/taches-cc-resources/taches-cc-resources/1.0.0/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/cache/taches-cc-resources/taches-cc-resources/1.0.0/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@home-manager/desktops/default.nix
@home-manager/desktops/hyprland/default.nix
@home-manager/browsers/default.nix
@home-manager/browsers/firefox.nix
@modules/services/desktop/hyprland.nix
@modules/apps/desktop/desktop.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create window manager modules</name>
  <files>modules/apps/window-managers/default.nix, modules/apps/window-managers/hyprland.nix</files>
  <action>
Create new directory: modules/apps/window-managers/

Create modules/apps/window-managers/default.nix:
```nix
{ ... }:
{
  imports = [
    ./hyprland.nix
  ];
}
```

Create modules/apps/window-managers/hyprland.nix:
This module should handle Hyprland INSTALLATION only (the window manager binary and essential packages).
- Define myModules.apps.window-managers.hyprland.enable option
- When enabled, install hyprland package (environment.systemPackages or via programs.hyprland.enable)
- Install hyprland plugins: pkgs.hyprlandPlugins.hy3 (conditional on hostName != "griefling")
- Install essential hyprland ecosystem packages: hyprlock, wlogout

Do NOT include:
- User-level config (that stays in home-manager)
- Desktop utilities (rofi, waybar, dunst) - those belong in separate modules
- Wayland utilities - those are already in modules/services/desktop/hyprland.nix or wayland.nix

Reference existing patterns from modules/apps/browsers/brave.nix for the enable option structure.
  </action>
  <verify>
nix flake check passes.
Module file exists: modules/apps/window-managers/hyprland.nix
Contains myModules.apps.window-managers.hyprland.enable option.
  </verify>
  <done>
- modules/apps/window-managers/ directory created
- hyprland.nix module defines installation, not configuration
- Enable option follows myModules.apps.* pattern
- No evaluation errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create desktop utilities modules</name>
  <files>modules/apps/desktop/rofi.nix, modules/apps/desktop/waybar.nix, modules/apps/desktop/dunst.nix</files>
  <action>
Create three new modules in modules/apps/desktop/ for desktop utilities currently in home-manager:

1. modules/apps/desktop/rofi.nix
   - myModules.apps.desktop.rofi.enable option
   - Install rofi-wayland package
   - No configuration (stays in home-manager)

2. modules/apps/desktop/waybar.nix
   - myModules.apps.desktop.waybar.enable option
   - Install waybar package
   - No configuration (stays in home-manager)

3. modules/apps/desktop/dunst.nix
   - myModules.apps.desktop.dunst.enable option
   - Install dunst package
   - No configuration (stays in home-manager)

Each module should follow the pattern:
```nix
{ config, lib, pkgs, ... }:
let
  cfg = config.myModules.apps.desktop.{name};
in
{
  options.myModules.apps.desktop.{name} = {
    enable = lib.mkEnableOption "{Name} - {description}";
  };

  config = lib.mkIf cfg.enable {
    environment.systemPackages = [ pkgs.{package} ];
  };
}
```

Update modules/apps/desktop/default.nix to import these new modules.
  </action>
  <verify>
nix flake check passes.
Files exist: rofi.nix, waybar.nix, dunst.nix in modules/apps/desktop/
Each has myModules.apps.desktop.*.enable option.
modules/apps/desktop/default.nix imports them.
  </verify>
  <done>
- Three desktop utility modules created
- Each provides installation only, no configuration
- All imported in desktop/default.nix
- No evaluation errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Create browser installation modules</name>
  <files>modules/apps/browsers/firefox.nix, modules/apps/browsers/brave.nix, modules/apps/browsers/chromium.nix</files>
  <action>
Currently modules/apps/browsers/default.nix is empty (just `{ }` placeholder).

Create three browser modules that handle INSTALLATION only:

1. modules/apps/browsers/firefox.nix
   - myModules.apps.browsers.firefox.enable option
   - Install firefox package (environment.systemPackages)
   - No programs.firefox configuration (that stays in home-manager)

2. modules/apps/browsers/brave.nix
   - myModules.apps.browsers.brave.enable option
   - Install brave package

3. modules/apps/browsers/chromium.nix
   - myModules.apps.browsers.chromium.enable option
   - Install chromium package

Pattern for each:
```nix
{ config, lib, pkgs, ... }:
let
  cfg = config.myModules.apps.browsers.{name};
in
{
  options.myModules.apps.browsers.{name} = {
    enable = lib.mkEnableOption "{Name} browser";
  };

  config = lib.mkIf cfg.enable {
    environment.systemPackages = [ pkgs.{package} ];
  };
}
```

Update modules/apps/browsers/default.nix to:
```nix
{ ... }:
{
  imports = [
    ./brave.nix
    ./chromium.nix
    ./firefox.nix
  ];
}
```

IMPORTANT: Do NOT move the programs.firefox configuration from home-manager/browsers/firefox.nix - that stays in home-manager because it's user-level settings (policies, extensions, profiles). Only package installation moves to modules.
  </action>
  <verify>
nix flake check passes.
Files exist and define enable options: firefox.nix, brave.nix, chromium.nix
modules/apps/browsers/default.nix imports all three.
Each module only installs packages, no configuration.
  </verify>
  <done>
- Three browser installation modules created
- modules/apps/browsers/default.nix updated with imports
- Package installation separated from configuration
- No evaluation errors
  </done>
</task>

<task type="auto">
  <name>Task 4: Update home-manager to remove package installations</name>
  <files>home-manager/desktops/default.nix, home-manager/desktops/hyprland/default.nix, home-manager/desktops/hyprlock.nix, home-manager/desktops/wlogout.nix</files>
  <action>
Update home-manager desktop files to remove package installations (those are now in modules):

1. home-manager/desktops/default.nix
   - KEEP imports for: ./hyprland, ./services/dunst.nix, ./waybar.nix, ./rofi.nix
   - REMOVE home.packages section (pulseaudio, pavucontrol, wl-clipboard, galculator)
   - Those packages should either:
     a) Move to modules/apps/desktop/desktop.nix if they're essential desktop utilities
     b) Be added via module selection in host configs if optional
   - Add comment explaining: "Package installations managed via modules/apps/, this file only contains home-manager configuration"

2. home-manager/desktops/hyprland/default.nix
   - KEEP: wayland.windowManager.hyprland configuration (enable, systemd, plugins, extraConfig)
   - KEEP: home.file script deployments
   - KEEP: imports for hyprlock.nix, wlogout.nix
   - This file is purely home-manager configuration, no package installation

3. home-manager/desktops/hyprlock.nix
   - CHECK if this uses programs.hyprlock or just installs package
   - If programs.hyprlock with config: KEEP (home-manager settings)
   - If just package install: MOVE to modules/apps/window-managers/hyprland.nix

4. home-manager/desktops/wlogout.nix
   - CHECK if this uses programs.wlogout or services.wlogout with config
   - If config present: KEEP (home-manager settings)
   - If just package install: MOVE to modules/apps/window-managers/hyprland.nix

Add header comments to updated files explaining the separation:
```nix
# Home-manager configuration for {component}
# Package installation managed via modules/apps/{path}
# Enable via: myModules.apps.{path}.enable = true;
```
  </action>
  <verify>
nix flake check passes.
home-manager/desktops/default.nix has no home.packages.
hyprland/default.nix contains only wayland.windowManager.hyprland config.
All files have explanatory header comments.
  </verify>
  <done>
- Package installations removed from home-manager desktop files
- Only home-manager-specific configuration remains
- Header comments added explaining separation
- No evaluation errors
  </done>
</task>

<task type="auto">
  <name>Task 5: Update home-manager browsers to remove installations</name>
  <files>home-manager/browsers/firefox.nix, home-manager/browsers/brave.nix, home-manager/browsers/chromium.nix, home-manager/browsers/default.nix</files>
  <action>
Update browser files in home-manager to remove `programs.{browser}.enable = true` since package installation is now in modules:

1. home-manager/browsers/firefox.nix
   - Change `programs.firefox.enable = true;` to `programs.firefox.enable = false;`
   - WAIT NO - this is wrong. programs.firefox is used for CONFIGURATION (policies, extensions, profiles).
   - Actually, KEEP programs.firefox.enable = true BUT add comment:
     ```nix
     # Firefox configuration via home-manager programs.firefox
     # Package installation via: myModules.apps.browsers.firefox.enable = true
     # Both must be enabled for Firefox to work with these settings
     ```
   - The programs.firefox module in home-manager handles CONFIGURATION, not just installation
   - When both module (installation) and home-manager (configuration) are enabled, they work together

2. home-manager/browsers/brave.nix
   - CHECK what this file does
   - If just `programs.brave.enable = true` with no config: REMOVE the file entirely
   - If it has configuration: KEEP it and add header comment

3. home-manager/browsers/chromium.nix
   - CHECK what this file does
   - If just `programs.chromium.enable = true` with no config: REMOVE the file entirely
   - If it has configuration: KEEP it and add header comment

4. home-manager/browsers/default.nix
   - Update imports to only include files with actual configuration
   - If brave.nix/chromium.nix were removed, remove those imports

IMPORTANT PRINCIPLE:
- If home-manager file uses programs.{app}.{settings} for configuration: KEEP IT
- If home-manager file only does programs.{app}.enable = true with no config: REMOVE IT
- Installation is now separate (modules), configuration stays (home-manager)
  </action>
  <verify>
Read brave.nix and chromium.nix to determine if they have config.
Update files accordingly.
nix flake check passes.
home-manager/browsers/default.nix imports only files with configuration.
  </verify>
  <done>
- Browser files updated based on whether they contain configuration
- Files with only enable = true removed
- Files with actual configuration kept with explanatory comments
- default.nix imports updated
- No evaluation errors
  </done>
</task>

<task type="auto">
  <name>Task 6: Add package modules to desktop role</name>
  <files>roles/desktop/default.nix</files>
  <action>
The desktop role needs to enable the new package installation modules so desktop systems get these apps.

Add to roles/desktop/default.nix in the myModules section:

```nix
# Window managers
apps.window-managers.hyprland.enable = true;

# Desktop utilities
apps.desktop.rofi.enable = true;
apps.desktop.waybar.enable = true;
apps.desktop.dunst.enable = true;

# Browsers (desktop users typically want a browser)
apps.browsers.firefox.enable = true;
# Optional: brave, chromium if desired by default
```

Also check if desktop utilities like pulseaudio, pavucontrol, wl-clipboard, galculator that were in home-manager/desktops/default.nix should be added here or to modules/apps/desktop/desktop.nix.

Recommendation: Add to modules/apps/desktop/desktop.nix as essential desktop packages (that module is already enabled by desktop role).
  </action>
  <verify>
nix flake check passes.
roles/desktop/default.nix enables new modules.
Desktop hosts build successfully: nix build .#nixosConfigurations.malphas.config.system.build.toplevel
  </verify>
  <done>
- Desktop role enables window manager, utilities, and browser modules
- Desktop utilities moved to appropriate module location
- Desktop hosts build without errors
  </done>
</task>

<task type="auto">
  <name>Task 7: Test malphas build and verify package presence</name>
  <files>None (testing task)</files>
  <action>
Test that the reorganization works correctly on malphas (main desktop host):

1. Build malphas configuration:
   nix build .#nixosConfigurations.malphas.config.system.build.toplevel

2. Check that expected packages are included in the build:
   nix-store -qR result | grep -E "(hyprland|firefox|rofi|waybar|dunst)"

3. Verify module options are working:
   nix eval .#nixosConfigurations.malphas.config.myModules.apps.window-managers.hyprland.enable
   nix eval .#nixosConfigurations.malphas.config.myModules.apps.browsers.firefox.enable

4. Check for any evaluation warnings or errors

5. If build succeeds and packages are present, the reorganization is working correctly.

If there are issues:
- Check that imports are correct in modules/apps/*/default.nix
- Verify role enables the new modules
- Check for typos in option paths (window-managers vs windowManagers, etc.)
  </action>
  <verify>
malphas builds successfully.
Expected packages present in closure: hyprland, firefox, rofi, waybar, dunst
Module enable options evaluate to true.
No evaluation errors or warnings.
  </verify>
  <done>
- malphas builds successfully with reorganized structure
- All desktop packages present in build
- Module system working correctly
- No evaluation issues
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Reorganized home-manager structure:
- Desktop environments (hyprland) and browsers (firefox, etc.) installation moved to modules/apps/
- Desktop utilities (rofi, waybar, dunst) installation moved to modules/apps/
- Home-manager files now contain only user-level configuration (programs.* settings, user scripts, dotfiles)
- Package installation follows standard myModules.apps.* pattern used throughout repo
  </what-built>
  <how-to-verify>
1. Review the new module structure:
   - ls -la modules/apps/window-managers/
   - ls -la modules/apps/desktop/
   - ls -la modules/apps/browsers/

2. Check that home-manager files contain only configuration:
   - cat home-manager/desktops/default.nix (should have no home.packages)
   - cat home-manager/desktops/hyprland/default.nix (only wayland.windowManager.hyprland config)
   - cat home-manager/browsers/firefox.nix (only programs.firefox settings)

3. Verify desktop role enables new modules:
   - grep -A 10 "apps\." roles/desktop/default.nix

4. Build test passed (malphas builds successfully)

5. Check git diff to ensure changes are clean and intentional:
   - git diff --stat

Confirm that:
- Installation separated from configuration cleanly
- Module pattern consistent across repo
- No functionality lost (all packages still available)
- Home-manager focused on user-level config only
  </how-to-verify>
  <resume-signal>Type "approved" if structure looks good, or describe any issues found</resume-signal>
</task>

<task type="auto">
  <name>Task 8: Clean up and document changes</name>
  <files>home-manager/README.md (create if doesn't exist), modules/apps/window-managers/README.md (optional)</files>
  <action>
Document the new structure to make it clear for future reference:

1. Create or update home-manager/README.md explaining:
   ```markdown
   # Home Manager Configuration

   This directory contains user-level configuration for applications.

   ## Principle

   - **Package installation**: Managed via `modules/apps/*` (NixOS system packages)
   - **User configuration**: Managed here via home-manager `programs.*` and `services.*`

   ## Structure

   - `desktops/` - Desktop environment user configuration (Hyprland settings, user scripts)
   - `browsers/` - Browser configuration (Firefox policies, extensions, preferences)
   - `xdg.nix` - XDG MIME associations and defaults
   - `chezmoi.nix` - Dotfile deployment configuration

   ## Enabling Applications

   To add a desktop app:
   1. Enable installation: `myModules.apps.{category}.{app}.enable = true` (in host or role)
   2. Add configuration: Create/update file in `home-manager/{category}/` (optional)

   Example:
   - Installation: `myModules.apps.browsers.firefox.enable = true` (in role/host)
   - Configuration: `home-manager/browsers/firefox.nix` (programs.firefox settings)
   ```

2. Add comments to key files explaining the pattern:
   - Add header to home-manager/browsers/firefox.nix
   - Add header to home-manager/desktops/hyprland/default.nix

3. Optionally create modules/apps/window-managers/README.md if helpful for explaining window manager modules.

4. Verify all changes are intentional:
   - Review git diff
   - Ensure no accidental deletions or modifications
  </action>
  <verify>
README.md created in home-manager/ with clear explanation.
Header comments added to key configuration files.
git diff looks clean and intentional.
  </verify>
  <done>
- Documentation created explaining installation vs configuration separation
- Header comments added to clarify purpose of files
- Changes reviewed and confirmed intentional
  </done>
</task>

<task type="auto">
  <name>Task 9: Commit changes</name>
  <files>Multiple (see git diff)</files>
  <action>
Commit the reorganization:

1. Review final git status:
   git status
   git diff --stat

2. Stage all changes:
   git add modules/apps/window-managers/
   git add modules/apps/desktop/rofi.nix modules/apps/desktop/waybar.nix modules/apps/desktop/dunst.nix
   git add modules/apps/browsers/
   git add home-manager/
   git add roles/desktop/default.nix

3. Create commit:
   ```
   refactor(home-manager): separate installation from configuration

   Move desktop environment and browser installations to modules/apps/,
   keeping only user-level configuration in home-manager.

   Changes:
   - Created modules/apps/window-managers/hyprland.nix for Hyprland installation
   - Created modules/apps/desktop/{rofi,waybar,dunst}.nix for utilities
   - Created modules/apps/browsers/{firefox,brave,chromium}.nix for installation
   - Updated home-manager to remove package installations
   - Preserved user configuration in home-manager (programs.*, user scripts)
   - Updated desktop role to enable new package modules
   - Added documentation explaining installation vs configuration split

   Benefits:
   - Consistent module selection pattern across repo
   - Clear separation: modules/apps = installation, home-manager = config
   - Desktop apps follow same enable pattern as all other modules
   - Easier to understand and maintain

   Phase 22 - Home Manager Cleanup
   ```

4. Do NOT push yet (wait for final approval)
  </action>
  <verify>
git log shows commit with proper message.
git status shows clean working directory or only Phase 22 SUMMARY pending.
All module files, home-manager files, and role changes committed.
  </verify>
  <done>
- Changes committed with descriptive message
- Commit explains what changed and why
- Ready for push after final approval
  </done>
</task>

<task type="auto">
  <name>Task 10: Create Phase 22 SUMMARY</name>
  <files>.planning/phases/22-home-manager-cleanup/22-01-SUMMARY.md</files>
  <action>
Create SUMMARY.md documenting the phase completion:

```markdown
# Phase 22 Plan 1: Home Manager Cleanup Summary

**Separated installation from configuration: desktop/browser packages moved to modules/apps/, user config stays in home-manager**

## Accomplishments

- Created modules/apps/window-managers/ for window manager installations
  - hyprland.nix: Hyprland WM installation, plugins, essential packages

- Created desktop utility modules in modules/apps/desktop/
  - rofi.nix, waybar.nix, dunst.nix: Installation only, config in home-manager

- Created browser installation modules in modules/apps/browsers/
  - firefox.nix, brave.nix, chromium.nix: Package installation
  - Browser configuration remains in home-manager (programs.firefox policies/extensions)

- Updated home-manager files to remove package installations
  - Kept only user-level configuration (programs.*, services.*, user scripts)
  - Added header comments explaining installation vs config separation

- Updated desktop role to enable new package modules
  - Desktop systems automatically get window manager, utilities, browsers

- Created documentation explaining the new pattern
  - home-manager/README.md clarifies installation vs configuration split
  - Header comments in key files

## Files Created/Modified

Created:
- `modules/apps/window-managers/default.nix` - Window manager module imports
- `modules/apps/window-managers/hyprland.nix` - Hyprland installation
- `modules/apps/desktop/rofi.nix` - Rofi installation
- `modules/apps/desktop/waybar.nix` - Waybar installation
- `modules/apps/desktop/dunst.nix` - Dunst installation
- `modules/apps/browsers/firefox.nix` - Firefox installation
- `modules/apps/browsers/brave.nix` - Brave installation
- `modules/apps/browsers/chromium.nix` - Chromium installation
- `home-manager/README.md` - Documentation of new pattern

Modified:
- `modules/apps/browsers/default.nix` - Added browser module imports
- `modules/apps/desktop/default.nix` - Added desktop utility imports
- `home-manager/desktops/default.nix` - Removed package installations
- `home-manager/desktops/hyprland/default.nix` - Kept only WM configuration
- `home-manager/browsers/firefox.nix` - Header comment added
- `home-manager/browsers/brave.nix` - [Updated based on content]
- `home-manager/browsers/chromium.nix` - [Updated based on content]
- `home-manager/browsers/default.nix` - Updated imports
- `roles/desktop/default.nix` - Enabled new package modules

## Decisions Made

- **Naming**: Used `window-managers` (plural, hyphenated) for consistency with repo patterns
- **Scope**: Only moved installations to modules, kept configuration in home-manager
- **Browser config**: Kept programs.firefox in home-manager (policies, extensions need it)
- **Desktop utilities**: Moved essential tools (pavucontrol, etc.) to modules/apps/desktop/desktop.nix

## Issues Encountered

[Document any issues found during implementation]

## Next Phase Readiness

Phase 22 complete. Home-manager now focused solely on user-level configuration.
Installation follows consistent myModules.apps.* pattern repo-wide.

Ready to proceed with Phase 21 (TPM Unlock) or other work.
```

Update with actual details from implementation.
  </action>
  <verify>
SUMMARY.md exists in .planning/phases/22-home-manager-cleanup/
Accurately documents what was accomplished.
Lists all created/modified files.
Notes any issues encountered.
  </verify>
  <done>
- SUMMARY.md created with complete implementation details
- Phase outcome documented
- Ready for roadmap update
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] nix flake check passes without errors
- [ ] Desktop hosts build successfully (malphas)
- [ ] All desktop packages present in build closure
- [ ] Module enable options evaluate correctly
- [ ] home-manager contains only configuration, no installations
- [ ] modules/apps/ contains package installations
- [ ] Desktop role enables new modules
- [ ] Documentation explains the new pattern
- [ ] No regressions in desktop functionality
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Package installation moved to modules/apps/
- User configuration remains in home-manager
- Consistent module selection pattern across repo
- Desktop environments and browsers follow myModules.apps.* pattern
- Documentation clearly explains installation vs configuration
- Changes committed and ready for deployment
- Desktop hosts build and function correctly
</success_criteria>

<output>
After completion, create `.planning/phases/22-home-manager-cleanup/22-01-SUMMARY.md`:

# Phase 22 Plan 1: Home Manager Cleanup Summary

**[Substantive one-liner describing the reorganization]**

## Accomplishments
- Separated package installation from user configuration
- Created window manager, desktop utility, and browser modules
- Updated home-manager to focus on configuration only
- Documented installation vs configuration pattern

## Files Created/Modified
[List of all modules created and files modified]

## Decisions Made
[Key decisions about structure, naming, scope]

## Issues Encountered
[Any challenges, bugs, or workarounds needed]

## Next Phase Readiness
Phase 22 complete. Home-manager reorganization successful.
Ready for Phase 21 (TPM Unlock) or other phases.
</output>
