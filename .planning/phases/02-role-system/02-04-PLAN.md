---
phase: 02-role-system
plan: 04
type: execute
---

<objective>
Wire up roles in flake and verify the complete role system works end-to-end.

Purpose: Integrate the role system into the flake so hosts can use roles.desktop.enable = true.
Output: Working role system that a host can use to get all appropriate modules.
</objective>

<execution_context>
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/templates/summary.md
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/references/checkpoints.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/02-role-system/02-01-SUMMARY.md
@.planning/phases/02-role-system/02-02-SUMMARY.md
@.planning/phases/02-role-system/02-03-SUMMARY.md
@flake.nix
@roles/default.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire up roles in flake</name>
  <files>flake.nix</files>
  <action>
Update flake.nix mkHost function to include roles:

1. **Add roles to the modules list in mkHost:**
```nix
mkHost = hostname: let
  # ... existing code ...
in nixpkgs.lib.nixosSystem {
  inherit system;
  specialArgs = { inherit inputs outputs lib; };
  modules = [
    # Role system - must come before host config
    ./roles

    # Existing modules...
    ./modules/common
    ./hosts/${hostname}
    # ... etc
  ];
};
```

2. **Ensure roles/default.nix is imported** so all role definitions are available.

3. **Verify that modules/common includes the roles.nix options file** from Plan 02-03.

The goal: When a host sets `roles.desktop = true;`, the role's imports and config are activated.
  </action>
  <verify>nix flake check --no-build (should not error on role-related issues)</verify>
  <done>Roles wired into flake, available to all hosts</done>
</task>

<task type="auto">
  <name>Task 2: Create test host using role system</name>
  <files>hosts/nixos/roletest/default.nix, hosts/nixos/roletest/hardware-configuration.nix</files>
  <action>
Create a minimal test host that uses the role system:

**hosts/nixos/roletest/default.nix:**
```nix
{ config, lib, pkgs, ... }:
{
  # Minimal host using role system
  roles.vm = true;  # Use VM role for testing

  # Required host-specific settings
  hostSpec = {
    hostName = "roletest";
    primaryUsername = "test";
  };

  # Minimal hardware (for evaluation only)
  fileSystems."/" = {
    device = "/dev/sda1";
    fsType = "ext4";
  };
  boot.loader.grub.device = "/dev/sda";

  system.stateVersion = "25.05";
}
```

This is just for testing that the role system evaluates correctly.
It doesn't need to actually boot - just needs to pass nix evaluation.
  </action>
  <verify>nix eval .#nixosConfigurations.roletest.config.roles.vm --json returns true</verify>
  <done>Test host created and role system evaluates correctly</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 2 Role System: modules migrated, roles defined, integrated into flake</what-built>
  <how-to-verify>
    1. Check module structure:
       ls modules/apps/ modules/services/
       - Should see cli/, fonts/, media/, gaming/, development/, etc.
       - Should see networking/, desktop/, audio/, security/, etc.

    2. Check roles exist:
       ls roles/
       - Should see: default.nix, desktop.nix, laptop.nix, server.nix, pi.nix, tablet.nix, darwin.nix, vm.nix

    3. Test role evaluation:
       nix eval .#nixosConfigurations.roletest.config.roles.vm
       - Should return: true

    4. Test that a role imports modules:
       nix eval .#nixosConfigurations.roletest.config.services.openssh.enable
       - Should return: true (VM role enables SSH by default)

    5. Optional - test with existing host:
       Try adding `roles.desktop = true;` to an existing host temporarily
       and verify it evaluates without errors.
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 2, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] roles/ imported in flake.nix mkHost
- [ ] Test host evaluates with role enabled
- [ ] Role options (roles.X) accessible in host configs
- [ ] Role modules are conditionally imported based on enable flag
</verification>

<success_criteria>
- Phase 2 Role System complete
- Hosts can declare `roles.desktop = true;` to get all desktop modules
- Migrated modules from ~/nix/roles/ available as proper modules
- Role defaults are overridable (lib.mkDefault)
- Ready for Phase 3 (Host-Spec & Inheritance)
</success_criteria>

<output>
After completion, create `.planning/phases/02-role-system/02-04-SUMMARY.md`

This summary should include:
- All four plans' accomplishments
- Count of migrated modules
- List of roles created
- Any issues with module migration
- Confirmation ready for Phase 3
</output>
