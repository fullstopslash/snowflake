---
phase: 02-role-system
plan: 01
type: execute
---

<objective>
Create module directory structure and migrate core/desktop modules from ~/nix/roles/.

Purpose: Establish the module organization that roles will import, migrating working configurations from ~/nix.
Output: /modules/apps/ and /modules/services/ with migrated core and desktop modules.
</objective>

<execution_context>
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
@~/nix/roles/
@modules/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create modules directory structure</name>
  <files>modules/apps/, modules/services/, modules/hardware/</files>
  <action>
Create organized module structure:

```
modules/
├── apps/           # User-facing applications
│   ├── browsers/   # firefox, etc.
│   ├── editors/    # neovim, etc.
│   ├── media/      # video players, obs, etc.
│   └── productivity/ # document processing, etc.
├── services/       # System services
│   ├── audio/      # pipewire, audio-tuning
│   ├── networking/ # tailscale, syncthing, vpn
│   ├── desktop/    # display managers, compositors
│   └── development/ # containers, dev tools
├── hardware/       # Hardware-specific
│   ├── gpu/        # AMD, NVIDIA, etc.
│   └── input/      # controllers, tablets
└── common/         # Shared by all (keep existing structure)
```

Create the directories with placeholder default.nix files that just return empty module:
```nix
{ ... }: { }
```

Keep existing modules/common/, modules/home/, modules/hosts/ intact.
  </action>
  <verify>ls -la modules/apps modules/services modules/hardware shows directories exist</verify>
  <done>Module directory structure created with placeholder files</done>
</task>

<task type="auto">
  <name>Task 2: Migrate core modules from ~/nix/roles/</name>
  <files>modules/apps/shell/, modules/apps/cli/, modules/services/</files>
  <action>
Copy these essential modules from ~/nix/roles/ to appropriate locations:

**CLI/Shell tools → modules/apps/cli/**
- cli-tools.nix → modules/apps/cli/tools.nix
- shell.nix → modules/apps/cli/shell.nix
- atuin.nix → modules/apps/cli/atuin.nix

**Fonts → modules/apps/fonts/**
- fonts.nix → modules/apps/fonts/default.nix

**Networking services → modules/services/networking/**
- networking.nix → modules/services/networking/default.nix
- tailscale.nix → modules/services/networking/tailscale.nix
- syncthing.nix → modules/services/networking/syncthing.nix
- vpn.nix → modules/services/networking/vpn.nix

**Storage → modules/services/storage/**
- network-storage.nix → modules/services/storage/network-storage.nix

When copying:
1. Keep the file content exactly as-is for now
2. Update any relative import paths if they reference ../../ patterns
3. Do NOT change functionality - just relocate

Create default.nix in each directory that imports all modules in that directory using lib.custom.scanPaths or explicit imports.
  </action>
  <verify>ls modules/apps/cli/ modules/services/networking/ shows migrated files</verify>
  <done>Core modules migrated to new structure</done>
</task>

<task type="auto">
  <name>Task 3: Migrate desktop modules</name>
  <files>modules/apps/desktop/, modules/services/desktop/, modules/apps/media/</files>
  <action>
Copy desktop-related modules:

**Desktop environment → modules/services/desktop/**
- desktop.nix → modules/services/desktop/common.nix (core desktop services)
- hyprland.nix → modules/services/desktop/hyprland.nix
- plasma.nix → modules/services/desktop/plasma.nix
- niri.nix → modules/services/desktop/niri.nix
- greetd.nix → modules/services/desktop/greetd.nix
- waybar.nix → modules/services/desktop/waybar.nix

**Audio → modules/services/audio/**
- audio-tuning.nix → modules/services/audio/tuning.nix

**Media apps → modules/apps/media/**
- media.nix → modules/apps/media/default.nix
- obs.nix → modules/apps/media/obs.nix

**Gaming → modules/apps/gaming/**
- gaming.nix → modules/apps/gaming/default.nix
- moondeck-buddy.nix → modules/apps/gaming/moondeck.nix

**Theming → modules/apps/theming/**
- stylix.nix → modules/apps/theming/stylix.nix

When copying:
1. Keep file content as-is
2. Fix any broken import paths
3. Create default.nix in each new directory

Note: Some modules may have dependencies on inputs (stylix, sops-nix). Keep those import patterns - they'll be wired up when roles import them.
  </action>
  <verify>ls modules/services/desktop/ modules/apps/media/ modules/apps/gaming/ shows migrated files</verify>
  <done>Desktop modules migrated to new structure</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] modules/apps/ has cli/, fonts/, media/, gaming/, theming/ subdirectories
- [ ] modules/services/ has networking/, desktop/, audio/, storage/ subdirectories
- [ ] Core modules (cli-tools, shell, networking, etc.) exist in new locations
- [ ] Desktop modules (hyprland, plasma, waybar, etc.) exist in new locations
- [ ] No syntax errors in migrated files (nix-instantiate --parse on each)
</verification>

<success_criteria>
- Module directory structure established
- 20+ modules migrated from ~/nix/roles/
- File contents preserved (no functional changes)
- Directory default.nix files created for easy importing
</success_criteria>

<output>
After completion, create `.planning/phases/02-role-system/02-01-SUMMARY.md`
</output>
