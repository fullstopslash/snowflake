---
phase: 02-role-system
plan: 02
type: execute
---

<objective>
Complete module migration: development tools, services, and fix all import paths.

Purpose: Finish migrating all modules from ~/nix/roles/ and ensure they work in the new structure.
Output: Complete module library ready for role definitions to import.
</objective>

<execution_context>
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/02-role-system/02-01-SUMMARY.md
@~/nix/roles/
@modules/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate development modules</name>
  <files>modules/apps/development/, modules/services/development/</files>
  <action>
Copy development-related modules:

**Development tools → modules/apps/development/**
- development.nix → modules/apps/development/default.nix
- neovim.nix → modules/apps/development/neovim.nix
- ai-tools.nix → modules/apps/development/ai-tools.nix
- rust-packages.nix → modules/apps/development/rust.nix
- latex.nix → modules/apps/development/latex.nix

**Containers/VMs → modules/services/development/**
- containers.nix → modules/services/development/containers.nix
- quickemu.nix → modules/services/development/quickemu.nix

Create default.nix files that import all modules in each directory.
  </action>
  <verify>ls modules/apps/development/ modules/services/development/ shows migrated files</verify>
  <done>Development modules migrated</done>
</task>

<task type="auto">
  <name>Task 2: Migrate service/utility modules</name>
  <files>modules/services/</files>
  <action>
Copy remaining service modules:

**Security/Secrets → modules/services/security/**
- secrets.nix → modules/services/security/secrets.nix
- bitwarden-automation.nix → modules/services/security/bitwarden.nix

**AI services → modules/services/ai/**
- ollama.nix → modules/services/ai/ollama.nix
- crush.nix → modules/services/ai/crush.nix (if it's a service)

**Misc services → modules/services/misc/**
- flatpak.nix → modules/services/misc/flatpak.nix
- sinkzone.nix → modules/services/misc/sinkzone.nix
- voice-assistant.nix → modules/services/misc/voice-assistant.nix

**Also migrate from ~/nix/modules/ if useful:**
- Check ~/nix/modules/ for any additional modules worth bringing over
- sops.nix → modules/services/security/sops.nix (if not already present)
- ssh-no-sleep.nix → modules/services/misc/ssh-no-sleep.nix

Create default.nix files for new directories.
  </action>
  <verify>ls modules/services/security/ modules/services/ai/ modules/services/misc/ shows migrated files</verify>
  <done>Service modules migrated</done>
</task>

<task type="auto">
  <name>Task 3: Fix module imports and create index</name>
  <files>modules/apps/default.nix, modules/services/default.nix</files>
  <action>
1. **Audit all migrated modules for broken imports:**
   - Search for `../../roles/` patterns and fix them
   - Search for `../modules/` patterns and update paths
   - Ensure `inputs.` references are preserved (they'll work when imported by hosts)

2. **Create top-level index files:**

modules/apps/default.nix:
```nix
{ ... }: {
  imports = [
    ./cli
    ./fonts
    ./media
    ./gaming
    ./theming
    ./development
  ];
}
```

modules/services/default.nix:
```nix
{ ... }: {
  imports = [
    ./networking
    ./desktop
    ./audio
    ./storage
    ./development
    ./security
    ./ai
    ./misc
  ];
}
```

3. **Test that modules can be parsed:**
   Run `nix-instantiate --parse` on a sampling of migrated modules to catch syntax errors.

4. **Document any modules that couldn't be migrated** (dependencies on missing inputs, etc.) in the summary.
  </action>
  <verify>nix-instantiate --parse modules/apps/default.nix && nix-instantiate --parse modules/services/default.nix</verify>
  <done>All imports fixed, index files created, modules parse successfully</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 30+ modules from ~/nix/roles/ have been migrated
- [ ] modules/apps/default.nix imports all app categories
- [ ] modules/services/default.nix imports all service categories
- [ ] No broken import paths (grep for `../../roles/` returns nothing)
- [ ] Sample modules parse without syntax errors
</verification>

<success_criteria>
- Complete module migration from ~/nix/roles/
- All import paths updated for new structure
- Index files allow importing entire categories
- Modules ready for role definitions to use
</success_criteria>

<output>
After completion, create `.planning/phases/02-role-system/02-02-SUMMARY.md`
</output>
