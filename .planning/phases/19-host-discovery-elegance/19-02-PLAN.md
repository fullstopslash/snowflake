---
phase: 19-host-discovery-elegance
plan: 02
type: execute
---

<objective>
Rename hostSpec to host with clearer structure and boundaries between /roles, /modules, and /hosts.

Purpose: Create elegant, minimal, streamlined host configuration that's obvious and easy to parse at a glance. The host module should define WHO the machine is (identity + hardware + preferences), not HOW it behaves (that's derived from modules/roles).

Output: New modules/common/host.nix with clear categories, all 37+ files migrated to use new structure.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/19-host-discovery-elegance/19-01-SUMMARY.md
@modules/common/host-spec.nix
@hosts/griefling/default.nix
@hosts/malphas/default.nix
@roles/common.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create modules/common/host.nix with clearer structure</name>
  <files>modules/common/host.nix, roles/common.nix</files>
  <action>
Create new modules/common/host.nix with these sections (copy from host-spec.nix but reorganize):

**IDENTITY OPTIONS** (hosts set these):
- hostName (required)
- primaryUsername (default from role)
- email (from secrets)
- domain (from secrets)
- userFullName (from secrets)
- handle (default: "fullstopslash")
- home (auto-computed)
- users (default: [primaryUsername])
- architecture (required - set by roles)
- nixpkgsVariant (default: "stable")
- useCustomPkgs (derived from nixpkgsVariant)

**HARDWARE OPTIONS** (hosts set based on physical hardware):
- wifi (bool, default from role)
- hdr (bool, default false)
- scaling (string, default "1")
- isDarwin (derived from architecture)

**PREFERENCES** (hosts customize these):
- isWork (bool, default false)
- useYubikey (bool, default false)
- voiceCoding (bool, default false)
- isAutoStyled (bool, default false)
- theme (string, default "dracula")
- useNeovimTerminal (bool, default false)
- wallpaper (path, default from assets)
- defaultBrowser (string, default "firefox")
- defaultEditor (string, default "nvim")
- defaultDesktop (string, default "Hyprland")

**DERIVED OPTIONS** (computed, rarely need manual override):
- isMinimal (derived: no desktop or apps)
- isHeadless (default false, roles can override)
- isProduction (default true, roles can override)
- isDevelopment (derived: modules.development != [])
- isMobile (default false, roles can override)
- useWayland (derived: wayland desktop selected)
- useWindowManager (derived: desktop modules selected)
- hasSecrets (default true, ISO overrides to false)
- useAtticCache (default true)

**SECRET CATEGORIES** (roles set these):
- secretCategories.base (bool, default true)
- secretCategories.desktop (bool, default false)
- secretCategories.server (bool, default false)
- secretCategories.network (bool, default false)
- secretCategories.cli (bool, default false)

REMOVE these deprecated/redundant options:
- username (deprecated alias, use primaryUsername)
- networking (moved to secrets)
- persistFolder (belongs in impermanence config, not host identity)

Update roles/common.nix to set defaults for new `host.*` structure:
- host.primaryUsername = lib.mkDefault "rain"
- host.handle = lib.mkDefault "fullstopslash"
- host.useAtticCache = lib.mkDefault true

Keep all assertions from host-spec.nix (isWork check, impermanence check, voiceCoding+Wayland check).

AVOID changing the logic of derived options - they should work identically, just with new naming.
  </action>
  <verify>
- modules/common/host.nix exists and follows structure
- nix eval .#nixosConfigurations.griefling.config.host.hostName succeeds
- Options are organized into clear sections with comments
- Deprecated options are removed
  </verify>
  <done>New host.nix module created with clear structure, defaults set in roles/common.nix</done>
</task>

<task type="auto">
  <name>Task 2: Mass migration - update all files to use host.* instead of hostSpec.*</name>
  <files>modules/services/networking/tailscale.nix, modules/services/networking/syncthing.nix, nixos-installer/flake.nix, modules/common/nixos-defaults.nix, roles/task-test.nix, modules/common/auto-upgrade.nix, flake.nix, modules/services/dotfiles/chezmoi-sync.nix, modules/security/sops-enforcement.nix, modules/common/sops.nix, modules/services/display-manager/ly.nix, hosts/TEMPLATE.nix, hosts/template/default.nix, modules/services/networking/ssh.nix, modules/services/storage/borg.nix, modules/services/security/bitwarden.nix, modules/services/security/yubikey.nix, modules/users/default.nix, modules/services/networking/openssh.nix, modules/services/cli/atuin.nix, modules/services/desktop/common.nix, modules/disks/default.nix, modules/common/nix-management.nix, modules/services/security/clamav.nix, modules/users/minimal-user.nix, nixos-installer/minimal-configuration.nix, modules/users/nixos-defaults.nix, modules/common/universal.nix, modules/disks/nvme.nix, modules/disks/btrfs-luks-impermanence-disk.nix, modules/disks/btrfs-impermanence-disk.nix, home-manager/desktops/hyprland/default.nix, home-manager/desktops/hyprland/binds.nix, home-manager/desktops/hyprland/host-config-link.nix, home-manager/xdg.nix, home-manager/desktops/waybar.nix, hosts/iso/default.nix, hosts/malphas/default.nix, hosts/sorrow/default.nix, hosts/torment/default.nix, hosts/griefling/default.nix</files>
  <action>
Perform global find-and-replace across all 37+ files:
- Replace `hostSpec.` with `host.` (config.hostSpec.foo → config.host.foo)
- Replace `options.hostSpec` with `options.host`
- Keep the actual values and logic identical - this is purely a rename

Strategy:
1. Use sed or similar to perform regex replacement: s/hostSpec\./host\./g and s/options\.hostSpec/options.host/g
2. Handle special cases:
   - In modules/common/host.nix imports section, add: modules/common/host-spec.nix is removed (see next plan)
   - In flake.nix mkHost function, update variable references
   - In nixos-installer, update hostSpec references to host

3. Update all host files (griefling, malphas, sorrow, torment, iso, template):
   - hostSpec { ... } → host { ... }
   - Keep all existing values and structure

4. Test after each batch of ~10 files to catch any issues early

AVOID changing any logic or values - this is a mechanical rename. If something breaks, it means the migration wasn't pure enough.
  </action>
  <verify>
- grep -r "hostSpec\." modules/ hosts/ roles/ returns no matches (all renamed)
- nix flake check passes (all hosts evaluate)
- nix eval .#nixosConfigurations.griefling.config.host.hostName returns "griefling"
- nix eval .#nixosConfigurations.malphas.config.host.primaryUsername returns "rain"
  </verify>
  <done>All 37+ files migrated from hostSpec to host, no eval errors, all hosts build</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] modules/common/host.nix exists with clear structure
- [ ] No files reference hostSpec anymore: grep -r "hostSpec" modules/ hosts/ roles/ returns only comments
- [ ] All hosts evaluate: nix flake check passes
- [ ] griefling config accessible: nix eval .#nixosConfigurations.griefling.config.host.hostName
- [ ] All hosts build successfully
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- hostSpec renamed to host across entire codebase
- New module has elegant, clear structure
- Host configs are easy to parse at a glance
- Three-tier system clear: /roles (presets), /modules (units), /hosts (identity)
</success_criteria>

<output>
After completion, create `.planning/phases/19-host-discovery-elegance/19-02-SUMMARY.md`:

# Phase 19 Plan 2: Rename hostSpec → host Summary

**[One-line summary of what shipped]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `file/path` - Description

## Decisions Made
[Key decisions and rationale, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Ready for 19-03-PLAN.md (Cleanup & Verification)
</output>
