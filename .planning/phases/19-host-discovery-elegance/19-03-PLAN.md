---
phase: 19-host-discovery-elegance
plan: 03
type: execute
---

<objective>
Clean up old hostSpec module, embed nix-config in ISO, and verify entire system works end-to-end.

Purpose: Complete the migration by removing backward compatibility, ensuring ISO has embedded config for install-host command, and validating all hosts build and work correctly.

Output: Clean codebase with host module only, ISO with embedded flake, full documentation, all hosts verified.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/19-host-discovery-elegance/19-01-SUMMARY.md
@.planning/phases/19-host-discovery-elegance/19-02-SUMMARY.md
@modules/common/host-spec.nix
@modules/common/host.nix
@nixos-installer/flake.nix
@hosts/iso/default.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove old hostSpec module and update ISO configuration</name>
  <files>modules/common/host-spec.nix, modules/common/default.nix, hosts/iso/default.nix, nixos-installer/minimal-configuration.nix</files>
  <action>
1. Delete modules/common/host-spec.nix entirely (migration complete, no longer needed)

2. Update modules/common/default.nix imports:
   - Remove host-spec.nix from imports list
   - Ensure host.nix is imported (should already be there)

3. Update hosts/iso/default.nix:
   - Set host.hasSecrets = lib.mkForce false (ISO doesn't have secrets)
   - Add comment explaining ISO is for recovery/install, secrets bootstrapped post-install

4. Update nixos-installer/minimal-configuration.nix to embed nix-config and install tools:
   ```nix
   { pkgs, ... }: {
     # Embed nix-config for install-host script
     system.activationScripts.embedNixConfig = ''
       mkdir -p /etc/nixos-config
       cp -r ${/home/rain/nix-config}/* /etc/nixos-config/
       chmod -R +w /etc/nixos-config
     '';

     # Install helper script
     environment.systemPackages = with pkgs; [
       (writeShellScriptBin "install-host" (builtins.readFile ./install-host.sh))
     ];

     # Troubleshooting tools for recovery
     environment.systemPackages = with pkgs; [
       neovim
       btrfs-progs
       bcachefs-tools
       git
       just  # For accessing justfile commands if needed
     ];

     # Pre-populate bash history for convenience
     programs.bash.interactiveShellInit = ''
       if [ ! -f ~/.bash_history ]; then
         echo "install-host " > ~/.bash_history
       fi
     '';
   }
   ```

5. Verify the embedded path doesn't include nix-secrets (security check)

AVOID embedding secrets in ISO - the embedded config is public structure only. The nix-secrets input will be fetched during build on target system after bootstrap.
  </action>
  <verify>
- modules/common/host-spec.nix no longer exists
- grep -r "hostSpec" modules/ returns no results
- hosts/iso/default.nix has host.hasSecrets = false
- nixos-installer/minimal-configuration.nix embeds config and includes tools
- ISO configuration evaluates: nix build .#nixosConfigurations.iso.config.system.build.isoImage
  </verify>
  <done>Old module removed, ISO configured with embedded flake and tools, no secrets in ISO</done>
</task>

<task type="auto">
  <name>Task 2: Comprehensive verification and documentation</name>
  <files>README.md, docs/installation.md (create if not exists), .planning/phases/19-host-discovery-elegance/19-03-SUMMARY.md</files>
  <action>
1. Build verification - ensure all hosts build successfully:
   - nix build .#nixosConfigurations.griefling.config.system.build.toplevel
   - nix build .#nixosConfigurations.malphas.config.system.build.toplevel
   - nix build .#nixosConfigurations.sorrow.config.system.build.toplevel
   - nix build .#nixosConfigurations.torment.config.system.build.toplevel
   - nix build .#nixosConfigurations.iso.config.system.build.isoImage

2. Test installer auto-discovery:
   - nix flake show --flake ./nixos-installer (should list all hosts except iso/template)
   - Verify each host has correct architecture and nixpkgs variant

3. Create/update docs/installation.md with new workflows:
   ```markdown
   # Installation Guide

   ## Remote Install (from another machine)
   ```bash
   just install <hostname> <ip-address>
   ```

   ## ISO Install (from recovery ISO)
   1. Boot from ISO
   2. Connect to network (if needed)
   3. Run: `install-host <hostname>`
   4. After reboot: `cd /path/to/nix-config && ./scripts/bootstrap-secrets.sh <hostname>`

   ## Adding a New Host
   1. Create `hosts/<hostname>/` directory
   2. Add `default.nix` with:
      - `roles = [ "form-factor" "task-roles" ];`
      - `host = { hostName = "..."; };`
      - `disks = { ... };` (for installer)
   3. Add `hardware-configuration.nix`
   4. Commit and push
   5. Install with either method above

   ## Architecture Notes
   - Host behavior is declarative in host configs
   - Roles set defaults (architecture, wifi, etc.)
   - Hosts override as needed
   - No manual flake declarations required
   ```

4. Update README.md to mention new host module and installation workflows

5. Verify three-tier system clarity by reviewing a few host files:
   - Should be obvious what /roles does (presets)
   - Should be obvious what /modules does (units)
   - Should be obvious what /hosts does (identity)

AVOID skipping the build verification - catching issues now is critical before declaring phase complete.
  </action>
  <verify>
- All hosts build without errors
- ISO builds successfully
- Installation docs exist and are clear
- README updated with new structure
- No grep matches for "hostSpec" in codebase (except git history)
  </verify>
  <done>All hosts verified, ISO builds, documentation complete, Phase 19 finished</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] All hosts build: griefling, malphas, sorrow, torment, iso
- [ ] ISO includes embedded nix-config at /etc/nixos-config
- [ ] ISO includes install-host command and troubleshooting tools
- [ ] No secrets in ISO
- [ ] Documentation updated (installation.md, README.md)
- [ ] No hostSpec references remain (except git history)
- [ ] Three-tier system is clear: roles/modules/hosts have distinct purposes
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- hostSpec fully removed from codebase
- ISO functional with embedded config
- All hosts build successfully
- Documentation complete and accurate
- System is elegant, minimal, streamlined, and easy to parse
- Phase 19 objectives fully achieved
</success_criteria>

<output>
After completion, create `.planning/phases/19-host-discovery-elegance/19-03-SUMMARY.md`:

# Phase 19 Plan 3: Cleanup & Verification Summary

**[One-line summary of what shipped]**

## Accomplishments
- [Key outcomes from all 3 plans]

## Files Created/Modified
- `file/path` - Description

## Decisions Made
[Key decisions across entire phase]

## Issues Encountered
[Problems and resolutions, or "None"]

## Deviations from Plan
[Any deviations using deviation rules, or "None"]

## Phase 19 Complete
All objectives achieved:
- ✅ Host auto-discovery (no manual declarations)
- ✅ Declarative host behavior (no hardcoded lists)
- ✅ hostSpec renamed to host (elegant, minimal, clear)
- ✅ Three-tier system: /roles, /modules, /hosts with distinct functions
- ✅ ISO with embedded config and install-host helper
- ✅ Single-command installs (remote and ISO)

## Future Enhancements
- Single-step ISO installs with secrets (Phase 20+)
  - Could add --with-secrets flag to prompt for credentials
  - Could read from USB key
  - Current design is extensible for this

## Next Phase
Ready for Phase 17 (Physical Security & Recovery) or Phase 20 (new work)
</output>
