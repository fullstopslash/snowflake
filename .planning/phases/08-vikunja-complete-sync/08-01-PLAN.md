---
phase: 08-vikunja-complete-sync
plan: 01
type: execute
---

<objective>
Fix project field sync so that changing a task's project in Taskwarrior correctly moves the task to the new project in Vikunja.

Purpose: Currently, when a TW task's project is changed, the Vikunja task stays in its original project because `project_id` is only set during task creation, not updates. This breaks bidirectional sync for project reorganization.

Output: Modified vikunja-direct.py that syncs project changes in both directions.
</objective>

<context>
@.planning/ROADMAP.md
@pkgs/vikunja-sync/vikunja-direct.py
@pkgs/vikunja-sync/vikunja_common.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add project_id to tw_to_vikunja_task conversion</name>
  <files>pkgs/vikunja-sync/vikunja-direct.py</files>
  <action>
Modify `tw_to_vikunja_task()` function to accept and include project_id in the returned dict.

Current function signature: `def tw_to_vikunja_task(tw_task: dict) -> dict:`

New signature: `def tw_to_vikunja_task(tw_task: dict, project_id: int | None = None) -> dict:`

Add to the returned dict:
```python
if project_id:
    vikunja_task["project_id"] = project_id
```

This ensures that when updating existing tasks, the project_id is included in the API payload, allowing Vikunja to move the task to the correct project.

AVOID: Don't add project_id unconditionally - only when provided, as some callers may not have it available.
  </action>
  <verify>grep -n "project_id" pkgs/vikunja-sync/vikunja-direct.py shows project_id handling in tw_to_vikunja_task</verify>
  <done>Function signature updated, project_id conditionally added to return dict</done>
</task>

<task type="auto">
  <name>Task 2: Pass project_id to tw_to_vikunja_task in push_to_vikunja</name>
  <files>pkgs/vikunja-sync/vikunja-direct.py</files>
  <action>
In `push_to_vikunja()` function, update the call to `tw_to_vikunja_task()` to pass the resolved project_id.

Current code (around line 554):
```python
vikunja_task = tw_to_vikunja_task(tw_task)
```

Updated code:
```python
vikunja_task = tw_to_vikunja_task(tw_task, project_id)
```

This passes the project_id that was already resolved via `get_or_create_project()` on line 549.

AVOID: Don't pass project_id before it's resolved - the `get_or_create_project()` call must happen first.
  </action>
  <verify>grep -A2 "tw_to_vikunja_task" pkgs/vikunja-sync/vikunja-direct.py shows project_id being passed</verify>
  <done>push_to_vikunja passes project_id to tw_to_vikunja_task</done>
</task>

<task type="auto">
  <name>Task 3: Handle project changes correctly in Vikunja API update</name>
  <files>pkgs/vikunja-sync/vikunja-direct.py</files>
  <action>
Verify that the Vikunja API POST to `/tasks/{vikunja_id}` correctly handles project_id updates.

The current code at line 576:
```python
result = vikunja.post(f"/tasks/{vikunja_id}", vikunja_task)
```

The Vikunja API should accept project_id in the update payload and move the task. Verify this by:
1. Checking Vikunja API docs (if available) or testing manually
2. If API doesn't support project moves via POST, use a different endpoint

If Vikunja requires special handling for project moves:
- Some APIs require DELETE from old project + PUT to new project
- Check if there's a `/tasks/{id}/project` endpoint
- May need to compare old vs new project_id and only include when changed

For now, assume the standard POST works (most modern APIs support this). If testing reveals issues, add explicit project-move logic.

AVOID: Don't delete and recreate tasks unless absolutely necessary - this loses task history.
  </action>
  <verify>python3 -c "import pkgs.vikunja-sync.vikunja-direct" (syntax check)</verify>
  <done>Project move handling verified or implemented</done>
</task>

<task type="auto">
  <name>Task 4: Add integration test for project move sync</name>
  <files>pkgs/vikunja-sync/vikunja-direct.py</files>
  <action>
Add a simple CLI command to test project sync. Add a new `cmd_test_project_move` function:

```python
def cmd_test_project_move(args: list[str]) -> int:
    """Test project move sync: vikunja-direct test-project-move <uuid> <new-project>"""
    if len(args) < 2:
        print("Usage: vikunja-direct test-project-move <uuid> <new-project>", file=sys.stderr)
        return 1

    uuid = args[0]
    new_project = args[1]

    tw = TaskwarriorClient()
    task = tw.export_task(uuid)
    if not task:
        log(f"Task {uuid} not found")
        return 1

    old_project = task.get("project", "inbox")
    task["project"] = new_project

    try:
        config = Config.from_env()
        result = push_to_vikunja(task, config, "inbox")
        print(f"Project move: {old_project} -> {new_project}")
        print(json.dumps(result))
        return 0 if result["success"] else 1
    except ConfigError as e:
        log(f"Config error: {e}")
        return 1
```

Add to main():
```python
elif cmd == "test-project-move":
    return cmd_test_project_move(args)
```

This allows manual testing of project moves without modifying TW state.

AVOID: Don't actually modify the TW task in this test command - just test the Vikunja push.
  </action>
  <verify>vikunja-direct --help shows test-project-move command (after rebuild)</verify>
  <done>Test command added for manual project move verification</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python3 -m py_compile pkgs/vikunja-sync/vikunja-direct.py` passes
- [ ] `tw_to_vikunja_task` accepts and handles project_id parameter
- [ ] `push_to_vikunja` passes project_id to conversion function
- [ ] Test command exists for manual verification
</verification>

<success_criteria>
- All tasks completed
- Python syntax valid
- Project field included in update payloads
- Manual test confirms project moves work end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/08-vikunja-complete-sync/08-01-SUMMARY.md`
</output>
