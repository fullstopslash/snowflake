---
phase: 08-vikunja-complete-sync
plan: 02
type: execute
---

<objective>
Implement bidirectional description/body text sync and completion status reversals.

Purpose: Currently, Vikunja descriptions become TW annotations (one-way, capped at 500 chars), and completing/uncompleting tasks has asymmetric sync behavior. This plan fixes both issues for true bidirectional sync.

Output: Modified vikunja-direct.py with full description sync and reversible completion states.
</objective>

<context>
@.planning/ROADMAP.md
@.planning/phases/08-vikunja-complete-sync/08-01-PLAN.md
@pkgs/vikunja-sync/vikunja-direct.py
@pkgs/vikunja-sync/vikunja_common.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract note annotations and sync to Vikunja description</name>
  <files>pkgs/vikunja-sync/vikunja-direct.py</files>
  <action>
Modify `tw_to_vikunja_task()` to extract `note:` prefixed annotations and send them to Vikunja as description.

Add after the vikunja_task initialization:

```python
# Extract note: annotations to sync as Vikunja description
notes = []
for ann in tw_task.get("annotations", []):
    desc = ann.get("description", "")
    if desc.startswith("note:"):
        notes.append(desc[5:])  # Remove "note:" prefix
# Combine multiple notes with newlines
if notes:
    vikunja_task["description"] = "\n\n".join(notes)
else:
    vikunja_task["description"] = ""
```

This syncs TW note annotations back to Vikunja body text.

AVOID: Don't include vikunja_id annotations - only note: annotations.
AVOID: Don't cap at 500 chars on outgoing sync - Vikunja can handle longer text.
  </action>
  <verify>grep -A10 "note:" pkgs/vikunja-sync/vikunja-direct.py shows note extraction logic</verify>
  <done>Note annotations extracted and synced to Vikunja description field</done>
</task>

<task type="auto">
  <name>Task 2: Remove 500-char cap on incoming description</name>
  <files>pkgs/vikunja-sync/vikunja-direct.py</files>
  <action>
In `vikunja_to_tw_task()`, remove the 500-character limit on description sync.

Current code (around line 214):
```python
annotations.append({
    "entry": datetime.now(timezone.utc).strftime("%Y%m%dT%H%M%SZ"),
    "description": f"note:{vikunja_desc.strip()[:500]}",  # Limit length
})
```

Updated code:
```python
annotations.append({
    "entry": datetime.now(timezone.utc).strftime("%Y%m%dT%H%M%SZ"),
    "description": f"note:{vikunja_desc.strip()}",
})
```

Rationale: TW annotations can handle longer text, and truncating loses data.

AVOID: Don't remove the note: prefix - it's needed to identify these annotations.
  </action>
  <verify>grep "note:" pkgs/vikunja-sync/vikunja-direct.py shows no :500 truncation</verify>
  <done>500-char limit removed from incoming description sync</done>
</task>

<task type="auto">
  <name>Task 3: Handle completion status reversals (done->pending)</name>
  <files>pkgs/vikunja-sync/vikunja-direct.py</files>
  <action>
In `handle_webhook()`, add logic to handle task uncompleting (going from done=true to done=false).

In the update branch (around line 380-388), add handling for uncompleting:

```python
# Handle completion status
if tw_task["status"] == "completed":
    if not tw.complete_task(existing_uuid):
        log(f"Failed to mark TW task {existing_uuid} done")
        return {"success": False, "action": "done_failed", "uuid": existing_uuid}
elif existing_task and existing_task.get("status") == "completed":
    # Task was completed but now uncompleted in Vikunja - revert to pending
    # TW doesn't have an "uncomplete" command, need to use modify
    if not tw.modify_task(existing_uuid, status="pending"):
        log(f"Failed to uncomplete TW task {existing_uuid}")
        return {"success": False, "action": "uncomplete_failed", "uuid": existing_uuid}
```

Also add a `modify_task` method to `TaskwarriorClient` in vikunja_common.py if needed to handle status changes.

AVOID: Don't assume all status values - only handle "completed" and "pending".
AVOID: Don't use `task done --undo` as it may have side effects.
  </action>
  <verify>grep -A5 "uncomplete" pkgs/vikunja-sync/vikunja-direct.py shows uncomplete handling</verify>
  <done>Completion reversals (uncomplete) supported in webhook handler</done>
</task>

<task type="auto">
  <name>Task 4: Handle note annotation updates on modify</name>
  <files>pkgs/vikunja-sync/vikunja-direct.py</files>
  <action>
In `handle_webhook()`, when updating existing tasks, properly handle note annotation updates.

Current behavior: New note annotations are added but old ones aren't updated/removed.

Add logic to update/replace note annotations:

```python
# Update note annotation if description changed
vikunja_desc = task.get("description", "")
if existing_task:
    # Find and update existing note annotation
    existing_anns = existing_task.get("annotations", [])
    note_updated = False
    new_annotations = []
    for ann in existing_anns:
        if ann.get("description", "").startswith("note:"):
            if vikunja_desc.strip():
                # Update with new note
                new_annotations.append({
                    "entry": ann.get("entry"),
                    "description": f"note:{vikunja_desc.strip()}"
                })
                note_updated = True
            # else: Remove old note (don't append)
        else:
            new_annotations.append(ann)

    if not note_updated and vikunja_desc.strip():
        # No existing note, add new one
        new_annotations.append({
            "entry": datetime.now(timezone.utc).strftime("%Y%m%dT%H%M%SZ"),
            "description": f"note:{vikunja_desc.strip()}"
        })

    if new_annotations != existing_anns:
        # Need to update annotations via task import
        # TW doesn't support modify annotations directly
        pass  # Handled via tw_task["annotations"] on import
```

Note: This is complex because TW doesn't have native annotation update support.
Consider whether this complexity is worth it or if "append-only" notes are acceptable.

AVOID: Don't lose existing non-note annotations (like vikunja_id).
  </action>
  <verify>Manual test: Update task description in Vikunja, check TW annotation updates</verify>
  <done>Note annotations properly updated on task modification</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python3 -m py_compile pkgs/vikunja-sync/vikunja-direct.py` passes
- [ ] TW note: annotations sync back to Vikunja description
- [ ] No 500-char truncation on incoming descriptions
- [ ] Uncompleting a task in Vikunja reverts TW to pending
</verification>

<success_criteria>
- All tasks completed
- Python syntax valid
- Description sync is bidirectional without data loss
- Completion status can be reversed in both directions
</success_criteria>

<output>
After completion, create `.planning/phases/08-vikunja-complete-sync/08-02-SUMMARY.md`
</output>
