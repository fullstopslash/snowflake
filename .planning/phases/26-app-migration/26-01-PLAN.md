# Phase 26: TrueNAS SCALE App Migration to Self-Managed Storage

<objective>
Migrate all Servarr stack and related applications from TrueNAS SCALE ix-apps managed storage to a clean, self-managed structure at /mnt/apps/apps/ with modular organization optimized for future k3s migration.
</objective>

<execution_context>
<!-- Files needed for execution protocol -->
- `.planning/docs/execute-phase.md` - Execution protocol and deviation rules
- `/mnt/apps/apps/` - Target self-managed app storage location
- `/mnt/storage/ix-apps/` - Current ix-apps managed location
- `/mnt/storage/media/` - Media files (DO NOT MOVE - only referenced by apps)
</execution_context>

<context>
## Background

Currently running a Servarr media automation stack and other applications on TrueNAS SCALE with apps split between two locations:
- **ix-apps managed storage** (typically `/mnt/storage/ix-apps/`) - TrueNAS-managed, opaque structure
- **Self-managed storage** (`/mnt/apps/apps/`) - Clean, modular structure (partially migrated)

**Current Pain Points:**
- Unclear what has been migrated vs what remains in ix-apps
- Potential duplicates between locations
- ix-apps managed storage is opaque and hard to manage
- Need clean structure for future k3s migration

**Strategic Goal:**
This migration is pre-work for eventual k3s cluster migration. The clean, modular structure at `/mnt/apps/apps/` will make it easier to:
1. Mount volumes in k3s pods
2. Understand app data dependencies
3. Perform backups and restores
4. Debug application issues

## Target Structure

```
/mnt/apps/apps/
├── sonarr/
│   ├── config/          # Application configuration files
│   └── data/            # Application data (if needed)
├── radarr/
│   ├── config/
│   └── data/
├── prowlarr/
│   ├── config/
│   └── data/
├── lidarr/
│   ├── config/
│   └── data/
├── readarr/
│   ├── config/
│   └── data/
├── bazarr/
│   ├── config/
│   └── data/
├── overseerr/
│   ├── config/
│   └── data/
├── jellyfin/
│   ├── config/
│   ├── data/            # Metadata, images, etc.
│   └── cache/           # Transcoding cache (optional)
├── qbittorrent/
│   ├── config/
│   └── data/            # Torrent session data
├── sabnzbd/
│   ├── config/
│   └── data/            # NZB history, etc.
├── recyclarr/
│   └── config/
├── configarr/
│   └── config/
├── janitorr/
│   ├── config/
│   └── data/
├── unpackerr/
│   └── config/
├── notifiarr/
│   └── config/
├── tautulli/
│   ├── config/
│   └── data/            # Database, logs
└── [app-with-postgres]/
    ├── config/
    ├── data/
    └── postgres/        # PostgreSQL data directory (if app uses it)
```

**Key Principles:**
1. **Modular per-app directories** - Each app is self-contained
2. **Consistent subdirectory structure** - config/, data/, postgres/ as needed
3. **No nesting beyond app level** - Flat structure for clarity
4. **Separation of app data from media** - Media stays in /mnt/storage/media/

## Known Applications (Servarr Stack)

**Media Management:**
- Sonarr (TV shows)
- Radarr (Movies)
- Lidarr (Music)
- Readarr (Books)
- Bazarr (Subtitles)

**Indexers & Download:**
- Prowlarr (Indexer management)
- qBittorrent (Torrent client)
- SABnzbd or NZBGet (Usenet downloader)

**Request & Playback:**
- Overseerr or Jellyseerr (Request management)
- Jellyfin or Plex (Media server)
- Tautulli (Plex monitoring)

**Automation & Utilities:**
- Recyclarr or Configarr (Config synchronization)
- Janitorr (Cleanup automation)
- Unpackerr (Archive extraction)
- Notifiarr (Notifications)

## Important Considerations

### Data Integrity Rules
1. **No data loss permitted** - Verify before deleting anything
2. **/mnt/apps/apps/ is authoritative** - If duplicates exist, this is the correct version
3. **Backup before migration** - Both locations backed up before any changes
4. **Verify functionality** - Test each app after migration before cleanup

### TrueNAS SCALE Specifics
- Apps use **Custom App** configurations with volume mounts
- Volume mount paths must be updated in TrueNAS UI
- Apps run as specific user/group (typically `apps` or `568`)
- Permissions must match: `chown -R 568:568 /mnt/apps/apps/appname`
- Some apps use PostgreSQL (check for postgres containers)

### Shared Resources
- **Download folders** - Multiple apps may reference same download directories
- **Media library** - All *arr apps reference /mnt/storage/media/ (DO NOT MOVE)
- **API keys** - Apps communicate via API (Prowlarr ↔ Sonarr/Radarr/etc.)
- **Reverse proxy** - Some apps may be behind Traefik/nginx

### PostgreSQL Apps
Apps that typically use PostgreSQL:
- Prowlarr
- Sonarr (v4+)
- Radarr (v5+)
- Readarr
- Lidarr (recent versions)

**Migration Steps for PostgreSQL Apps:**
1. Stop app container
2. Backup database: `pg_dump -U user -d dbname > backup.sql`
3. Move postgres data directory to new location
4. Update volume mount in TrueNAS
5. Start app container
6. Verify database connectivity

</context>

<tasks>

## Phase 1: Discovery & Inventory

<task id="1" type="manual">
<description>Inventory all apps currently in /mnt/apps/apps/</description>
<actions>
1. SSH to TrueNAS SCALE system
2. List all directories in /mnt/apps/apps/
3. For each app directory:
   - Check for config/, data/, postgres/ subdirectories
   - Check ownership/permissions
   - Estimate data size: `du -sh /mnt/apps/apps/*/`
   - Document last modified time
4. Create inventory checklist in discovery-inventory.md
</actions>
<verification>
```bash
# List all app directories with sizes
ls -lah /mnt/apps/apps/
du -sh /mnt/apps/apps/*/

# Check ownership
ls -la /mnt/apps/apps/*/

# Verify structure consistency
for app in /mnt/apps/apps/*/; do
  echo "=== $(basename $app) ==="
  ls -la "$app"
done
```
</verification>
<deliverable>
File: `.planning/phases/26-app-migration/discovery-inventory.md`

Contents:
```markdown
# /mnt/apps/apps/ Inventory

| App Name | Size | Structure | Owner:Group | Last Modified | Notes |
|----------|------|-----------|-------------|---------------|-------|
| sonarr   | 2.3G | config/   | 568:568     | 2025-12-15    | Active |
| ...      | ...  | ...       | ...         | ...           | ...   |

## Apps Present in /mnt/apps/apps/
- [ ] sonarr
- [ ] radarr
- [ ] prowlarr
[... complete list ...]

## Structure Issues Found
- App X missing data/ directory
- App Y has wrong permissions
[... etc ...]
```
</deliverable>
</task>

<task id="2" type="manual">
<description>Inventory all apps remaining in ix-apps managed storage</description>
<actions>
1. SSH to TrueNAS SCALE system
2. Locate ix-apps storage: `find /mnt -name "ix-apps" -type d`
3. Explore ix-apps structure:
   - List all app installations
   - Identify app data volumes
   - Check for PVC (Persistent Volume Claims)
   - Document ix-applications API metadata
4. Cross-reference with /mnt/apps/apps/ to identify:
   - Apps fully migrated (in both locations)
   - Apps not yet migrated (only in ix-apps)
   - Apps only in /mnt/apps/apps/ (migration complete)
5. For each ix-apps app, document:
   - App name and version
   - Data volume location
   - Size estimate
   - Database type (sqlite vs postgres)
   - Last modified time
</actions>
<verification>
```bash
# Find ix-apps directories
find /mnt -path "*/ix-apps/*" -type d -maxdepth 3

# List app volumes
ls -lah /mnt/storage/ix-apps/*/

# Check for postgres containers
docker ps | grep postgres
# Or: k3s kubectl get pods | grep postgres

# Check app metadata in TrueNAS
midclt call app.query | jq '.[] | {name, state, metadata}'
```
</verification>
<deliverable>
File: `.planning/phases/26-app-migration/ix-apps-inventory.md`

Contents:
```markdown
# ix-apps Managed Storage Inventory

## Apps Still in ix-apps
| App Name | Version | Size | Location | Database | Status |
|----------|---------|------|----------|----------|--------|
| example  | 1.2.3   | 5.2G | /mnt/... | postgres | Running |

## Apps with Duplicates
- [ ] App A (in both locations - /mnt/apps/apps/ is authoritative)
- [ ] App B (in both locations - verify before cleanup)

## Apps Fully Migrated
- [x] App C (only in /mnt/apps/apps/ - can delete ix-apps version)
```
</deliverable>
</task>

<task id="3" type="manual">
<description>Create migration priority matrix</description>
<actions>
1. Review both inventories
2. Categorize apps by migration priority:
   - **Critical** - Core apps (Prowlarr, download clients)
   - **High** - Frequently used (*arr apps, media servers)
   - **Medium** - Supporting apps (monitoring, config management)
   - **Low** - Optional apps (can migrate last)
3. Assess migration complexity:
   - **Simple** - SQLite database, small data, no dependencies
   - **Moderate** - PostgreSQL database or large data
   - **Complex** - Multiple dependencies, shared resources, reverse proxy
4. Create migration order considering:
   - Dependency chain (Prowlarr before Sonarr/Radarr)
   - Downtime impact (migrate less critical apps first)
   - Data size (smaller apps first for learning)
</actions>
<verification>
Manual review of categorization by checking:
- App interdependencies (API connections)
- Download folder sharing
- Database types
- User impact during downtime
</verification>
<deliverable>
File: `.planning/phases/26-app-migration/migration-matrix.md`

Contents:
```markdown
# Migration Priority Matrix

## Wave 1: Test Migration (Simple, Low Impact)
1. Recyclarr (simple config, no database)
2. Configarr (simple config, no database)
3. Unpackerr (simple config, no database)

Rationale: Small, simple apps to validate migration procedure with minimal risk.

## Wave 2: Download Clients (Moderate, Foundation)
1. qBittorrent (moderate data, needed by *arrs)
2. SABnzbd (moderate data, needed by *arrs)

Rationale: Download clients are dependencies for *arr apps. Migrate before media automation.

## Wave 3: Indexer Management (Critical, Foundation)
1. Prowlarr (postgres database, critical for all *arrs)

Rationale: Central indexer management. Must be working before migrating *arr apps.

## Wave 4: Media Automation (High, Complex)
1. Sonarr (postgres, references download client & Prowlarr)
2. Radarr (postgres, references download client & Prowlarr)
3. Lidarr (postgres, references download client & Prowlarr)
4. Readarr (postgres, references download client & Prowlarr)
5. Bazarr (sqlite, references Sonarr/Radarr)

Rationale: Core media automation. Migrate in order of user priority.

## Wave 5: Request & Playback (High, User-Facing)
1. Jellyfin (large data, user-facing)
2. Overseerr (postgres, user-facing)
3. Tautulli (sqlite, monitoring only)

Rationale: User-facing apps. Migrate when *arr stack is stable.

## Wave 6: Utilities (Low, Supporting)
1. Janitorr (cleanup automation)
2. Notifiarr (notifications)

Rationale: Supporting services. Can migrate last with minimal impact.
```
</deliverable>
</task>

<task id="4" type="manual">
<description>Verify /mnt/apps/apps/ versions are functional</description>
<actions>
1. For each app already in /mnt/apps/apps/:
   - Check if TrueNAS app is configured to use this path
   - Access app web UI and verify it loads
   - Check app logs for errors
   - Verify app can access media library (if applicable)
   - Test basic functionality (search, add item, etc.)
2. Document any non-functional apps in /mnt/apps/apps/
3. If app is functional, confirm it as authoritative version
4. If app is non-functional:
   - Check if ix-apps version is functional
   - Decide whether to fix /mnt/apps/apps/ or re-migrate from ix-apps
</actions>
<verification>
```bash
# Check TrueNAS app configurations
midclt call app.query | jq '.[] | {name, config.volumes}'

# Check app container status
docker ps -a | grep -E "sonarr|radarr|prowlarr"

# Access web UIs
curl -I http://localhost:8989  # Sonarr
curl -I http://localhost:7878  # Radarr
curl -I http://localhost:9696  # Prowlarr
```
</verification>
<deliverable>
File: `.planning/phases/26-app-migration/functional-status.md`

Contents:
```markdown
# App Functional Status

## Apps in /mnt/apps/apps/ - Verified Working
- [x] sonarr - UI loads, can search, database intact
- [x] radarr - UI loads, can add movies
- [ ] ...

## Apps in /mnt/apps/apps/ - Non-Functional
- [ ] App X - Database connection error (fix required)
- [ ] App Y - Permission denied (fix required)

## Apps in ix-apps - Working (Need Migration)
- [ ] prowlarr - Working in ix-apps, not in /mnt/apps/apps/
- [ ] ...

## Decision Matrix
| App | /mnt/apps/apps/ Status | ix-apps Status | Action |
|-----|------------------------|----------------|--------|
| sonarr | Working | Duplicate | Keep /mnt/apps/apps/, delete ix-apps |
| prowlarr | Missing | Working | Migrate from ix-apps |
```
</deliverable>
</task>

## Phase 2: Pre-Migration Preparation

<task id="5" type="auto">
<description>Backup current state of all app data</description>
<actions>
1. Stop all TrueNAS apps (to ensure consistent backup)
2. Create backup directory: `/mnt/storage/backups/app-migration-$(date +%Y%m%d)/`
3. Backup /mnt/apps/apps/:
   ```bash
   rsync -av --progress /mnt/apps/apps/ /mnt/storage/backups/app-migration-$(date +%Y%m%d)/apps/
   ```
4. Backup ix-apps data:
   ```bash
   rsync -av --progress /mnt/storage/ix-apps/ /mnt/storage/backups/app-migration-$(date +%Y%m%d)/ix-apps/
   ```
5. Export TrueNAS app configurations:
   ```bash
   midclt call app.query > /mnt/storage/backups/app-migration-$(date +%Y%m%d)/truenas-apps-config.json
   ```
6. Verify backup integrity:
   - Check backup sizes match source
   - Verify file counts match
   - Test restore of a small app to temp location
7. Document backup location and restore procedure
</actions>
<verification>
```bash
# Compare sizes
du -sh /mnt/apps/apps/
du -sh /mnt/storage/backups/app-migration-*/apps/

# Compare file counts
find /mnt/apps/apps/ -type f | wc -l
find /mnt/storage/backups/app-migration-*/apps/ -type f | wc -l

# Verify backup exists
ls -lah /mnt/storage/backups/app-migration-*/
```
</verification>
<deliverable>
File: `.planning/phases/26-app-migration/backup-manifest.md`

Contents:
```markdown
# Backup Manifest - App Migration 2025-XX-XX

## Backup Location
`/mnt/storage/backups/app-migration-20251230/`

## Backup Contents
- `apps/` - Full copy of /mnt/apps/apps/ (X GB)
- `ix-apps/` - Full copy of /mnt/storage/ix-apps/ (Y GB)
- `truenas-apps-config.json` - TrueNAS app configurations

## Verification
- Total size: XX GB
- File count: XXXXX files
- Backup started: 2025-XX-XX HH:MM
- Backup completed: 2025-XX-XX HH:MM
- Integrity: ✓ Verified

## Restore Procedure
1. Stop app in TrueNAS
2. Remove current data: `rm -rf /mnt/apps/apps/appname/`
3. Restore from backup: `rsync -av /mnt/storage/backups/app-migration-*/apps/appname/ /mnt/apps/apps/appname/`
4. Fix permissions: `chown -R 568:568 /mnt/apps/apps/appname/`
5. Start app in TrueNAS
```
</deliverable>
</task>

<task id="6" type="manual">
<description>Create migration runbook template</description>
<actions>
1. Document standard migration procedure for each app type:
   - SQLite apps (simple config copy)
   - PostgreSQL apps (database migration)
   - Large data apps (rsync with progress)
2. Include rollback procedure for each type
3. Create checklist template for per-app migration
4. Document TrueNAS app configuration update steps
5. Include verification steps for each migration
</actions>
<verification>
Manual review of runbook for completeness and clarity
</verification>
<deliverable>
File: `.planning/phases/26-app-migration/migration-runbook.md`

See detailed runbook in separate section below.
</deliverable>
</task>

<task id="7" type="manual">
<description>Prepare target directory structure</description>
<actions>
1. For apps not yet in /mnt/apps/apps/, create directory structure:
   ```bash
   for app in prowlarr qbittorrent sabnzbd jellyfin; do
     mkdir -p /mnt/apps/apps/$app/{config,data}
     chown -R 568:568 /mnt/apps/apps/$app
     chmod -R 755 /mnt/apps/apps/$app
   done
   ```
2. For apps with PostgreSQL, add postgres directory:
   ```bash
   for app in prowlarr sonarr radarr; do
     mkdir -p /mnt/apps/apps/$app/postgres
     chown -R 568:568 /mnt/apps/apps/$app/postgres
     chmod 700 /mnt/apps/apps/$app/postgres
   done
   ```
3. Verify ownership and permissions
4. Document directory structure in structure-template.md
</actions>
<verification>
```bash
# Verify structure
tree -L 2 /mnt/apps/apps/

# Verify permissions
ls -la /mnt/apps/apps/*/

# Verify ownership
find /mnt/apps/apps/ -not -user 568 -o -not -group 568
```
</verification>
<deliverable>
Directory structure created and verified, documented in:
`.planning/phases/26-app-migration/structure-template.md`
</deliverable>
</task>

## Phase 3: Wave 1 - Test Migration (Simple Apps)

<task id="8" type="manual">
<description>Migrate Recyclarr (test simple config-only app)</description>
<actions>
Following migration-runbook.md for simple config app:

1. **Stop App**
   - TrueNAS UI → Apps → Recyclarr → Stop

2. **Check Current Location**
   ```bash
   # Find current data location
   midclt call app.query | jq '.[] | select(.name=="recyclarr") | .config.volumes'
   ```

3. **Copy Config**
   ```bash
   # If in ix-apps:
   rsync -av --progress /mnt/storage/ix-apps/recyclarr/config/ /mnt/apps/apps/recyclarr/config/

   # If already in /mnt/apps/apps/ and needs structure fix:
   # Just verify it's already there
   ```

4. **Fix Permissions**
   ```bash
   chown -R 568:568 /mnt/apps/apps/recyclarr/
   chmod -R 755 /mnt/apps/apps/recyclarr/
   ```

5. **Update TrueNAS Volume Mounts**
   - TrueNAS UI → Apps → Recyclarr → Edit
   - Update volume mounts:
     - OLD: `/mnt/storage/ix-apps/recyclarr/config` → `/config`
     - NEW: `/mnt/apps/apps/recyclarr/config` → `/config`
   - Save changes

6. **Start App**
   - TrueNAS UI → Apps → Recyclarr → Start

7. **Verify Functionality**
   - Access web UI
   - Check logs: `docker logs recyclarr`
   - Verify config loaded correctly
   - Test sync operation

8. **Verify Old Data Not in Use**
   ```bash
   # Monitor old directory for access
   ls -ltu /mnt/storage/ix-apps/recyclarr/config/ | head -5
   # If timestamps don't change after restart, old location is not being used
   ```

9. **Document Migration**
   - Update migration-log.md with details
   - Note any issues encountered
   - Record verification results
</actions>
<verification>
```bash
# App is running
docker ps | grep recyclarr

# App is using new location
lsof | grep /mnt/apps/apps/recyclarr

# Web UI accessible
curl -I http://localhost:[recyclarr-port]

# No errors in logs
docker logs recyclarr --tail 50 | grep -i error
```
</verification>
<deliverable>
Successfully migrated Recyclarr with verification in migration-log.md
</deliverable>
</task>

<task id="9" type="manual">
<description>Migrate Configarr and Unpackerr (complete Wave 1)</description>
<actions>
Repeat task #8 procedure for:
1. Configarr
2. Unpackerr

Use same migration-runbook.md simple app procedure.
Document any variations or issues encountered.
</actions>
<verification>
Same verification as task #8 for each app
</verification>
<deliverable>
Wave 1 complete - all simple apps migrated and documented
</deliverable>
</task>

## Phase 4: Wave 2 - Download Clients

<task id="10" type="manual">
<description>Migrate qBittorrent</description>
<actions>
Following migration-runbook.md for moderate data app:

1. **Stop App**
   - TrueNAS UI → Apps → qBittorrent → Stop

2. **Check Current State**
   ```bash
   # Find current data location
   midclt call app.query | jq '.[] | select(.name=="qbittorrent") | .config.volumes'

   # Check data size
   du -sh /mnt/storage/ix-apps/qbittorrent/
   ```

3. **Migrate Data**
   ```bash
   # Copy config and data
   rsync -av --progress /mnt/storage/ix-apps/qbittorrent/config/ /mnt/apps/apps/qbittorrent/config/
   rsync -av --progress /mnt/storage/ix-apps/qbittorrent/data/ /mnt/apps/apps/qbittorrent/data/
   ```

4. **Fix Permissions**
   ```bash
   chown -R 568:568 /mnt/apps/apps/qbittorrent/
   ```

5. **Update TrueNAS Volume Mounts**
   - Update ALL volume mounts to point to /mnt/apps/apps/qbittorrent/
   - Ensure download folder mount is correct (should point to /mnt/storage/downloads or similar)
   - **DO NOT change media library mounts** - they should stay at /mnt/storage/media/

6. **Start App & Verify**
   - Start qBittorrent
   - Access web UI
   - Check active torrents still visible
   - Verify download location settings
   - Test adding new torrent
   - Verify downloads work

7. **Monitor for 24 Hours**
   - Check logs periodically
   - Verify active torrents continue working
   - Test pause/resume
   - Verify integration with *arr apps (after they're migrated)
</actions>
<verification>
```bash
# App running with new paths
docker inspect qbittorrent | grep /mnt/apps/apps/qbittorrent

# Active torrents visible
# (Check web UI)

# Download location correct
# (Check web UI settings)

# No errors in logs
docker logs qbittorrent --tail 100 | grep -i error
```
</verification>
<deliverable>
qBittorrent migrated and verified, documented in migration-log.md
</deliverable>
</task>

<task id="11" type="manual">
<description>Migrate SABnzbd</description>
<actions>
Same procedure as task #10 for SABnzbd.

Additional considerations:
- SABnzbd queue/history database location
- NZB history retention
- Watch folder configuration
- Post-processing scripts location

Verify:
- Queue items preserved
- Download history intact
- API key unchanged (needed by *arr apps)
- Post-processing works
</actions>
<verification>
Same as task #10, plus verify NZB history and queue
</verification>
<deliverable>
SABnzbd migrated and verified, Wave 2 complete
</deliverable>
</task>

## Phase 5: Wave 3 - Indexer Management (Critical)

<task id="12" type="manual">
<description>Migrate Prowlarr (PostgreSQL app - critical foundation)</description>
<actions>
Following migration-runbook.md for PostgreSQL app:

1. **Pre-Migration Checks**
   ```bash
   # Verify Prowlarr uses PostgreSQL
   docker ps | grep prowlarr
   docker ps | grep prowlarr.*postgres

   # Check database size
   docker exec prowlarr-postgres psql -U prowlarr -c "SELECT pg_size_pretty(pg_database_size('prowlarr'));"
   ```

2. **Stop App (Both Containers)**
   - Stop Prowlarr app container
   - Stop Prowlarr postgres container (if separate)
   ```bash
   docker stop prowlarr prowlarr-postgres
   ```

3. **Backup Database**
   ```bash
   # If postgres is embedded in app container:
   docker exec prowlarr-postgres pg_dump -U prowlarr prowlarr > /mnt/storage/backups/prowlarr-db-backup-$(date +%Y%m%d).sql

   # Alternative: backup entire postgres data directory
   rsync -av /mnt/storage/ix-apps/prowlarr/postgres/ /mnt/storage/backups/prowlarr-postgres-backup-$(date +%Y%m%d)/
   ```

4. **Migrate All Data**
   ```bash
   # Config
   rsync -av --progress /mnt/storage/ix-apps/prowlarr/config/ /mnt/apps/apps/prowlarr/config/

   # Data (if separate)
   rsync -av --progress /mnt/storage/ix-apps/prowlarr/data/ /mnt/apps/apps/prowlarr/data/

   # PostgreSQL data directory
   rsync -av --progress /mnt/storage/ix-apps/prowlarr/postgres/ /mnt/apps/apps/prowlarr/postgres/
   ```

5. **Fix Permissions**
   ```bash
   chown -R 568:568 /mnt/apps/apps/prowlarr/config
   chown -R 568:568 /mnt/apps/apps/prowlarr/data

   # PostgreSQL directory needs strict permissions
   chown -R 999:999 /mnt/apps/apps/prowlarr/postgres  # Or check postgres user in container
   chmod 700 /mnt/apps/apps/prowlarr/postgres
   ```

6. **Update TrueNAS Volume Mounts**
   - Update config mount: `/mnt/apps/apps/prowlarr/config` → `/config`
   - Update data mount: `/mnt/apps/apps/prowlarr/data` → `/data`
   - Update postgres mount: `/mnt/apps/apps/prowlarr/postgres` → `/var/lib/postgresql/data`
   - **Critical**: Ensure postgres connection string points to new location

7. **Start App**
   - Start postgres container first (if separate)
   - Wait for postgres to be ready
   - Start Prowlarr app container

8. **Verify Database Connection**
   ```bash
   # Check postgres is running
   docker ps | grep prowlarr.*postgres

   # Check Prowlarr logs for database connection
   docker logs prowlarr --tail 50 | grep -i database
   docker logs prowlarr --tail 50 | grep -i postgres

   # Should see: "Database connection successful" or similar
   ```

9. **Verify Application Functionality**
   - Access web UI
   - Verify all indexers still configured
   - Test search on an indexer
   - Check sync with apps (may need to re-add after *arr migration)
   - Verify API key unchanged

10. **Extended Monitoring (24-48 Hours)**
    - Monitor logs for database errors
    - Test indexer searches regularly
    - Verify sync continues working
    - Check database performance
</actions>
<verification>
```bash
# App and database running
docker ps | grep prowlarr

# Database accessible
docker exec prowlarr-postgres psql -U prowlarr -c "SELECT version();"

# App using new location
docker inspect prowlarr | grep /mnt/apps/apps/prowlarr

# No database errors in logs
docker logs prowlarr --tail 200 | grep -i "database\|postgres\|error"

# Web UI accessible
curl -I http://localhost:9696

# Database size matches pre-migration
docker exec prowlarr-postgres psql -U prowlarr -c "SELECT pg_size_pretty(pg_database_size('prowlarr'));"
```
</verification>
<deliverable>
Prowlarr migrated with PostgreSQL database intact, fully functional and verified
</deliverable>
</task>

## Phase 6: Wave 4 - Media Automation (*arr Stack)

<task id="13" type="manual">
<description>Migrate Sonarr (PostgreSQL)</description>
<actions>
Follow same PostgreSQL migration procedure as task #12 (Prowlarr).

**Sonarr-specific considerations:**
- Series database (verify all shows present after migration)
- Episode file database (verify episode tracking)
- Calendar data
- Download client configuration (verify qBittorrent/SABnzbd connection)
- Prowlarr integration (may need to re-sync)
- Root folders pointing to media library (verify paths)

**Critical Verifications:**
1. All series still present
2. Episode files still tracked
3. Calendar shows upcoming episodes
4. Can search for new episodes
5. Download client connection works
6. Prowlarr sync works
7. Root folders correct: `/mnt/storage/media/tv/` (NOT moved)
</actions>
<verification>
```bash
# Database running and connected
docker logs sonarr | grep -i postgres

# All series present
# (Check web UI - compare count to pre-migration)

# Root folders correct
# (Check web UI → Settings → Media Management → Root Folders)

# Download client connected
# (Check web UI → Settings → Download Clients)

# Prowlarr sync working
# (Check web UI → Settings → Indexers → Prowlarr)
```
</verification>
<deliverable>
Sonarr migrated, PostgreSQL intact, all series and tracking preserved
</deliverable>
</task>

<task id="14" type="manual">
<description>Migrate Radarr (PostgreSQL)</description>
<actions>
Same procedure as task #13 for Radarr.

**Radarr-specific considerations:**
- Movies database
- Movie file tracking
- Custom formats
- Quality profiles
- Lists (if using Trakt, IMDb, etc.)

**Critical Verifications:**
1. All movies still present
2. Movie files still tracked
3. Custom formats preserved
4. Quality profiles intact
5. Lists still syncing
6. Root folders: `/mnt/storage/media/movies/`
</actions>
<verification>
Same pattern as Sonarr verification
</verification>
<deliverable>
Radarr migrated and verified
</deliverable>
</task>

<task id="15" type="manual">
<description>Migrate Lidarr and Readarr (PostgreSQL)</description>
<actions>
Same PostgreSQL migration procedure for:
1. Lidarr (music)
2. Readarr (books)

Verify:
- Database intact
- Media files tracked
- Download clients connected
- Prowlarr sync working
- Root folders correct
</actions>
<verification>
Same pattern as Sonarr/Radarr
</verification>
<deliverable>
Lidarr and Readarr migrated and verified
</deliverable>
</task>

<task id="16" type="manual">
<description>Migrate Bazarr (SQLite - simpler)</description>
<actions>
Bazarr typically uses SQLite, not PostgreSQL.

1. **Stop App**
2. **Migrate Data**
   ```bash
   rsync -av /mnt/storage/ix-apps/bazarr/config/ /mnt/apps/apps/bazarr/config/
   rsync -av /mnt/storage/ix-apps/bazarr/data/ /mnt/apps/apps/bazarr/data/
   ```
3. **Fix Permissions**
4. **Update Volume Mounts**
5. **Start & Verify**
   - Sonarr/Radarr connections work
   - Subtitle searches work
   - Language profiles intact

**Bazarr-specific:**
- Verify Sonarr/Radarr API connections
- Test subtitle search
- Verify subtitle history preserved
</actions>
<verification>
```bash
# App running
docker ps | grep bazarr

# Sonarr/Radarr connected
# (Check web UI → Settings → Sonarr/Radarr)

# Subtitle history present
# (Check web UI → History)
```
</verification>
<deliverable>
Bazarr migrated, Sonarr/Radarr integration working
</deliverable>
</task>

## Phase 7: Wave 5 - Request & Playback

<task id="17" type="manual">
<description>Migrate Jellyfin (large data, critical app)</description>
<actions>
Jellyfin has the largest data footprint (metadata, images, transcoding cache).

1. **Pre-Migration**
   ```bash
   # Check data size
   du -sh /mnt/storage/ix-apps/jellyfin/

   # May be 10GB+ depending on library size
   ```

2. **Stop App**
   - Users will lose access during migration (plan for low-usage time)

3. **Migrate Data** (This will take time)
   ```bash
   # Config (user settings, server config)
   rsync -av --progress /mnt/storage/ix-apps/jellyfin/config/ /mnt/apps/apps/jellyfin/config/

   # Data (metadata, images, playlists, watched status)
   rsync -av --progress --stats /mnt/storage/ix-apps/jellyfin/data/ /mnt/apps/apps/jellyfin/data/

   # Cache (transcoding cache - can skip if space limited)
   # rsync -av --progress /mnt/storage/ix-apps/jellyfin/cache/ /mnt/apps/apps/jellyfin/cache/
   ```

4. **Fix Permissions**
   ```bash
   chown -R 568:568 /mnt/apps/apps/jellyfin/
   ```

5. **Update Volume Mounts**
   - Config: `/mnt/apps/apps/jellyfin/config` → `/config`
   - Data: `/mnt/apps/apps/jellyfin/data` → `/data`
   - Cache: `/mnt/apps/apps/jellyfin/cache` → `/cache` (or temp directory)
   - **Media libraries**: `/mnt/storage/media/` → `/media` (READ-ONLY, DO NOT MOVE)

6. **Start App**

7. **Verify Everything**
   - All libraries visible
   - Metadata/posters loaded
   - User accounts present
   - Watch status preserved
   - Playback works
   - Transcoding works
   - Collections intact
   - Plugins still installed

8. **Test with Multiple Users**
   - Login as different users
   - Verify watched status is user-specific
   - Test playback on different devices
   - Verify server accessible remotely (if applicable)

**Rollback Plan:**
If major issues, can quickly revert volume mounts to old location and restart.
</actions>
<verification>
```bash
# App running
docker ps | grep jellyfin

# All libraries present
# (Check web UI → Dashboard → Libraries)

# Metadata loaded
# (Browse library, verify posters/metadata)

# Users present
# (Check web UI → Dashboard → Users)

# Playback works
# (Play a video)

# No errors in logs
docker logs jellyfin --tail 200 | grep -i error
```
</verification>
<deliverable>
Jellyfin migrated with all user data, metadata, and watch status preserved
</deliverable>
</task>

<task id="18" type="manual">
<description>Migrate Overseerr (request management)</description>
<actions>
Overseerr typically uses SQLite.

1. **Stop App**
2. **Migrate Data**
   ```bash
   rsync -av /mnt/storage/ix-apps/overseerr/config/ /mnt/apps/apps/overseerr/config/
   ```
3. **Fix Permissions**
4. **Update Volume Mounts**
5. **Start & Verify**
   - Sonarr/Radarr connections work
   - Request history preserved
   - Users can request media
   - Notifications work

**Overseerr-specific:**
- Verify Sonarr/Radarr API connections
- Test submitting a request
- Verify user permissions
- Check notification services (Discord, Email, etc.)
</actions>
<verification>
```bash
# App running
docker ps | grep overseerr

# Sonarr/Radarr connected
# (Settings → Services)

# Request history present
# (Requests page)

# Can submit test request
# (Search and request a movie/show)
```
</verification>
<deliverable>
Overseerr migrated, request system working
</deliverable>
</task>

<task id="19" type="manual">
<description>Migrate Tautulli (Plex monitoring)</description>
<actions>
Only if using Plex instead of/in addition to Jellyfin.

Tautulli uses SQLite.

1. **Stop App**
2. **Migrate Data**
   ```bash
   rsync -av /mnt/storage/ix-apps/tautulli/config/ /mnt/apps/apps/tautulli/config/
   ```
3. **Fix Permissions**
4. **Update Volume Mounts**
5. **Start & Verify**
   - Plex connection works
   - Watch history preserved
   - Stats/graphs display correctly
   - Notifications work

**Tautulli-specific:**
- Verify Plex Media Server connection
- Check historical data intact
- Verify stats calculations
- Test notifications
</actions>
<verification>
```bash
# App running
docker ps | grep tautulli

# Plex connected
# (Settings → Plex Media Server)

# History present
# (History page)
```
</verification>
<deliverable>
Tautulli migrated (if applicable)
</deliverable>
</task>

## Phase 8: Wave 6 - Utilities

<task id="20" type="manual">
<description>Migrate Janitorr and Notifiarr</description>
<actions>
Final simple apps:

1. **Janitorr** (cleanup automation)
   - Simple config-only migration
   - Verify scheduled tasks still configured
   - Test cleanup operation

2. **Notifiarr** (notifications)
   - Simple config migration
   - Verify API connections to *arr apps
   - Test sending notification
</actions>
<verification>
Per-app verification of functionality
</verification>
<deliverable>
Wave 6 complete - all apps migrated
</deliverable>
</task>

## Phase 9: Verification & Cleanup

<task id="21" type="auto">
<description>Comprehensive verification of all migrated apps</description>
<actions>
1. **Create verification script**
   ```bash
   #!/bin/bash
   # verify-all-apps.sh

   echo "=== Docker Container Status ==="
   docker ps -a | grep -E "sonarr|radarr|prowlarr|lidarr|readarr|bazarr|overseerr|jellyfin|qbittorrent|sabnzbd|recyclarr|configarr|janitorr|unpackerr|notifiarr"

   echo -e "\n=== App Directory Sizes ==="
   du -sh /mnt/apps/apps/*/

   echo -e "\n=== App Directory Ownership ==="
   for app in /mnt/apps/apps/*/; do
     echo "$(basename $app): $(stat -c '%U:%G' $app)"
   done

   echo -e "\n=== Web UI Accessibility ==="
   # Test each app's web UI
   curl -I -m 5 http://localhost:8989 2>&1 | head -1  # Sonarr
   curl -I -m 5 http://localhost:7878 2>&1 | head -1  # Radarr
   curl -I -m 5 http://localhost:9696 2>&1 | head -1  # Prowlarr
   # ... etc for all apps

   echo -e "\n=== Recent Errors in Logs ==="
   for container in $(docker ps --format "{{.Names}}" | grep -E "sonarr|radarr|prowlarr"); do
     echo "=== $container ==="
     docker logs $container --since 1h --tail 50 | grep -i error || echo "No errors"
   done
   ```

2. **Run comprehensive verification**
   ```bash
   chmod +x verify-all-apps.sh
   ./verify-all-apps.sh > /mnt/storage/backups/app-migration-verification-$(date +%Y%m%d).txt
   ```

3. **Manual verification checklist**
   - [ ] All apps show in `docker ps`
   - [ ] All web UIs accessible
   - [ ] No errors in recent logs
   - [ ] All app directories in /mnt/apps/apps/
   - [ ] Correct ownership (568:568 or app-specific)
   - [ ] All apps using /mnt/apps/apps/ paths (not ix-apps)

4. **Functional testing**
   - [ ] Prowlarr can search indexers
   - [ ] Sonarr can search and download episode
   - [ ] Radarr can search and download movie
   - [ ] qBittorrent actively downloading
   - [ ] Jellyfin can play media
   - [ ] Overseerr can submit request
   - [ ] All integrations working (Prowlarr ↔ Sonarr/Radarr, etc.)

5. **Performance verification**
   - Check app response times (should be similar to pre-migration)
   - Verify no database slowdowns
   - Check disk I/O for any bottlenecks
   - Monitor for 48 hours for any delayed issues
</actions>
<verification>
```bash
# All containers running
[ $(docker ps | grep -cE "sonarr|radarr|prowlarr") -eq [EXPECTED_COUNT] ]

# All using new paths
! docker inspect $(docker ps -q) | grep -q "ix-apps"

# All web UIs respond
for port in 8989 7878 9696; do
  curl -f -m 5 http://localhost:$port > /dev/null || echo "FAIL: Port $port"
done

# No critical errors in logs
! docker logs sonarr --since 1h | grep -i "critical\|fatal"
```
</verification>
<deliverable>
File: `.planning/phases/26-app-migration/verification-report.md`

Contents:
```markdown
# Comprehensive Verification Report

## Date: 2025-XX-XX

### Container Status
All XX apps running:
- [x] Sonarr
- [x] Radarr
[... full list ...]

### Path Verification
All apps using /mnt/apps/apps/:
- [x] No references to ix-apps in docker configs
- [x] All volume mounts point to /mnt/apps/apps/

### Functional Testing
- [x] Prowlarr indexer search: ✓ Working
- [x] Sonarr episode search: ✓ Working
- [x] Radarr movie search: ✓ Working
- [x] qBittorrent download: ✓ Working
- [x] Jellyfin playback: ✓ Working
- [x] Overseerr request: ✓ Working

### Integration Testing
- [x] Prowlarr → Sonarr: ✓ Connected
- [x] Prowlarr → Radarr: ✓ Connected
- [x] Sonarr → qBittorrent: ✓ Connected
- [x] Radarr → qBittorrent: ✓ Connected
- [x] Overseerr → Sonarr: ✓ Connected
- [x] Overseerr → Radarr: ✓ Connected

### Performance
- Average response time: Similar to pre-migration
- Database queries: Normal speed
- No disk I/O bottlenecks detected

### Issues Found
[None / List any issues]

### Conclusion
Migration successful. All apps operational and using new storage structure.
```
</deliverable>
</task>

<task id="22" type="manual">
<description>Monitor all apps for 7 days before cleanup</description>
<actions>
**7-Day Monitoring Period:**

1. **Daily Checks** (for 7 days)
   ```bash
   # Run daily
   ./verify-all-apps.sh >> /mnt/storage/backups/daily-check-$(date +%Y%m%d).txt
   ```

2. **Monitor for Issues**
   - Check logs daily for errors
   - Verify downloads working daily
   - Test playback daily
   - Monitor disk space
   - Check database integrity

3. **User Feedback**
   - Note any user-reported issues
   - Check for playback problems
   - Verify request system working
   - Monitor notification reliability

4. **Document Any Issues**
   - Log all problems encountered
   - Document solutions applied
   - Track performance metrics
   - Note any required rollbacks

5. **Daily Checklist**
   ```markdown
   ## Day X/7 - 2025-XX-XX

   - [ ] All containers running
   - [ ] No errors in logs
   - [ ] Web UIs accessible
   - [ ] Downloads working
   - [ ] Playback working
   - [ ] No user complaints
   - [ ] Disk space adequate

   Issues: [None / List]
   Actions taken: [None / List]
   ```

**Rollback Criteria:**
If any critical issue persists >24 hours:
1. Revert volume mounts to old location
2. Restore from backup if needed
3. Document failure reason
4. Plan remediation before retry
</actions>
<verification>
Manual daily verification checklist completion
</verification>
<deliverable>
File: `.planning/phases/26-app-migration/7day-monitoring-log.md`

7 days of monitoring data showing system stability
</deliverable>
</task>

<task id="23" type="auto">
<description>Cleanup old ix-apps data after 7-day verification</description>
<actions>
**CRITICAL: Only after 7 days of verified stable operation**

1. **Final Verification Before Cleanup**
   ```bash
   # Ensure NO apps are using ix-apps paths
   docker inspect $(docker ps -q) | grep -c "ix-apps"
   # Should be 0

   # Verify all apps running
   docker ps | grep -c "Up"
   # Should match total app count
   ```

2. **Create Final Backup**
   ```bash
   # One last backup before deletion
   rsync -av /mnt/storage/ix-apps/ /mnt/storage/backups/ix-apps-final-backup-$(date +%Y%m%d)/
   ```

3. **Document What Will Be Deleted**
   ```bash
   # Create deletion manifest
   echo "=== ix-apps Deletion Manifest ===" > deletion-manifest.txt
   echo "Date: $(date)" >> deletion-manifest.txt
   echo "Total size: $(du -sh /mnt/storage/ix-apps/)" >> deletion-manifest.txt
   echo -e "\nDirectories:" >> deletion-manifest.txt
   find /mnt/storage/ix-apps/ -maxdepth 2 -type d >> deletion-manifest.txt
   ```

4. **Soft Delete (Rename First)**
   ```bash
   # Rename instead of delete (safer)
   mv /mnt/storage/ix-apps /mnt/storage/ix-apps-DELETED-$(date +%Y%m%d)
   ```

5. **Monitor for 24 Hours**
   - Verify all apps still working
   - Check for any errors about missing paths
   - Confirm no impact on functionality

6. **Hard Delete After 24 Hours**
   ```bash
   # Only if 24 hour verification passes
   rm -rf /mnt/storage/ix-apps-DELETED-*

   # Verify deletion
   ls /mnt/storage/ | grep ix-apps
   # Should return nothing
   ```

7. **Update TrueNAS App Configs**
   - TrueNAS may still reference ix-apps in metadata
   - Check `midclt call app.query` output
   - May need to clean up app metadata (optional)

8. **Reclaim Space**
   ```bash
   # Verify space reclaimed
   df -h /mnt/storage/
   ```

**Safety Measures:**
- Keep final backup for 30 days minimum
- Rename before delete (easy to undo)
- Wait 24 hours between rename and delete
- Document everything deleted
</actions>
<verification>
```bash
# ix-apps directory gone
[ ! -d /mnt/storage/ix-apps ]

# No apps referencing old location
! docker inspect $(docker ps -q) | grep "ix-apps"

# All apps still running
docker ps | grep -cE "Up" | grep [EXPECTED_COUNT]

# Space reclaimed
df -h /mnt/storage/ | grep -v "100%"
```
</verification>
<deliverable>
Old ix-apps data cleaned up, space reclaimed, all apps confirmed working
</deliverable>
</task>

<task id="24" type="manual">
<description>Document final structure and create maintenance runbook</description>
<actions>
1. **Document Final Structure**
   ```bash
   # Generate structure documentation
   tree -L 3 /mnt/apps/apps/ > final-structure.txt
   du -sh /mnt/apps/apps/*/ >> final-structure.txt
   ```

2. **Create App Inventory**
   ```markdown
   # Final App Inventory

   | App | Location | Size | Database | Purpose |
   |-----|----------|------|----------|---------|
   | Sonarr | /mnt/apps/apps/sonarr | 2.1G | PostgreSQL | TV automation |
   | Radarr | /mnt/apps/apps/radarr | 1.8G | PostgreSQL | Movie automation |
   [... complete list ...]
   ```

3. **Create Maintenance Runbook**
   - How to add new app to structure
   - How to backup apps
   - How to restore apps
   - How to migrate app data
   - Permissions management
   - Database maintenance (PostgreSQL)

4. **Document Lessons Learned**
   - What went well
   - What challenges occurred
   - How challenges were solved
   - Recommendations for future migrations
   - Time estimates for each wave

5. **Create Quick Reference**
   ```markdown
   # Quick Reference: App Locations

   All apps: /mnt/apps/apps/[appname]/{config,data,postgres}
   Media library: /mnt/storage/media/ (READ-ONLY for apps)
   Downloads: /mnt/storage/downloads/
   Backups: /mnt/storage/backups/

   Default owner:group: 568:568
   PostgreSQL owner:group: 999:999 (or container-specific)

   Common commands:
   - Check app status: docker ps | grep [appname]
   - View logs: docker logs [appname] --tail 100
   - Restart app: docker restart [appname]
   - Check permissions: ls -la /mnt/apps/apps/[appname]/
   ```
</actions>
<verification>
Manual review of documentation completeness
</verification>
<deliverable>
File: `.planning/phases/26-app-migration/SUMMARY.md`

Complete documentation of:
- Final structure
- App inventory
- Maintenance procedures
- Lessons learned
- Quick reference guide
</deliverable>
</task>

</tasks>

<success_criteria>

## Technical Success Criteria

### All Apps Migrated
- [ ] All apps running from /mnt/apps/apps/
- [ ] No apps using ix-apps paths
- [ ] All apps accessible via web UI
- [ ] All databases intact and functional

### Data Integrity
- [ ] All app configurations preserved
- [ ] All databases intact (SQLite and PostgreSQL)
- [ ] All user data preserved (watch status, history, etc.)
- [ ] All integrations working (APIs between apps)
- [ ] No data loss during migration

### Structure Compliance
- [ ] Consistent directory structure: appname/{config,data,postgres}
- [ ] Correct permissions on all directories
- [ ] Correct ownership (568:568 or app-specific)
- [ ] PostgreSQL directories have strict permissions (700)

### Functionality Verified
- [ ] All apps accessible via web UI
- [ ] Prowlarr can search indexers
- [ ] *arr apps can search and add content
- [ ] Download clients actively downloading
- [ ] Media servers can play content
- [ ] Request system works (Overseerr)
- [ ] All notifications working

### Integration Verified
- [ ] Prowlarr ↔ Sonarr/Radarr/Lidarr/Readarr
- [ ] Sonarr/Radarr ↔ Download clients
- [ ] Overseerr ↔ Sonarr/Radarr
- [ ] Bazarr ↔ Sonarr/Radarr
- [ ] All API connections functioning

### Cleanup Complete
- [ ] Old ix-apps data removed
- [ ] Space reclaimed
- [ ] No references to ix-apps in configs
- [ ] TrueNAS app metadata cleaned (if needed)

### Documentation Complete
- [ ] Migration log documenting all changes
- [ ] Final structure documented
- [ ] Maintenance runbook created
- [ ] Lessons learned captured
- [ ] Quick reference guide available

## Operational Success Criteria

### Stability
- [ ] 7 days of stable operation post-migration
- [ ] No critical errors in logs
- [ ] No user-reported issues
- [ ] Performance equivalent to pre-migration

### Preparedness for k3s
- [ ] Clean, modular structure ready for k3s PVs
- [ ] Clear understanding of app dependencies
- [ ] Documented volume mount requirements
- [ ] Known database types and connections

### Backup Strategy
- [ ] Pre-migration backups preserved
- [ ] Final ix-apps backup retained (30 days)
- [ ] Regular backup strategy documented
- [ ] Tested restore procedure

### Knowledge Transfer
- [ ] Complete documentation for future maintainers
- [ ] Migration runbook reusable for new apps
- [ ] Lessons learned documented
- [ ] Common issues and solutions documented

</success_criteria>

<effort_estimate>

## Time Estimates per Wave

### Wave 1: Test Migration (Simple Apps)
- Recyclarr: 30 minutes
- Configarr: 30 minutes
- Unpackerr: 30 minutes
- **Total: 1.5 hours**

### Wave 2: Download Clients
- qBittorrent: 1 hour (moderate data)
- SABnzbd: 1 hour (moderate data)
- **Total: 2 hours**

### Wave 3: Indexer Management
- Prowlarr: 2 hours (PostgreSQL, critical app)
- **Total: 2 hours**

### Wave 4: Media Automation
- Sonarr: 2 hours (PostgreSQL, complex)
- Radarr: 2 hours (PostgreSQL, complex)
- Lidarr: 1.5 hours (PostgreSQL)
- Readarr: 1.5 hours (PostgreSQL)
- Bazarr: 1 hour (SQLite, simpler)
- **Total: 8 hours**

### Wave 5: Request & Playback
- Jellyfin: 3 hours (very large data, critical)
- Overseerr: 1 hour
- Tautulli: 1 hour (if applicable)
- **Total: 5 hours**

### Wave 6: Utilities
- Janitorr: 30 minutes
- Notifiarr: 30 minutes
- **Total: 1 hour**

### Verification & Cleanup
- Comprehensive verification: 2 hours
- 7-day monitoring: 1 hour (distributed over 7 days)
- Cleanup: 2 hours
- Documentation: 3 hours
- **Total: 8 hours**

## Overall Estimate

**Total Hands-On Time: 27.5 hours**

**Calendar Time (including 7-day monitoring): 8-9 days**

**Recommended Schedule:**
- Week 1, Day 1-2: Discovery & Preparation (6 hours)
- Week 1, Day 3: Waves 1-2 (3.5 hours)
- Week 1, Day 4: Wave 3 (2 hours)
- Week 1, Day 5-6: Wave 4 (8 hours)
- Week 2, Day 1: Wave 5 (5 hours)
- Week 2, Day 2: Wave 6 + Verification (3 hours)
- Week 2, Day 3-9: 7-day monitoring (passive)
- Week 2, Day 10: Cleanup & Documentation (5 hours)

</effort_estimate>

---

## Appendix: Migration Runbook Template

### Simple Config-Only App Migration

**Example: Recyclarr, Configarr, Unpackerr**

```bash
# 1. Stop app in TrueNAS UI
# Apps → [AppName] → Stop

# 2. Find current location
midclt call app.query | jq '.[] | select(.name=="appname") | .config.volumes'

# 3. Copy config
rsync -av --progress [SOURCE]/config/ /mnt/apps/apps/appname/config/

# 4. Fix permissions
chown -R 568:568 /mnt/apps/apps/appname/
chmod -R 755 /mnt/apps/apps/appname/

# 5. Update TrueNAS volume mounts
# Apps → [AppName] → Edit → Update volume paths

# 6. Start app
# Apps → [AppName] → Start

# 7. Verify
docker ps | grep appname
docker logs appname --tail 50
curl -I http://localhost:[PORT]
```

**Time: ~30 minutes per app**

---

### Moderate Data App Migration

**Example: qBittorrent, SABnzbd**

```bash
# 1. Stop app
# Apps → [AppName] → Stop

# 2. Check size
du -sh [SOURCE]/

# 3. Copy config and data
rsync -av --progress [SOURCE]/config/ /mnt/apps/apps/appname/config/
rsync -av --progress [SOURCE]/data/ /mnt/apps/apps/appname/data/

# 4. Fix permissions
chown -R 568:568 /mnt/apps/apps/appname/

# 5. Update volume mounts
# Apps → [AppName] → Edit → Update all volume paths
# Verify download folder mounts are correct
# Ensure media library mounts are READ-ONLY

# 6. Start app
# Apps → [AppName] → Start

# 7. Verify
docker ps | grep appname
docker logs appname --tail 100
# Access web UI
# Check active downloads/queue
# Verify settings preserved

# 8. Test
# Add test download
# Verify download location
# Check integration with *arr apps (after migration)
```

**Time: ~1-1.5 hours per app**

---

### PostgreSQL App Migration

**Example: Prowlarr, Sonarr, Radarr, Lidarr, Readarr**

```bash
# 1. Verify PostgreSQL usage
docker ps | grep appname
docker ps | grep appname.*postgres

# 2. Stop both containers
docker stop appname appname-postgres

# 3. Backup database (CRITICAL)
docker exec appname-postgres pg_dump -U [user] [dbname] > /mnt/storage/backups/appname-db-$(date +%Y%m%d).sql

# Alternative: backup entire postgres directory
rsync -av [SOURCE]/postgres/ /mnt/storage/backups/appname-postgres-$(date +%Y%m%d)/

# 4. Copy all data
rsync -av --progress [SOURCE]/config/ /mnt/apps/apps/appname/config/
rsync -av --progress [SOURCE]/data/ /mnt/apps/apps/appname/data/
rsync -av --progress [SOURCE]/postgres/ /mnt/apps/apps/appname/postgres/

# 5. Fix permissions
chown -R 568:568 /mnt/apps/apps/appname/config
chown -R 568:568 /mnt/apps/apps/appname/data

# PostgreSQL needs strict permissions
chown -R 999:999 /mnt/apps/apps/appname/postgres  # Or check container postgres user
chmod 700 /mnt/apps/apps/appname/postgres

# 6. Update TrueNAS volume mounts
# Apps → [AppName] → Edit
# Update config mount: /mnt/apps/apps/appname/config → /config
# Update data mount: /mnt/apps/apps/appname/data → /data
# Update postgres mount: /mnt/apps/apps/appname/postgres → /var/lib/postgresql/data
# Ensure postgres connection string correct

# 7. Start postgres first
docker start appname-postgres

# Wait for postgres ready (check logs)
docker logs -f appname-postgres
# Look for "database system is ready to accept connections"

# 8. Start app
docker start appname

# 9. Verify database connection
docker logs appname --tail 100 | grep -i database
docker logs appname --tail 100 | grep -i postgres
# Should see successful connection

# 10. Verify app functionality
# Access web UI
# Check all data present
# Test search
# Verify API connections
# Check database size matches pre-migration:
docker exec appname-postgres psql -U [user] -c "SELECT pg_size_pretty(pg_database_size('[dbname]'));"

# 11. Extended monitoring
# Monitor logs for 24-48 hours
docker logs -f appname | grep -i error
```

**Time: ~2-3 hours per app**

**Rollback Procedure:**
```bash
# If issues occur:
docker stop appname appname-postgres
# Revert volume mounts in TrueNAS UI to old location
docker start appname-postgres
docker start appname
# Or restore from backup if data corruption occurred
```

---

### Large Data App Migration

**Example: Jellyfin (10GB+ metadata/images)**

```bash
# 1. Announce downtime to users
# Plan for low-usage time window

# 2. Stop app
# Apps → Jellyfin → Stop

# 3. Check size (may be 10-50GB depending on library)
du -sh [SOURCE]/

# 4. Copy data (THIS WILL TAKE TIME)
# Use screen/tmux in case of SSH disconnect
screen -S jellyfin-migration

rsync -av --progress --stats [SOURCE]/config/ /mnt/apps/apps/jellyfin/config/
rsync -av --progress --stats [SOURCE]/data/ /mnt/apps/apps/jellyfin/data/

# Cache is optional (can regenerate)
# rsync -av --progress [SOURCE]/cache/ /mnt/apps/apps/jellyfin/cache/

# 5. Fix permissions
chown -R 568:568 /mnt/apps/apps/jellyfin/

# 6. Update volume mounts
# Apps → Jellyfin → Edit
# Config: /mnt/apps/apps/jellyfin/config → /config
# Data: /mnt/apps/apps/jellyfin/data → /data
# Cache: /mnt/apps/apps/jellyfin/cache → /cache
# MEDIA: /mnt/storage/media → /media (READ-ONLY, DO NOT MOVE)

# 7. Start app
# Apps → Jellyfin → Start

# 8. Comprehensive verification
# Access web UI
# Check all libraries visible
# Verify metadata/posters loaded
# Verify user accounts present
# Check watch status preserved
# Test playback on multiple devices
# Verify transcoding works
# Check collections intact
# Verify plugins present

# 9. Test with multiple users
# Login as different users
# Verify user-specific watch status
# Test remote access (if applicable)

# 10. Monitor performance
# Check response times
# Monitor transcoding
# Verify no playback issues
```

**Time: 3-5 hours (depending on data size)**

**Rollback:**
```bash
# Quick revert if major issues:
docker stop jellyfin
# Revert volume mounts in TrueNAS UI
docker start jellyfin
# Old data still intact, immediate restore
```

---

## Appendix: Common Issues and Solutions

### Issue: Permission Denied

**Symptoms:**
- App logs show "Permission denied" errors
- Cannot read/write to config or data directories

**Solution:**
```bash
# Check current ownership
ls -la /mnt/apps/apps/appname/

# Fix ownership (most apps use 568:568)
chown -R 568:568 /mnt/apps/apps/appname/

# For PostgreSQL, may need different user:
chown -R 999:999 /mnt/apps/apps/appname/postgres/
chmod 700 /mnt/apps/apps/appname/postgres/

# Check app-specific user in container:
docker exec appname id
```

---

### Issue: Database Connection Failed

**Symptoms:**
- App logs show "Failed to connect to database"
- PostgreSQL connection errors

**Solution:**
```bash
# 1. Verify postgres container running
docker ps | grep postgres

# 2. Check postgres logs
docker logs appname-postgres --tail 100

# 3. Verify postgres data directory permissions
ls -la /mnt/apps/apps/appname/postgres/
chmod 700 /mnt/apps/apps/appname/postgres/

# 4. Check postgres connection string in app config
# Usually in /mnt/apps/apps/appname/config/config.xml or similar

# 5. Restart postgres first, then app
docker restart appname-postgres
# Wait for "ready to accept connections"
docker restart appname

# 6. If corruption suspected, restore from backup:
docker stop appname appname-postgres
rm -rf /mnt/apps/apps/appname/postgres/
rsync -av /mnt/storage/backups/appname-postgres-*/  /mnt/apps/apps/appname/postgres/
chown -R 999:999 /mnt/apps/apps/appname/postgres/
chmod 700 /mnt/apps/apps/appname/postgres/
docker start appname-postgres appname
```

---

### Issue: App Data Missing After Migration

**Symptoms:**
- App starts but shows no configured items
- Empty library, no settings

**Solution:**
```bash
# 1. Verify data was copied
ls -la /mnt/apps/apps/appname/config/
ls -la /mnt/apps/apps/appname/data/

# 2. Check volume mounts in TrueNAS
midclt call app.query | jq '.[] | select(.name=="appname") | .config.volumes'

# 3. Verify app is actually using new paths
docker inspect appname | grep -A 10 Mounts

# 4. If data is there but not loaded:
# Check app logs for config file path
docker logs appname --tail 100 | grep -i config

# 5. If using wrong path, update TrueNAS volume mounts
# Apps → [AppName] → Edit → Fix volume mount paths

# 6. If data truly missing, restore from backup:
docker stop appname
rsync -av /mnt/storage/backups/app-migration-*/apps/appname/ /mnt/apps/apps/appname/
chown -R 568:568 /mnt/apps/apps/appname/
docker start appname
```

---

### Issue: API Connections Broken Between Apps

**Symptoms:**
- Prowlarr not syncing to Sonarr/Radarr
- Sonarr can't connect to download client
- Overseerr can't connect to Sonarr/Radarr

**Solution:**
```bash
# 1. Check if apps can reach each other
docker exec sonarr ping radarr
docker exec sonarr ping prowlarr

# 2. Verify API keys unchanged after migration
# Check each app's settings page for API key
# Compare to connected app's config

# 3. Re-test connection in app UI
# Settings → [Connected Service] → Test

# 4. If test fails, check:
# - Correct IP/hostname
# - Correct port
# - Correct API key
# - No firewall blocking

# 5. For Prowlarr sync issues:
# Prowlarr → Settings → Apps → [App] → Test → Sync

# 6. If still failing, may need to re-add connection:
# Delete old connection
# Add new connection with same settings
# Test and sync
```

---

### Issue: TrueNAS Still Using Old ix-apps Path

**Symptoms:**
- Updated volume mounts but app still using old data
- ix-apps directory showing recent access times

**Solution:**
```bash
# 1. Verify volume mounts actually updated
midclt call app.query | jq '.[] | select(.name=="appname") | .config.volumes'

# 2. Completely stop and restart app (not just restart)
# Apps → [AppName] → Stop
# Wait 10 seconds
# Apps → [AppName] → Start

# 3. Verify container using new mounts
docker inspect appname | grep -A 20 Mounts

# 4. If still using old path, may need to delete and recreate app:
# BACKUP FIRST
# Apps → [AppName] → Delete (keep data)
# Recreate app with correct volume mounts from start

# 5. Check for app metadata caching
# TrueNAS may cache app config
midclt call app.upgrade [appname]
```

---

### Issue: Performance Degradation After Migration

**Symptoms:**
- App slower than before migration
- Database queries slow
- High disk I/O

**Solution:**
```bash
# 1. Check disk I/O
iostat -x 5

# 2. Check if /mnt/apps/apps/ is on slow disk
df -h /mnt/apps/apps/

# 3. For PostgreSQL apps, vacuum database
docker exec appname-postgres psql -U [user] -d [dbname] -c "VACUUM ANALYZE;"

# 4. Check for permission issues causing retries
docker logs appname --tail 200 | grep -i "permission\|denied"

# 5. Verify no network mount latency
# /mnt/apps/apps/ should be local disk, not NFS/SMB

# 6. Check for disk fragmentation (if applicable)

# 7. If persistent, consider database rebuild:
# Some apps have "Database Maintenance" in Settings
# Or export/import data to fresh database
```

---

### Issue: Jellyfin Metadata Missing

**Symptoms:**
- Movies/shows present but no posters
- No metadata loaded

**Solution:**
```bash
# 1. Verify metadata directory copied
ls -la /mnt/apps/apps/jellyfin/data/metadata/

# 2. Check permissions
chown -R 568:568 /mnt/apps/apps/jellyfin/data/

# 3. Trigger metadata refresh
# Jellyfin UI → Dashboard → Libraries → [Library] → Scan Library
# Or: Replace All Metadata

# 4. Check Jellyfin logs
docker logs jellyfin --tail 200 | grep -i metadata

# 5. If metadata truly missing, restore from backup:
docker stop jellyfin
rsync -av /mnt/storage/backups/app-migration-*/apps/jellyfin/data/metadata/ /mnt/apps/apps/jellyfin/data/metadata/
chown -R 568:568 /mnt/apps/apps/jellyfin/data/
docker start jellyfin
```

---

## Appendix: k3s Migration Preparation Notes

**This migration prepares for future k3s deployment by:**

1. **Clean Volume Structure**
   - Each app's data in clear, separate directory
   - Easy to mount as k3s PersistentVolume
   - Consistent subdirectory structure (config/, data/, postgres/)

2. **Documented Dependencies**
   - Clear understanding of which apps need PostgreSQL
   - Known API connections between apps
   - Shared volume requirements (download folders)

3. **Known Database Types**
   - SQLite apps (easier to migrate)
   - PostgreSQL apps (need StatefulSets or external DB)
   - Database sizes documented

4. **Tested Restore Procedures**
   - Backup and restore validated
   - Rollback procedures documented
   - Data integrity verified

**Future k3s Deployment Will Use:**

```yaml
# Example PersistentVolume for Sonarr
apiVersion: v1
kind: PersistentVolume
metadata:
  name: sonarr-config
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: /mnt/apps/apps/sonarr/config
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: sonarr-postgres
spec:
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: /mnt/apps/apps/sonarr/postgres
```

**k3s Migration Advantages After This Phase:**
- No data reorganization needed
- Clear volume mount mappings
- Known permissions and ownership
- Tested backup/restore procedures
- Documented app interdependencies

**k3s Migration Will Require:**
- Helm charts or custom manifests for each app
- Service definitions for inter-app communication
- Ingress configuration for web UIs
- Secret management for API keys
- PostgreSQL StatefulSets or external database

**DO NOT implement k3s yet** - this phase only prepares the data structure.
