---
phase: 10-griefling-speedup
type: execute
---

<objective>
Continue fixing unconditional imports in remaining role files and modules.

Purpose: After Plan 01, hw-desktop.nix is fixed but other role files still have unconditional imports that pull in heavy dependencies. This plan addresses hw-laptop, hw-tablet, and remaining unguarded modules.

Output: All role files use enable-based module activation, all modules have enable guards.
</objective>

<context>
@.planning/phases/10-griefling-speedup/10-01-SUMMARY.md
@roles/hw-laptop.nix - imports modules outside mkIf
@roles/hw-tablet.nix - imports modules outside mkIf
@roles/task-mediacenter.nix - imports media modules
@modules/services/desktop/niri.nix - check for enable guard
@modules/services/misc/flatpak.nix - check for enable guard
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix hw-laptop.nix unconditional imports</name>
  <files>roles/hw-laptop.nix</files>
  <action>
    1. Remove all `imports = [...]` at top level
    2. Move to enable-based pattern: `myModules.desktop.plasma.enable = lib.mkDefault true;` etc
    3. Ensure all modules referenced have enable options
    4. Keep laptop-specific config (power management, wifi) in mkIf block
  </action>
  <verify>grep -q "^  imports" roles/hw-laptop.nix returns exit 1</verify>
  <done>Laptop role uses enable options instead of direct imports</done>
</task>

<task type="auto">
  <name>Task 2: Fix hw-tablet.nix unconditional imports</name>
  <files>roles/hw-tablet.nix</files>
  <action>
    1. Remove all `imports = [...]` at top level
    2. Move to enable-based pattern
    3. Ensure touch-friendly modules have enable options
  </action>
  <verify>grep -q "^  imports" roles/hw-tablet.nix returns exit 1</verify>
  <done>Tablet role uses enable options instead of direct imports</done>
</task>

<task type="auto">
  <name>Task 3: Add enable option to modules/services/desktop/niri.nix</name>
  <files>modules/services/desktop/niri.nix</files>
  <action>
    Check if niri.nix has enable guard. If not:
    1. Add `options.myModules.desktop.niri.enable = lib.mkEnableOption "Niri compositor";`
    2. Wrap config in `config = lib.mkIf cfg.enable { ... }`
  </action>
  <verify>grep -q "mkEnableOption" modules/services/desktop/niri.nix</verify>
  <done>Niri module only activates when explicitly enabled</done>
</task>

<task type="auto">
  <name>Task 4: Add enable option to modules/services/misc/flatpak.nix</name>
  <files>modules/services/misc/flatpak.nix</files>
  <action>
    Check if flatpak.nix has enable guard. If not:
    1. Add `options.myModules.services.flatpak.enable = lib.mkEnableOption "Flatpak support";`
    2. Wrap config in `config = lib.mkIf cfg.enable { ... }`
  </action>
  <verify>grep -q "mkEnableOption" modules/services/misc/flatpak.nix</verify>
  <done>Flatpak module only activates when explicitly enabled</done>
</task>

<task type="auto">
  <name>Task 5: Fix task-mediacenter.nix imports</name>
  <files>roles/task-mediacenter.nix</files>
  <action>
    1. Remove `imports = [../modules/apps/media]`
    2. Replace with `myModules.apps.media.enable = lib.mkDefault true;` inside mkIf
    3. Also enable audio modules via options
  </action>
  <verify>grep -q "^  imports" roles/task-mediacenter.nix returns exit 1</verify>
  <done>Mediacenter task role uses enable options</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `nix flake check` passes
- [ ] No role files have top-level `imports = [...]` (except ./common.nix in default.nix)
- [ ] All referenced modules have enable options
</verification>

<success_criteria>
- hw-laptop.nix has no top-level imports
- hw-tablet.nix has no top-level imports
- task-mediacenter.nix has no top-level imports
- All desktop/misc modules have enable guards
</success_criteria>

<output>
After completion, create `.planning/phases/10-griefling-speedup/10-02-SUMMARY.md`
</output>
