---
phase: 10-griefling-speedup
type: execute
---

<objective>
Fix unconditional module imports in the role system so griefling VM deploys in minutes, not ages.

Purpose: The current role system imports ALL modules for ALL hosts because role files have `imports = [...]` sections outside their `lib.mkIf` blocks. This causes griefling (a minimal VM) to include 300+ packages including full Plasma 6, Jellyfin, Spotify, etc.

Output: Role files with imports moved inside mkIf blocks, and all imported modules converted to enable-gated pattern.
</objective>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@roles/default.nix - imports all role files unconditionally
@roles/hw-vm.nix - VM role with imports outside mkIf
@roles/hw-desktop.nix - desktop role importing heavy modules
@modules/services/desktop/plasma.nix - KDE Plasma with NO enable guard
@modules/apps/media/default.nix - jellyfin/spotify with NO enable guard
</context>

<root_cause_analysis>
Import chain causing bloat:
1. flake.nix → ./roles (for all hosts)
2. roles/default.nix → all hw-*.nix, task-*.nix (unconditionally)
3. hw-desktop.nix imports = [...] (OUTSIDE mkIf) → modules/services/desktop
4. modules/services/desktop/default.nix uses scanPaths → plasma.nix
5. plasma.nix has no enable option → unconditionally enables Plasma 6

Evidence: griefling has 39 KDE/Plasma packages, 5 Jellyfin packages, Spotify, VLC despite roles.vm = true
</root_cause_analysis>

<tasks>

<task type="auto">
  <name>Task 1: Add enable option to modules/services/desktop/plasma.nix</name>
  <files>modules/services/desktop/plasma.nix</files>
  <action>
    1. Add `options.myModules.desktop.plasma.enable = lib.mkEnableOption "KDE Plasma 6 desktop";`
    2. Create local `cfg = config.myModules.desktop.plasma;`
    3. Wrap ALL existing config in `config = lib.mkIf cfg.enable { ... }`
    4. Leave `services.desktopManager.plasma6.enable = true;` inside the mkIf block
  </action>
  <verify>nix eval .#nixosConfigurations.griefling.config.myModules.desktop.plasma.enable returns false</verify>
  <done>Plasma module only activates when explicitly enabled</done>
</task>

<task type="auto">
  <name>Task 2: Add enable option to modules/apps/media/default.nix</name>
  <files>modules/apps/media/default.nix</files>
  <action>
    1. Add `options.myModules.apps.media.enable = lib.mkEnableOption "Media apps (Jellyfin, Spotify, VLC, etc)";`
    2. Wrap ALL environment.systemPackages and services in `config = lib.mkIf cfg.enable { ... }`
    3. Keep the systemd.user.services.jellyfin-mpv-shim inside the mkIf
    4. Move spice-vdagentd to a separate module (it's VM-specific, not media)
  </action>
  <verify>nix eval .#nixosConfigurations.griefling.config.myModules.apps.media.enable 2>&1 | grep -q "false"</verify>
  <done>Media module only installs jellyfin/spotify/vlc when enabled</done>
</task>

<task type="auto">
  <name>Task 3: Move hw-desktop.nix imports inside mkIf block</name>
  <files>roles/hw-desktop.nix</files>
  <action>
    1. Remove the `imports = [...]` section at the top
    2. Instead, enable modules via options: `myModules.desktop.plasma.enable = lib.mkDefault true;`
    3. Add: `myModules.apps.media.enable = lib.mkDefault true;`
    4. Keep all other `myModules.*.enable` patterns inside the existing `lib.mkIf cfg.desktop { ... }` block
    Note: This requires all imported modules to have enable options (Tasks 1 & 2)
  </action>
  <verify>grep -q "^  imports" roles/hw-desktop.nix returns exit 1 (no top-level imports)</verify>
  <done>Desktop role no longer imports modules unconditionally</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `nix flake check` passes
- [ ] griefling dry-run build has NO plasma packages: `nix derivation show .#nixosConfigurations.griefling.config.system.build.toplevel 2>/dev/null | grep -i plasma` returns nothing
- [ ] griefling dry-run build has NO jellyfin packages
- [ ] malphas (if fixed) still evaluates successfully
</verification>

<success_criteria>
- plasma.nix has myModules.desktop.plasma.enable option
- media/default.nix has myModules.apps.media.enable option
- hw-desktop.nix has no top-level imports section
- griefling build excludes KDE/Plasma entirely
</success_criteria>

<output>
After completion, create `.planning/phases/10-griefling-speedup/10-01-SUMMARY.md`
</output>
