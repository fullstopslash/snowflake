---
phase: 10-griefling-speedup
type: execute
---

<objective>
Create a fast-test module for quick deployment testing and verify griefling is truly minimal.

Purpose: After fixing the unconditional imports, griefling should be minimal. This plan creates a dedicated test module that can be enabled for fast deployment testing, and validates the final griefling closure size.

Output: A `roles.fastTest = true` option for minimal deployment testing, griefling verified under 100 system-path packages.
</objective>

<context>
@.planning/phases/10-griefling-speedup/10-03-SUMMARY.md
@roles/task-test.nix - current test role
@roles/hw-vm.nix - VM hardware role
@hosts/griefling/default.nix - test VM host
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create roles/task-fast-test.nix for minimal testing</name>
  <files>roles/task-fast-test.nix</files>
  <action>
    Create a new task role optimized for fast deployment testing:
    ```nix
    # Fast test role - absolute minimum for deployment testing
    { config, lib, pkgs, ... }:
    let cfg = config.roles; in {
      options.roles.fastTest = lib.mkEnableOption "Fast test mode (minimal packages for deployment testing)";

      config = lib.mkIf cfg.fastTest {
        # Override any heavy defaults
        myModules = {
          apps.gaming.enable = lib.mkForce false;
          apps.media.enable = lib.mkForce false;
          desktop.plasma.enable = lib.mkForce false;
          services.development.containers.enable = lib.mkForce false;
          apps.development.latex.enable = lib.mkForce false;
          apps.cli.tools.enable = lib.mkForce false;
        };

        # Minimal test packages only
        environment.systemPackages = with pkgs; [
          git
          curl
          htop
        ];

        # Disable documentation
        documentation.enable = false;
        documentation.man.enable = false;
        documentation.nixos.enable = false;
      };
    }
    ```
  </action>
  <verify>nix-instantiate --parse roles/task-fast-test.nix</verify>
  <done>Fast test role exists and parses correctly</done>
</task>

<task type="auto">
  <name>Task 2: Register task-fast-test.nix in roles/default.nix</name>
  <files>roles/default.nix</files>
  <action>
    1. Add `./task-fast-test.nix` to the imports list
    2. Ensure it's in the task-based roles section
  </action>
  <verify>grep -q "task-fast-test" roles/default.nix</verify>
  <done>Fast test role is registered in role system</done>
</task>

<task type="auto">
  <name>Task 3: Validate griefling closure size</name>
  <files>hosts/griefling/default.nix</files>
  <action>
    1. Run closure analysis:
       ```
       nix derivation show .#nixosConfigurations.griefling.config.system.build.toplevel 2>/dev/null | \
         jq -r 'to_entries[0].value.inputDrvs | keys | .[]' | wc -l
       ```
    2. Target: under 100 direct derivation inputs (was 300+)
    3. Verify no KDE/Plasma packages in closure
    4. Verify no Jellyfin/Spotify packages in closure
  </action>
  <verify>
    nix derivation show .#nixosConfigurations.griefling.config.system.build.toplevel 2>/dev/null | \
      jq -r 'to_entries[0].value.inputDrvs | keys[]' | \
      grep -iE "(plasma|kde|jellyfin|spotify|vlc)" | wc -l
    # Should return 0
  </verify>
  <done>griefling has under 100 packages, no heavy desktop apps</done>
</task>

<task type="auto">
  <name>Task 4: Test actual deployment time</name>
  <files>hosts/griefling/default.nix</files>
  <action>
    1. Build griefling: `nix build .#nixosConfigurations.griefling.config.system.build.toplevel`
    2. Note build time
    3. Compare to previous builds (if available in git history)
    4. Target: build should complete in under 5 minutes on local machine
  </action>
  <verify>time nix build .#nixosConfigurations.griefling.config.system.build.toplevel --no-link 2>&1 | tail -5</verify>
  <done>griefling builds in reasonable time</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `nix flake check` passes
- [ ] griefling closure has < 100 direct derivation inputs
- [ ] No plasma/kde packages in griefling closure
- [ ] No jellyfin/spotify/vlc packages in griefling closure
- [ ] Build completes without errors
</verification>

<success_criteria>
- task-fast-test.nix exists and is registered
- griefling closure reduced from 300+ to <100 packages
- No heavy desktop/media packages in griefling
- Fast deployment testing is possible
</success_criteria>

<output>
After completion, create `.planning/phases/10-griefling-speedup/10-04-SUMMARY.md`
</output>
