---
phase: 10-griefling-speedup
type: execute
---

<objective>
Ensure all modules in scanPaths directories have enable guards to prevent accidental activation.

Purpose: The `lib.custom.scanPaths` pattern imports ALL .nix files in a directory. Any file without an enable guard will unconditionally apply its config. This plan audits and fixes all scanPaths directories.

Output: Every module file in scanPaths directories has an enable guard.
</objective>

<context>
@.planning/phases/10-griefling-speedup/10-02-SUMMARY.md
@lib/default.nix - contains scanPaths implementation
@modules/services/default.nix - imports subdirectories
@modules/apps/default.nix - imports subdirectories
</context>

<scanpath_directories>
Directories using scanPaths (each file needs enable guard):
- modules/services/ai/
- modules/services/audio/
- modules/services/cli/
- modules/services/desktop/
- modules/services/development/
- modules/services/display-manager/
- modules/services/misc/
- modules/services/networking/
- modules/services/security/
- modules/services/storage/
- modules/apps/cli/
- modules/apps/development/
- modules/common/
- modules/hardware/gpu/
</scanpath_directories>

<tasks>

<task type="auto">
  <name>Task 1: Audit and fix modules/services/audio/*.nix</name>
  <files>modules/services/audio/pipewire.nix, modules/services/audio/tuning.nix</files>
  <action>
    For each file:
    1. Check if it has `mkEnableOption` - if yes, skip
    2. If no enable guard, add one following pattern:
       ```nix
       let cfg = config.myModules.services.audio.NAME; in {
         options.myModules.services.audio.NAME.enable = lib.mkEnableOption "NAME";
         config = lib.mkIf cfg.enable { ... existing config ... };
       }
       ```
  </action>
  <verify>for f in modules/services/audio/*.nix; do grep -q "mkEnableOption" "$f" || echo "MISSING: $f"; done</verify>
  <done>All audio modules have enable guards</done>
</task>

<task type="auto">
  <name>Task 2: Audit and fix modules/services/ai/*.nix</name>
  <files>modules/services/ai/crush.nix, modules/services/ai/ollama.nix</files>
  <action>
    For each file:
    1. Check for mkEnableOption
    2. Add if missing following myModules.services.ai.NAME pattern
  </action>
  <verify>for f in modules/services/ai/*.nix; do grep -q "mkEnableOption" "$f" || echo "MISSING: $f"; done</verify>
  <done>All AI modules have enable guards</done>
</task>

<task type="auto">
  <name>Task 3: Audit and fix modules/services/misc/*.nix</name>
  <files>modules/services/misc/*.nix</files>
  <action>
    Files to check: voice-assistant.nix, flatpak.nix, ssh-no-sleep.nix, sinkzone.nix
    Add enable guards where missing.
  </action>
  <verify>for f in modules/services/misc/*.nix; do grep -q "mkEnableOption" "$f" || echo "MISSING: $f"; done</verify>
  <done>All misc modules have enable guards</done>
</task>

<task type="auto">
  <name>Task 4: Audit and fix modules/services/storage/*.nix</name>
  <files>modules/services/storage/borg.nix, modules/services/storage/network-storage.nix</files>
  <action>
    Add enable guards where missing following myModules.services.storage.NAME pattern.
  </action>
  <verify>for f in modules/services/storage/*.nix; do grep -q "mkEnableOption" "$f" || echo "MISSING: $f"; done</verify>
  <done>All storage modules have enable guards</done>
</task>

<task type="auto">
  <name>Task 5: Audit and fix modules/services/security/*.nix</name>
  <files>modules/services/security/*.nix</files>
  <action>
    Files: clamav.nix, secrets.nix, yubikey.nix, bitwarden.nix, sops.nix
    Add enable guards where missing.
    Note: sops.nix may be special (always needed for sops-nix integration)
  </action>
  <verify>for f in modules/services/security/*.nix; do grep -q "mkEnableOption" "$f" && echo "OK: $f" || echo "MISSING: $f"; done</verify>
  <done>All security modules have appropriate guards</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `nix flake check` passes
- [ ] All modules in scanPaths directories have enable guards (except intentionally universal ones)
- [ ] griefling build is now minimal (under 100 packages in system-path)
</verification>

<success_criteria>
- Every module file has mkEnableOption (or is documented as intentionally universal)
- griefling dry-run shows no KDE, Jellyfin, Spotify, etc.
- Evaluation is fast (no heavy dependencies pulled)
</success_criteria>

<output>
After completion, create `.planning/phases/10-griefling-speedup/10-03-SUMMARY.md`
</output>
