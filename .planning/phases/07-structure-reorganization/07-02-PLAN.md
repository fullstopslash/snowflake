# Plan 07-02: Convert hosts/common/optional to Modules

## Objective
Convert all config fragments in `/hosts/common/optional/` to proper NixOS modules with `mkOption`/`mkEnableOption` in `/modules/`.

## Context
Currently `/hosts/common/optional/` contains 32 config fragment files that are imported directly. This violates the principle of all option definitions living in `/modules/`. These should be converted to proper modules that can be enabled via `services.*.enable = true` or similar patterns.

## Current State
```
hosts/common/optional/
├── services/
│   ├── openssh.nix      -> Already has module in modules/
│   ├── printing.nix
│   ├── sddm.nix
│   ├── greetd.nix       -> Already has module in modules/services/desktop/
│   ├── bluetooth.nix
│   └── ly.nix
├── syncthing.nix        -> Duplicate! modules/services/networking/ has one too
├── thunar.nix
├── vlc.nix
├── zsa-keeb.nix
├── wifi.nix
├── stylix.nix
├── audio.nix
├── network-storage.nix  -> Already has module in modules/services/storage/
├── protonvpn.nix
├── scanning.nix
├── fonts.nix
├── yubikey.nix
├── msmtp.nix
├── gaming.nix
├── wayland.nix
├── libvirt.nix
├── nix-config-repo.nix
├── plymouth.nix
├── hyprland.nix         -> Already has module in modules/services/desktop/
├── nvtop.nix
├── amdgpu_top.nix
├── smbclient.nix
├── xfce.nix
├── obsidian.nix
├── tailscale.nix        -> Already has module in modules/services/networking/
└── minimal-user.nix
```

## Strategy

### Phase A: Identify Duplicates
Files that already have modules in `/modules/`:
- `syncthing.nix` -> `modules/services/networking/syncthing.nix`
- `network-storage.nix` -> `modules/services/storage/network-storage.nix`
- `greetd.nix` -> `modules/services/desktop/greetd.nix`
- `hyprland.nix` -> `modules/services/desktop/hyprland.nix`
- `tailscale.nix` -> `modules/services/networking/tailscale.nix`

Action: Consolidate into module version, remove hosts/common/optional version.

### Phase B: Convert Simple Configs to Modules
Files that are simple enable-only configs:
- `bluetooth.nix` -> `modules/services/hardware/bluetooth.nix`
- `printing.nix` -> `modules/services/hardware/printing.nix`
- `scanning.nix` -> `modules/services/hardware/scanning.nix`
- `audio.nix` -> `modules/services/audio/pipewire.nix`
- `wifi.nix` -> `modules/services/networking/wifi.nix`
- `plymouth.nix` -> `modules/services/desktop/plymouth.nix`
- `wayland.nix` -> `modules/services/desktop/wayland.nix`

### Phase C: Convert App Configs to Modules
App-specific configs:
- `thunar.nix` -> `modules/apps/files/thunar.nix`
- `vlc.nix` -> `modules/apps/media/vlc.nix`
- `obsidian.nix` -> `modules/apps/productivity/obsidian.nix`
- `nvtop.nix` -> `modules/apps/cli/nvtop.nix`
- `amdgpu_top.nix` -> `modules/apps/cli/amdgpu-top.nix`

### Phase D: Convert Complex Configs to Modules
More complex configs:
- `stylix.nix` -> `modules/apps/theming/stylix.nix`
- `gaming.nix` -> `modules/apps/gaming/core.nix`
- `zsa-keeb.nix` -> `modules/hardware/input/zsa.nix`
- `yubikey.nix` -> `modules/services/security/yubikey.nix`
- `libvirt.nix` -> `modules/services/development/libvirt.nix`
- `smbclient.nix` -> `modules/services/storage/samba-client.nix`
- `msmtp.nix` -> `modules/services/networking/msmtp.nix`
- `protonvpn.nix` -> `modules/services/networking/protonvpn.nix`

### Phase E: Handle Display Managers
- `sddm.nix` -> `modules/services/desktop/sddm.nix`
- `ly.nix` -> `modules/services/desktop/ly.nix`
- `xfce.nix` -> `modules/services/desktop/xfce.nix`

### Phase F: Special Cases
- `fonts.nix` -> Integrate into existing `modules/apps/fonts/`
- `nix-config-repo.nix` -> Keep in hosts/common/core/ (repo setup is universal)
- `minimal-user.nix` -> Keep in hosts/common/ (special bootstrap case)
- `openssh.nix` -> Consolidate with modules version if exists

## Module Template
Each converted module should follow this pattern:
```nix
{ config, lib, pkgs, ... }:
let
  cfg = config.myModules.category.name;
in
{
  options.myModules.category.name = {
    enable = lib.mkEnableOption "description";
    # Additional options as needed
  };

  config = lib.mkIf cfg.enable {
    # Actual configuration
  };
}
```

## Steps

1. **Audit all 32 files** - categorize by complexity
2. **Handle duplicates first** - consolidate into module versions
3. **Convert batch by batch** - A through F phases
4. **Update host imports** - change from `imports = [ ../optional/x.nix ]` to `myModules.x.enable = true`
5. **Update roles** - ensure roles enable appropriate modules
6. **Remove hosts/common/optional/** - once all converted
7. **Verify build** - test on griefling VM

## Verification
- [ ] No files in `hosts/common/optional/` (except special cases)
- [ ] All features available via module options
- [ ] Hosts use `enable = true` pattern instead of imports
- [ ] `nix flake check` passes
- [ ] Test host builds and boots successfully

## Risk
Medium - significant restructuring. Test thoroughly on VM before applying to real hosts.
