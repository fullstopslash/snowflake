# Plan 07-04: Migrate Home-Manager Configs to NixOS

## Objective
Move as many configurations as possible from home-manager to standard NixOS module definitions. Home-manager should only be used when absolutely necessary.

## Context
Home-manager adds complexity and is often unnecessary. Many configs can be done at the system level. This plan identifies what can move and what must stay in HM.

## Analysis: What MUST Stay in Home-Manager

### Truly HM-Only Features
These have no NixOS equivalent:
1. **User dotfiles** - `home.file`, `xdg.configFile`
2. **User services** - `systemd.user.services` (some)
3. **User shell config** - `.bashrc`, `.zshrc` customization
4. **nixvim** - Uses HM module system
5. **User-specific program configs** - programs.* that need per-user settings

### Can Move to NixOS
1. **Package installation** - `home.packages` -> `users.users.*.packages` or `environment.systemPackages`
2. **System-wide programs** - `programs.git`, `programs.zsh` etc. have NixOS equivalents
3. **Fonts** - `fonts.packages` (NixOS)
4. **GTK/Qt theming** - Can use `qt.enable`, `gtk.enable` at system level
5. **Many program enables** - e.g., `programs.direnv` exists in NixOS

## Current home/common/ Contents to Analyze

### home/common/core/
```
ghostty.nix       -> Can move to NixOS (just package + config file)
nixvim/           -> MUST stay (HM module)
nixos.nix         -> Review contents
timers/           -> Review - some can be system timers
```

### home/common/optional/
Need to audit each file to determine if HM is required.

## Migration Strategy

### Phase A: Inventory
1. List all HM configs
2. Categorize each as:
   - MUST_STAY_HM: Truly requires HM
   - CAN_MIGRATE: Has NixOS equivalent
   - TRIVIAL: Just package install, easy move

### Phase B: Migrate Trivial
- Package lists -> `environment.systemPackages` or user packages
- Simple program enables with NixOS equivalents

### Phase C: Migrate Complex
- Configs that need rewriting for NixOS
- May require creating new NixOS modules

### Phase D: Consolidate HM
- What remains is truly HM-only
- Document why each remaining config needs HM

## Example Migrations

### Package Installation
```nix
# Before (HM)
home.packages = with pkgs; [ ripgrep fd ];

# After (NixOS)
environment.systemPackages = with pkgs; [ ripgrep fd ];
# OR per-user:
users.users.rain.packages = with pkgs; [ ripgrep fd ];
```

### Git Config
```nix
# Before (HM)
programs.git = {
  enable = true;
  userName = "rain";
  userEmail = "rain@example.com";
};

# After (NixOS)
programs.git = {
  enable = true;
  # Note: user-specific settings still need gitconfig or HM
};
```

### Shell Config
```nix
# Before (HM)
programs.zsh = {
  enable = true;
  shellAliases = { ... };
};

# After (NixOS) - partial
programs.zsh.enable = true;
# Aliases can go in /etc/zshrc via environment.shellAliases
environment.shellAliases = { ... };
```

## Steps

1. **Full audit of home/ directory**
   - Create spreadsheet/list of every HM config
   - Mark migration status for each

2. **Create NixOS equivalents**
   - For each CAN_MIGRATE item, create NixOS module

3. **Update roles to use NixOS modules**
   - Instead of importing HM configs, enable NixOS modules

4. **Remove migrated HM configs**
   - Delete files no longer needed

5. **Document remaining HM needs**
   - Add comments explaining why HM is required

6. **Test thoroughly**
   - Build and test on VM
   - Verify all features work

## What Will Likely Remain in HM
- nixvim configuration (no NixOS equivalent)
- User-specific dotfiles
- Per-user shell customizations beyond system defaults
- User systemd services that need HM

## Verification
- [ ] Audit complete with migration status for each file
- [ ] Migrated configs work via NixOS modules
- [ ] Remaining HM configs documented with rationale
- [ ] Significantly reduced HM footprint
- [ ] All hosts build and work correctly

## Risk
High - significant architectural change. Requires careful testing. Do incrementally.

## Dependencies
- Complete 07-01 (remove ta)
- Complete 07-02 (convert optional to modules)
- Complete 07-03 (rename to home-manager/)
