---
phase: 20-bcachefs-native-encryption
plan: 03
type: execute
---

<objective>
Implement boot unlock automation and key management for bcachefs native encryption.

Purpose: Enable seamless automatic unlock of encrypted bcachefs volumes at boot, integrate with Phase 17 password infrastructure, and provide clear installation/recovery workflows in ISO installer.

Output: Systemd units for bcachefs unlock, NixOS configuration integration, ISO installer support
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/20-bcachefs-native-encryption/20-01-FINDINGS.md
@.planning/phases/20-bcachefs-native-encryption/20-02-SUMMARY.md
@modules/disks/bcachefs-encrypt-disk.nix
@modules/disks/bcachefs-encrypt-impermanence-disk.nix
@modules/common/host.nix
@nixos-installer/flake.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bcachefs unlock systemd units</name>
  <files>modules/disks/bcachefs-unlock.nix</files>
  <action>
Create NixOS module for bcachefs encrypted volume unlock automation based on FINDINGS.md recommendations:

Module structure:
- Conditional on disks.layout matching "bcachefs-encrypt*" patterns
- systemd unit(s) for bcachefs unlock at boot
- Integration with systemd-ask-password or custom unlock mechanism
- Proper ordering (before mounting filesystems)
- initrd integration if required by FINDINGS

Implementation based on FINDINGS:
- If FINDINGS shows systemd-ask-password approach: implement that
- If FINDINGS shows custom initrd script: implement that
- If FINDINGS shows kernel keyring integration: implement that
- Follow recommended unlock workflow from FINDINGS

Unlock workflow:
1. Detect encrypted bcachefs device at boot
2. Prompt for passphrase (or use keyfile if configured)
3. Run `bcachefs unlock /dev/xxx` with passphrase
4. Allow filesystem mount to proceed

Key management:
- Support /tmp/disko-password during installation (Phase 17 pattern)
- Support systemd-ask-password for interactive boot
- Document how to change passphrase post-install (bcachefs set-passphrase)
- Consider TPM integration if FINDINGS shows it's supported

AVOID:
- Don't use systemd-cryptenroll (doesn't support bcachefs)
- Don't assume LUKS tooling will work (different encryption system)
- Don't hardcode device paths (use cfg.device from disks module)
- Don't skip initrd integration if FINDINGS says it's required
</action>
  <verify>
```bash
# Verify module syntax
nix-instantiate --parse modules/disks/bcachefs-unlock.nix

# Verify it integrates with disks module
nix eval .#nixosConfigurations.griefling.config.systemd.services --show-trace 2>&1 | grep bcachefs || echo "No bcachefs services (expected if not using bcachefs-encrypt layout)"
```
  </verify>
  <done>
- Module created with proper NixOS module structure
- systemd units generated for bcachefs-encrypt layouts
- Unlock mechanism matches FINDINGS recommendations
- Passphrase prompt mechanism implemented
- Proper boot ordering configured
- /tmp/disko-password support for installation
- Module parses and evaluates without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate unlock module with disks module</name>
  <files>modules/disks/default.nix</files>
  <action>
Update modules/disks/default.nix to import and enable bcachefs-unlock module:

1. Add import at module level:
```nix
imports = [
  inputs.disko.nixosModules.disko
  ./bcachefs-unlock.nix  # Add this
];
```

2. Pass configuration to unlock module:
- Device path (cfg.device)
- Layout type (cfg.layout)
- Whether encryption is enabled (layout contains "encrypt")

3. Add documentation in layout description about boot unlock:
```
Native encryption requires boot passphrase prompt. See modules/disks/bcachefs-unlock.nix
for customization options (TPM unlock, keyfile, etc).
```

Integration approach:
- bcachefs-unlock.nix should activate automatically when layout = "bcachefs-encrypt*"
- No additional host configuration required for basic password unlock
- Advanced options (TPM, keyfile) available via disks.unlock.* options if needed

AVOID:
- Don't require hosts to manually import bcachefs-unlock.nix
- Don't break existing non-encrypted layouts
- Don't add unlock configuration for non-encrypted bcachefs layouts
</action>
  <verify>
```bash
# Verify import added
grep 'bcachefs-unlock' modules/disks/default.nix

# Verify documentation updated
grep -A 3 'Native encryption requires' modules/disks/default.nix

# Test evaluation still works
nix eval .#nixosConfigurations.griefling.config.disks.layout --show-trace
```
  </verify>
  <done>
- bcachefs-unlock.nix imported in default.nix
- Automatic activation for bcachefs-encrypt layouts
- Documentation includes boot unlock information
- Module evaluation succeeds
- Non-encrypted layouts unaffected
  </done>
</task>

<task type="auto">
  <name>Task 3: Update ISO installer with bcachefs encryption support</name>
  <files>nixos-installer/flake.nix, nixos-installer/README.md (or appropriate docs)</files>
  <action>
Update ISO installer to support bcachefs native encryption workflows:

1. Ensure bcachefs-tools is available in ISO environment
2. Document installation workflow for encrypted bcachefs:
   ```
   # Create encrypted bcachefs
   bcachefs format --encrypt /dev/xxx

   # Unlock for installation
   echo "password" > /tmp/disko-password
   bcachefs unlock /dev/xxx

   # Run disko with bcachefs-encrypt layout
   sudo disko --mode disko /path/to/config

   # Password will be used for unlock at boot
   ```

3. Update install-host command (if it exists) to handle bcachefs-encrypt layouts
4. Add troubleshooting section for bcachefs encryption issues

Documentation locations based on existing installer structure:
- If nixos-installer/README.md exists: add bcachefs section there
- If docs/installation.md exists (from Phase 19): add bcachefs section there
- If installer has interactive prompts: add bcachefs encryption option

AVOID:
- Don't require manual bcachefs unlock steps if disko can handle it
- Don't duplicate existing LUKS documentation (reference it, note differences)
- Don't add bcachefs-specific quirks to general installation docs
</action>
  <verify>
```bash
# Verify bcachefs-tools in ISO
grep -r 'bcachefs' nixos-installer/ || echo "Need to add bcachefs-tools"

# Check documentation structure
ls -la docs/ nixos-installer/ | grep -i readme || ls -la docs/ nixos-installer/
```
  </verify>
  <done>
- bcachefs-tools available in ISO environment
- Installation workflow documented for encrypted bcachefs
- Troubleshooting guidance added
- install-host command (if exists) handles bcachefs-encrypt layouts
- Documentation clear on differences from LUKS approach
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] bcachefs-unlock.nix module created and integrated
- [ ] systemd units generated for bcachefs-encrypt layouts
- [ ] Boot unlock mechanism works (or documented as requiring testing)
- [ ] /tmp/disko-password integration maintained
- [ ] ISO installer supports bcachefs encryption workflows
- [ ] Documentation covers installation and recovery scenarios
- [ ] Non-encrypted layouts unaffected
- [ ] Module evaluation succeeds for all layout types
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Boot unlock automation implemented (mechanism from FINDINGS)
- Phase 17 password infrastructure integration maintained
- ISO installer documentation updated
- No errors introduced
- Phase 20 complete: Native bcachefs encryption fully functional
- Clear migration path from LUKS documented (when to use which)
</success_criteria>

<output>
After completion, create `.planning/phases/20-bcachefs-native-encryption/20-03-SUMMARY.md`:

# Phase 20 Plan 3: Boot Integration & Key Management Summary

**Implemented boot unlock automation and key management for bcachefs native encryption.**

## Accomplishments
- Created bcachefs-unlock.nix systemd units for automatic boot unlock
- Integrated unlock module with disks module (automatic activation)
- Updated ISO installer with bcachefs encryption workflows
- Documented installation, boot, and recovery procedures

## Files Created/Modified
- `modules/disks/bcachefs-unlock.nix` - Boot unlock systemd units
- `modules/disks/default.nix` - Integrated unlock module
- `nixos-installer/[docs]` - Bcachefs encryption installation guide
- [Other affected files]

## Decisions Made
[Document unlock mechanism chosen from FINDINGS: systemd-ask-password vs custom initrd vs other]
[Document TPM integration decision if applicable]

## Issues Encountered
[Problems and resolutions, or "None"]

## Phase 20 Complete

**Phase 20: Bcachefs Native Encryption - Complete**

Summary: Successfully implemented bcachefs native ChaCha20/Poly1305 encryption with:
- Two new layout options (bcachefs-encrypt, bcachefs-encrypt-impermanence)
- Automatic boot unlock via systemd units
- Phase 17 password infrastructure integration
- ISO installer support and documentation

Native encryption provides authenticated encryption chain with metadata integrity verification,
offering superior security properties compared to block-layer encryption. LUKS variants remain
available for environments requiring traditional full-disk encryption tooling.

Next: Update ROADMAP.md to mark Phase 20 complete.
</output>
