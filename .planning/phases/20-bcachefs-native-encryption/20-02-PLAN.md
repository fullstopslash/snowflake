---
phase: 20-bcachefs-native-encryption
plan: 02
type: execute
---

<objective>
Implement bcachefs disk layouts with native ChaCha20/Poly1305 encryption.

Purpose: Provide bcachefs-native encrypted layouts alongside existing LUKS options, leveraging authenticated encryption with superior security properties (encryption chain of trust, metadata integrity verification).

Output: New bcachefs-encrypt and bcachefs-encrypt-impermanence layout options in modules/disks/
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/20-bcachefs-native-encryption/20-01-FINDINGS.md
@modules/disks/default.nix
@modules/disks/bcachefs-disk.nix
@modules/disks/bcachefs-luks-disk.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bcachefs-encrypt-disk.nix</name>
  <files>modules/disks/bcachefs-encrypt-disk.nix</files>
  <action>
Create simple bcachefs layout with native encryption (ChaCha20/Poly1305):
- ESP partition (512M, vfat, /boot)
- Encrypted bcachefs root partition (100%, bcachefs with encryption enabled)
- Use disko configuration pattern from FINDINGS.md
- Follow existing bcachefs-disk.nix structure (disk parameter, minimal signature)
- Add clear comments explaining native encryption vs LUKS approach
- Include encryption-specific mount options if required by FINDINGS

Structure should mirror bcachefs-disk.nix but with encryption configuration.

AVOID:
- Don't add LUKS layer (this is native bcachefs encryption)
- Don't include unused parameters (lib, withSwap, swapSize) - keep minimal like current bcachefs layouts
- Don't add LVM unless FINDINGS recommends it
</action>
  <verify>
```bash
# Test import
nix-instantiate --eval --strict -E '
let
  bcachefsEncryptLayout = import ./modules/disks/bcachefs-encrypt-disk.nix {
    disk = "/dev/vda";
  };
in
bcachefsEncryptLayout.disko.devices.disk.disk0.content.partitions.root.content.format
' 2>&1 | grep bcachefs
```
  </verify>
  <done>
- File created with proper disko structure
- Encryption configuration matches FINDINGS recommendations
- Import test succeeds and shows bcachefs format
- Comments explain native encryption benefits
  </done>
</task>

<task type="auto">
  <name>Task 2: Create bcachefs-encrypt-impermanence-disk.nix</name>
  <files>modules/disks/bcachefs-encrypt-impermanence-disk.nix</files>
  <action>
Create bcachefs layout with native encryption + impermanence pattern:
- ESP partition (512M, vfat, /boot)
- Encrypted bcachefs persist partition (50%, for persistent data)
- Encrypted bcachefs root partition (50%, ephemeral)
- Both filesystems use native bcachefs encryption
- Separate partitions approach (bcachefs doesn't have subvolumes)
- Accept persistFolder parameter for mount point configuration

Implementation approach based on FINDINGS:
- If FINDINGS shows single encrypted partition with multiple bcachefs filesystems: use that pattern
- If FINDINGS shows separate encrypted partitions: use that pattern
- Follow recommended disko syntax for bcachefs encryption from FINDINGS

AVOID:
- Don't add LUKS layer
- Don't add LVM unless FINDINGS specifically recommends it for encryption+impermanence
- Don't use subvolumes (bcachefs doesn't support them)
</action>
  <verify>
```bash
# Test import with persistFolder
nix-instantiate --eval --strict -E '
let
  layout = import ./modules/disks/bcachefs-encrypt-impermanence-disk.nix {
    disk = "/dev/vda";
    persistFolder = "/persist";
  };
in
{
  persist = layout.disko.devices.disk.disk0.content.partitions.persist.content.format;
  root = layout.disko.devices.disk.disk0.content.partitions.root.content.format;
}
' 2>&1
```
  </verify>
  <done>
- File created with encrypted impermanence pattern
- Separate persist and root partitions both encrypted
- persistFolder parameter properly used
- Import test shows both partitions as bcachefs
- Pattern follows FINDINGS recommendations
  </done>
</task>

<task type="auto">
  <name>Task 3: Update modules/disks/default.nix</name>
  <files>modules/disks/default.nix</files>
  <action>
Add new bcachefs native encryption layout options:

1. Add imports for new layouts:
```nix
bcachefsEncryptLayout = import ./bcachefs-encrypt-disk.nix {
  disk = cfg.device;
};

bcachefsEncryptImpermanenceLayout = import ./bcachefs-encrypt-impermanence-disk.nix {
  disk = cfg.device;
  persistFolder = config.host.persistFolder;
};
```

2. Add to layout enum:
- "bcachefs-encrypt"
- "bcachefs-encrypt-impermanence"

3. Add to selectedLayout conditional:
- bcachefs-encrypt -> bcachefsEncryptLayout.disko.devices.disk (or .devices if structure differs)
- bcachefs-encrypt-impermanence -> bcachefsEncryptImpermanenceLayout.disko.devices.disk (or .devices)

4. Update description to document new options:
```
Bcachefs native encryption (ChaCha20/Poly1305):
- bcachefs-encrypt: Native authenticated encryption
- bcachefs-encrypt-impermanence: Native encryption + /persist partition

Native encryption provides authenticated encryption chain with metadata
integrity verification. LUKS variants still available for Phase 17 compatibility.
```

AVOID:
- Don't remove existing bcachefs-luks options (user requested keeping them)
- Don't change existing layout enum ordering
- Don't add withSwap/swapSize parameters to native encrypt imports (not implemented)
</action>
  <verify>
```bash
# Verify enum includes new options
grep -A 15 'layout = lib.mkOption' modules/disks/default.nix | grep bcachefs-encrypt

# Verify description updated
grep -A 5 'Bcachefs native encryption' modules/disks/default.nix

# Test evaluation with new layout option
nix eval .#nixosConfigurations.griefling.config.disks --show-trace 2>&1 | head -5
```
  </verify>
  <done>
- New layouts imported in default.nix
- Enum includes bcachefs-encrypt and bcachefs-encrypt-impermanence
- selectedLayout conditional handles new options correctly
- Description documents native encryption benefits
- Existing options preserved (bcachefs-luks kept)
- Module evaluates without errors
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Both new layout files exist and follow disko structure
- [ ] Import tests succeed for both layouts
- [ ] modules/disks/default.nix enum includes new options
- [ ] selectedLayout properly routes to new layouts
- [ ] Module evaluation succeeds without errors
- [ ] Comments explain native encryption vs LUKS trade-offs
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors introduced
- bcachefs-encrypt layout option functional
- bcachefs-encrypt-impermanence layout option functional
- Existing bcachefs-luks layouts preserved
- Documentation clarifies when to use native vs LUKS encryption
- Ready for 20-03-PLAN.md (boot integration)
</success_criteria>

<output>
After completion, create `.planning/phases/20-bcachefs-native-encryption/20-02-SUMMARY.md`:

# Phase 20 Plan 2: Native Encryption Layouts Summary

**Implemented bcachefs native ChaCha20/Poly1305 encryption layouts with authenticated encryption chain.**

## Accomplishments
- Created bcachefs-encrypt-disk.nix (simple encrypted layout)
- Created bcachefs-encrypt-impermanence-disk.nix (encrypted + impermanence)
- Updated modules/disks/default.nix with new layout options
- Documented native encryption vs LUKS trade-offs

## Files Created/Modified
- `modules/disks/bcachefs-encrypt-disk.nix` - Simple native encryption layout
- `modules/disks/bcachefs-encrypt-impermanence-disk.nix` - Encrypted impermanence layout
- `modules/disks/default.nix` - Added new layout options to enum and selection logic

## Decisions Made
[Document encryption configuration patterns chosen based on FINDINGS]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Ready for 20-03-PLAN.md (boot integration and key management)
</output>
