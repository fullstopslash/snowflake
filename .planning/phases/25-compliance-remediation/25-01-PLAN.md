# Phase 25: Architectural Compliance Remediation

<objective>
Fix all 7 critical violations identified in Phase 24 architectural audit to achieve 95%+ compliance (A grade). Replace hardcoded usernames with config.identity.primaryUsername and hardcoded paths with proper user home directory references.
</objective>

<execution_context>
<!-- Files needed for execution protocol -->
- `.planning/docs/execute-phase.md` - Execution protocol and deviation rules
- `.planning/phases/24-architectural-audit/24-01-FINDINGS.md` - Detailed violation analysis
- `.planning/phases/24-architectural-audit/24-01-SUMMARY.md` - Current compliance metrics
</execution_context>

<context>
## Background

Phase 24 architectural audit (completed 2025-12-30) identified **7 critical violations** where modules contain hardcoded usernames and paths, breaking reusability across different hosts and users.

**Current State:**
- Compliance Score: 85/100 (B+ grade)
- Violation Rate: 5.6%
- Critical Violations: 7 instances across 5 files

**Target State:**
- Compliance Score: 95/100 (A grade)
- Violation Rate: <2%
- Critical Violations: 0

## Architectural Principle

**Modules must be universal and reusable**. Any configuration specific to a particular user, hostname, or file path must be parameterized through the config.identity.* namespace:

- `config.identity.primaryUsername` - The primary user
- `config.identity.home` - Primary user's home directory
- `config.users.users.${config.identity.primaryUsername}.home` - User's actual home path

## Critical Violations to Fix

### 1. modules/services/audio/pipewire.nix:54
- **Violation**: `User = "rain";`
- **Fix**: `User = config.identity.primaryUsername;`

### 2. modules/theming/stylix.nix:161
- **Violation**: `User = "rain";` in systemd.user.services
- **Fix**: Remove `User` field (systemd.user.services automatically run as the user)

### 3. modules/services/desktop/common.nix:70
- **Violation**: `User = "rain";`
- **Fix**: `User = config.identity.primaryUsername;`

### 4. modules/services/desktop/common.nix:72
- **Violation**: `"HOME=/home/rain"`
- **Fix**: `"HOME=${config.identity.home}"`

### 5. modules/services/desktop/common.nix:73
- **Violation**: `"XDG_RUNTIME_DIR=/run/user/1000"`
- **Fix**: `"XDG_RUNTIME_DIR=/run/user/${toString config.users.users.${config.identity.primaryUsername}.uid}"`

### 6. modules/apps/ai/voice-assistant.nix:14
- **Violation**: `user = "rain";`
- **Fix**: `user = config.identity.primaryUsername;`

### 7. modules/apps/ai/voice-assistant.nix:25
- **Violation**: `awake = "/home/rain/958__anton__groter.wav";`
- **Fix**: `awake = "${config.identity.home}/958__anton__groter.wav";`

### 8. modules/apps/gaming/gaming.nix:44
- **Violation**: `data-root = "/home/rain/docker/images/";`
- **Fix**: `data-root = "${config.identity.home}/docker/images/";`

## Reference Files

Key files for context:
- `modules/common/identity.nix` - Defines identity.* options
- `.planning/phases/23-eliminate-host-nix/23-01-PLAN.md` - Architectural guidelines
</context>

<tasks>

<task id="1" type="auto">
<description>Fix pipewire.nix hardcoded username</description>
<actions>
1. Read modules/services/audio/pipewire.nix
2. Replace line 54: `User = "rain";` → `User = config.identity.primaryUsername;`
3. Verify the change with grep
</actions>
<verification>
```bash
grep -n "User = config.identity.primaryUsername" modules/services/audio/pipewire.nix
! grep -n 'User = "rain"' modules/services/audio/pipewire.nix
```
</verification>
</task>

<task id="2" type="auto">
<description>Fix stylix.nix hardcoded username</description>
<actions>
1. Read modules/theming/stylix.nix around line 161
2. Identify the systemd.user.services block
3. Remove the `User = "rain";` line (systemd.user.services run as user automatically)
4. Verify the change
</actions>
<verification>
```bash
! grep -n 'User = "rain"' modules/theming/stylix.nix
```
</verification>
</task>

<task id="3" type="auto">
<description>Fix common.nix hardcoded username and paths</description>
<actions>
1. Read modules/services/desktop/common.nix
2. Fix line 70: `User = "rain";` → `User = config.identity.primaryUsername;`
3. Fix line 72: `"HOME=/home/rain"` → `"HOME=${config.identity.home}"`
4. Fix line 73: `"XDG_RUNTIME_DIR=/run/user/1000"` → `"XDG_RUNTIME_DIR=/run/user/${toString config.users.users.${config.identity.primaryUsername}.uid}"`
5. Verify all changes
</actions>
<verification>
```bash
grep -n "User = config.identity.primaryUsername" modules/services/desktop/common.nix
grep -n "HOME=\${config.identity.home}" modules/services/desktop/common.nix
grep -n "XDG_RUNTIME_DIR=/run/user/\${toString config.users.users.\${config.identity.primaryUsername}.uid}" modules/services/desktop/common.nix
! grep -n 'User = "rain"' modules/services/desktop/common.nix
! grep -n 'HOME=/home/rain' modules/services/desktop/common.nix
! grep -n 'XDG_RUNTIME_DIR=/run/user/1000' modules/services/desktop/common.nix
```
</verification>
</task>

<task id="4" type="auto">
<description>Fix voice-assistant.nix hardcoded username and path</description>
<actions>
1. Read modules/apps/ai/voice-assistant.nix
2. Fix line 14: `user = "rain";` → `user = config.identity.primaryUsername;`
3. Fix line 25: `awake = "/home/rain/958__anton__groter.wav";` → `awake = "${config.identity.home}/958__anton__groter.wav";`
4. Verify both changes
</actions>
<verification>
```bash
grep -n "user = config.identity.primaryUsername" modules/apps/ai/voice-assistant.nix
grep -n "awake = \"\${config.identity.home}/958__anton__groter.wav\"" modules/apps/ai/voice-assistant.nix
! grep -n 'user = "rain"' modules/apps/ai/voice-assistant.nix
! grep -n 'awake = "/home/rain' modules/apps/ai/voice-assistant.nix
```
</verification>
</task>

<task id="5" type="auto">
<description>Fix gaming.nix hardcoded Docker path</description>
<actions>
1. Read modules/apps/gaming/gaming.nix around line 44
2. Fix: `data-root = "/home/rain/docker/images/";` → `data-root = "${config.identity.home}/docker/images/";`
3. Verify the change
</actions>
<verification>
```bash
grep -n "data-root = \"\${config.identity.home}/docker/images/\"" modules/apps/gaming/gaming.nix
! grep -n 'data-root = "/home/rain' modules/apps/gaming/gaming.nix
```
</verification>
</task>

<task id="6" type="auto">
<description>Verify no remaining hardcoded usernames in modules</description>
<actions>
1. Search all modules for hardcoded "rain" username
2. Exclude modules/users directory (user-specific configs are allowed there)
3. Verify zero matches
</actions>
<verification>
```bash
# Should return no results
! grep -rn '"rain"' modules/ --exclude-dir=users | grep -v "# " | grep -v "description"
```
</verification>
</task>

<task id="7" type="auto">
<description>Verify no remaining hardcoded /home/rain paths in modules</description>
<actions>
1. Search all modules for hardcoded /home/rain paths
2. Verify zero matches
</actions>
<verification>
```bash
# Should return no results
! grep -rn '/home/rain' modules/
```
</verification>
</task>

<task id="8" type="auto">
<description>Build all hosts to verify fixes don't break anything</description>
<actions>
1. Build a representative host (griefling - test VM)
2. Run nix flake check
3. Verify no errors
</actions>
<verification>
```bash
# Build griefling host config
nix build .#nixosConfigurations.griefling.config.system.build.toplevel --dry-run

# Run flake check
nix flake check --no-build
```
</verification>
</task>

</tasks>

<success_criteria>
## Automated Compliance Checks

After remediation, these must all pass:

```bash
# Zero hardcoded usernames in modules
! grep -rn '"rain"' modules/ --exclude-dir=users | grep -v "# " | grep -v "description"

# Zero hardcoded /home/rain paths in modules
! grep -rn '/home/rain' modules/

# All specific fixes verified
grep -q "User = config.identity.primaryUsername" modules/services/audio/pipewire.nix
! grep -q 'User = "rain"' modules/theming/stylix.nix
grep -q "User = config.identity.primaryUsername" modules/services/desktop/common.nix
grep -q "HOME=\${config.identity.home}" modules/services/desktop/common.nix
grep -q "user = config.identity.primaryUsername" modules/apps/ai/voice-assistant.nix
grep -q "data-root = \"\${config.identity.home}" modules/apps/gaming/gaming.nix

# Build verification
nix flake check --no-build
```

## Target Metrics

- **Compliance Score**: 95/100 (A grade)
- **Critical Violations**: 0
- **Violation Rate**: <2%
- **Build Status**: All hosts build successfully

## Documentation

- Create SUMMARY.md documenting:
  - Files modified
  - Lines changed
  - Before/after examples
  - Build verification results
  - New compliance score

</success_criteria>

<effort_estimate>
- Task 1-5: 2 hours (straightforward replacements)
- Task 6-7: 30 minutes (verification)
- Task 8: 1 hour (build testing)
- Documentation: 30 minutes
- **Total**: 4 hours
</effort_estimate>

## Notes

- All fixes are mechanical string replacements
- No architectural changes required
- Low risk - config.identity.* already established in Phase 23
- Builds should pass without issues (same functionality, different variable)
