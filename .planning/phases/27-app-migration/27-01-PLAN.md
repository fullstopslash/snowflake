# Phase 27: TrueNAS SCALE App Migration - Remaining 19 Apps

<objective>
Migrate the remaining 19 applications from TrueNAS SCALE ix-apps managed storage to self-managed structure at /mnt/apps/apps/, completing the comprehensive migration started in Phase 26 and achieving 100% migration coverage.
</objective>

<execution_context>
<!-- Files needed for execution protocol -->
- `.planning/docs/execute-phase.md` - Execution protocol and deviation rules
- `.planning/phases/26-app-migration/26-01-PLAN.md` - Phase 26 proven procedures
- `.planning/phases/26-app-migration/AUDIT-REPORT.md` - Comprehensive audit identifying remaining apps
- `/mnt/apps/apps/` - Target self-managed app storage location
- `/mnt/.ix-apps/` - Current ix-apps managed location
- `/mnt/storage/` - Media files (DO NOT MOVE - only referenced by apps)
</execution_context>

<context>
## Background

### Phase 26 Success
Phase 26 successfully migrated 9 applications with **100% success rate, zero errors, completed in 5 minutes**:
- qBittorrent, SABnzbd (download clients)
- Prowlarr (indexer management)
- Sonarr, Radarr, Bazarr (media automation)
- Jellyseerr, Jellyfin, Janitorr (request/playback/utilities)

**Key Learnings from Phase 26:**
1. Proven migration procedure works flawlessly
2. Simple apps migrate in ~30 seconds each
3. No database migrations needed (configs only)
4. Wave-based approach provides safety and verification
5. Backup → Stop → rsync → Update compose → Start → Verify

### Current State (Post-Audit)
**Comprehensive audit completed 2025-12-30:**
- **Total containers:** 65
- **Successfully using /mnt/apps/apps/:** 36 apps (55.4%)
- **Still in ix-apps:** 19 apps (29.2%) - **THESE ARE OUR TARGETS**
- **Mixed paths:** 2 apps (temp/cache only - can ignore)
- **No persistent storage:** 8 apps (stateless - no migration needed)

### Why These 19 Apps Were Missed in Phase 26

**Servarr Ecosystem Extensions (6 apps):**
- These apps extend the core servarr stack with additional functionality
- Not discovered during initial Phase 26 inventory
- Part of the same ecosystem but supporting/auxiliary services

**DMZ Infrastructure (4 apps):**
- Additional download/processing tools in DMZ
- Some integrate with migrated download clients
- Missed during initial download client migration

**Infrastructure Apps (8 apps):**
- Independent services (calibre, syncthing, n8n, vaultwarden)
- Not related to servarr stack
- Lower priority for media workflow

**Media Processing (1 app):**
- Tdarr transcoding automation
- Potentially large data footprint
- Requires special handling

### Strategic Importance

**Completing this phase achieves:**
1. **100% migration coverage** - No apps remaining in ix-apps
2. **Consistent structure** - All apps in /mnt/apps/apps/
3. **k3s readiness** - Clean, modular structure for future k3s migration
4. **Simplified management** - Single location for all app data
5. **Backup simplification** - One directory to backup

## Apps to Migrate (19 Total)

### Wave 1: Homarr Special Case (1 app) - TEST CASE
**Rationale:** Unique path structure requires testing procedure first

1. **core-homarr** - Servarr dashboard
   - **Path:** `/mnt/.ix-apps/app_configs/servarr/versions/1.0.0/templates/rendered/homarr/appdata`
   - **RED FLAG:** Uses `app_configs` path (template directory) instead of `app_mounts`
   - **Size:** Small config-only
   - **Priority:** HIGH (servarr ecosystem)
   - **Special handling:** Different source path pattern

### Wave 2: Simple Servarr Apps (5 apps) - QUICK WINS
**Rationale:** Extend servarr ecosystem, simple config-only migrations

2. **core-SuggestArr** - Request suggestions
   - **Path:** `/mnt/.ix-apps/app_mounts/suggestarr/config`
   - **Size:** Small config
   - **Priority:** HIGH

3. **core-audiobookrequest** - Audiobook requests
   - **Path:** `/mnt/.ix-apps/app_mounts/audiobookrequest/config`
   - **Storage:** Yes
   - **Priority:** HIGH

4. **core-huntarr** - Usenet indexer hunter
   - **Path:** `/mnt/.ix-apps/app_mounts/huntarr/config`
   - **Storage:** Yes
   - **Priority:** HIGH

5. **core-decluttarr** - Cleanup automation
   - **Path:** `/mnt/.ix-apps/app_mounts/decluttarr/config.yaml` (single file)
   - **Storage:** Yes
   - **Priority:** HIGH

6. **core-whisparr** - Adult content management
   - **Path:** `/mnt/.ix-apps/app_mounts/whisparr/config` + `/data`
   - **Storage:** Yes
   - **Priority:** HIGH
   - **Note:** Has separate data directory

### Wave 3: Download/Processing Apps (4 apps) - MODERATE
**Rationale:** Support download infrastructure, moderate data

7. **dmz-ytdl-sub** - YouTube download automation
   - **Path:** `/mnt/.ix-apps/app_mounts/ytdl-sub/config`
   - **Storage:** Yes
   - **Priority:** MEDIUM

8. **dmz-nzbget** - Usenet downloader (alternative to SABnzbd)
   - **Path:** `/mnt/.ix-apps/app_mounts/nzbget/data`
   - **Storage:** Yes
   - **Priority:** MEDIUM
   - **Note:** May have active queue data

9. **dmz-spottarr** - Spotify downloader
   - **Path:** `/mnt/.ix-apps/app_mounts/spottarr/data`
   - **Storage:** Yes
   - **Priority:** MEDIUM

10. **dmz-gluetun** - VPN container
    - **Path:** `/mnt/.ix-apps/app_mounts/gluetun`
    - **Priority:** MEDIUM
    - **CRITICAL:** Check if other apps depend on this VPN
    - **Note:** Network dependencies possible

### Wave 4: Tdarr Media Processing (1 app) - LARGE DATA
**Rationale:** Transcoding automation with multiple mounts, potentially large cache

11. **ix-tdarr-tdarr-1** - Transcoding automation
    - **Paths:** Multiple mounts
      - `/mnt/.ix-apps/app_mounts/tdarr/configs`
      - `/mnt/.ix-apps/app_mounts/tdarr/logs`
      - `/mnt/.ix-apps/app_mounts/tdarr/server`
      - `/mnt/.ix-apps/app_mounts/tdarr/transcodes` (temp cache)
    - **Storage:** Yes
    - **Priority:** MEDIUM
    - **Special:** Check data size before migration, may have large temp files

### Wave 5: E-books and Sync (3 apps) - INDEPENDENT
**Rationale:** Independent services, not critical to media workflow

12. **ix-calibre-calibre-1** - E-book management
    - **Path:** `/mnt/.ix-apps/app_mounts/calibre/config`
    - **Storage:** Yes
    - **Priority:** LOW

13. **ix-calibre-web-calibre-web-1** - Calibre web interface
    - **Path:** `/mnt/.ix-apps/app_mounts/calibre-web/config`
    - **Storage:** Books directory mounted
    - **Priority:** LOW
    - **Note:** Depends on calibre

14. **ix-syncthing-syncthing-1** - File synchronization
    - **Path:** `/mnt/.ix-apps/app_mounts/syncthing/config`
    - **Storage:** Yes
    - **Priority:** LOW

### Wave 6: n8n Workflow Stack (3 apps) - DATABASE APPS
**Rationale:** n8n with postgres and redis, migrate as unit

15. **ix-n8n-n8n-1** - Workflow automation
    - **Paths:**
      - `/mnt/.ix-apps/app_mounts/n8n/data`
      - `/mnt/.ix-apps/docker/volumes/ix-n8n_tmp-n8n-npm-cache/_data` (cache)
      - `/mnt/.ix-apps/docker/volumes/[hash]/_data` (tmp)
    - **Priority:** LOW
    - **Note:** Has postgres and redis dependencies

16. **ix-n8n-postgres-1** - n8n database
    - **Paths:**
      - `/mnt/.ix-apps/app_mounts/n8n/postgres_data`
      - `/mnt/.ix-apps/docker/volumes/[hash]/_data`
    - **Priority:** LOW
    - **CRITICAL:** Migrate with parent n8n app

17. **ix-n8n-redis-1** - n8n cache
    - **Path:** `/mnt/.ix-apps/docker/volumes/ix-n8n_redis-data/_data`
    - **Priority:** LOW
    - **CRITICAL:** Migrate with parent n8n app

### Wave 7: Vaultwarden Stack (2 apps) - DATABASE APPS
**Rationale:** Password manager with postgres, migrate as unit

18. **ix-vaultwarden-vaultwarden-1** - Password manager
    - **Path:** `/mnt/.ix-apps/app_mounts/vaultwarden/data`
    - **Priority:** LOW
    - **Note:** Has postgres dependency

19. **ix-vaultwarden-postgres-1** - Vaultwarden database
    - **Paths:**
      - `/mnt/.ix-apps/app_mounts/vaultwarden/postgres_data`
      - `/mnt/.ix-apps/docker/volumes/[hash]/_data`
    - **Priority:** LOW
    - **CRITICAL:** Migrate with parent vaultwarden app

## Target Structure

Following Phase 26 established pattern:

```
/mnt/apps/apps/
├── homarr/
│   └── config/
├── suggestarr/
│   └── config/
├── audiobookrequest/
│   └── config/
├── huntarr/
│   └── config/
├── decluttarr/
│   └── config/
├── whisparr/
│   ├── config/
│   └── data/
├── ytdl-sub/
│   └── config/
├── nzbget/
│   └── config/
├── spottarr/
│   └── config/
├── gluetun/
│   └── config/
├── tdarr/
│   ├── configs/
│   ├── logs/
│   ├── server/
│   └── transcodes/
├── calibre/
│   └── config/
├── calibre-web/
│   └── config/
├── syncthing/
│   └── config/
├── n8n/
│   ├── data/
│   ├── postgres/
│   └── redis/
└── vaultwarden/
    ├── data/
    └── postgres/
```

**Key Principles (from Phase 26):**
1. **Modular per-app directories** - Each app self-contained
2. **Consistent subdirectory structure** - config/, data/, postgres/ as needed
3. **No nesting beyond app level** - Flat structure for clarity
4. **Separation of app data from media** - Media stays in /mnt/storage/

## Migration Procedure (Proven from Phase 26)

**Standard Migration Pattern:**
1. **Backup** - Create full backup of app data
2. **Stop** - Stop app in TrueNAS UI
3. **Verify Source** - Confirm current ix-apps path
4. **Create Target** - Create /mnt/apps/apps/appname structure
5. **rsync** - Copy data with progress monitoring
6. **Permissions** - Fix ownership (568:568)
7. **Update Compose** - Modify docker-compose.yml paths
8. **Redeploy** - Update app in TrueNAS
9. **Verify** - Test app functionality
10. **Monitor** - Watch logs for issues

**Time Estimates (from Phase 26 experience):**
- Simple config-only: ~30 seconds
- With data directory: ~1-2 minutes
- Multi-mount apps: ~2-3 minutes
- Database apps: ~3-5 minutes each

## Special Considerations

### Homarr Special Case (Wave 1)
- Uses `app_configs` path instead of `app_mounts`
- Source: `/mnt/.ix-apps/app_configs/servarr/versions/1.0.0/templates/rendered/homarr/appdata`
- May be in template directory due to custom installation
- **Test this first** to establish pattern for any similar cases
- If data is minimal, may be easier to reconfigure fresh

### Gluetun VPN Dependencies
- **CRITICAL:** Check if other containers route through gluetun
- Audit docker networks for containers using gluetun
- Options:
  1. Migrate early if no dependencies
  2. Migrate with dependent apps together
  3. Migrate last if other apps depend on it
- **Action:** Verify dependencies before migration

### Tdarr Large Data Handling
- Check size of `/mnt/.ix-apps/app_mounts/tdarr/transcodes` before migration
- Transcoding cache can be 10GB+ depending on usage
- **Options:**
  1. Migrate full cache (long rsync time)
  2. Skip cache, let it regenerate (faster)
  3. Clear old cache before migration
- **Recommendation:** Check size, skip if >5GB (cache is temporary)

### Database Apps (n8n, vaultwarden)
- Migrate postgres containers with parent apps
- Use Phase 26 postgres migration pattern
- **Critical steps:**
  1. Stop postgres first (with parent app)
  2. rsync postgres data directory
  3. Set strict permissions (700 for postgres dir)
  4. Start postgres before parent app
  5. Verify database connectivity

### Docker Volume Paths
Some apps use docker volumes (paths with long hashes):
- `/mnt/.ix-apps/docker/volumes/[hash]/_data`
- These are typically temp/cache directories
- **Approach:**
  1. Identify what they contain (logs, cache, temp)
  2. Decide if migration needed (may skip cache/temp)
  3. Create new volume mounts in /mnt/apps/apps/ if needed

## Safety Measures (from Phase 26)

1. **Comprehensive Backup**
   - Backup ALL 19 apps before starting
   - Store in `/mnt/storage/backups/phase27-app-migration-$(date +%Y%m%d)/`
   - Verify backup integrity before proceeding

2. **Wave-Based Migration**
   - Migrate in small waves (1-5 apps)
   - Verify each wave before proceeding
   - Allows early detection of issues

3. **Incremental Verification**
   - Test each app after migration
   - Verify web UI accessible
   - Check logs for errors
   - Confirm functionality

4. **Rollback Capability**
   - Keep old ix-apps data intact during migration
   - Can revert volume mounts if issues occur
   - Document rollback steps per app

5. **Monitoring Period**
   - 7-day monitoring before cleanup (like Phase 26)
   - Daily verification of all migrated apps
   - User feedback collection

6. **Dependencies Tracking**
   - Document app dependencies (gluetun VPN, postgres)
   - Verify integrations after migration
   - Test API connections

</context>

<tasks>

## Phase 1: Discovery & Preparation

<task id="1" type="manual">
<description>Verify audit findings and double-check 19 apps</description>
<actions>
1. SSH to waterbug.lan
2. Verify each of the 19 apps is running:
   ```bash
   docker ps | grep -E "homarr|suggestarr|audiobookrequest|huntarr|decluttarr|whisparr|ytdl-sub|nzbget|spottarr|gluetun|tdarr|calibre|syncthing|n8n|vaultwarden"
   ```

3. Verify current ix-apps paths for each app:
   ```bash
   # Check sample of apps
   docker inspect core-homarr | grep -A 20 Mounts
   docker inspect core-SuggestArr | grep -A 20 Mounts
   docker inspect dmz-gluetun | grep -A 20 Mounts
   docker inspect ix-tdarr-tdarr-1 | grep -A 20 Mounts
   ```

4. Create verified app list in discovery-verified.md
5. Note any apps that are stopped or have issues
6. Confirm all 19 apps are in ix-apps paths (not already migrated)

</actions>
<verification>
```bash
# All 19 apps present
docker ps -a | grep -cE "homarr|suggestarr|audiobookrequest|huntarr|decluttarr|whisparr|ytdl-sub|nzbget|spottarr|gluetun|tdarr|calibre|syncthing|n8n|vaultwarden"
# Should return 19

# Verify using ix-apps paths
for app in homarr suggestarr audiobookrequest; do
  echo "=== $app ==="
  docker inspect $app 2>/dev/null | grep "ix-apps" || echo "Not found or not using ix-apps"
done
```
</verification>
<deliverable>
File: `.planning/phases/27-app-migration/discovery-verified.md`

List of 19 verified apps with:
- Current running status
- Current ix-apps paths
- Estimated data sizes
- Any special notes
</deliverable>
</task>

<task id="2" type="manual">
<description>Check for dependencies (gluetun VPN, postgres databases)</description>
<actions>
1. **Check Gluetun VPN Dependencies:**
   ```bash
   # Check which containers use gluetun network
   docker network ls | grep gluetun

   # Check containers connected to gluetun network
   docker network inspect [gluetun-network-id] | jq '.[].Containers'

   # Check if any apps use gluetun as network mode
   grep -r "network_mode.*gluetun" /mnt/.ix-apps/app_configs/*/versions/*/templates/rendered/*/docker-compose.yml

   # Alternative: Check if containers share gluetun's network namespace
   docker ps --format "{{.Names}}" | while read container; do
     network_mode=$(docker inspect $container --format '{{.HostConfig.NetworkMode}}')
     if [[ $network_mode == *"gluetun"* ]]; then
       echo "$container uses gluetun network"
     fi
   done
   ```

2. **Check Database Dependencies:**
   ```bash
   # Verify n8n uses postgres and redis
   docker logs ix-n8n-n8n-1 --tail 50 | grep -i "postgres\|redis"

   # Verify vaultwarden uses postgres
   docker logs ix-vaultwarden-vaultwarden-1 --tail 50 | grep -i postgres

   # Check database sizes
   docker exec ix-n8n-postgres-1 du -sh /var/lib/postgresql 2>/dev/null
   docker exec ix-vaultwarden-postgres-1 du -sh /var/lib/postgresql 2>/dev/null
   ```

3. **Check App Interconnections:**
   ```bash
   # Check if servarr apps connect to newly migrated homarr
   # (homarr is dashboard, should pull from other apps, not vice versa)
   ```

4. **Document Dependencies:**
   - Create dependency map
   - Note which apps must migrate together
   - Identify migration order constraints

</actions>
<verification>
Manual review of dependency findings and migration constraints
</verification>
<deliverable>
File: `.planning/phases/27-app-migration/dependencies.md`

Contents:
```markdown
# App Dependencies Analysis

## Gluetun VPN Dependencies
- Apps using gluetun network: [list]
- Migration strategy: [migrate together / migrate gluetun last / no dependencies]

## Database Stack Dependencies
### n8n Stack
- n8n-postgres size: X GB
- n8n-redis size: Y GB
- Migration order: postgres → redis → n8n

### Vaultwarden Stack
- vaultwarden-postgres size: X GB
- Migration order: postgres → vaultwarden

## App Interconnections
- [Any discovered interconnections]

## Migration Order Constraints
1. [Constraint 1]
2. [Constraint 2]
```
</deliverable>
</task>

<task id="3" type="auto">
<description>Create comprehensive backup of all 19 apps</description>
<actions>
1. **Create backup directory:**
   ```bash
   backup_dir="/mnt/storage/backups/phase27-app-migration-$(date +%Y%m%d-%H%M)"
   mkdir -p "$backup_dir"
   ```

2. **Backup all 19 apps from ix-apps:**
   ```bash
   # Servarr ecosystem (including homarr special case)
   rsync -av /mnt/.ix-apps/app_configs/servarr/versions/1.0.0/templates/rendered/homarr/ "$backup_dir/homarr/"
   rsync -av /mnt/.ix-apps/app_mounts/suggestarr/ "$backup_dir/suggestarr/"
   rsync -av /mnt/.ix-apps/app_mounts/audiobookrequest/ "$backup_dir/audiobookrequest/"
   rsync -av /mnt/.ix-apps/app_mounts/huntarr/ "$backup_dir/huntarr/"
   rsync -av /mnt/.ix-apps/app_mounts/decluttarr/ "$backup_dir/decluttarr/"
   rsync -av /mnt/.ix-apps/app_mounts/whisparr/ "$backup_dir/whisparr/"

   # Download/Processing
   rsync -av /mnt/.ix-apps/app_mounts/ytdl-sub/ "$backup_dir/ytdl-sub/"
   rsync -av /mnt/.ix-apps/app_mounts/nzbget/ "$backup_dir/nzbget/"
   rsync -av /mnt/.ix-apps/app_mounts/spottarr/ "$backup_dir/spottarr/"
   rsync -av /mnt/.ix-apps/app_mounts/gluetun/ "$backup_dir/gluetun/"

   # Tdarr
   rsync -av /mnt/.ix-apps/app_mounts/tdarr/ "$backup_dir/tdarr/"

   # E-books and sync
   rsync -av /mnt/.ix-apps/app_mounts/calibre/ "$backup_dir/calibre/"
   rsync -av /mnt/.ix-apps/app_mounts/calibre-web/ "$backup_dir/calibre-web/"
   rsync -av /mnt/.ix-apps/app_mounts/syncthing/ "$backup_dir/syncthing/"

   # n8n stack
   rsync -av /mnt/.ix-apps/app_mounts/n8n/ "$backup_dir/n8n/"

   # Vaultwarden stack
   rsync -av /mnt/.ix-apps/app_mounts/vaultwarden/ "$backup_dir/vaultwarden/"
   ```

3. **Export TrueNAS app configurations:**
   ```bash
   midclt call app.query > "$backup_dir/truenas-apps-config.json"
   ```

4. **Verify backup integrity:**
   ```bash
   # Compare sizes
   du -sh /mnt/.ix-apps/app_mounts/*/
   du -sh "$backup_dir"/*/

   # Count files
   find /mnt/.ix-apps/app_mounts/ -type f | wc -l
   find "$backup_dir"/ -type f | wc -l

   # Create manifest
   tree -L 3 "$backup_dir" > "$backup_dir/backup-manifest.txt"
   du -sh "$backup_dir"/* >> "$backup_dir/backup-manifest.txt"
   ```

5. **Document backup location:**
   ```bash
   echo "Phase 27 Backup Location: $backup_dir" > .planning/phases/27-app-migration/BACKUP-LOCATION.txt
   echo "Backup Date: $(date)" >> .planning/phases/27-app-migration/BACKUP-LOCATION.txt
   echo "Total Size: $(du -sh $backup_dir | cut -f1)" >> .planning/phases/27-app-migration/BACKUP-LOCATION.txt
   ```

</actions>
<verification>
```bash
# Verify backup exists
[ -d "$backup_dir" ] && echo "Backup exists" || echo "ERROR: Backup missing"

# Verify backup has content
backup_size=$(du -s "$backup_dir" | cut -f1)
[ $backup_size -gt 1000 ] && echo "Backup has content" || echo "WARNING: Backup seems small"

# Verify manifest created
[ -f "$backup_dir/backup-manifest.txt" ] && echo "Manifest exists" || echo "ERROR: No manifest"
```
</verification>
<deliverable>
Backup of all 19 apps in `/mnt/storage/backups/phase27-app-migration-[date]/`

Backup manifest documented in `.planning/phases/27-app-migration/BACKUP-LOCATION.txt`
</deliverable>
</task>

## Phase 2: Wave 1 - Homarr Special Case (Test)

<task id="4" type="manual">
<description>Migrate Homarr (special app_configs path - establish pattern)</description>
<actions>
**Homarr uses unusual path - test this first to establish procedure**

1. **Pre-Migration Analysis:**
   ```bash
   # Check current homarr path
   docker inspect core-homarr | grep -A 30 Mounts

   # Verify source data exists
   ls -la /mnt/.ix-apps/app_configs/servarr/versions/1.0.0/templates/rendered/homarr/appdata/

   # Check size
   du -sh /mnt/.ix-apps/app_configs/servarr/versions/1.0.0/templates/rendered/homarr/

   # Check what's in there
   tree -L 3 /mnt/.ix-apps/app_configs/servarr/versions/1.0.0/templates/rendered/homarr/
   ```

2. **Stop App:**
   - TrueNAS UI → Apps → homarr → Stop

3. **Create Target Structure:**
   ```bash
   mkdir -p /mnt/apps/apps/homarr/config
   chown -R 568:568 /mnt/apps/apps/homarr
   chmod -R 755 /mnt/apps/apps/homarr
   ```

4. **Migrate Data:**
   ```bash
   # Copy from special app_configs path
   rsync -av --progress \
     /mnt/.ix-apps/app_configs/servarr/versions/1.0.0/templates/rendered/homarr/appdata/ \
     /mnt/apps/apps/homarr/config/
   ```

5. **Fix Permissions:**
   ```bash
   chown -R 568:568 /mnt/apps/apps/homarr/
   chmod -R 755 /mnt/apps/apps/homarr/
   ```

6. **Update Docker Compose:**
   ```bash
   # Edit homarr docker-compose.yml
   compose_file="/mnt/.ix-apps/app_configs/servarr/versions/1.0.0/templates/rendered/homarr/docker-compose.yml"

   # Backup original
   cp "$compose_file" "$compose_file.backup-phase27"

   # Update volume mount (example - adjust based on actual file)
   # OLD: /mnt/.ix-apps/app_configs/servarr/versions/1.0.0/templates/rendered/homarr/appdata:/appdata
   # NEW: /mnt/apps/apps/homarr/config:/appdata

   # Use sed or manual edit
   sed -i 's|/mnt/\.ix-apps/app_configs/servarr/versions/1\.0\.0/templates/rendered/homarr/appdata|/mnt/apps/apps/homarr/config|g' "$compose_file"
   ```

7. **Redeploy App:**
   - TrueNAS UI → Apps → homarr → Edit
   - OR: `docker-compose -f "$compose_file" up -d`

8. **Verify Functionality:**
   ```bash
   # Check container running
   docker ps | grep homarr

   # Check mounts
   docker inspect core-homarr | grep -A 20 Mounts | grep "/mnt/apps/apps/homarr"

   # Check logs
   docker logs core-homarr --tail 50

   # Access web UI (check port from docker ps)
   curl -I http://localhost:[homarr-port]
   ```

9. **Test Dashboard:**
   - Access Homarr web UI
   - Verify dashboard configuration intact
   - Check if it can connect to other servarr apps
   - Verify widgets/integrations working

10. **Document Special Case:**
    - Note the app_configs path pattern
    - Document if other apps use similar pattern
    - Update migration runbook if needed

</actions>
<verification>
```bash
# App running
docker ps | grep homarr | grep -q "Up" && echo "✓ Running" || echo "✗ Not running"

# Using new path
docker inspect core-homarr | grep -q "/mnt/apps/apps/homarr" && echo "✓ New path" || echo "✗ Old path"

# No errors in logs
! docker logs core-homarr --tail 100 | grep -i error && echo "✓ No errors" || echo "⚠ Check errors"

# Web UI accessible
curl -f -I -m 5 http://localhost:[port] > /dev/null 2>&1 && echo "✓ Web UI accessible" || echo "✗ Web UI not accessible"
```
</verification>
<deliverable>
Homarr successfully migrated from app_configs path

Pattern documented for any similar special cases

File: `.planning/phases/27-app-migration/wave1-homarr-complete.md`
</deliverable>
</task>

## Phase 3: Wave 2 - Simple Servarr Apps (Quick Wins)

<task id="5" type="manual">
<description>Migrate SuggestArr, audiobookrequest, and huntarr</description>
<actions>
**Migrate 3 simple servarr apps using proven Phase 26 procedure**

For each app (suggestarr, audiobookrequest, huntarr):

1. **Stop App:**
   - TrueNAS UI → Apps → [appname] → Stop

2. **Create Target:**
   ```bash
   appname="[suggestarr|audiobookrequest|huntarr]"
   mkdir -p /mnt/apps/apps/$appname/config
   chown -R 568:568 /mnt/apps/apps/$appname
   chmod -R 755 /mnt/apps/apps/$appname
   ```

3. **Migrate Data:**
   ```bash
   rsync -av --progress \
     /mnt/.ix-apps/app_mounts/$appname/config/ \
     /mnt/apps/apps/$appname/config/
   ```

4. **Fix Permissions:**
   ```bash
   chown -R 568:568 /mnt/apps/apps/$appname/
   ```

5. **Update Docker Compose:**
   ```bash
   compose_file=$(find /mnt/.ix-apps/app_configs -name "docker-compose.yml" -path "*/$appname/*" | sort -V | tail -1)
   cp "$compose_file" "$compose_file.backup-phase27"

   # Update volume mount
   sed -i "s|/mnt/\.ix-apps/app_mounts/$appname/config|/mnt/apps/apps/$appname/config|g" "$compose_file"

   # Verify change
   grep "/mnt/apps/apps/$appname" "$compose_file"
   ```

6. **Redeploy:**
   - TrueNAS UI → Apps → [appname] → Edit → Save (triggers redeploy)

7. **Verify:**
   ```bash
   docker ps | grep $appname
   docker inspect $appname | grep "/mnt/apps/apps/$appname"
   docker logs $appname --tail 50
   ```

**Estimated time: ~2 minutes per app, ~6 minutes total**

</actions>
<verification>
```bash
# All 3 apps running
for app in suggestarr audiobookrequest huntarr; do
  docker ps | grep -q $app && echo "✓ $app running" || echo "✗ $app not running"
done

# All using new paths
for app in suggestarr audiobookrequest huntarr; do
  docker inspect $app | grep -q "/mnt/apps/apps/$app" && echo "✓ $app new path" || echo "✗ $app old path"
done
```
</verification>
<deliverable>
3 servarr apps migrated successfully

File: `.planning/phases/27-app-migration/wave2-servarr-simple-complete.md`
</deliverable>
</task>

<task id="6" type="manual">
<description>Migrate decluttarr and whisparr</description>
<actions>
**Migrate remaining 2 servarr apps**

### Decluttarr (single file config)
1. **Stop App**
2. **Create Target:**
   ```bash
   mkdir -p /mnt/apps/apps/decluttarr/config
   chown -R 568:568 /mnt/apps/apps/decluttarr
   ```

3. **Migrate Config File:**
   ```bash
   rsync -av \
     /mnt/.ix-apps/app_mounts/decluttarr/config.yaml \
     /mnt/apps/apps/decluttarr/config/config.yaml
   ```

4. **Update Compose & Redeploy**

### Whisparr (config + data directories)
1. **Stop App**
2. **Create Target:**
   ```bash
   mkdir -p /mnt/apps/apps/whisparr/{config,data}
   chown -R 568:568 /mnt/apps/apps/whisparr
   ```

3. **Migrate Both Directories:**
   ```bash
   rsync -av --progress \
     /mnt/.ix-apps/app_mounts/whisparr/config/ \
     /mnt/apps/apps/whisparr/config/

   rsync -av --progress \
     /mnt/.ix-apps/app_mounts/whisparr/data/ \
     /mnt/apps/apps/whisparr/data/
   ```

4. **Update Compose (both mounts):**
   ```bash
   # Update both config and data paths
   sed -i 's|/mnt/\.ix-apps/app_mounts/whisparr/config|/mnt/apps/apps/whisparr/config|g' "$compose_file"
   sed -i 's|/mnt/\.ix-apps/app_mounts/whisparr/data|/mnt/apps/apps/whisparr/data|g' "$compose_file"
   ```

5. **Redeploy & Verify**

**Estimated time: ~4 minutes total**

</actions>
<verification>
```bash
# Apps running
docker ps | grep -E "decluttarr|whisparr"

# Using new paths
docker inspect decluttarr | grep "/mnt/apps/apps/decluttarr"
docker inspect core-whisparr | grep "/mnt/apps/apps/whisparr"

# Whisparr has both mounts
docker inspect core-whisparr | grep -c "/mnt/apps/apps/whisparr" | grep -q "2"
```
</verification>
<deliverable>
Wave 2 complete - 5 servarr apps migrated

File: `.planning/phases/27-app-migration/wave2-complete.md`
</deliverable>
</task>

## Phase 4: Wave 3 - Download/Processing Apps

<task id="7" type="manual">
<description>Migrate ytdl-sub, nzbget, and spottarr</description>
<actions>
**Migrate 3 download/processing apps using proven procedure**

For each app (ytdl-sub, nzbget, spottarr):

1. **Stop App**

2. **Check Data Size:**
   ```bash
   appname="[ytdl-sub|nzbget|spottarr]"
   du -sh /mnt/.ix-apps/app_mounts/$appname/
   ```

3. **Create Target:**
   ```bash
   # nzbget uses 'data' directory, others use 'config'
   if [ "$appname" = "nzbget" ]; then
     mkdir -p /mnt/apps/apps/$appname/config  # nzbget's 'data' is actually config
   else
     mkdir -p /mnt/apps/apps/$appname/{config,data}
   fi
   chown -R 568:568 /mnt/apps/apps/$appname
   ```

4. **Migrate Data:**
   ```bash
   # nzbget special case (data -> config)
   if [ "$appname" = "nzbget" ]; then
     rsync -av --progress \
       /mnt/.ix-apps/app_mounts/nzbget/data/ \
       /mnt/apps/apps/nzbget/config/
   else
     # Standard migration
     rsync -av --progress \
       /mnt/.ix-apps/app_mounts/$appname/data/ \
       /mnt/apps/apps/$appname/config/
   fi
   ```

5. **Fix Permissions**

6. **Update Compose & Redeploy**

7. **Verify:**
   - App running
   - Web UI accessible
   - Check queue/history preserved (if applicable)
   - Test download functionality

**Estimated time: ~2-3 minutes per app, ~8 minutes total**

</actions>
<verification>
```bash
# All running
for app in ytdl-sub nzbget spottarr; do
  docker ps | grep -q $app && echo "✓ $app" || echo "✗ $app"
done

# Using new paths
docker inspect dmz-ytdl-sub | grep "/mnt/apps/apps/ytdl-sub"
docker inspect dmz-nzbget | grep "/mnt/apps/apps/nzbget"
docker inspect dmz-spottarr | grep "/mnt/apps/apps/spottarr"
```
</verification>
<deliverable>
3 download/processing apps migrated

File: `.planning/phases/27-app-migration/wave3-download-complete.md`
</deliverable>
</task>

<task id="8" type="manual">
<description>Migrate Gluetun VPN (check dependencies first)</description>
<actions>
**CRITICAL: Verify dependencies before migration**

1. **Check Dependencies (from Task 2):**
   - Review dependencies.md
   - Confirm if other apps use gluetun network
   - Plan migration order accordingly

2. **If No Dependencies:**
   - Proceed with standard migration

3. **If Dependencies Exist:**
   - **Option A:** Migrate gluetun + dependent apps together
   - **Option B:** Migrate gluetun last
   - **Recommended:** Migrate together to minimize downtime

4. **Migration Procedure:**
   ```bash
   # Stop gluetun (and dependent apps if any)
   docker stop dmz-gluetun [dependent-apps]

   # Create target
   mkdir -p /mnt/apps/apps/gluetun/config
   chown -R 568:568 /mnt/apps/apps/gluetun

   # Migrate
   rsync -av --progress \
     /mnt/.ix-apps/app_mounts/gluetun/ \
     /mnt/apps/apps/gluetun/config/

   # Update compose
   # Update VPN credentials path if applicable
   # Update network configuration if needed

   # Start gluetun first
   docker start dmz-gluetun

   # Verify VPN connection
   docker logs dmz-gluetun --tail 50 | grep -i "connected\|tunnel"

   # Start dependent apps
   # Verify they can access internet through VPN
   ```

5. **Verify VPN Functionality:**
   - Check VPN connection established
   - Verify dependent apps can reach internet
   - Test IP address (should show VPN IP)
   - Check for DNS leaks

**Estimated time: ~5-10 minutes (depending on dependencies)**

</actions>
<verification>
```bash
# Gluetun running
docker ps | grep -q gluetun && echo "✓ Gluetun running" || echo "✗ Not running"

# VPN connected
docker logs dmz-gluetun --tail 50 | grep -i "connected" && echo "✓ VPN connected" || echo "⚠ Check connection"

# Using new path
docker inspect dmz-gluetun | grep -q "/mnt/apps/apps/gluetun" && echo "✓ New path" || echo "✗ Old path"

# Dependent apps working (if any)
# [Add specific checks based on dependencies]
```
</verification>
<deliverable>
Gluetun migrated with dependencies verified

File: `.planning/phases/27-app-migration/wave3-gluetun-complete.md`

Include dependency verification results
</deliverable>
</task>

## Phase 5: Wave 4 - Tdarr Media Processing

<task id="9" type="manual">
<description>Migrate Tdarr (multiple mounts, check transcode cache size)</description>
<actions>
**Tdarr has multiple mount points and potentially large temp data**

1. **Pre-Migration Analysis:**
   ```bash
   # Check all mount sizes
   du -sh /mnt/.ix-apps/app_mounts/tdarr/configs
   du -sh /mnt/.ix-apps/app_mounts/tdarr/logs
   du -sh /mnt/.ix-apps/app_mounts/tdarr/server
   du -sh /mnt/.ix-apps/app_mounts/tdarr/transcodes  # May be large!

   # Total size
   du -sh /mnt/.ix-apps/app_mounts/tdarr/

   # Check what's in transcodes
   ls -lh /mnt/.ix-apps/app_mounts/tdarr/transcodes/
   ```

2. **Decision Point:**
   - **If transcodes < 5GB:** Migrate everything
   - **If transcodes > 5GB:** Consider skipping (cache regenerates)
   - **If transcodes > 20GB:** Definitely skip, clear before migration

3. **Stop Tdarr:**
   - Stop any active transcoding jobs first
   - Then stop container

4. **Create Target Structure:**
   ```bash
   mkdir -p /mnt/apps/apps/tdarr/{configs,logs,server,transcodes}
   chown -R 568:568 /mnt/apps/apps/tdarr
   chmod -R 755 /mnt/apps/apps/tdarr
   ```

5. **Migrate Data:**
   ```bash
   # Configs (small, always migrate)
   rsync -av --progress \
     /mnt/.ix-apps/app_mounts/tdarr/configs/ \
     /mnt/apps/apps/tdarr/configs/

   # Logs (small, always migrate)
   rsync -av --progress \
     /mnt/.ix-apps/app_mounts/tdarr/logs/ \
     /mnt/apps/apps/tdarr/logs/

   # Server (database, always migrate)
   rsync -av --progress \
     /mnt/.ix-apps/app_mounts/tdarr/server/ \
     /mnt/apps/apps/tdarr/server/

   # Transcodes (decision based on size)
   # Option A: Migrate
   rsync -av --progress --stats \
     /mnt/.ix-apps/app_mounts/tdarr/transcodes/ \
     /mnt/apps/apps/tdarr/transcodes/

   # Option B: Skip (cache will regenerate)
   # Just create empty directory
   mkdir -p /mnt/apps/apps/tdarr/transcodes
   ```

6. **Fix Permissions:**
   ```bash
   chown -R 568:568 /mnt/apps/apps/tdarr/
   ```

7. **Update Docker Compose (4 volume mounts):**
   ```bash
   compose_file=$(find /mnt/.ix-apps/app_configs -name "docker-compose.yml" -path "*/tdarr/*" | sort -V | tail -1)
   cp "$compose_file" "$compose_file.backup-phase27"

   # Update all 4 paths
   sed -i 's|/mnt/\.ix-apps/app_mounts/tdarr/configs|/mnt/apps/apps/tdarr/configs|g' "$compose_file"
   sed -i 's|/mnt/\.ix-apps/app_mounts/tdarr/logs|/mnt/apps/apps/tdarr/logs|g' "$compose_file"
   sed -i 's|/mnt/\.ix-apps/app_mounts/tdarr/server|/mnt/apps/apps/tdarr/server|g' "$compose_file"
   sed -i 's|/mnt/\.ix-apps/app_mounts/tdarr/transcodes|/mnt/apps/apps/tdarr/transcodes|g' "$compose_file"

   # Verify all 4 updated
   grep -c "/mnt/apps/apps/tdarr" "$compose_file"  # Should be 4
   ```

8. **Redeploy Tdarr**

9. **Verify Functionality:**
   ```bash
   # Container running
   docker ps | grep tdarr

   # All 4 mounts present
   docker inspect ix-tdarr-tdarr-1 | grep -c "/mnt/apps/apps/tdarr"  # Should be 4

   # Check logs
   docker logs ix-tdarr-tdarr-1 --tail 100

   # Access web UI
   curl -I http://localhost:[tdarr-port]
   ```

10. **Test Tdarr:**
    - Access web UI
    - Verify library connections
    - Check transcoding queue
    - Verify settings preserved
    - Test starting a transcode job

**Estimated time: 5-15 minutes (depending on transcode cache decision)**

</actions>
<verification>
```bash
# Tdarr running
docker ps | grep -q "tdarr" && echo "✓ Running" || echo "✗ Not running"

# All 4 mounts using new path
mount_count=$(docker inspect ix-tdarr-tdarr-1 | grep -c "/mnt/apps/apps/tdarr")
[ $mount_count -eq 4 ] && echo "✓ All 4 mounts migrated" || echo "⚠ Only $mount_count mounts found"

# No errors in logs
! docker logs ix-tdarr-tdarr-1 --tail 100 | grep -i "error\|failed" && echo "✓ No errors" || echo "⚠ Check errors"

# Web UI accessible
curl -f -I -m 5 http://localhost:[port] > /dev/null 2>&1 && echo "✓ Web UI accessible" || echo "✗ Check UI"
```
</verification>
<deliverable>
Tdarr migrated with all 4 mount points

Decision documented: transcodes migrated or skipped

File: `.planning/phases/27-app-migration/wave4-tdarr-complete.md`
</deliverable>
</task>

## Phase 6: Wave 5 - E-books and Sync

<task id="10" type="manual">
<description>Migrate calibre and calibre-web (migrate together)</description>
<actions>
**Migrate calibre pair together (calibre-web depends on calibre)**

### Calibre (E-book management)
1. **Stop calibre**

2. **Create Target:**
   ```bash
   mkdir -p /mnt/apps/apps/calibre/config
   chown -R 568:568 /mnt/apps/apps/calibre
   ```

3. **Migrate:**
   ```bash
   rsync -av --progress \
     /mnt/.ix-apps/app_mounts/calibre/config/ \
     /mnt/apps/apps/calibre/config/
   ```

4. **Update Compose & Redeploy**

5. **Verify calibre working before proceeding to calibre-web**

### Calibre-Web (Web interface)
1. **Stop calibre-web**

2. **Create Target:**
   ```bash
   mkdir -p /mnt/apps/apps/calibre-web/config
   chown -R 568:568 /mnt/apps/apps/calibre-web
   ```

3. **Migrate:**
   ```bash
   rsync -av --progress \
     /mnt/.ix-apps/app_mounts/calibre-web/config/ \
     /mnt/apps/apps/calibre-web/config/
   ```

4. **Update Compose & Redeploy**

5. **Verify Integration:**
   - Access calibre-web UI
   - Verify can see calibre library
   - Test book access
   - Check metadata sync

**Estimated time: ~5 minutes total**

</actions>
<verification>
```bash
# Both running
docker ps | grep -E "calibre"

# Using new paths
docker inspect ix-calibre-calibre-1 | grep "/mnt/apps/apps/calibre"
docker inspect ix-calibre-web-calibre-web-1 | grep "/mnt/apps/apps/calibre-web"

# calibre-web can access calibre library
# (Check via web UI)
```
</verification>
<deliverable>
Calibre pair migrated with integration verified

File: `.planning/phases/27-app-migration/wave5-calibre-complete.md`
</deliverable>
</task>

<task id="11" type="manual">
<description>Migrate Syncthing</description>
<actions>
**Migrate Syncthing file synchronization**

1. **Pre-Migration:**
   ```bash
   # Check config size
   du -sh /mnt/.ix-apps/app_mounts/syncthing/config/

   # Check if actively syncing
   docker logs ix-syncthing-syncthing-1 --tail 50 | grep -i "sync"

   # Note: May want to pause syncs before migration
   ```

2. **Stop Syncthing:**
   - Pause active syncs if possible
   - Stop container

3. **Create Target:**
   ```bash
   mkdir -p /mnt/apps/apps/syncthing/config
   chown -R 568:568 /mnt/apps/apps/syncthing
   ```

4. **Migrate Config:**
   ```bash
   rsync -av --progress \
     /mnt/.ix-apps/app_mounts/syncthing/config/ \
     /mnt/apps/apps/syncthing/config/
   ```

5. **Update Compose & Redeploy**

6. **Verify:**
   - Access Syncthing web UI
   - Verify all folders configured
   - Check device connections
   - Resume syncing
   - Monitor sync status

**Estimated time: ~3 minutes**

</actions>
<verification>
```bash
# Running
docker ps | grep -q syncthing && echo "✓ Running" || echo "✗ Not running"

# New path
docker inspect ix-syncthing-syncthing-1 | grep -q "/mnt/apps/apps/syncthing" && echo "✓ New path" || echo "✗ Old path"

# Web UI accessible
curl -f -I -m 5 http://localhost:[syncthing-port] > /dev/null 2>&1 && echo "✓ UI accessible" || echo "✗ Check UI"

# Check sync status via UI
```
</verification>
<deliverable>
Syncthing migrated with sync folders verified

File: `.planning/phases/27-app-migration/wave5-complete.md`
</deliverable>
</task>

## Phase 7: Wave 6 - n8n Workflow Stack (Database Apps)

<task id="12" type="manual">
<description>Migrate n8n stack (n8n + postgres + redis as unit)</description>
<actions>
**Migrate entire n8n stack together (3 containers)**

**CRITICAL: Migrate in order - postgres first, then redis, then n8n**

### 1. Stop All n8n Containers
```bash
docker stop ix-n8n-n8n-1 ix-n8n-redis-1 ix-n8n-postgres-1
```

### 2. Create Target Structure
```bash
mkdir -p /mnt/apps/apps/n8n/{data,postgres,redis}
chown -R 568:568 /mnt/apps/apps/n8n
chmod 700 /mnt/apps/apps/n8n/postgres  # Strict permissions for postgres
```

### 3. Migrate PostgreSQL
```bash
# Backup database first
docker start ix-n8n-postgres-1
sleep 5
docker exec ix-n8n-postgres-1 pg_dump -U n8n n8n > /mnt/storage/backups/n8n-db-backup-$(date +%Y%m%d).sql
docker stop ix-n8n-postgres-1

# Migrate postgres data
rsync -av --progress \
  /mnt/.ix-apps/app_mounts/n8n/postgres_data/ \
  /mnt/apps/apps/n8n/postgres/

# Fix permissions (postgres user typically 999:999 or 70:70)
chown -R 999:999 /mnt/apps/apps/n8n/postgres
chmod 700 /mnt/apps/apps/n8n/postgres
```

### 4. Migrate Redis
```bash
rsync -av --progress \
  /mnt/.ix-apps/docker/volumes/ix-n8n_redis-data/_data/ \
  /mnt/apps/apps/n8n/redis/

chown -R 568:568 /mnt/apps/apps/n8n/redis
```

### 5. Migrate n8n Data
```bash
rsync -av --progress \
  /mnt/.ix-apps/app_mounts/n8n/data/ \
  /mnt/apps/apps/n8n/data/

chown -R 568:568 /mnt/apps/apps/n8n/data
```

### 6. Update Docker Compose (All 3 Containers)
```bash
# Find n8n compose files
compose_dir=$(find /mnt/.ix-apps/app_configs -type d -path "*/n8n/*/templates/rendered" | sort -V | tail -1)

# Backup all compose files
cp -r "$compose_dir" "$compose_dir-backup-phase27"

# Update postgres paths
sed -i 's|/mnt/\.ix-apps/app_mounts/n8n/postgres_data|/mnt/apps/apps/n8n/postgres|g' "$compose_dir"/*/docker-compose.yml
sed -i 's|/mnt/\.ix-apps/docker/volumes/.*_data|/mnt/apps/apps/n8n/postgres|g' "$compose_dir"/postgres*/docker-compose.yml

# Update redis paths
sed -i 's|/mnt/\.ix-apps/docker/volumes/ix-n8n_redis-data/_data|/mnt/apps/apps/n8n/redis|g' "$compose_dir"/redis*/docker-compose.yml

# Update n8n paths
sed -i 's|/mnt/\.ix-apps/app_mounts/n8n/data|/mnt/apps/apps/n8n/data|g' "$compose_dir"/n8n*/docker-compose.yml
```

### 7. Start in Order
```bash
# Start postgres first
docker start ix-n8n-postgres-1

# Wait for postgres ready
timeout=30
while [ $timeout -gt 0 ]; do
  if docker logs ix-n8n-postgres-1 2>&1 | grep -q "database system is ready"; then
    echo "Postgres ready"
    break
  fi
  sleep 1
  timeout=$((timeout-1))
done

# Start redis
docker start ix-n8n-redis-1
sleep 5

# Start n8n
docker start ix-n8n-n8n-1
```

### 8. Verify Database Connections
```bash
# Check postgres running
docker ps | grep n8n-postgres

# Check postgres logs
docker logs ix-n8n-postgres-1 --tail 50 | grep -i "ready\|error"

# Check n8n logs for database connection
docker logs ix-n8n-n8n-1 --tail 100 | grep -i "database\|postgres\|redis"

# Should see successful connections
```

### 9. Verify n8n Functionality
- Access n8n web UI
- Verify workflows present
- Check credentials intact
- Test executing a workflow
- Verify database persistence

**Estimated time: 10-15 minutes**

</actions>
<verification>
```bash
# All 3 containers running
docker ps | grep -c "ix-n8n" | grep -q "3" && echo "✓ All 3 running" || echo "✗ Check containers"

# Postgres using new path
docker inspect ix-n8n-postgres-1 | grep -q "/mnt/apps/apps/n8n/postgres" && echo "✓ Postgres path" || echo "✗ Check path"

# Redis using new path
docker inspect ix-n8n-redis-1 | grep -q "/mnt/apps/apps/n8n/redis" && echo "✓ Redis path" || echo "✗ Check path"

# n8n using new path
docker inspect ix-n8n-n8n-1 | grep -q "/mnt/apps/apps/n8n/data" && echo "✓ n8n path" || echo "✗ Check path"

# Database connected
docker logs ix-n8n-n8n-1 --tail 100 | grep -i "connected" && echo "✓ DB connected" || echo "⚠ Check connection"

# Web UI accessible
curl -f -I -m 5 http://localhost:[n8n-port] > /dev/null 2>&1 && echo "✓ UI accessible" || echo "✗ Check UI"
```
</verification>
<deliverable>
n8n stack (3 containers) migrated with database verified

File: `.planning/phases/27-app-migration/wave6-n8n-complete.md`

Include:
- Database connection verification
- Workflow preservation confirmation
- All 3 containers status
</deliverable>
</task>

## Phase 8: Wave 7 - Vaultwarden Stack (Database Apps)

<task id="13" type="manual">
<description>Migrate vaultwarden stack (vaultwarden + postgres as unit)</description>
<actions>
**Migrate vaultwarden password manager with postgres database**

**CRITICAL: This is password manager - extra caution required**

### 1. Pre-Migration Backup
```bash
# Backup vaultwarden data
rsync -av /mnt/.ix-apps/app_mounts/vaultwarden/ /mnt/storage/backups/vaultwarden-full-backup-$(date +%Y%m%d)/

# Backup postgres data separately
rsync -av /mnt/.ix-apps/app_mounts/vaultwarden/postgres_data/ /mnt/storage/backups/vaultwarden-postgres-backup-$(date +%Y%m%d)/

# Export database
docker exec ix-vaultwarden-postgres-1 pg_dump -U vaultwarden vaultwarden > /mnt/storage/backups/vaultwarden-db-$(date +%Y%m%d).sql
```

### 2. Stop Both Containers
```bash
docker stop ix-vaultwarden-vaultwarden-1 ix-vaultwarden-postgres-1
```

### 3. Create Target Structure
```bash
mkdir -p /mnt/apps/apps/vaultwarden/{data,postgres}
chown -R 568:568 /mnt/apps/apps/vaultwarden/data
chown -R 999:999 /mnt/apps/apps/vaultwarden/postgres
chmod 700 /mnt/apps/apps/vaultwarden/postgres
```

### 4. Migrate PostgreSQL
```bash
rsync -av --progress \
  /mnt/.ix-apps/app_mounts/vaultwarden/postgres_data/ \
  /mnt/apps/apps/vaultwarden/postgres/

chown -R 999:999 /mnt/apps/apps/vaultwarden/postgres
chmod 700 /mnt/apps/apps/vaultwarden/postgres
```

### 5. Migrate Vaultwarden Data
```bash
rsync -av --progress \
  /mnt/.ix-apps/app_mounts/vaultwarden/data/ \
  /mnt/apps/apps/vaultwarden/data/

chown -R 568:568 /mnt/apps/apps/vaultwarden/data
```

### 6. Update Docker Compose (Both Containers)
```bash
compose_dir=$(find /mnt/.ix-apps/app_configs -type d -path "*/vaultwarden/*/templates/rendered" | sort -V | tail -1)

cp -r "$compose_dir" "$compose_dir-backup-phase27"

# Update postgres paths
sed -i 's|/mnt/\.ix-apps/app_mounts/vaultwarden/postgres_data|/mnt/apps/apps/vaultwarden/postgres|g' "$compose_dir"/postgres*/docker-compose.yml

# Update vaultwarden paths
sed -i 's|/mnt/\.ix-apps/app_mounts/vaultwarden/data|/mnt/apps/apps/vaultwarden/data|g' "$compose_dir"/vaultwarden*/docker-compose.yml
```

### 7. Start in Order
```bash
# Start postgres first
docker start ix-vaultwarden-postgres-1

# Wait for postgres ready
sleep 10
docker logs ix-vaultwarden-postgres-1 --tail 20 | grep "ready to accept connections"

# Start vaultwarden
docker start ix-vaultwarden-vaultwarden-1
```

### 8. Verify Database Connection
```bash
# Check postgres running
docker ps | grep vaultwarden-postgres

# Check vaultwarden logs for database connection
docker logs ix-vaultwarden-vaultwarden-1 --tail 100 | grep -i "database\|postgres"

# Should see successful connection
```

### 9. CRITICAL: Verify Vaultwarden Functionality
- Access vaultwarden web vault
- **Test login with existing account**
- Verify all stored passwords visible
- **Test retrieving a password**
- Verify collections/folders intact
- **DO NOT proceed if any data missing**

### 10. Test Data Integrity
```bash
# Compare database size pre/post migration
docker exec ix-vaultwarden-postgres-1 psql -U vaultwarden -c "SELECT pg_size_pretty(pg_database_size('vaultwarden'));"

# Should match pre-migration size
```

**Estimated time: 10-15 minutes**

**CRITICAL: Extra verification for password manager - do not rush**

</actions>
<verification>
```bash
# Both containers running
docker ps | grep -c "vaultwarden" | grep -q "2" && echo "✓ Both running" || echo "✗ Check containers"

# Postgres using new path
docker inspect ix-vaultwarden-postgres-1 | grep -q "/mnt/apps/apps/vaultwarden/postgres" && echo "✓ Postgres path" || echo "✗ Check path"

# Vaultwarden using new path
docker inspect ix-vaultwarden-vaultwarden-1 | grep -q "/mnt/apps/apps/vaultwarden/data" && echo "✓ Vaultwarden path" || echo "✗ Check path"

# Database connected
docker logs ix-vaultwarden-vaultwarden-1 --tail 50 | grep -i "database.*connected" && echo "✓ DB connected" || echo "⚠ Check connection"

# Web vault accessible
curl -f -I -m 5 http://localhost:[vaultwarden-port] > /dev/null 2>&1 && echo "✓ Web accessible" || echo "✗ Check UI"

# MANUAL: Login and verify passwords accessible
echo "⚠ MANUAL CHECK REQUIRED: Login and verify password access"
```
</verification>
<deliverable>
Vaultwarden stack migrated with password data verified

File: `.planning/phases/27-app-migration/wave7-vaultwarden-complete.md`

**MUST include:**
- Manual login verification completed
- Password retrieval tested
- Database integrity confirmed
- Backup locations documented
</deliverable>
</task>

## Phase 9: Verification & Monitoring

<task id="14" type="auto">
<description>Comprehensive verification of all 19 migrated apps</description>
<actions>
1. **Create Verification Script:**
   ```bash
   cat > /tmp/verify-phase27-apps.sh << 'EOF'
#!/bin/bash

echo "=== Phase 27 App Migration Verification ==="
echo "Date: $(date)"
echo

apps=(
  "core-homarr"
  "core-SuggestArr"
  "core-audiobookrequest"
  "core-huntarr"
  "core-decluttarr"
  "core-whisparr"
  "dmz-ytdl-sub"
  "dmz-nzbget"
  "dmz-spottarr"
  "dmz-gluetun"
  "ix-tdarr-tdarr-1"
  "ix-calibre-calibre-1"
  "ix-calibre-web-calibre-web-1"
  "ix-syncthing-syncthing-1"
  "ix-n8n-n8n-1"
  "ix-n8n-postgres-1"
  "ix-n8n-redis-1"
  "ix-vaultwarden-vaultwarden-1"
  "ix-vaultwarden-postgres-1"
)

echo "=== Container Status ==="
for app in "${apps[@]}"; do
  if docker ps | grep -q "$app"; then
    echo "✓ $app - Running"
  else
    echo "✗ $app - NOT RUNNING"
  fi
done

echo
echo "=== Path Verification ==="
for app in "${apps[@]}"; do
  if docker inspect "$app" 2>/dev/null | grep -q "/mnt/apps/apps/"; then
    echo "✓ $app - Using /mnt/apps/apps/"
  else
    echo "✗ $app - NOT using /mnt/apps/apps/"
  fi
done

echo
echo "=== ix-apps Path Check (should be none) ==="
for app in "${apps[@]}"; do
  if docker inspect "$app" 2>/dev/null | grep -q "/mnt/.ix-apps/"; then
    echo "⚠ $app - Still has ix-apps mount!"
  fi
done

echo
echo "=== Recent Errors in Logs ==="
for app in "${apps[@]}"; do
  errors=$(docker logs "$app" --since 1h --tail 50 2>/dev/null | grep -i "error\|fatal\|critical" | head -3)
  if [ -n "$errors" ]; then
    echo "⚠ $app has errors:"
    echo "$errors"
  fi
done

echo
echo "=== Directory Sizes ==="
du -sh /mnt/apps/apps/*/ | grep -E "homarr|suggestarr|audiobookrequest|huntarr|decluttarr|whisparr|ytdl-sub|nzbget|spottarr|gluetun|tdarr|calibre|syncthing|n8n|vaultwarden"

echo
echo "=== Verification Complete ==="
EOF

   chmod +x /tmp/verify-phase27-apps.sh
   ```

2. **Run Comprehensive Verification:**
   ```bash
   /tmp/verify-phase27-apps.sh | tee .planning/phases/27-app-migration/verification-$(date +%Y%m%d-%H%M).txt
   ```

3. **Manual Verification Checklist:**
   - [ ] All 19 apps showing as running
   - [ ] All 19 apps using /mnt/apps/apps/ paths
   - [ ] No apps still using ix-apps paths
   - [ ] No critical errors in recent logs
   - [ ] All web UIs accessible (spot check)

4. **Functional Testing:**
   - [ ] Homarr dashboard displays servarr apps
   - [ ] Servarr apps can communicate
   - [ ] Download clients functional
   - [ ] Gluetun VPN connected (if applicable)
   - [ ] Tdarr can access media library
   - [ ] Calibre-web can access calibre
   - [ ] Syncthing syncing properly
   - [ ] n8n workflows execute
   - [ ] Vaultwarden login works

5. **Dependency Verification:**
   - [ ] Gluetun VPN dependencies working
   - [ ] n8n postgres/redis connections
   - [ ] Vaultwarden postgres connection
   - [ ] Calibre/calibre-web integration

6. **Create Verification Report:**
   ```bash
   cat > .planning/phases/27-app-migration/VERIFICATION-REPORT.md << 'EOF'
# Phase 27 Migration Verification Report

**Date:** $(date)
**Apps Migrated:** 19

## Summary
- All 19 apps running: [YES/NO]
- All using new paths: [YES/NO]
- No ix-apps remnants: [YES/NO]
- All functional tests passed: [YES/NO]

## Container Status
[Paste output from verification script]

## Functional Testing
[Results of manual functional tests]

## Issues Found
[List any issues or concerns]

## Conclusion
[Migration successful / Issues need addressing]
EOF
   ```

</actions>
<verification>
```bash
# All 19 apps running
app_count=$(docker ps | grep -cE "homarr|suggestarr|audiobookrequest|huntarr|decluttarr|whisparr|ytdl-sub|nzbget|spottarr|gluetun|tdarr|calibre|syncthing|n8n|vaultwarden")
[ $app_count -eq 19 ] && echo "✓ All 19 running" || echo "✗ Only $app_count running"

# All using new paths
new_path_count=0
for app in homarr suggestarr audiobookrequest huntarr decluttarr whisparr ytdl-sub nzbget spottarr gluetun tdarr calibre syncthing n8n vaultwarden; do
  docker inspect $app 2>/dev/null | grep -q "/mnt/apps/apps/" && new_path_count=$((new_path_count+1))
done
[ $new_path_count -eq 19 ] && echo "✓ All using new paths" || echo "⚠ Only $new_path_count using new paths"

# No ix-apps remnants
! docker inspect $(docker ps -q) 2>/dev/null | grep -q "/mnt/.ix-apps/app_mounts/" && echo "✓ No ix-apps mounts" || echo "⚠ Some ix-apps mounts remain"
```
</verification>
<deliverable>
File: `.planning/phases/27-app-migration/VERIFICATION-REPORT.md`

Comprehensive verification of all 19 apps with:
- Container status
- Path verification
- Functional testing results
- Dependency verification
- Any issues found
</deliverable>
</task>

<task id="15" type="manual">
<description>7-day monitoring period with daily checks</description>
<actions>
**Monitor all 19 apps for 7 days before cleanup (following Phase 26 pattern)**

1. **Create Daily Monitoring Script:**
   ```bash
   cat > /mnt/apps/scripts/phase27-daily-check.sh << 'EOF'
#!/bin/bash
echo "=== Phase 27 Daily Check - $(date) ===" | tee -a /mnt/storage/backups/phase27-monitoring.log

# Quick health check
docker ps | grep -cE "homarr|suggestarr|audiobookrequest|huntarr|decluttarr|whisparr|ytdl-sub|nzbget|spottarr|gluetun|tdarr|calibre|syncthing|n8n|vaultwarden" | tee -a /mnt/storage/backups/phase27-monitoring.log

# Check for errors in last 24h
echo "Recent errors:" | tee -a /mnt/storage/backups/phase27-monitoring.log
for app in homarr suggestarr audiobookrequest huntarr decluttarr whisparr ytdl-sub nzbget spottarr gluetun ix-tdarr-tdarr-1 ix-calibre-calibre-1 ix-calibre-web-calibre-web-1 ix-syncthing-syncthing-1 ix-n8n-n8n-1 ix-n8n-postgres-1 ix-n8n-redis-1 ix-vaultwarden-vaultwarden-1 ix-vaultwarden-postgres-1; do
  error_count=$(docker logs $app --since 24h 2>/dev/null | grep -ci "error\|fatal")
  if [ $error_count -gt 0 ]; then
    echo "$app: $error_count errors" | tee -a /mnt/storage/backups/phase27-monitoring.log
  fi
done

echo "---" | tee -a /mnt/storage/backups/phase27-monitoring.log
EOF

   chmod +x /mnt/apps/scripts/phase27-daily-check.sh
   ```

2. **Daily Checklist (for 7 days):**
   ```markdown
   ## Day X/7 - $(date +%Y-%m-%d)

   - [ ] All 19 containers running
   - [ ] No critical errors in logs (run daily script)
   - [ ] Web UIs accessible (spot check 3-5 apps)
   - [ ] Key functionality working:
     - [ ] Servarr apps can search/download
     - [ ] Download clients active
     - [ ] n8n workflows executing
     - [ ] Vaultwarden accessible
   - [ ] No user complaints
   - [ ] Disk space adequate

   ### Issues Found:
   [None / List issues]

   ### Actions Taken:
   [None / List actions]
   ```

3. **Run Daily:**
   ```bash
   /mnt/apps/scripts/phase27-daily-check.sh
   ```

4. **Monitor Specific Apps:**
   - **Vaultwarden:** Daily login test
   - **n8n:** Check workflow execution
   - **Gluetun:** Verify VPN connection
   - **Database apps:** Check database logs

5. **Track in Monitoring Log:**
   - Create `.planning/phases/27-app-migration/7DAY-MONITORING.md`
   - Document each day's check
   - Note any issues or anomalies
   - Track resolution of any problems

**Rollback Criteria (if critical issue persists >24 hours):**
1. Identify failing app
2. Stop app
3. Revert docker-compose paths to ix-apps
4. Restart app
5. Document failure reason
6. Plan remediation

</actions>
<verification>
Manual daily checklist completion for 7 consecutive days
</verification>
<deliverable>
File: `.planning/phases/27-app-migration/7DAY-MONITORING.md`

7 days of monitoring data showing:
- Daily app status
- Any errors encountered
- Resolutions applied
- System stability confirmation
</deliverable>
</task>

<task id="16" type="auto">
<description>Cleanup old ix-apps data after 7-day verification</description>
<actions>
**CRITICAL: Only after 7 days of verified stable operation**

1. **Final Verification Before Cleanup:**
   ```bash
   # Ensure ALL 19 apps using new paths
   /tmp/verify-phase27-apps.sh

   # Ensure NO apps using old paths
   docker inspect $(docker ps -q) | grep -c "/mnt/.ix-apps/app_mounts/"
   # Should be 0 (or only komga/searxng temp mounts from audit)

   # Verify all apps running
   docker ps | grep -cE "homarr|suggestarr|audiobookrequest|huntarr|decluttarr|whisparr|ytdl-sub|nzbget|spottarr|gluetun|tdarr|calibre|syncthing|n8n|vaultwarden"
   # Should be 19
   ```

2. **Create Deletion Manifest:**
   ```bash
   cleanup_date=$(date +%Y%m%d)

   echo "=== Phase 27 ix-apps Cleanup Manifest ===" > .planning/phases/27-app-migration/CLEANUP-MANIFEST.txt
   echo "Date: $(date)" >> .planning/phases/27-app-migration/CLEANUP-MANIFEST.txt
   echo >> .planning/phases/27-app-migration/CLEANUP-MANIFEST.txt

   echo "Directories to be removed:" >> .planning/phases/27-app-migration/CLEANUP-MANIFEST.txt

   # List all Phase 27 app directories
   for app in homarr suggestarr audiobookrequest huntarr decluttarr whisparr ytdl-sub nzbget spottarr gluetun tdarr calibre calibre-web syncthing n8n vaultwarden; do
     app_path=$(find /mnt/.ix-apps/app_mounts -name "$app" -type d 2>/dev/null)
     if [ -n "$app_path" ]; then
       size=$(du -sh "$app_path" 2>/dev/null | cut -f1)
       echo "- $app_path ($size)" >> .planning/phases/27-app-migration/CLEANUP-MANIFEST.txt
     fi
   done

   # Special: homarr app_configs path
   echo "- /mnt/.ix-apps/app_configs/servarr/versions/1.0.0/templates/rendered/homarr/" >> .planning/phases/27-app-migration/CLEANUP-MANIFEST.txt

   # Calculate total size
   echo >> .planning/phases/27-app-migration/CLEANUP-MANIFEST.txt
   echo "Total size to be freed: $(du -sh /mnt/.ix-apps/app_mounts/{homarr,suggestarr,audiobookrequest,huntarr,decluttarr,whisparr,ytdl-sub,nzbget,spottarr,gluetun,tdarr,calibre,calibre-web,syncthing,n8n,vaultwarden} 2>/dev/null | awk '{sum+=$1} END {print sum}')" >> .planning/phases/27-app-migration/CLEANUP-MANIFEST.txt
   ```

3. **Soft Delete (Rename First - Safer):**
   ```bash
   # Rename each app directory instead of deleting
   rename_suffix="-DELETED-phase27-$cleanup_date"

   for app in suggestarr audiobookrequest huntarr decluttarr whisparr ytdl-sub nzbget spottarr gluetun tdarr calibre calibre-web syncthing n8n vaultwarden; do
     app_path="/mnt/.ix-apps/app_mounts/$app"
     if [ -d "$app_path" ]; then
       mv "$app_path" "${app_path}${rename_suffix}"
       echo "Renamed: $app_path"
     fi
   done

   # Special: homarr app_configs
   homarr_path="/mnt/.ix-apps/app_configs/servarr/versions/1.0.0/templates/rendered/homarr"
   if [ -d "$homarr_path" ]; then
     mv "$homarr_path" "${homarr_path}${rename_suffix}"
     echo "Renamed: $homarr_path"
   fi
   ```

4. **Monitor for 24 Hours After Rename:**
   ```bash
   # Run verification script
   /tmp/verify-phase27-apps.sh

   # Check for any errors about missing paths
   for app in homarr suggestarr audiobookrequest huntarr decluttarr whisparr ytdl-sub nzbget spottarr gluetun ix-tdarr-tdarr-1 ix-calibre-calibre-1 ix-calibre-web-calibre-web-1 ix-syncthing-syncthing-1 ix-n8n-n8n-1 ix-vaultwarden-vaultwarden-1; do
     docker logs $app --since 1h | grep -i "no such file\|not found\|missing"
   done
   ```

5. **Hard Delete After 24 Hours (if no issues):**
   ```bash
   # Only if 24 hour verification passes

   for app in suggestarr audiobookrequest huntarr decluttarr whisparr ytdl-sub nzbget spottarr gluetun tdarr calibre calibre-web syncthing n8n vaultwarden; do
     deleted_path="/mnt/.ix-apps/app_mounts/${app}${rename_suffix}"
     if [ -d "$deleted_path" ]; then
       rm -rf "$deleted_path"
       echo "Deleted: $deleted_path"
     fi
   done

   # homarr
   deleted_homarr="/mnt/.ix-apps/app_configs/servarr/versions/1.0.0/templates/rendered/homarr${rename_suffix}"
   if [ -d "$deleted_homarr" ]; then
     rm -rf "$deleted_homarr"
     echo "Deleted: $deleted_homarr"
   fi
   ```

6. **Verify Cleanup:**
   ```bash
   # Should not find Phase 27 apps in ix-apps anymore
   for app in homarr suggestarr audiobookrequest huntarr decluttarr whisparr ytdl-sub nzbget spottarr gluetun tdarr calibre calibre-web syncthing n8n vaultwarden; do
     if [ -d "/mnt/.ix-apps/app_mounts/$app" ]; then
       echo "WARNING: $app still exists in ix-apps!"
     fi
   done
   ```

7. **Reclaim Space:**
   ```bash
   # Check space freed
   df -h /mnt/.ix-apps/

   # Document in cleanup report
   echo "Space reclaimed: [X GB]" >> .planning/phases/27-app-migration/CLEANUP-MANIFEST.txt
   ```

**Safety Measures:**
- Keep Phase 27 backup for 30 days minimum
- Rename before delete (easy to undo if issues)
- Wait 24 hours between rename and delete
- Monitor logs for missing file errors
- Document everything removed

</actions>
<verification>
```bash
# Phase 27 apps removed from ix-apps
! ls -d /mnt/.ix-apps/app_mounts/{homarr,suggestarr,audiobookrequest,huntarr,decluttarr,whisparr,ytdl-sub,nzbget,spottarr,gluetun,tdarr,calibre,calibre-web,syncthing,n8n,vaultwarden} 2>/dev/null && echo "✓ Cleanup complete" || echo "⚠ Some remain"

# All apps still running
docker ps | grep -cE "homarr|suggestarr|audiobookrequest|huntarr|decluttarr|whisparr|ytdl-sub|nzbget|spottarr|gluetun|tdarr|calibre|syncthing|n8n|vaultwarden" | grep -q "19" && echo "✓ All running" || echo "✗ Check containers"

# No apps using old paths
! docker inspect $(docker ps -q) | grep "/mnt/.ix-apps/app_mounts/\(homarr\|suggestarr\|audiobookrequest\|huntarr\|decluttarr\|whisparr\|ytdl-sub\|nzbget\|spottarr\|gluetun\|tdarr\|calibre\|syncthing\|n8n\|vaultwarden\)" && echo "✓ No old paths" || echo "⚠ Old paths detected"
```
</verification>
<deliverable>
Old ix-apps data cleaned up for Phase 27 apps

Space reclaimed and documented

File: `.planning/phases/27-app-migration/CLEANUP-MANIFEST.txt`
</deliverable>
</task>

## Phase 10: Documentation & Completion

<task id="17" type="manual">
<description>Create comprehensive Phase 27 summary and update documentation</description>
<actions>
1. **Create Phase 27 Summary:**
   ```markdown
   File: `.planning/phases/27-app-migration/SUMMARY.md`

   # Phase 27: App Migration Summary

   **Completion Date:** [date]
   **Apps Migrated:** 19
   **Migration Success Rate:** [X%]
   **Total Time:** [X hours hands-on, Y days calendar]

   ## Apps Migrated
   ### Wave 1: Homarr (1 app)
   - core-homarr (special app_configs path)

   ### Wave 2: Servarr Apps (5 apps)
   - core-SuggestArr
   - core-audiobookrequest
   - core-huntarr
   - core-decluttarr
   - core-whisparr

   ### Wave 3: Download/Processing (4 apps)
   - dmz-ytdl-sub
   - dmz-nzbget
   - dmz-spottarr
   - dmz-gluetun

   ### Wave 4: Media Processing (1 app)
   - ix-tdarr-tdarr-1

   ### Wave 5: E-books and Sync (3 apps)
   - ix-calibre-calibre-1
   - ix-calibre-web-calibre-web-1
   - ix-syncthing-syncthing-1

   ### Wave 6: n8n Stack (3 apps)
   - ix-n8n-n8n-1
   - ix-n8n-postgres-1
   - ix-n8n-redis-1

   ### Wave 7: Vaultwarden Stack (2 apps)
   - ix-vaultwarden-vaultwarden-1
   - ix-vaultwarden-postgres-1

   ## Migration Statistics
   - Simple apps (config only): [X] apps, avg [Y] minutes each
   - Multi-mount apps: [X] apps, avg [Y] minutes each
   - Database stack apps: [X] apps, avg [Y] minutes each
   - Special cases (homarr): 1 app, [Y] minutes

   ## Issues Encountered
   [List any issues and resolutions]

   ## Lessons Learned
   1. [Lesson 1]
   2. [Lesson 2]
   ...

   ## Overall Migration Status
   **Total Apps on System:** 65
   **Using /mnt/apps/apps/:** 55 (36 from previous + 19 from Phase 27)
   **Remaining in ix-apps:** 0 (100% migration complete!)
   **Mixed paths:** 2 (temp/cache only - acceptable)
   **No persistent storage:** 8 (stateless - no migration needed)

   ## Next Steps
   - Phase 26+27 complete - all migratable apps migrated
   - Optional: Clean up mixed paths (komga, searxng temp mounts)
   - Future: Begin k3s migration planning
   ```

2. **Update Overall Migration Documentation:**
   - Update combined inventory of all apps
   - Document final structure at `/mnt/apps/apps/`
   - Create quick reference for all app locations

3. **Create Maintenance Runbook Updates:**
   - Add Phase 27 apps to backup procedures
   - Document special cases (homarr, gluetun, database apps)
   - Update restore procedures

4. **Document Special Patterns Discovered:**
   - Homarr app_configs path pattern
   - Gluetun VPN dependencies handling
   - Database stack migration (n8n, vaultwarden)
   - Tdarr multi-mount handling

5. **Create Quick Reference:**
   ```markdown
   # Phase 27 Apps - Quick Reference

   ## Servarr Ecosystem Extensions
   - homarr: /mnt/apps/apps/homarr/config (dashboard)
   - suggestarr: /mnt/apps/apps/suggestarr/config
   - audiobookrequest: /mnt/apps/apps/audiobookrequest/config
   - huntarr: /mnt/apps/apps/huntarr/config
   - decluttarr: /mnt/apps/apps/decluttarr/config
   - whisparr: /mnt/apps/apps/whisparr/{config,data}

   ## Download/Processing
   - ytdl-sub: /mnt/apps/apps/ytdl-sub/config
   - nzbget: /mnt/apps/apps/nzbget/config
   - spottarr: /mnt/apps/apps/spottarr/config
   - gluetun: /mnt/apps/apps/gluetun/config (VPN)

   ## Media Processing
   - tdarr: /mnt/apps/apps/tdarr/{configs,logs,server,transcodes}

   ## E-books and Sync
   - calibre: /mnt/apps/apps/calibre/config
   - calibre-web: /mnt/apps/apps/calibre-web/config
   - syncthing: /mnt/apps/apps/syncthing/config

   ## Workflow/Password (with databases)
   - n8n: /mnt/apps/apps/n8n/{data,postgres,redis}
   - vaultwarden: /mnt/apps/apps/vaultwarden/{data,postgres}
   ```

</actions>
<verification>
Manual review of documentation completeness and accuracy
</verification>
<deliverable>
Files:
- `.planning/phases/27-app-migration/SUMMARY.md`
- `.planning/phases/27-app-migration/QUICK-REFERENCE.md`
- Updated overall app inventory
- Updated maintenance runbooks

Complete documentation package for Phase 27
</deliverable>
</task>

</tasks>

<success_criteria>

## Technical Success Criteria

### All 19 Apps Migrated
- [ ] All 19 apps running from /mnt/apps/apps/
- [ ] No apps using ix-apps paths (except temp/cache acceptable)
- [ ] All apps accessible via web UI
- [ ] All databases intact and functional (n8n, vaultwarden)

### Data Integrity
- [ ] All app configurations preserved
- [ ] All databases intact (postgres for n8n, vaultwarden)
- [ ] All user data preserved (passwords, workflows, e-books, etc.)
- [ ] All integrations working (calibre↔calibre-web, gluetun dependencies)
- [ ] No data loss during migration

### Structure Compliance
- [ ] Consistent directory structure: appname/{config,data,postgres,redis}
- [ ] Correct permissions on all directories
- [ ] Correct ownership (568:568 for apps, 999:999 for postgres)
- [ ] PostgreSQL directories have strict permissions (700)

### Functionality Verified

**Servarr Ecosystem (6 apps):**
- [ ] Homarr dashboard displays all servarr apps
- [ ] SuggestArr functional
- [ ] Audiobookrequest functional
- [ ] Huntarr functional
- [ ] Decluttarr functional
- [ ] Whisparr can search and manage content

**Download/Processing (4 apps):**
- [ ] ytdl-sub can download videos
- [ ] nzbget can download usenet content
- [ ] spottarr can download music
- [ ] Gluetun VPN connected and routing correctly

**Media Processing (1 app):**
- [ ] Tdarr can access media library
- [ ] Tdarr transcoding functional
- [ ] All 4 mounts working (configs, logs, server, transcodes)

**E-books and Sync (3 apps):**
- [ ] Calibre manages e-books
- [ ] Calibre-web accesses calibre library
- [ ] Syncthing syncing files

**Workflow/Password (5 apps):**
- [ ] n8n workflows execute
- [ ] n8n postgres connected
- [ ] n8n redis connected
- [ ] Vaultwarden login works
- [ ] Vaultwarden postgres connected

### Integration Verified
- [ ] Homarr ↔ All servarr apps
- [ ] Calibre ↔ Calibre-web
- [ ] Gluetun ↔ Dependent apps (if any)
- [ ] n8n ↔ postgres + redis
- [ ] Vaultwarden ↔ postgres

### Special Cases Handled
- [ ] Homarr app_configs path migrated successfully
- [ ] Gluetun dependencies managed correctly
- [ ] Tdarr multi-mount migration complete
- [ ] n8n stack (3 containers) working together
- [ ] Vaultwarden stack (2 containers) working together

### Cleanup Complete
- [ ] Old ix-apps data removed for all 19 apps
- [ ] Space reclaimed
- [ ] No references to ix-apps in Phase 27 app configs
- [ ] Backup retained for 30 days

### Documentation Complete
- [ ] Migration log documenting all changes
- [ ] Special cases documented (homarr, gluetun, databases)
- [ ] Dependency handling documented
- [ ] Quick reference created
- [ ] Lessons learned captured

## Operational Success Criteria

### Stability
- [ ] 7 days of stable operation post-migration
- [ ] No critical errors in logs
- [ ] No user-reported issues
- [ ] Performance equivalent to pre-migration

### Combined Phases 26+27 Achievement
- [ ] **100% migration coverage** - All migratable apps in /mnt/apps/apps/
- [ ] **55 apps total** (36 previous + 19 from Phase 27)
- [ ] **0 apps in ix-apps** (excluding acceptable temp/cache)
- [ ] **Clean, consistent structure** across all apps

### Preparedness for k3s
- [ ] Clean, modular structure ready for k3s PVs
- [ ] All app dependencies documented
- [ ] Database types and connections known
- [ ] Volume mount requirements clear

### Backup Strategy
- [ ] Pre-migration backups preserved
- [ ] Phase 27 backup retained (30 days)
- [ ] Restore procedures tested
- [ ] All critical apps backed up (especially vaultwarden)

### Knowledge Transfer
- [ ] Complete documentation for future maintainers
- [ ] Special case patterns documented
- [ ] Migration runbook updated with new patterns
- [ ] Common issues and solutions documented

</success_criteria>

<effort_estimate>

## Time Estimates per Wave

Based on Phase 26 experience (9 apps in 5 minutes) and accounting for special cases:

### Wave 1: Homarr Special Case
- **Apps:** 1
- **Time:** 15-20 minutes (special path requires extra care)

### Wave 2: Simple Servarr Apps
- **Apps:** 5
- **Time:** 10-15 minutes (2-3 min each, proven fast from Phase 26)

### Wave 3: Download/Processing
- **Apps:** 4
- **Time:** 15-20 minutes (gluetun needs dependency check)

### Wave 4: Tdarr
- **Apps:** 1
- **Time:** 10-15 minutes (4 mounts, may skip large transcode cache)

### Wave 5: E-books and Sync
- **Apps:** 3
- **Time:** 10-15 minutes (calibre pair + syncthing)

### Wave 6: n8n Stack
- **Apps:** 3 (migrate together)
- **Time:** 15-20 minutes (database stack, careful migration)

### Wave 7: Vaultwarden Stack
- **Apps:** 2 (migrate together)
- **Time:** 15-20 minutes (password manager, extra verification)

### Verification & Cleanup
- Comprehensive verification: 30 minutes
- 7-day monitoring: 1 hour distributed (15 min/day)
- Cleanup: 30 minutes
- Documentation: 1-2 hours

## Overall Estimate

**Total Apps:** 19
**Total Hands-On Time:** 2.5-3.5 hours
**Calendar Time (including 7-day monitoring):** 8-9 days

**Recommended Schedule:**

**Day 1: Discovery & Waves 1-3 (1.5 hours)**
- Task 1-3: Discovery, dependencies, backup (30 min)
- Wave 1: Homarr (15 min)
- Wave 2: Servarr apps (15 min)
- Wave 3: Download/processing (20 min)
- Verify and test (10 min)

**Day 2: Waves 4-5 (45 minutes)**
- Wave 4: Tdarr (15 min)
- Wave 5: E-books and sync (15 min)
- Verify and test (15 min)

**Day 3: Waves 6-7 (1 hour)**
- Wave 6: n8n stack (20 min)
- Wave 7: Vaultwarden stack (20 min)
- Comprehensive verification (20 min)

**Days 4-10: Monitoring (passive)**
- Daily checks (5-10 min/day)
- Monitor logs
- Track any issues

**Day 11: Cleanup & Documentation (1.5 hours)**
- Cleanup old ix-apps data (30 min)
- Create comprehensive documentation (1 hour)

## Comparison to Phase 26

Phase 26: 9 apps in 5 minutes (33 seconds per app average)
Phase 27: 19 apps in ~3 hours (9.5 minutes per app average)

**Why longer per app?**
- Special cases (homarr app_configs path, gluetun VPN, databases)
- Multi-mount apps (tdarr with 4 mounts)
- Database stacks (n8n 3 containers, vaultwarden 2 containers)
- Extra verification (password manager, workflow automation)

**Still Very Efficient:**
- Most simple apps still ~2-3 minutes each
- Special cases get needed attention
- Database apps get proper verification
- Overall very manageable timeline

</effort_estimate>

---

## Appendix A: Special Case Patterns

### Pattern 1: app_configs Path (Homarr)

**Problem:** App uses `/mnt/.ix-apps/app_configs/[name]/versions/[ver]/templates/rendered/[app]/appdata` instead of standard `app_mounts`

**Solution:**
```bash
# Source is in app_configs, not app_mounts
source="/mnt/.ix-apps/app_configs/servarr/versions/1.0.0/templates/rendered/homarr/appdata"
target="/mnt/apps/apps/homarr/config"

rsync -av "$source/" "$target/"
```

**Note:** If other apps use this pattern, follow same procedure

---

### Pattern 2: VPN Container Dependencies (Gluetun)

**Problem:** Other containers may route traffic through gluetun VPN

**Detection:**
```bash
# Check network mode
docker inspect [container] --format '{{.HostConfig.NetworkMode}}'
# If contains "container:gluetun" or similar, it's dependent

# Check for gluetun network
docker network inspect gluetun 2>/dev/null
```

**Solution Options:**
1. **No dependencies:** Migrate gluetun independently
2. **Has dependencies:** Migrate gluetun + dependent apps together
3. **Critical dependencies:** Migrate gluetun last

---

### Pattern 3: Multi-Mount Apps (Tdarr)

**Problem:** App has multiple distinct mount points (configs, logs, server, transcodes)

**Solution:**
```bash
# Create all subdirectories
mkdir -p /mnt/apps/apps/tdarr/{configs,logs,server,transcodes}

# Migrate each separately
rsync -av /mnt/.ix-apps/app_mounts/tdarr/configs/ /mnt/apps/apps/tdarr/configs/
rsync -av /mnt/.ix-apps/app_mounts/tdarr/logs/ /mnt/apps/apps/tdarr/logs/
rsync -av /mnt/.ix-apps/app_mounts/tdarr/server/ /mnt/apps/apps/tdarr/server/

# Transcodes: decision based on size
du -sh /mnt/.ix-apps/app_mounts/tdarr/transcodes/
# If >5GB, consider skipping (cache regenerates)

# Update compose: all paths must be updated
sed -i 's|/mnt/\.ix-apps/app_mounts/tdarr/configs|/mnt/apps/apps/tdarr/configs|g' "$compose_file"
# Repeat for logs, server, transcodes
```

---

### Pattern 4: Database Stacks (n8n, Vaultwarden)

**Problem:** App has postgres and/or redis dependencies that must migrate together

**Migration Order:**
1. Stop all containers in stack
2. Backup databases
3. Migrate postgres first
4. Migrate redis (if applicable)
5. Migrate main app last
6. Start postgres first (wait for ready)
7. Start redis (if applicable)
8. Start main app last
9. Verify database connections

**PostgreSQL Specific:**
```bash
# Permissions critical
chown -R 999:999 /mnt/apps/apps/[app]/postgres
chmod 700 /mnt/apps/apps/[app]/postgres

# Wait for ready before starting dependent app
docker logs [postgres] --tail 20 | grep "ready to accept connections"
```

**Verification:**
```bash
# Check postgres connection from main app
docker logs [main-app] --tail 100 | grep -i "database\|postgres"

# Should see: "Connected to database" or similar
```

---

### Pattern 5: Docker Volume Paths (Hash Paths)

**Problem:** Some apps use docker volume paths like `/mnt/.ix-apps/docker/volumes/[long-hash]/_data`

**Identification:**
```bash
# These are typically temp/cache directories
docker inspect [container] | grep "docker/volumes"
```

**Solution:**
1. **Temp/cache directories:** Can often skip migration (regenerates)
2. **Important data:** Create equivalent in /mnt/apps/apps/[app]/
3. **Decision:** Check what's in there, determine if needed

**Example:**
```bash
# n8n npm cache - can skip
/mnt/.ix-apps/docker/volumes/ix-n8n_tmp-n8n-npm-cache/_data

# If migrating:
mkdir -p /mnt/apps/apps/n8n/cache
rsync -av [source]/ /mnt/apps/apps/n8n/cache/
```

---

## Appendix B: Rollback Procedures

### Simple App Rollback
```bash
# 1. Stop app
docker stop [app-name]

# 2. Restore compose file
cp /mnt/.ix-apps/app_configs/[...]/docker-compose.yml.backup-phase27 \
   /mnt/.ix-apps/app_configs/[...]/docker-compose.yml

# 3. Redeploy
# TrueNAS UI → Apps → [app] → Edit → Save

# 4. Start app
docker start [app-name]

# 5. Verify using old path
docker inspect [app-name] | grep "ix-apps"
```

### Database App Rollback
```bash
# 1. Stop main app and database
docker stop [app-name] [app-postgres]

# 2. Restore from backup
rm -rf /mnt/apps/apps/[app]/postgres
rsync -av /mnt/storage/backups/phase27-app-migration-*/[app]/postgres_data/ \
          /mnt/apps/apps/[app]/postgres/

# OR: Revert to ix-apps path in compose file

# 3. Restore compose
cp [compose-file].backup-phase27 [compose-file]

# 4. Start database first
docker start [app-postgres]
# Wait for ready

# 5. Start main app
docker start [app-name]
```

### Full Phase Rollback (Emergency)
```bash
# If entire phase needs rollback:

# 1. Stop all Phase 27 apps
docker stop [all 19 apps]

# 2. Restore all compose files from backups
find /mnt/.ix-apps/app_configs -name "docker-compose.yml.backup-phase27" | while read backup; do
  original="${backup%.backup-phase27}"
  cp "$backup" "$original"
done

# 3. Restart all apps
docker start [all 19 apps]

# 4. Verify using old paths
# Apps should be using ix-apps paths again

# 5. Investigate root cause before retrying migration
```

---

## Appendix C: Common Issues & Solutions

### Issue: Permission Denied After Migration

**Symptoms:**
```
Error: Permission denied: /config
Cannot write to /data
```

**Solution:**
```bash
# Fix ownership
chown -R 568:568 /mnt/apps/apps/[app]/

# For postgres directories
chown -R 999:999 /mnt/apps/apps/[app]/postgres
chmod 700 /mnt/apps/apps/[app]/postgres

# Restart app
docker restart [app]
```

---

### Issue: Database Connection Failed

**Symptoms:**
```
Failed to connect to database
Connection refused: postgres:5432
```

**Solution:**
```bash
# 1. Check postgres running
docker ps | grep postgres

# 2. Check postgres logs
docker logs [app-postgres] --tail 50

# 3. Verify postgres ready
docker logs [app-postgres] | grep "ready to accept connections"

# 4. Check main app can reach postgres
docker exec [main-app] ping postgres

# 5. Restart in order
docker restart [app-postgres]
# Wait 10 seconds
docker restart [main-app]
```

---

### Issue: App Uses Old Path After Update

**Symptoms:**
```
docker inspect shows /mnt/.ix-apps/ still
App not using new config
```

**Solution:**
```bash
# 1. Verify compose file updated
grep "mnt/apps/apps" [compose-file]

# 2. Completely stop app (not just restart)
docker stop [app]
sleep 5

# 3. Remove container (keeps data)
docker rm [app]

# 4. Redeploy from compose
docker-compose -f [compose-file] up -d

# 5. Verify new path
docker inspect [app] | grep "mnt/apps/apps"
```

---

### Issue: Vaultwarden Passwords Not Accessible

**Symptoms:**
```
Cannot login to vaultwarden
Passwords missing
Database error
```

**Solution (CRITICAL - DO NOT DELETE DATA):**
```bash
# 1. STOP - Do not proceed with cleanup
docker stop ix-vaultwarden-vaultwarden-1

# 2. Restore from backup IMMEDIATELY
rsync -av /mnt/storage/backups/phase27-app-migration-*/vaultwarden/ \
          /mnt/apps/apps/vaultwarden/

# 3. Fix permissions
chown -R 568:568 /mnt/apps/apps/vaultwarden/data
chown -R 999:999 /mnt/apps/apps/vaultwarden/postgres
chmod 700 /mnt/apps/apps/vaultwarden/postgres

# 4. Restart postgres first
docker start ix-vaultwarden-postgres-1
sleep 10

# 5. Start vaultwarden
docker start ix-vaultwarden-vaultwarden-1

# 6. Test login BEFORE proceeding
# Access web vault
# Login with master password
# Verify passwords accessible

# 7. If still fails, ROLLBACK to ix-apps paths
```

---

**End of Phase 27 Plan**

This plan provides a comprehensive, detailed migration strategy for the remaining 19 TrueNAS apps, building on Phase 26's proven success while addressing special cases and complexities unique to these applications.
