# Plan 09-02: Fix hw-vm Role and Enable Ly for VMs

## Objective

Fix the hw-vm role to:
1. Move unconditional imports inside mkIf block or remove them
2. Add display manager (Ly) support for VMs that need GUI
3. Ensure griefling has a way to launch Hyprland

## Context

@roles/hw-vm.nix - Current VM role with unconditional import of modules/apps/cli
@roles/hw-desktop.nix - Desktop role with Ly enabled by default
@modules/services/display-manager/ly.nix - Ly display manager module
@hosts/griefling/default.nix - Griefling host config

## Problem Analysis

Current hw-vm.nix (line 22-24):
```nix
imports = [
  ../modules/apps/cli  # Always imported, outside mkIf
];

config = lib.mkIf cfg.vm {  # Config is conditional
  ...
```

This means modules/apps/cli is imported for ALL hosts (because roles/default.nix imports hw-vm.nix unconditionally).

Additionally:
- hw-vm enables `myModules.desktop.hyprland.enable = true` but no display manager
- Without Ly or another greeter, there's no way to launch Hyprland

## Tasks

### Task 1: Remove unconditional import from hw-vm.nix

- **Type**: refactor
- **Files**: roles/hw-vm.nix
- **Action**:
  1. Remove `imports = [ ../modules/apps/cli ];` from outside config block
  2. If CLI tools are needed for VM role, enable them via option: `myModules.apps.cli.tools.enable = lib.mkDefault true;` inside the mkIf block
- **Verify**: `nix eval .#nixosConfigurations.ghost.config.environment.systemPackages --json | jq length` (ghost is desktop, should still have tools)

### Task 2: Add display manager option to hw-vm role

- **Type**: feature
- **Files**: roles/hw-vm.nix
- **Action**:
  1. Add `myModules.displayManager.ly.enable = lib.mkDefault true;` inside the mkIf cfg.vm block
  2. This enables Ly for VMs so users can log in and start Hyprland
- **Verify**: `nix eval .#nixosConfigurations.griefling.config.services.displayManager.ly.enable` returns true

### Task 3: Ensure display-manager module is imported for VMs

- **Type**: fix
- **Files**: roles/hw-vm.nix
- **Action**:
  1. Add import of `../modules/services/display-manager` to hw-vm.nix imports
  2. This is needed because hw-vm doesn't inherit from hw-desktop imports
- **Verify**: Ly service definition exists in griefling config

## Verification

1. `nix flake check` passes
2. `nix eval .#nixosConfigurations.griefling.config.services.displayManager.ly.enable` returns true
3. Griefling can build successfully: `nix build .#nixosConfigurations.griefling.config.system.build.toplevel --dry-run`

## Success Criteria

- [ ] hw-vm.nix has no unconditional imports (empty imports or none)
- [ ] Ly display manager is enabled by default for vm role
- [ ] griefling build includes Ly and can launch Hyprland

## Output

Create SUMMARY.md documenting changes and commit hash
