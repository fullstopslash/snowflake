# Plan 09-01: Fix Module Imports - Add Enable Options

## Objective

Fix the role system so modules are NOT imported unconditionally. Convert problematic modules to use `mkEnableOption` pattern so they only apply config when explicitly enabled.

## Context

@roles/hw-vm.nix - VM role that imports modules/apps/cli unconditionally
@roles/hw-desktop.nix - Desktop role importing many modules unconditionally
@modules/apps/gaming/default.nix - Unconditionally enables Steam, Docker, gaming
@modules/apps/development/latex.nix - Unconditionally adds latex-fhs
@modules/services/development/containers.nix - Unconditionally configures Docker
@modules/apps/cli/tools.nix - Unconditionally adds 100+ packages

## Problem Analysis

The role system imports ALL role files from `roles/default.nix`. Each role file has an `imports` section that pulls in modules REGARDLESS of whether the role is enabled. This breaks the "minimal install" pattern.

Current flow:
```
roles/default.nix
  -> imports hw-vm.nix, hw-desktop.nix, etc. (always)
  -> hw-vm.nix imports modules/apps/cli (always, outside mkIf)
  -> hw-desktop.nix imports modules/apps/gaming (always, outside mkIf)
  -> gaming/default.nix has no enable option, applies config unconditionally
```

Required flow:
```
roles/default.nix
  -> imports hw-vm.nix, hw-desktop.nix, etc. (always)
  -> each role uses mkIf cfg.roleX { ... }
  -> modules have mkEnableOption, only apply when explicitly enabled
```

## Tasks

### Task 1: Convert modules/apps/gaming to enable-gated pattern

- **Type**: refactor
- **Files**: modules/apps/gaming/default.nix
- **Action**:
  1. Add `options.myModules.apps.gaming.enable = lib.mkEnableOption "Gaming apps";`
  2. Wrap all config in `config = lib.mkIf cfg.enable { ... }`
  3. Keep all existing functionality, just make it conditional
- **Verify**: `nix eval .#nixosConfigurations.griefling.config.myModules.apps.gaming.enable` returns false

### Task 2: Convert modules/apps/development/latex.nix to enable-gated pattern

- **Type**: refactor
- **Files**: modules/apps/development/latex.nix
- **Action**:
  1. Add `options.myModules.apps.development.latex.enable = lib.mkEnableOption "LaTeX development environment";`
  2. Wrap all config in `config = lib.mkIf cfg.enable { ... }`
- **Verify**: LaTeX package not in `nix build .#nixosConfigurations.griefling.config.system.build.toplevel --dry-run` output

### Task 3: Convert modules/services/development/containers.nix to enable-gated pattern

- **Type**: refactor
- **Files**: modules/services/development/containers.nix
- **Action**:
  1. Add `options.myModules.services.development.containers.enable = lib.mkEnableOption "Docker containers";`
  2. Wrap all config in `config = lib.mkIf cfg.enable { ... }`
- **Verify**: Docker not in griefling build

### Task 4: Convert modules/apps/cli/tools.nix to enable-gated pattern

- **Type**: refactor
- **Files**: modules/apps/cli/tools.nix
- **Action**:
  1. Add `options.myModules.apps.cli.tools.enable = lib.mkEnableOption "Extended CLI tools";`
  2. Wrap all packages in `config = lib.mkIf cfg.enable { ... }`
- **Verify**: Extended tools not in minimal VM

### Task 5: Convert modules/apps/cli/shell.nix to enable-gated pattern

- **Type**: refactor
- **Files**: modules/apps/cli/shell.nix
- **Action**:
  1. Add `options.myModules.apps.cli.shell.enable = lib.mkEnableOption "Shell configuration";`
  2. Wrap config in `config = lib.mkIf cfg.enable { ... }`
- **Verify**: Shell extras not in minimal VM

## Verification

1. `nix flake check` passes
2. `nix build .#nixosConfigurations.griefling.config.system.build.toplevel --dry-run 2>&1 | grep -i steam` returns nothing
3. `nix build .#nixosConfigurations.griefling.config.system.build.toplevel --dry-run 2>&1 | grep -i docker` returns nothing
4. `nix build .#nixosConfigurations.griefling.config.system.build.toplevel --dry-run 2>&1 | grep -i texlive` returns nothing

## Success Criteria

- [ ] Gaming module has enable option, defaults to false
- [ ] LaTeX module has enable option, defaults to false
- [ ] Containers module has enable option, defaults to false
- [ ] CLI tools module has enable option, defaults to false
- [ ] Shell module has enable option, defaults to false
- [ ] griefling dry-run build shows no steam, docker, or latex packages

## Output

Create SUMMARY.md documenting:
- Files modified with enable options added
- Any unexpected dependencies discovered
- Commit hash for changes
