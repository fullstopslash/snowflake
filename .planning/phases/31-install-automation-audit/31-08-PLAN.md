---
phase: 31-install-automation-audit
type: execute
---

<objective>
Verify Attic cache automation and conduct comprehensive end-to-end testing of all install automation requirements.

Purpose: Ensure waterbug.lan cache works reliably on first boot and ALL success criteria are met for production-ready install automation.
Output: Fully verified install automation system ready for production use.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
@~/.claude/skills/create-plans/references/checkpoints.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/31-install-automation-audit/31-01-SUMMARY.md
@.planning/phases/31-install-automation-audit/31-02-SUMMARY.md
@.planning/phases/31-install-automation-audit/31-03-SUMMARY.md
@.planning/phases/31-install-automation-audit/31-04-SUMMARY.md
@.planning/phases/31-install-automation-audit/31-05-SUMMARY.md
@.planning/phases/31-install-automation-audit/31-06-SUMMARY.md
@.planning/phases/31-install-automation-audit/31-07-SUMMARY.md
@.planning/phases/31-install-automation-audit/AUDIT-FINDINGS.md
@modules/services/cache-resolver.nix
@modules/common/build-cache.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify cache-resolver network dependency fix works on first boot</name>
  <files>modules/services/cache-resolver.nix</files>
  <action>Audit cache-resolver service (fixed in earlier phase):
  1. Verify systemd service has: requires = [ "network-online.target" ]
  2. Check no retry loops (simple network dependency, not polling)
  3. Verify graceful fallback to cache.nixos.org if waterbug unavailable
  4. Test on fresh VM install: cache-resolver should succeed on first boot
  5. Check /run/cache-resolver/nix.conf contains waterbug substituter

  Confirm fix from earlier work:
  - Network dependency is "requires" not "wants"
  - Service waits for actual network availability
  - No dumb retry logic, just proper systemd dependencies

  Test both scenarios:
  - waterbug.lan available → should use http://waterbug.lan:9999/system
  - waterbug.lan unavailable → should fallback to https://cache.nixos.org</action>
  <verify>systemctl cat cache-resolver.service shows "requires = [ \"network-online.target\" ]"</verify>
  <done>Cache-resolver verified working reliably on first boot with proper network dependencies</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete install automation system with all 7 previous plans integrated</what-built>
  <how-to-verify>
    **Full end-to-end test:**

    1. **Fresh Install Test:**
       - Run: just vm-fresh griefling (completely fresh VM)
       - Installation should complete with ZERO manual steps
       - Watch for: SOPS keys auto-added, deploy keys created, repos cloned

    2. **Post-Install Verification (SSH into VM):**
       - ssh -p 22222 rain@127.0.0.1
       - Verify all three repos: ls ~/nix-config ~/nix-secrets ~/.local/share/chezmoi
       - Check SOPS decryption works: sudo cat /run/secrets/*/\*
       - Verify services: systemctl status atuin-autologin syncthing tailscaled
       - Check cache: cat /run/cache-resolver/nix.conf (should show waterbug)
       - Test chezmoi: ls ~/.zshrc ~/.config (dotfiles deployed)

    3. **Functionality Tests:**
       - Run: cd ~/nix-config && nix flake update nix-secrets (should work, no Permission denied)
       - Run: git pull in all three repos (deploy keys working)
       - Check: atuin history (should be syncing)
       - Check: tailscale status (should be connected)

    4. **Build Cache Test:**
       - Run: nh os switch (should pull from waterbug.lan, not nixos.org)
       - Watch for: "copying path from 'http://waterbug.lan:9999/system'"

    5. **Reboot Persistence:**
       - Run: sudo reboot
       - Wait, SSH back in
       - Verify: repos still exist, services still running, cache still configured

    **Expected:** ALL tests pass, ZERO manual intervention needed at any point.
  </how-to-verify>
  <resume-signal>Type "all tests passed" if every verification succeeded, or detail any failures</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Verification against all original success criteria</what-built>
  <how-to-verify>
    **Success Criteria Checklist** (from original requirements):

    1. **Repository Provisioning:**
       - [ ] All three repos cloned to system
       - [ ] GitHub auth works for automated AND manual updates
       - [ ] Repos persist across reboots
       - [ ] Both root AND user have deploy key access

    2. **Core Services:**
       - [ ] Atuin auto-login functional
       - [ ] Syncthing auto-config and syncing
       - [ ] Tailscale OAuth auto-connect

    3. **SOPS Management:**
       - [ ] Host keys properly encrypted
       - [ ] shared.yaml decrypts correctly
       - [ ] Host-specific secrets work
       - [ ] VM host keys auto-added to .sops.yaml
       - [ ] SOPS files auto-rekeyed

    4. **Chezmoi:**
       - [ ] Deploys on first install
       - [ ] Templates render with SOPS secrets
       - [ ] Pre-update re-add workflow prevents overwrites

    5. **Attic Cache:**
       - [ ] Builds pull from waterbug.lan (not nixos.org)
       - [ ] Cache-resolver works on first boot
       - [ ] Graceful fallback if cache unavailable

    6. **Install Normalization:**
       - [ ] vm-fresh and install function identically
       - [ ] No code duplication
       - [ ] DRY helper functions used

    7. **Automation Quality:**
       - [ ] Zero manual steps required
       - [ ] Conventional commits with datever
       - [ ] Easy audit trail (host + timestamp in commits)
       - [ ] jj used for all commits

    **Verify each checkbox, report any failures.**
  </how-to-verify>
  <resume-signal>Type "all criteria met" if every checkbox passes, or list unmet criteria</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan AND phase complete:
- [ ] Cache-resolver network dependency verified
- [ ] Full end-to-end griefling install succeeds
- [ ] All three repos accessible and functional
- [ ] All core services running
- [ ] SOPS decryption working
- [ ] Chezmoi deployed with templates
- [ ] Cache pulling from waterbug.lan
- [ ] Repos persist across reboot
- [ ] All original success criteria met
- [ ] Zero manual intervention required
</verification>

<success_criteria>
- All tasks completed
- Cache-resolver reliable on first boot
- End-to-end test passes completely
- All original success criteria verified met
- Install automation is production-ready
- Phase 31 complete
</success_criteria>

<output>
After completion, create `.planning/phases/31-install-automation-audit/31-08-SUMMARY.md`

# Phase 31 Plan 8: Attic Cache & Final Verification Summary

**Install automation fully verified and production-ready**

## Accomplishments
- Cache-resolver verified working on first boot
- Full end-to-end testing completed successfully
- All original success criteria verified met
- Install automation is production-ready

## Files Created/Modified
- [List any cache-resolver fixes if needed]

## Decisions Made
[Verification approach and success criteria validation]

## Issues Encountered
[Any final issues discovered and resolved]

## Next Step
Phase 31 COMPLETE - Install automation is air-tight, flawless, and production-ready
</output>
