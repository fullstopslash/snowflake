# Phase 31-09: Debug SSH Key/SOPS/Repo Deployment Flow

## Objective

Debug and fix the NixOS automated installation system to ensure SSH host keys, SOPS secrets, deploy keys, and GitHub repositories are properly deployed on first install.

**Current State**: VM installs successfully but repos fail to deploy due to age key mismatch between pre-generated SSH keys and deployed system keys.

**Target State**: Fresh `just vm-fresh griefling` completes with all repos cloned, SOPS secrets decrypted, and GitHub authentication working.

## Context

**Core Issue**: SSH host keys generated in EXTRA_FILES during installation are not being used by the deployed NixOS system, causing a cascade of failures:

1. **Age key mismatch**:
   - Pre-generated: `age132ywlfnu5r9rtda6pmsy7chy34ap4dgsanulad80pedzq0c6ysksq9j2ke`
   - Deployed system: `age1ugwvfdp9qyck8nyhtwe5wlc2m3xmqweexf6q8glfd660qy5vqpfsajmgjr`

2. **SOPS decryption fails**: sops-nix.service doesn't exist on deployed system

3. **Deploy keys not deployed**: /home/rain/.ssh/ doesn't exist (depends on SOPS)

4. **Repos not cloned**: github-repos-init service fails (depends on deploy keys)

**Relevant Files**:
- @file:justfile (vm-fresh recipe, lines 678-690 for SSH key generation)
- @file:scripts/test-fresh-install.sh (--extra-files handling, line 367)
- @file:modules/services/networking/openssh.nix (hostKeys configuration)
- @file:modules/common/sops.nix (age key configuration)
- @file:modules/services/development/github-repos.nix (deploy key and repo management)

## Tasks

<task type="auto">
<name>Debug SSH host key deployment mechanism</name>
<files>justfile, scripts/test-fresh-install.sh, modules/services/networking/openssh.nix, modules/disks/griefling.nix</files>
<action>
Investigate why SSH host keys in EXTRA_FILES don't match the deployed system:

1. **Trace --extra-files flow**:
   - Verify test-fresh-install.sh correctly merges EXTRA_FILES with temp directory
   - Confirm nixos-anywhere receives and extracts --extra-files
   - Check if files land in /etc/ssh/ vs /persist/etc/ssh/ on deployed system

2. **Check NixOS SSH configuration**:
   - Review modules/services/networking/openssh.nix for services.openssh.hostKeys
   - Determine if NixOS is overriding our pre-generated keys
   - Check if impermanence (/persist) is interfering with key deployment
   - Verify /persist mount happens before SSH key deployment

3. **Add debug instrumentation**:
   - Add logging to justfile vm-fresh to show generated SSH key fingerprint
   - Add systemd service to log deployed SSH key fingerprint on first boot
   - Compare fingerprints to identify where divergence occurs

4. **Test hypothesis**: Run `just vm-fresh griefling` and verify:
   - EXTRA_FILES contains expected SSH key
   - Deployed system /etc/ssh/ssh_host_ed25519_key.pub matches EXTRA_FILES
   - Age key derived from deployed SSH key matches .sops.yaml registration
</action>
<verify>
```bash
# On build machine
just vm-fresh griefling

# Capture pre-generated age key
AGE_KEY_EXPECTED=$(grep "age1.*" nix-secrets/.sops.yaml | grep griefling -A1 | tail -1 | awk '{print $2}')

# On deployed VM
ssh -p 22222 root@localhost "ssh-keygen -y -f /etc/ssh/ssh_host_ed25519_key | ssh-to-age"

# Compare: should match $AGE_KEY_EXPECTED
```
</verify>
<done>Age key derived from EXTRA_FILES SSH host key matches age key on deployed NixOS system. Root cause of key mismatch identified and documented.</done>
</task>

<task type="auto">
<name>Fix SOPS age key synchronization</name>
<files>justfile, modules/common/sops.nix, nix-secrets/.sops.yaml</files>
<action>
Ensure the entire age key flow uses the SAME SSH host key from generation through deployment:

1. **Verify age key derivation**:
   - Confirm justfile vm-fresh derives age key from EXTRA_FILES SSH key
   - Ensure this age key is what gets written to .sops.yaml
   - Verify no intermediate copies or transformations corrupt the key

2. **Fix key registration flow**:
   - Ensure .sops.yaml update commits to nix-secrets
   - Verify flake.lock update pulls latest nix-secrets with correct age key
   - Confirm deployed system's sops.nix reads age key from flake.lock nix-secrets

3. **Test SOPS decryption**:
   - Deploy VM with fixed SSH keys
   - SSH to deployed system
   - Run: `systemctl status sops-nix.service` (should exist and succeed)
   - Run: `sops -d /run/secrets-for-users/deploy-keys/nix-config` (should decrypt)
   - Verify /home/rain/.ssh/nix-config-deploy exists with correct permissions

4. **Validate end-to-end**:
   - Pre-generated age key → .sops.yaml → flake.lock → deployed system → SOPS decryption
   - All using the SAME age key derived from SAME SSH host key
</action>
<verify>
```bash
# On deployed VM after fix
ssh -p 22222 root@localhost <<'EOF'
  # Verify sops-nix service exists and succeeded
  systemctl status sops-nix.service

  # Verify SOPS secrets decrypted
  ls -la /run/secrets-for-users/deploy-keys/

  # Verify deploy keys deployed to user home
  ls -la /home/rain/.ssh/nix-config-deploy
  ls -la /home/rain/.ssh/nix-secrets-deploy
  ls -la /home/rain/.ssh/chezmoi-deploy
EOF
```
</verify>
<done>SOPS secrets decrypt successfully on deployed system. Deploy keys exist in /home/rain/.ssh/ with correct permissions. sops-nix.service exists and reports success.</done>
</task>

<task type="auto">
<name>Verify end-to-end repo deployment flow</name>
<files>modules/services/development/github-repos.nix, justfile</files>
<action>
Test the complete deployment flow from SOPS decryption through repo cloning:

1. **Verify SSH configuration**:
   - Check /home/rain/.ssh/config exists with github.com-* host aliases
   - Confirm IdentityFile paths point to deployed deploy keys
   - Test: `ssh -T git@github.com-nix-config` returns "Hi fullstopslash!"

2. **Verify systemd service**:
   - Check github-repos-init.service exists and runs
   - Review service logs: `journalctl -u github-repos-init`
   - Confirm ConditionPathExists triggers correctly
   - Verify service has git and openssh in PATH

3. **Verify repo cloning**:
   - Check /home/rain/nix-config/.git exists
   - Check /home/rain/nix-secrets/.git exists
   - Check /home/rain/.local/share/chezmoi/.git exists
   - Verify repos owned by rain:users, not root

4. **Test GitHub operations**:
   - SSH to deployed VM as rain user
   - cd into nix-config
   - Run: `git fetch` (should succeed)
   - Run: `git status` (should show clean working tree)
   - Verify: `jj log` works (jj should be available)

5. **Verify persistence across reboot**:
   - Run: `just vm-reboot griefling`
   - After reboot, check repos still exist
   - Verify GitHub authentication still works
</action>
<verify>
```bash
# Full verification script
ssh -p 22222 root@localhost <<'EOF'
  # Switch to user
  su - rain -c '
    # Verify repos exist
    test -d ~/nix-config/.git && echo "✅ nix-config cloned"
    test -d ~/nix-secrets/.git && echo "✅ nix-secrets cloned"
    test -d ~/.local/share/chezmoi/.git && echo "✅ chezmoi cloned"

    # Verify GitHub authentication
    ssh -T git@github.com-nix-config 2>&1 | grep -q "fullstopslash" && echo "✅ nix-config auth works"
    ssh -T git@github.com-nix-secrets 2>&1 | grep -q "fullstopslash" && echo "✅ nix-secrets auth works"
    ssh -T git@github.com-chezmoi 2>&1 | grep -q "fullstopslash" && echo "✅ chezmoi auth works"

    # Verify git operations
    cd ~/nix-config && git fetch && echo "✅ git fetch works"
    cd ~/nix-config && git status | grep -q "nothing to commit" && echo "✅ working tree clean"
  '
EOF
```
</verify>
<done>Fresh griefling VM install completes with all three repos cloned, owned by rain user, GitHub SSH authentication working for all repos, and repos persisting across reboot.</done>
</task>

## Verification

**Final acceptance test**:
```bash
# Clean slate
just vm-destroy griefling

# Single command install
just vm-fresh griefling

# Verify complete success
ssh -p 22222 root@localhost "su - rain -c 'ls -la ~/{nix-config,nix-secrets,.local/share/chezmoi}/.git && ssh -T git@github.com-nix-config 2>&1'"
```

Should output:
- Three .git directories exist
- "Hi fullstopslash/snowflake!" message from GitHub
- No errors in systemd service logs
- All repos owned by rain:users

## Success Criteria

1. ✅ SSH host keys in EXTRA_FILES match deployed system SSH keys
2. ✅ Age key derivation is consistent throughout deployment flow
3. ✅ SOPS secrets decrypt successfully (sops-nix.service exists and succeeds)
4. ✅ Deploy keys deployed to /home/rain/.ssh/ with correct ownership
5. ✅ SSH config created with github.com-* host aliases
6. ✅ All three repos cloned: nix-config, nix-secrets, chezmoi
7. ✅ GitHub authentication works: `ssh -T git@github.com-nix-config` succeeds
8. ✅ Repos owned by rain:users, not root
9. ✅ System survives reboot with repos intact
10. ✅ `just vm-fresh griefling` completes with zero manual intervention

## Output

Document findings in `31-09-SUMMARY.md` with:
- Root cause analysis of SSH key mismatch
- Changes made to fix deployment flow
- Complete verification results
- Any deviations from plan
- Commit hashes for all fixes
