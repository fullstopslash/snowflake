---
phase: 31-install-automation-audit
type: execute
---

<objective>
Ensure all three repos (nix-config, nix-secrets, chezmoi) persist correctly across reboots for both encrypted and regular hosts.

Purpose: Guarantee repos are cloned to the correct persistent location and remain accessible after system reboots.
Output: Verified repository persistence with reboot testing.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
@~/.claude/skills/create-plans/references/checkpoints.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/31-install-automation-audit/31-01-SUMMARY.md
@.planning/phases/31-install-automation-audit/31-02-SUMMARY.md
@.planning/phases/31-install-automation-audit/31-03-SUMMARY.md
@.planning/phases/31-install-automation-audit/31-04-SUMMARY.md
@justfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement robust /persist detection logic</name>
  <files>justfile (_detect-home-dir and _clone-repos helpers)</files>
  <action>Enhance _detect-home-dir helper to robustly detect encrypted vs regular hosts:
  1. SSH into target host
  2. Check: [ -d /persist ] && echo "/persist/home/$PRIMARY_USER" || echo "/home/$PRIMARY_USER"
  3. Return the correct path

  Enhance _clone-repos helper to use this detection:
  1. Call USER_HOME=$(_detect-home-dir {{HOST}})
  2. Create directory: mkdir -p $USER_HOME
  3. Clone to $USER_HOME/nix-config, $USER_HOME/nix-secrets, $USER_HOME/.local/share/chezmoi
  4. Set ownership: chown -R $PRIMARY_USER:users $USER_HOME
  5. Verify all three repos cloned successfully

  Handle edge cases:
  - /persist exists but /persist/home doesn't (create it)
  - User doesn't exist yet (use id -u fallback to 1000)
  - Clone failures (set -e and explicit error checking)</action>
  <verify>just _detect-home-dir griefling returns correct path based on /persist existence</verify>
  <done>Robust /persist detection implemented handling both encrypted and regular hosts with proper error handling</done>
</task>

<task type="auto">
  <name>Task 2: Verify all three repos clone to correct persistent location</name>
  <files>justfile (_clone-repos helper)</files>
  <action>Enhance _clone-repos to verify successful cloning:
  1. After cloning each repo, verify directory exists and contains .git
  2. Test: [ -d $USER_HOME/nix-config/.git ] || (echo "Failed to clone nix-config" && exit 1)
  3. Same for nix-secrets and .local/share/chezmoi
  4. Log success: echo "âœ… All repos cloned to $USER_HOME"

  Add verification that repos are in the CORRECT location:
  - On encrypted hosts: /persist/home/$USER/*
  - On regular hosts: /home/$USER/*
  - NOT in /root (ephemeral)

  Test with both griefling (regular) and an encrypted host if available.</action>
  <verify>SSH into fresh install, check all three repos exist in persistent location</verify>
  <done>All three repos verified cloning to correct persistent location with .git directories present</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Repository cloning to persistent locations with /persist detection</what-built>
  <how-to-verify>
    1. Run: just vm-fresh griefling (fresh install)
    2. Wait for installation to complete
    3. SSH into VM: ssh -p 22222 rain@127.0.0.1
    4. Verify repos exist:
       - ls -la ~/nix-config/.git (should exist)
       - ls -la ~/nix-secrets/.git (should exist)
       - ls -la ~/.local/share/chezmoi/.git (should exist)
    5. Reboot the VM: sudo reboot
    6. Wait for reboot, SSH back in
    7. Verify repos STILL exist after reboot (persistence test)
    8. Test Git operations work: cd ~/nix-config && git status

    Expected: All three repos accessible before AND after reboot, Git operations work.
  </how-to-verify>
  <resume-signal>Type "approved" if all three repos persist across reboot, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] _detect-home-dir correctly identifies /persist vs /home
- [ ] All three repos clone to persistent location
- [ ] Repos survive reboot (verified via checkpoint)
- [ ] Git operations work in all three repos
- [ ] Ownership and permissions correct ($USER:users)
</verification>

<success_criteria>
- All tasks completed
- /persist detection robust and correct
- All three repos cloned to persistent storage
- Human verification confirms persistence across reboot
- No repos lost on reboot
</success_criteria>

<output>
After completion, create `.planning/phases/31-install-automation-audit/31-05-SUMMARY.md`

# Phase 31 Plan 5: Repository Provisioning & Persistence Summary

**All three repos now persist correctly across reboots**

## Accomplishments
- Robust /persist detection implemented
- All three repos verified cloning to persistent location
- Reboot testing confirms persistence
- Git operations working in all repos

## Files Created/Modified
- `justfile` - Enhanced _detect-home-dir and _clone-repos helpers

## Decisions Made
[/persist detection strategy and persistence verification approach]

## Issues Encountered
[Any reboot persistence issues discovered]

## Next Step
Ready for 31-06-PLAN.md (Core Services Automation)
</output>
