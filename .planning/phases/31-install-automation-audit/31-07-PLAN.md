---
phase: 31-install-automation-audit
type: execute
---

<objective>
Implement chezmoi deployment on first install and auto-update workflow that prevents dotfile overwrites.

Purpose: Ensure chezmoi deploys on first install and automated system updates preserve dotfile changes via pre-update workflow: chezmoi re-add → jj commit → push.
Output: Chezmoi first-install automation and pre-update workflow preventing dotfile overwrites.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/31-install-automation-audit/31-01-SUMMARY.md
@.planning/phases/31-install-automation-audit/AUDIT-FINDINGS.md
@home-manager/chezmoi.nix
@modules/services/auto-update.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify chezmoi deploys on first install with templates working</name>
  <files>home-manager/chezmoi.nix, justfile (_clone-repos helper)</files>
  <action>Audit and fix chezmoi first-install deployment:
  1. Verify chezmoi repo clones to ~/.local/share/chezmoi (already in _clone-repos)
  2. Check chezmoi.nix enables chezmoi and configures source directory
  3. Verify SOPS secrets for chezmoi templates stored in sops/chezmoi.yaml
  4. Test chezmoi apply works on first login (templates rendered with secrets)
  5. Verify dotfiles appear in home directory after first apply

  Fix any issues:
  - Chezmoi not applying automatically → add to home-manager activation
  - Templates not rendering → verify SOPS integration
  - Source directory wrong → fix path in chezmoi.nix

  Test: Fresh install should have dotfiles deployed on first user login.</action>
  <verify>On fresh install, check ~/.zshrc, ~/.config/* exist with correct content after first login</verify>
  <done>Chezmoi verified deploying on first install with templates rendering correctly from SOPS secrets</done>
</task>

<task type="auto">
  <name>Task 2: Implement pre-update chezmoi re-add → jj commit → push workflow</name>
  <files>modules/services/auto-update.nix, systemd service files</files>
  <action>Create pre-update workflow that runs BEFORE system updates:
  1. Find or create auto-update systemd service/timer
  2. Add ExecStartPre script that:
     - cd ~/.local/share/chezmoi
     - chezmoi re-add (captures any manual dotfile changes)
     - jj status (check if changes exist)
     - If changes: jj commit -m "chore(dotfiles): auto-update $(date +%Y-%m-%d-%H%M)" && jj git push --bookmark main
     - If no changes: skip commit (avoid empty commits)
  3. Run as the primary user (not root)
  4. Handle errors gracefully (don't block system update if chezmoi fails)

  Conventional commit format: chore(dotfiles): auto-update 2026-01-02-1430
  Use jj (not git) for commits as user specified.
  Only commit when changes exist.</action>
  <verify>cat /etc/systemd/system/auto-update.service shows ExecStartPre with chezmoi re-add workflow</verify>
  <done>Pre-update workflow implemented that preserves dotfile changes before system updates</done>
</task>

<task type="auto">
  <name>Task 3: Add GitOps conventional commit automation with datever</name>
  <files>modules/services/auto-update.nix, auto-update scripts</files>
  <action>Enhance auto-update system to create conventional commits for all three repos:

  For nix-config updates:
  - After nix flake update, check jj status
  - If changes: jj commit -m "chore(flake): auto-update $(date +%Y-%m-%d-%H%M) on {{HOST}}"

  For nix-secrets updates (if any):
  - Check for secret changes or SOPS rekeying
  - If changes: jj commit -m "chore(secrets): auto-update $(date +%Y-%m-%d-%H%M) on {{HOST}}"

  For chezmoi (already in Task 2):
  - Already implemented with conventional commit format

  All commits include:
  - Conventional commit type (chore, fix, feat, etc.)
  - Scope (flake, secrets, dotfiles)
  - Datever format: YYYY-MM-DD-HHMM
  - Host that made the change (for audit trail)

  Only commit when changes exist (check jj status first).
  This enables easy rollbacks and audit trail as user requested.</action>
  <verify>Check auto-update logs show conventional commits with datever for all repos</verify>
  <done>GitOps conventional commit automation implemented for all three repos with datever and host tracking</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Chezmoi deploys on first install with templates working
- [ ] Pre-update workflow preserves dotfile changes
- [ ] Conventional commits created for all three repos when changes exist
- [ ] Datever format used: YYYY-MM-DD-HHMM
- [ ] Host name included in commit messages for audit trail
- [ ] jj used for all commits (not git)
</verification>

<success_criteria>
- All tasks completed
- Chezmoi deploys on first install
- Dotfiles never overwritten by system updates
- Conventional commit automation working for all repos
- Easy audit trail and rollback capability
- No empty commits created
</success_criteria>

<output>
After completion, create `.planning/phases/31-install-automation-audit/31-07-SUMMARY.md`

# Phase 31 Plan 7: Chezmoi & Auto-Update Workflows Summary

**Chezmoi first-install and GitOps auto-update workflows complete**

## Accomplishments
- Chezmoi verified deploying on first install
- Pre-update workflow prevents dotfile overwrites
- Conventional commit automation for all three repos
- Datever and host tracking for audit trail

## Files Created/Modified
- `home-manager/chezmoi.nix` - [any fixes]
- `modules/services/auto-update.nix` - Pre-update workflow and commit automation
- Systemd service files - [auto-update services]

## Decisions Made
[Commit message format and pre-update workflow design]

## Issues Encountered
[Any chezmoi or auto-update issues]

## Next Step
Ready for 31-08-PLAN.md (Attic Cache & Final Verification)
</output>
