---
phase: 31-install-automation-audit
type: execute
---

<objective>
Audit and fix core service automation: Atuin, Syncthing, and Tailscale OAuth.

Purpose: Ensure all three critical services function correctly on fresh installs without manual intervention.
Output: Verified and fixed automation for all three core services.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/31-install-automation-audit/31-01-SUMMARY.md
@.planning/phases/31-install-automation-audit/AUDIT-FINDINGS.md
@modules/services/atuin.nix
@modules/services/syncthing.nix
@modules/services/tailscale.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and fix Atuin auto-login service</name>
  <files>modules/services/atuin.nix, sops-related files</files>
  <action>Audit Atuin configuration:
  1. Check atuin-autologin.service systemd unit
  2. Verify atuin credentials stored in SOPS (sops/shared.yaml or per-host)
  3. Check service dependencies: After=network-online.target, sops-secrets.service
  4. Test credential extraction and auto-login flow
  5. Verify atuin sync works after login

  Fix any issues found:
  - Missing SOPS secrets → add to shared.yaml
  - Service timing issues → fix dependencies
  - Auto-login failures → add retry logic or better error handling

  Test: Fresh install should have atuin working immediately with history synced.</action>
  <verify>systemctl status atuin-autologin.service shows active (exited) with success</verify>
  <done>Atuin auto-login service verified working on fresh install with history sync functional</done>
</task>

<task type="auto">
  <name>Task 2: Audit and fix Syncthing auto-config</name>
  <files>modules/services/syncthing.nix, sops-related files</files>
  <action>Audit Syncthing configuration:
  1. Check Syncthing service starts automatically
  2. Verify device ID and API key in SOPS
  3. Check folder configurations are applied automatically
  4. Verify Syncthing connects to other devices without manual setup
  5. Test sync works (files appear in sync folders)

  Fix any issues:
  - Missing SOPS configuration → add to shared.yaml
  - Service not starting → check dependencies
  - Folder config not applied → fix declarative config
  - Connection issues → verify firewall/network settings

  Test: Fresh install should have Syncthing running and connected to network.</action>
  <verify>systemctl status syncthing.service shows active, sync folders populated</verify>
  <done>Syncthing verified auto-configuring and syncing on fresh install</done>
</task>

<task type="auto">
  <name>Task 3: Audit and fix Tailscale OAuth automation</name>
  <files>modules/services/tailscale.nix, sops-related files</files>
  <action>Audit Tailscale configuration:
  1. Check tailscale-oauth-key.service generates auth key
  2. Verify OAuth client credentials in SOPS (sops/shared.yaml)
  3. Check tailscaled-autoconnect.service uses auth key
  4. Verify Tailscale connects to network automatically
  5. Test: tailscale status shows connected

  Fix any issues from audit findings:
  - OAuth secrets missing → add to shared.yaml
  - Service failures → check dependencies and error handling
  - Connection timeouts → adjust timeout settings
  - Manual auth required → fix auth key flow

  Cross-reference with AUDIT-FINDINGS.md for known Tailscale issues.
  Test: Fresh install should show Tailscale connected without user interaction.</action>
  <verify>tailscale status shows node connected with IP assigned</verify>
  <done>Tailscale OAuth automation verified working with automatic connection on fresh install</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Atuin auto-login service succeeds on fresh install
- [ ] Syncthing auto-configures and syncs
- [ ] Tailscale connects automatically via OAuth
- [ ] All three services functional without manual intervention
- [ ] SOPS secrets properly configured for all services
</verification>

<success_criteria>
- All tasks completed
- All three core services (Atuin, Syncthing, Tailscale) automated
- No manual configuration required for any service
- All services functional on fresh griefling install
- Any discovered issues documented and fixed
</success_criteria>

<output>
After completion, create `.planning/phases/31-install-automation-audit/31-06-SUMMARY.md`

# Phase 31 Plan 6: Core Services Automation Summary

**Atuin, Syncthing, and Tailscale now fully automated**

## Accomplishments
- Atuin auto-login verified and fixed
- Syncthing auto-config verified and fixed
- Tailscale OAuth automation verified and fixed
- All services functional without manual intervention

## Files Created/Modified
- `modules/services/atuin.nix` - [any fixes]
- `modules/services/syncthing.nix` - [any fixes]
- `modules/services/tailscale.nix` - [any fixes]
- `../nix-secrets/sops/shared.yaml` - [any missing secrets added]

## Decisions Made
[Service automation strategies and SOPS secret organization]

## Issues Encountered
[Any service-specific issues discovered and resolved]

## Next Step
Ready for 31-07-PLAN.md (Chezmoi & Auto-Update Workflows)
</output>
