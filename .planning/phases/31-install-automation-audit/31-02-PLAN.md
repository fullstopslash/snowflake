---
phase: 31-install-automation-audit
type: execute
---

<objective>
Automate SOPS key management for new VM installations: host keys, user keys, and break-glass keys.

Purpose: Eliminate manual SOPS key management - new VMs should automatically add their host keys AND user keys to .sops.yaml and rekey files without human intervention. Establish per-host user keys for granular access control. Verify break-glass keys are integrated for catastrophic recovery.
Output: Fully automated SOPS key management (host + user + break-glass) integrated into install recipes.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/31-install-automation-audit/31-01-SUMMARY.md
@justfile
@../nix-secrets/.sops.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Auto-extract VM host SSH key and convert to age format</name>
  <files>justfile (vm-fresh and install recipes)</files>
  <action>After VM boots and before repo cloning:
  1. SSH into new system and extract /etc/ssh/ssh_host_ed25519_key.pub
  2. Use ssh-to-age to convert to age format
  3. Store in variable for use in next tasks

  Add this step in both install and vm-fresh recipes immediately after "System is up!" confirmation.
  Use `ssh-to-age` command (available on malphas).
  Avoid hardcoding the age key - it's different for each VM boot.</action>
  <verify>Run vm-fresh, check logs show "Extracted age key: age1..." message</verify>
  <done>Both recipes extract and convert host SSH key to age format automatically</done>
</task>

<task type="auto">
  <name>Task 2: Auto-update ../nix-secrets/.sops.yaml with new host key</name>
  <files>justfile, ../nix-secrets/.sops.yaml</files>
  <action>After extracting age key:
  1. Check if host key already exists in .sops.yaml (grep for age key)
  2. If not exists:
     - Add to hosts section: `- &{{HOST}} age1xxx...`
     - Add to shared.yaml encryption rule (after line 46)
     - Add to {{HOST}}.yaml encryption rule (create rule if doesn't exist)
  3. Use sed/yq to safely insert without corrupting YAML structure

  Handle both test VMs (griefling, sorrow, torment, anguish) and production hosts.
  Preserve existing formatting and comments.</action>
  <verify>cat ../nix-secrets/.sops.yaml | grep -A 5 "{{HOST}}" shows host key added correctly</verify>
  <done>Host key automatically added to .sops.yaml in correct locations for shared and host-specific encryption</done>
</task>

<task type="auto">
  <name>Task 3: Auto-rekey affected SOPS files</name>
  <files>justfile, ../nix-secrets/sops/*.yaml</files>
  <action>After updating .sops.yaml:
  1. cd ../nix-secrets
  2. Run: echo "y" | sops updatekeys sops/shared.yaml
  3. If sops/{{HOST}}.yaml exists, rekey it too
  4. Use jj (not git) to commit changes: jj commit -m "chore(sops): add {{HOST}} host key and rekey files"
  5. Push: jj git push --bookmark main

  Handle updatekeys confirmation automatically with echo "y".
  Commit message must use conventional commit format with datever.
  Only commit if changes exist (check jj status first).</action>
  <verify>cd ../nix-secrets && jj log -n 1 shows commit with "add {{HOST}} host key"</verify>
  <done>SOPS files automatically rekeyed and committed to nix-secrets repo with proper conventional commit message</done>
</task>

<task type="auto">
  <name>Task 4: Manage individual user keys for individual hosts</name>
  <files>justfile, ../nix-secrets/.sops.yaml, modules/users/default.nix</files>
  <action>Implement per-host user key management:
  1. Generate age key for primary user on each host (if not exists)
     - Check for ~/.config/sops/age/keys.txt on target host
     - If missing: generate with age-keygen
     - Store in persistent location (/persist/home/$USER/.config/sops/age/ or /home/$USER/.config/sops/age/)
  2. Extract user's age public key from target host
  3. Update .sops.yaml with user key:
     - Add to users section: `- &{{HOST}}-{{USER}} age1xxx...`
     - Add to {{HOST}}.yaml encryption rule (user can decrypt host-specific secrets)
     - Do NOT add to shared.yaml (host keys handle that)
  4. Document user key structure:
     - Host keys: decrypt shared.yaml (all hosts) and {{HOST}}.yaml (host-specific)
     - User keys: decrypt {{HOST}}.yaml only (per-host user access)
     - Enables user to manually decrypt host secrets with their personal key

  This establishes per-host user keys for granular access control.
  User keys enable: chezmoi template rendering, manual secret inspection, host-specific automation.

  Note: This focuses on the immediate need. A future phase may redesign the entire SOPS key architecture for better efficiency.</action>
  <verify>cat ../nix-secrets/.sops.yaml shows both host key (&{{HOST}}) and user key (&{{HOST}}-{{USER}}) entries</verify>
  <done>Individual user keys generated per host, added to .sops.yaml, enabling per-host user access to host-specific secrets</done>
</task>

<task type="auto">
  <name>Task 5: Verify and enforce break-glass key integration</name>
  <files>../nix-secrets/.sops.yaml, ../nix-secrets/sops/*.yaml</files>
  <action>Ensure break-glass keys are properly integrated for catastrophic recovery:
  1. Verify .sops.yaml has break-glass key(s) defined:
     - Check for glass-key or master-key entries in keys section
     - If missing, add placeholder comment indicating where to add (manual action by user)
  2. Verify break-glass key is in ALL encryption rules:
     - shared.yaml rule must include break-glass key
     - Each {{HOST}}.yaml rule must include break-glass key
     - chezmoi.yaml rule must include break-glass key
  3. Document break-glass key structure in .sops.yaml comments:
     - Purpose: Total infrastructure recovery if all host keys lost
     - Location: Physical backup (paper/metal/USB per Phase 17 docs)
     - Access: Emergency only, stored offline
  4. When updating .sops.yaml for new hosts:
     - Ensure break-glass key is added to the new host's encryption rule
     - This happens automatically if break-glass key is in template
  5. Add verification check:
     - Test that break-glass key can decrypt shared.yaml
     - Test that break-glass key can decrypt at least one host-specific file

  Cross-reference Phase 17 glass-key disaster recovery documentation.
  Break-glass key should be able to decrypt EVERYTHING for catastrophic recovery.

  Note: If break-glass key doesn't exist yet, document the need and provide setup instructions, but don't block automation. This task ensures the structure is ready when the key is generated.</action>
  <verify>grep -A 50 "creation_rules" ../nix-secrets/.sops.yaml shows break-glass key in all encryption rules</verify>
  <done>Break-glass key structure verified/enforced in .sops.yaml, ensuring catastrophic recovery capability for all secrets</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Test vm-fresh with fresh griefling - no manual SOPS intervention needed
- [ ] Check ../nix-secrets/.sops.yaml has griefling host key added
- [ ] Check ../nix-secrets/.sops.yaml has griefling-rain user key added
- [ ] Verify break-glass key present in all encryption rules (shared, host-specific, chezmoi)
- [ ] Verify sops/shared.yaml can be decrypted on griefling (host key)
- [ ] Verify sops/griefling.yaml can be decrypted on griefling (both host and user keys)
- [ ] Verify break-glass key can decrypt shared.yaml (catastrophic recovery test)
- [ ] Confirm jj log shows auto-commit for SOPS changes
- [ ] Verify user's age key persists in ~/.config/sops/age/keys.txt
</verification>

<success_criteria>
- All tasks completed
- SOPS key management fully automated in both recipes
- Host keys, user keys, AND break-glass keys properly integrated
- Per-host user keys enable granular access control
- Break-glass key enables total infrastructure recovery
- No manual .sops.yaml editing required
- No manual sops updatekeys required
- Conventional commits created automatically
</success_criteria>

<output>
After completion, create `.planning/phases/31-install-automation-audit/31-02-SUMMARY.md`

# Phase 31 Plan 2: SOPS Key Management Automation Summary

**Complete SOPS key management: host keys, user keys, and break-glass keys**

## Accomplishments
- Auto-extraction of SSH host keys with age conversion
- Auto-generation of per-host user age keys
- Break-glass key integration verified/enforced for catastrophic recovery
- Auto-update of .sops.yaml with host, user, and break-glass keys
- Auto-rekeying of shared and host-specific SOPS files
- Per-host user key granular access control
- Total infrastructure recovery capability via break-glass key
- Conventional commits for SOPS changes

## Files Created/Modified
- `justfile` - Added SOPS automation to install and vm-fresh
- `../nix-secrets/.sops.yaml` - Auto-updated structure
- `../nix-secrets/sops/*.yaml` - Auto-rekeyed files

## Decisions Made
[SOPS automation approach and commit message format]

## Issues Encountered
[Any ssh-to-age or sops updatekeys issues]

## Next Step
Ready for 31-03-PLAN.md (Install Recipe Normalization)
</output>
