---
phase: 31-install-automation-audit
type: execute
---

<objective>
Ensure deploy keys are fully automated and GitHub authentication works for both automated and manual updates.

Purpose: Guarantee that all three repos (nix-config, nix-secrets, chezmoi) can be cloned and updated by both root and the primary user without manual intervention.
Output: Rock-solid deploy key automation with comprehensive testing.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/31-install-automation-audit/31-01-SUMMARY.md
@.planning/phases/31-install-automation-audit/31-02-SUMMARY.md
@.planning/phases/31-install-automation-audit/31-03-SUMMARY.md
@justfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify and fix gh CLI deploy key automation</name>
  <files>justfile (deploy key sections in helpers)</files>
  <action>Audit current gh CLI usage for deploy keys:
  1. Verify deploy keys are created per-host (not shared)
  2. Confirm `gh repo deploy-key add` is used (not manual web UI)
  3. Ensure both repos get keys: fullstopslash/snowflake and fullstopslash/snowflake-secrets
  4. Check error handling: what if key already exists? (idempotent)
  5. Verify keys stored in SOPS under deploy-keys section
  6. Add chezmoi repo (fullstopslash/dotfiles) to deploy key automation if missing

  Fix any gaps. Deploy keys should be:
  - Generated if not in SOPS
  - Added to GitHub via `gh repo deploy-key add -R fullstopslash/[repo] -t "{{HOST}}-[repo]-deploy"`
  - Stored in sops/{{HOST}}.yaml
  - NOT shared across hosts (security isolation)</action>
  <verify>grep -A 10 "gh repo deploy-key add" justfile shows automation for all three repos</verify>
  <done>Deploy key automation verified complete for nix-config, nix-secrets, AND chezmoi repos</done>
</task>

<task type="auto">
  <name>Task 2: Ensure deploy keys deployed to both root AND primary user</name>
  <files>justfile (_deploy-host-keys helper)</files>
  <action>Verify _deploy-host-keys helper (created in Plan 3) does:
  1. Extract deploy keys from sops/{{HOST}}.yaml
  2. Copy keys to /root/.ssh/nix-config-deploy and /root/.ssh/nix-secrets-deploy
  3. Detect user home: call _detect-home-dir {{HOST}}
  4. Copy keys to $USER_HOME/.ssh/ with same names
  5. Set permissions: chmod 600 on all deploy keys
  6. Set ownership: chown root:root for /root, chown $USER:users for user home

  Both root and user must have identical deploy keys for:
  - Automated system updates (runs as root)
  - Manual user operations (nix flake update, git pull, etc.)

  Test by SSHing as both root and user, trying git operations.</action>
  <verify>SSH as root and user, run: ls -la ~/.ssh/*deploy* shows keys with correct permissions</verify>
  <done>Deploy keys deployed to both root and user accounts with correct permissions and ownership</done>
</task>

<task type="auto">
  <name>Task 3: Fix SSH config for direct github.com access</name>
  <files>justfile (_configure-ssh-github helper)</files>
  <action>Verify and fix _configure-ssh-github helper to create SSH config that:
  1. Uses `Host github.com` (NOT aliases like github.com-nix-config)
  2. Points to IdentityFile ~/.ssh/nix-secrets-deploy (works for all repos)
  3. Sets IdentitiesOnly yes (critical - prevents trying other keys)
  4. Sets StrictHostKeyChecking no (automation-friendly)
  5. Creates config for BOTH /root/.ssh/config and $USER_HOME/.ssh/config

  Nix flake URLs use git@github.com directly, so aliases don't work.
  Both root and user need this config.

  Test: nix flake update nix-secrets should work without Permission denied errors.</action>
  <verify>cat ~/.ssh/config shows "Host github.com" entry with IdentitiesOnly yes</verify>
  <done>SSH config uses direct github.com host (not aliases) for both root and user, enabling Nix flake operations</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Deploy keys exist for all three repos (nix-config, nix-secrets, dotfiles)
- [ ] gh repo deploy-key list -R fullstopslash/snowflake shows host deploy key
- [ ] Both root and user can: git pull in nix-config without password prompt
- [ ] nix flake update nix-secrets works without Permission denied
- [ ] SSH config on both accounts uses direct github.com (not aliases)
</verification>

<success_criteria>
- All tasks completed
- Deploy keys automated for all three repos
- Both root and user have deploy keys with correct permissions
- SSH config enables both manual and automated Git operations
- No "Permission denied (publickey)" errors possible
</success_criteria>

<output>
After completion, create `.planning/phases/31-install-automation-audit/31-04-SUMMARY.md`

# Phase 31 Plan 4: Deploy Keys & GitHub Auth Summary

**Deploy keys fully automated for all repos with root and user access**

## Accomplishments
- Verified gh CLI automation for all three repos
- Deploy keys deployed to both root and user accounts
- SSH config fixed for direct github.com access
- All Git operations tested and working

## Files Created/Modified
- `justfile` - Enhanced deploy key and SSH config helpers

## Decisions Made
[Deploy key strategy: per-host keys, direct github.com config]

## Issues Encountered
[Any permission or SSH config issues]

## Next Step
Ready for 31-05-PLAN.md (Repository Provisioning & Persistence)
</output>
