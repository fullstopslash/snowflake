---
phase: 31-install-automation-audit
type: execute
---

<objective>
Audit current state of install automation and document baseline for remediation.

Purpose: Establish comprehensive understanding of install/vm-fresh differences, identify DRY violations, and document current implementation patterns before remediation begins.
Output: Detailed audit document of current state, identified issues, and DRY opportunities.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@justfile
@scripts/test-fresh-install.sh
@modules/services/cache-resolver.nix
@modules/common/build-cache.nix
@../nix-secrets/.sops.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit install and vm-fresh recipes for differences</name>
  <files>justfile (lines 200-400, 500-700)</files>
  <action>Compare install and vm-fresh recipes line-by-line. Document:
  - Identical code blocks (DRY violation candidates)
  - Divergent logic (normalization needed)
  - Missing functionality in either recipe
  - Hard-coded paths vs dynamic detection
  - Deploy key handling differences
  - Repo cloning logic differences
  - SOPS key management gaps
  Create comprehensive diff analysis showing what should be shared vs recipe-specific.</action>
  <verify>grep -A 50 "^install:" justfile && grep -A 50 "^vm-fresh:" justfile show clear comparison points</verify>
  <done>Complete diff analysis documented with specific line numbers and code blocks identified for DRY extraction</done>
</task>

<task type="auto">
  <name>Task 2: Document current state baseline and automation gaps</name>
  <files>.planning/phases/31-install-automation-audit/AUDIT-FINDINGS.md</files>
  <action>Create comprehensive audit document covering all 9 known issues:
  1. SOPS key management: How VM host keys currently handled (manual vs auto)
  2. Deploy keys: Current gh CLI usage, user vs root deployment
  3. Repo cloning: Current /persist detection, persistence verification
  4. Cache resolver: Network dependency status post-fix
  5. Chezmoi: Current deployment timing, auto-update workflow status
  6. Core services: Atuin/Syncthing/Tailscale OAuth current state
  7. Install normalization: Quantify code duplication percentage
  8. Commit automation: Current jj/git usage in auto-updates
  9. Testing: Current end-to-end test coverage gaps

  Include: Current behavior, expected behavior, gap analysis, priority (CRITICAL/HIGH/MEDIUM).
  Cross-reference with nixos-anywhere documentation for best practices.</action>
  <verify>cat .planning/phases/31-install-automation-audit/AUDIT-FINDINGS.md shows all 9 areas documented with specific gaps identified</verify>
  <done>AUDIT-FINDINGS.md exists with comprehensive gap analysis for all 9 audit areas, prioritized and cross-referenced with docs</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] AUDIT-FINDINGS.md exists and is comprehensive
- [ ] All 9 known issues documented with current vs expected state
- [ ] DRY violations quantified with specific line numbers
- [ ] install vs vm-fresh differences clearly documented
- [ ] Priorities assigned to each remediation area
</verification>

<success_criteria>
- All tasks completed
- AUDIT-FINDINGS.md provides clear roadmap for remaining 7 plans
- No audit area left undocumented
- Specific code locations identified for remediation
</success_criteria>

<output>
After completion, create `.planning/phases/31-install-automation-audit/31-01-SUMMARY.md`

# Phase 31 Plan 1: Current State Audit Summary

**Comprehensive audit of install automation completed with baseline documented**

## Accomplishments
- Complete diff analysis of install vs vm-fresh recipes
- All 9 audit areas documented in AUDIT-FINDINGS.md
- DRY violations quantified and prioritized
- Gap analysis completed with nixos-anywhere best practices

## Files Created/Modified
- `.planning/phases/31-install-automation-audit/AUDIT-FINDINGS.md` - Comprehensive audit findings

## Decisions Made
[Audit findings and prioritization decisions]

## Issues Encountered
[None expected - read-only analysis]

## Next Step
Ready for 31-02-PLAN.md (SOPS Key Management Automation)
</output>
