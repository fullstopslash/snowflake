---
phase: 31-install-automation-audit
type: execute
---

<objective>
Comprehensively audit and fix the SSH/GitHub authentication system to ensure deploy keys, user SSH keys, repository cloning, and chezmoi dotfiles deployment work correctly on fresh installs.

Purpose: Fix the broken SSH/GitHub authentication workflow on griefling where GitHub auth fails, repos don't clone, and dotfiles aren't deployed despite SOPS containing the necessary keys.
Output: Fully functional SSH/GitHub authentication system with all three repos cloned, user SSH key deployed, and chezmoi dotfiles deployed automatically on fresh installs.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
@~/.claude/skills/create-plans/references/checkpoints.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/31-install-automation-audit/31-09-SUMMARY.md
@modules/services/development/github-repos.nix
@modules/common/sops.nix
@modules/services/networking/openssh.nix
@justfile
@scripts/helpers.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Comprehensive SSH/GitHub Authentication System Audit</name>
  <files>.planning/phases/31-install-automation-audit/SSH-AUTH-AUDIT.md</files>
  <action>SSH into griefling (ssh -p 22222 rain@127.0.0.1) and perform comprehensive audit:

1. **SSH Key Locations Audit:**
   - Check if ~/.ssh/ directory exists: ls -la ~/.ssh/
   - Check if /root/.ssh/ exists: sudo ls -la /root/.ssh/
   - List all SSH keys in both locations
   - Check permissions on all keys (should be 600 for private, 644 for public)

2. **SOPS Secret Status:**
   - Verify SOPS secrets are decrypted: sudo ls -la /run/secrets/deploy-keys/
   - Check if deploy keys exist in secrets: sudo cat /run/secrets/deploy-keys/nix-config 2>&1 | head -1
   - Check if user SSH key exists in secrets: sudo cat /run/secrets/github-ssh-key 2>&1 | head -1 (or similar path)
   - Check SOPS service status: systemctl status sops-nix.service

3. **Systemd Service Status:**
   - Check github-repos-init service: systemctl status github-repos-init.service
   - View service logs: journalctl -u github-repos-init.service -n 50
   - Check if service ran: systemctl show github-repos-init.service | grep ExecMainStatus
   - Check service dependencies: systemctl list-dependencies github-repos-init.service

4. **Repository Status:**
   - Check nix-config: ls -la ~/nix-config/.git
   - Check nix-secrets: ls -la ~/nix-secrets/.git
   - Check chezmoi: ls -la ~/.local/share/chezmoi/.git
   - Check ownership: ls -ld ~/{nix-config,nix-secrets,.local/share/chezmoi} 2>/dev/null

5. **SSH Configuration:**
   - Check SSH config exists: cat ~/.ssh/config
   - Check for GitHub host aliases: grep "github.com-" ~/.ssh/config
   - Check SSH config permissions: ls -la ~/.ssh/config

6. **GitHub Authentication Test:**
   - Test personal SSH key: ssh -T git@github.com 2>&1
   - Test deploy key (nix-config): ssh -T git@github.com-nix-config 2>&1
   - Test deploy key (nix-secrets): ssh -T git@github.com-nix-secrets 2>&1
   - Test deploy key (chezmoi): ssh -T git@github.com-chezmoi 2>&1

7. **Module Configuration Audit:**
   - Check if github-repos module is enabled in host config
   - Verify SOPS defaultSopsFile is set
   - Check impermanence detection in openssh.nix

Document ALL findings in SSH-AUTH-AUDIT.md with:
- What exists vs what's expected
- Exact error messages from failed commands
- Service failure reasons
- Identified root causes
- Specific fixes needed

Exit griefling SSH session after audit complete.</action>
  <verify>SSH-AUTH-AUDIT.md exists with comprehensive findings and specific root causes identified</verify>
  <done>Complete audit document created with exact failure points and fix recommendations</done>
</task>

<task type="auto">
  <name>Task 2: Fix SSH Key Deployment Architecture</name>
  <files>modules/services/development/github-repos.nix, modules/common/sops.nix, hosts/griefling/default.nix, roles/form-vm.nix</files>
  <action>Based on Task 1 audit findings, fix the SSH key deployment system:

1. **Fix github-repos.nix Module:**
   - Change conditional from `lib.mkIf (config.sops.defaultSopsFile or null != null)` to explicit enable check
   - Ensure module is ALWAYS enabled when host has secrets
   - Fix impermanence detection to match openssh.nix logic (use config.disks.layout)
   - Add user personal SSH key deployment from shared.yaml: "github-ssh-key" → ~/.ssh/id_ed25519
   - Set proper permissions: 600 for private keys, 644 for public keys
   - Ensure SSH config includes BOTH deploy keys AND personal key configuration

2. **Update SSH Config Template:**
   Add user personal key configuration to programs.ssh.extraConfig:
   ```
   Host github.com
       HostName github.com
       User git
       IdentityFile ~/.ssh/id_ed25519
       StrictHostKeyChecking accept-new
   ```
   Keep existing per-repo deploy key aliases intact.

3. **Fix SOPS Secret Paths:**
   - Add user personal SSH key to sops.secrets in github-repos.nix:
     ```
     "github-ssh-key" = {
       sopsFile = "${sopsFolder}/shared.yaml";
       owner = primaryUser;
       path = "${homeDir}/.ssh/id_ed25519";
       mode = "0600";
     };
     ```
   - Ensure all deploy key paths use homeDir correctly

4. **Fix Module Enablement:**
   - Check if modules.services.development = [ "github-repos" ] is set in griefling config
   - If not, add it to roles/form-vm.nix as default for VMs
   - Ensure host has hostSpec.hasSecrets = true OR proper SOPS configuration

5. **Fix Systemd Service Dependencies:**
   - Ensure github-repos-init.service has proper After/Wants for sops-nix.service
   - Add ConditionPathExists for SOPS secret paths (wait for secrets to be decrypted)
   - Ensure service runs as correct user with proper HOME environment

CRITICAL: Test each change incrementally. Do NOT make changes that break existing working functionality. Add defensive checks for missing SOPS paths.</action>
  <verify>
- git diff shows changes to github-repos.nix, sops configuration
- Module explicitly enabled in VM role or griefling config
- SOPS secrets include both deploy keys AND user personal SSH key
- SSH config template includes all necessary GitHub configurations
  </verify>
  <done>SSH key deployment architecture fixed with proper SOPS paths, module enablement, and SSH configuration</done>
</task>

<task type="auto">
  <name>Task 3: Fix Repository Cloning & Chezmoi Deployment</name>
  <files>modules/services/development/github-repos.nix, modules/apps/terminal/chezmoi.nix</files>
  <action>Ensure all three repos clone correctly and chezmoi deploys dotfiles:

1. **Fix github-repos-init Service Script:**
   - Add better error reporting: echo specific errors when git clone fails
   - Add SSH debugging: GIT_SSH_COMMAND="ssh -v" for clone commands
   - Ensure service waits for network AND SOPS secrets to be ready
   - Add retry logic with exponential backoff (3 retries, 5/10/20 second delays)
   - Check that ~/.ssh/config exists before attempting clones
   - Verify deploy keys are readable before cloning

2. **Fix Repository Clone Logic:**
   Current script checks: [ ! -d ${homeDir}/nix-config/.git ]

   Add pre-clone verification:
   - Verify ~/.ssh/nix-config-deploy exists and is readable
   - Test SSH connection: ssh -o ConnectTimeout=5 git@github.com-nix-config 2>&1
   - Only attempt clone if SSH connection succeeds
   - Log failure reasons clearly to journalctl

3. **Add Chezmoi Deployment Automation:**
   Create new systemd service: chezmoi-init.service
   - Description: "Deploy chezmoi dotfiles on first boot"
   - After: github-repos-init.service
   - Wants: github-repos-init.service
   - ConditionPathExists: !${homeDir}/.chezmoi-deployed (marker file)
   - Script:
     ```bash
     # Wait for chezmoi repo to exist
     while [ ! -d ${homeDir}/.local/share/chezmoi/.git ]; do sleep 1; done

     # Initialize chezmoi and apply
     ${pkgs.chezmoi}/bin/chezmoi init
     ${pkgs.chezmoi}/bin/chezmoi apply --force

     # Create marker file
     touch ${homeDir}/.chezmoi-deployed
     ```
   - User: primaryUser
   - Group: users

4. **Add Comprehensive Service Logging:**
   - Log each step with timestamps
   - Log SSH key verification results
   - Log git clone output (both stdout and stderr)
   - Make logs easily accessible via journalctl

5. **Fix Ownership & Permissions:**
   - Ensure all cloned repos are owned by primaryUser:users
   - Ensure ~/.ssh/ directory is 700
   - Ensure ~/.ssh/config is 600
   - Ensure all private keys are 600

AVOID: Do NOT add chezmoi deployment if it already exists in another module. Check modules/apps/terminal/chezmoi.nix first and extend that if it exists.</action>
  <verify>
- github-repos-init.service has better error handling and logging
- Chezmoi deployment automation added (either new service or extending existing module)
- Service scripts include SSH connection verification before cloning
- Proper ownership and permissions set for all files
  </verify>
  <done>Repository cloning fixed with robust error handling, chezmoi deployment automated, proper permissions set</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete SSH/GitHub authentication system with deploy keys, user SSH key, repository cloning, and chezmoi deployment</what-built>
  <how-to-verify>
**Test on griefling VM:**

1. **Rebuild System:**
   ```bash
   # On your host machine
   cd ~/nix-config
   just rebuild-local

   # SSH into griefling
   ssh -p 22222 rain@127.0.0.1

   # Rebuild on griefling to apply fixes
   cd ~/nix-config
   sudo nixos-rebuild switch --flake .#griefling
   ```

2. **Verify SSH Keys Deployed:**
   ```bash
   # Check user SSH directory
   ls -la ~/.ssh/
   # Should show: id_ed25519, nix-config-deploy, nix-secrets-deploy, chezmoi-deploy, config

   # Verify permissions
   ls -l ~/.ssh/id_ed25519  # Should be -rw------- (600)
   ls -l ~/.ssh/*-deploy    # Should be -r-------- (400)
   ls -l ~/.ssh/config      # Should be -rw------- (600)
   ```

3. **Test GitHub Authentication:**
   ```bash
   # Test personal SSH key
   ssh -T git@github.com
   # Should show: "Hi fullstopslash! You've successfully authenticated..."

   # Test deploy keys
   ssh -T git@github.com-nix-config
   ssh -T git@github.com-nix-secrets
   ssh -T git@github.com-chezmoi
   # Each should show successful authentication
   ```

4. **Verify Repositories Cloned:**
   ```bash
   # Check all three repos exist
   ls -la ~/nix-config/.git
   ls -la ~/nix-secrets/.git
   ls -la ~/.local/share/chezmoi/.git

   # Test git operations
   cd ~/nix-config && git status
   cd ~/nix-secrets && git status
   cd ~/.local/share/chezmoi && git status
   ```

5. **Verify Chezmoi Dotfiles Deployed:**
   ```bash
   # Check for chezmoi-managed dotfiles
   ls -la ~/.zshrc ~/.config/

   # Verify chezmoi status
   chezmoi status
   # Should show dotfiles are applied
   ```

6. **Test Persistence Across Reboot:**
   ```bash
   sudo reboot
   # Wait for system to come back up

   # SSH back in
   ssh -p 22222 rain@127.0.0.1

   # Verify everything still exists
   ls -la ~/.ssh/
   ls -la ~/nix-config/.git ~/nix-secrets/.git ~/.local/share/chezmoi/.git
   ssh -T git@github.com
   ```

7. **Check Service Status:**
   ```bash
   systemctl status github-repos-init.service
   systemctl status chezmoi-init.service  # if created

   # Check logs for any errors
   journalctl -u github-repos-init.service -n 50
   journalctl -u chezmoi-init.service -n 50  # if created
   ```

**Expected Results:**
- ✅ All SSH keys present with correct permissions
- ✅ GitHub authentication works for both personal key and deploy keys
- ✅ All three repos cloned and git operations work
- ✅ Chezmoi dotfiles deployed
- ✅ Everything persists across reboot
- ✅ No service failures in logs
  </how-to-verify>
  <resume-signal>Type "verified" if all tests pass, or describe any failures you encounter</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] SSH-AUTH-AUDIT.md created with detailed findings
- [ ] github-repos.nix fixed with proper enablement and SOPS paths
- [ ] User personal SSH key deployed from SOPS shared.yaml
- [ ] All three repos clone successfully via systemd service
- [ ] Chezmoi dotfiles deploy automatically
- [ ] SSH authentication to GitHub works (personal key + deploy keys)
- [ ] All files have correct ownership and permissions
- [ ] System persists across reboot
- [ ] Services run without errors
</verification>

<success_criteria>
- All tasks completed
- SSH/GitHub authentication works end-to-end
- All three repos (nix-config, nix-secrets, chezmoi) cloned automatically
- Chezmoi dotfiles deployed on first boot
- User can authenticate to GitHub with personal SSH key
- Deploy keys work for repository operations
- All changes persist across reboot
- No manual intervention required after fresh install
- Human verification confirms all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/31-install-automation-audit/31-10-SUMMARY.md`:

# Phase 31-10: SSH/GitHub Authentication System Overhaul - SUMMARY

**Complete SSH/GitHub authentication system now works end-to-end with all repos cloned and dotfiles deployed**

## Accomplishments
- Comprehensive audit identified exact root causes
- Fixed SSH key deployment architecture (deploy keys + user personal key)
- Fixed repository cloning automation (all three repos)
- Added chezmoi dotfiles deployment automation
- Verified end-to-end functionality on griefling

## Files Created/Modified
- `.planning/phases/31-install-automation-audit/SSH-AUTH-AUDIT.md` - Detailed audit findings
- `modules/services/development/github-repos.nix` - Fixed module enablement, added user SSH key, improved service
- `modules/common/sops.nix` - [If modified for user SSH key paths]
- `hosts/griefling/default.nix` - [If module enablement added]
- `roles/form-vm.nix` - [If default module enablement added]
- [Any chezmoi-related files if deployment automation added]

## Decisions Made
- User personal SSH key deployed from shared.yaml to ~/.ssh/id_ed25519
- Deploy keys remain in per-host SOPS files, deployed to ~/.ssh/*-deploy
- SSH config includes both personal key and per-repo deploy key aliases
- Chezmoi deployment automated via [systemd service / module extension]
- [Any other architectural decisions made during implementation]

## Issues Encountered
- [Specific issues found during audit]
- [How they were resolved]
- [Any remaining edge cases to watch for]

## Next Step
[If this was the last pending plan: "Phase 31 complete - Install automation is production-ready"]
[Otherwise: "Ready for 31-08-PLAN.md - Final verification and testing"]
</output>
