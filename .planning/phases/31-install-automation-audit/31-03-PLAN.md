---
phase: 31-install-automation-audit
type: execute
---

<objective>
Normalize install and vm-fresh recipes to eliminate code duplication.

Purpose: Extract common logic into DRY shared functions so both recipes function identically with no divergent code paths.
Output: Refactored justfile with shared helper functions and both recipes using them.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/31-install-automation-audit/31-01-SUMMARY.md
@.planning/phases/31-install-automation-audit/31-02-SUMMARY.md
@.planning/phases/31-install-automation-audit/AUDIT-FINDINGS.md
@justfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract common install logic into shared helper functions</name>
  <files>justfile</files>
  <action>Create helper recipes (prefixed with _) for shared logic:
  - `_deploy-host-keys HOST`: Deploy deploy keys to both root and user
  - `_configure-ssh-github HOST`: Set up SSH config for github.com
  - `_clone-repos HOST PORT`: Clone nix-config, nix-secrets, chezmoi to correct location (/persist detection)
  - `_setup-sops-keys HOST`: Auto-extract, update .sops.yaml, rekey (from Plan 2)
  - `_detect-home-dir HOST`: Return /persist/home/$USER or /home/$USER based on /persist existence

  Each helper should:
  - Take HOST as parameter
  - Handle both encrypted (/persist) and regular hosts
  - Use jj for commits
  - Be idempotent (safe to run multiple times)

  Place these helpers before the install recipe definition.</action>
  <verify>just --list shows new helper recipes prefixed with underscore</verify>
  <done>All common logic extracted into reusable helper recipes with clear interfaces</done>
</task>

<task type="auto">
  <name>Task 2: Refactor vm-fresh to use shared helper functions</name>
  <files>justfile (vm-fresh recipe)</files>
  <action>Replace duplicated code blocks in vm-fresh with calls to helpers:
  - Replace deploy key logic → call `_deploy-host-keys {{HOST}}`
  - Replace SSH config setup → call `_configure-ssh-github {{HOST}}`
  - Replace repo cloning → call `_clone-repos {{HOST}} $SSH_PORT`
  - Replace SOPS setup → call `_setup-sops-keys {{HOST}}`

  Preserve vm-fresh-specific logic:
  - VM network setup
  - nixos-anywhere invocation with --no-substitute-on-destination
  - SSH port forwarding (22222)
  - VM-specific cache configuration

  Recipe should be significantly shorter, just orchestrating helpers.
  Test with: just vm-fresh griefling</action>
  <verify>just vm-fresh griefling --dry-run shows helper recipes being called</verify>
  <done>vm-fresh recipe refactored to use shared helpers, no duplicated code remains</done>
</task>

<task type="auto">
  <name>Task 3: Refactor install to use shared helper functions</name>
  <files>justfile (install recipe)</files>
  <action>Replace duplicated code blocks in install with same helper calls:
  - Replace deploy key logic → call `_deploy-host-keys {{HOST}}`
  - Replace SSH config setup → call `_configure-ssh-github {{HOST}}`
  - Replace repo cloning → call `_clone-repos {{HOST}} 22`
  - Replace SOPS setup → call `_setup-sops-keys {{HOST}}`

  Preserve install-specific logic:
  - Real hardware target ({{HOST}}.local)
  - Standard SSH port (22)
  - No VM-specific network setup

  Both recipes should now be nearly identical in structure, just differing in:
  - Target (VM vs real hardware)
  - Network config (port forwarding vs direct)
  - nixos-anywhere flags

  Verify DRY: Common logic should appear exactly once in helpers.</action>
  <verify>diff <(sed -n '/^vm-fresh:/,/^[a-z]/p' justfile) <(sed -n '/^install:/,/^[a-z]/p' justfile) shows only expected differences</verify>
  <done>install recipe refactored to use shared helpers, achieving perfect DRY with vm-fresh</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] just --list shows all helper recipes
- [ ] No code duplication between install and vm-fresh
- [ ] Both recipes tested (vm-fresh with griefling, install with test target if available)
- [ ] All helpers are idempotent and handle edge cases
- [ ] Helpers use jj for commits (not git)
</verification>

<success_criteria>
- All tasks completed
- Zero code duplication between recipes
- Both recipes function identically (modulo VM vs hardware differences)
- Clean helper abstraction with clear separation of concerns
- Both recipes significantly shorter and more maintainable
</success_criteria>

<output>
After completion, create `.planning/phases/31-install-automation-audit/31-03-SUMMARY.md`

# Phase 31 Plan 3: Install Recipe Normalization Summary

**Install and vm-fresh recipes normalized with DRY helper functions**

## Accomplishments
- Extracted all common logic into reusable helper recipes
- Refactored vm-fresh to use shared helpers
- Refactored install to use shared helpers
- Achieved perfect DRY with zero duplication

## Files Created/Modified
- `justfile` - Added helper recipes, refactored install and vm-fresh

## Decisions Made
[Helper recipe interfaces and parameter design]

## Issues Encountered
[Any edge cases discovered during refactoring]

## Next Step
Ready for 31-04-PLAN.md (Deploy Keys & GitHub Auth)
</output>
