---
phase: 03-host-spec-inheritance
plan: 01
type: execute
---

<objective>
Redesign host-spec.nix to support role-based defaults and streamlined host definitions.

Purpose: Simplify hostSpec so roles can set sensible defaults, and hosts only override what's different.
Output: Cleaned host-spec.nix with role-derived defaults and deprecated options removed.
</objective>

<execution_context>
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/02-role-system/02-04-SUMMARY.md
@modules/common/host-spec.nix
@modules/common/roles.nix
@roles/desktop.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clean up deprecated hostSpec options</name>
  <files>modules/common/host-spec.nix</files>
  <action>
Remove deprecated and redundant options from host-spec.nix:

1. **Remove `username`** - deprecated in favor of `primaryUsername`

2. **Remove boolean flags that duplicate role system:**
   - `isServer` - use `roles.server = true` instead
   - `isMobile` - handled by `roles.laptop` or `roles.tablet`
   - `isDevelopment` - not a device role; handle via modules

3. **Keep essential host-specific options:**
   - `primaryUsername` (required)
   - `hostName` (required)
   - `email` (user-specific)
   - `userFullName`, `handle` (user-specific)
   - `home` (computed from primaryUsername)
   - `persistFolder` (for impermanence)
   - `domain` (networking)
   - `networking` (host-specific network config)
   - `wifi` (hardware capability)
   - `users` (multi-user support)

4. **Keep configuration options that vary per host:**
   - `isMinimal` (for minimal installs)
   - `isProduction` (prod vs dev environments)
   - `isWork` (work-related configs)
   - `useYubikey` (hardware-specific)
   - Theme/display options: `theme`, `wallpaper`, `hdr`, `scaling`
   - Desktop options: `useWayland`, `useWindowManager`, `defaultBrowser`, `defaultEditor`, `defaultDesktop`
   - `useAtticCache`, `useNeovimTerminal`, `isAutoStyled`, `voiceCoding`

5. **Update assertions** to work with cleaned options.

6. **Update users default** to use `primaryUsername` instead of deprecated `username`.
  </action>
  <verify>nix-instantiate --parse modules/common/host-spec.nix</verify>
  <done>Deprecated options removed, hostSpec streamlined</done>
</task>

<task type="auto">
  <name>Task 2: Add role-derived defaults to hostSpec</name>
  <files>modules/common/host-spec.nix, roles/desktop.nix, roles/laptop.nix, roles/server.nix</files>
  <action>
Add sensible role-based defaults so hosts don't need to repeat common settings:

1. **In roles/desktop.nix, add hostSpec defaults:**
```nix
config = lib.mkIf cfg.desktop {
  # Existing config...

  # Desktop hostSpec defaults
  hostSpec = {
    useWayland = lib.mkDefault true;
    useWindowManager = lib.mkDefault true;
    isDevelopment = lib.mkDefault true;
  };
};
```

2. **In roles/laptop.nix, add:**
```nix
config = lib.mkIf cfg.laptop {
  # Laptop hostSpec defaults
  hostSpec = {
    wifi = lib.mkDefault true;
  };
};
```

3. **In roles/server.nix, add:**
```nix
config = lib.mkIf cfg.server {
  # Server hostSpec defaults
  hostSpec = {
    useWayland = lib.mkDefault false;
    useWindowManager = lib.mkDefault false;
    isProduction = lib.mkDefault true;
  };
};
```

4. **Ensure all defaults use lib.mkDefault** so hosts can override.
  </action>
  <verify>nix eval .#nixosConfigurations.roletest.config.hostSpec.useWayland --json (should not error)</verify>
  <done>Roles set sensible hostSpec defaults</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Deprecated hostSpec.username removed
- [ ] hostSpec.isServer, hostSpec.isMobile removed (use roles instead)
- [ ] Roles set hostSpec defaults with lib.mkDefault
- [ ] Existing hosts still evaluate without errors
</verification>

<success_criteria>
- hostSpec streamlined with unnecessary options removed
- Roles provide sensible hostSpec defaults
- All existing hosts continue to work (backward compatible)
- lib.mkDefault used so hosts can override role defaults
</success_criteria>

<output>
After completion, create `.planning/phases/03-host-spec-inheritance/03-01-SUMMARY.md`
</output>
