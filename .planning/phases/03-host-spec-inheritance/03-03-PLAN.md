---
phase: 03-host-spec-inheritance
plan: 03
type: execute
---

<objective>
Demonstrate minimal host pattern with a test host that inherits everything from its role.

Purpose: Validate the role inheritance system works end-to-end with a real minimal host definition.
Output: Test host with <20 lines of config that gets full desktop environment from role.
</objective>

<execution_context>
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-host-spec-inheritance/03-01-SUMMARY.md
@.planning/phases/03-host-spec-inheritance/03-02-SUMMARY.md
@hosts/nixos/roletest/default.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create minimal desktop test host</name>
  <files>hosts/nixos/minimaltest/default.nix</files>
  <action>
Create a new minimal host that demonstrates the role inheritance pattern:

**hosts/nixos/minimaltest/default.nix:**
```nix
{ lib, ... }:
{
  imports = [
    (lib.custom.relativeToRoot "hosts/common/core")
  ];

  # Just pick a role - everything else comes from inheritance
  roles.desktop = true;

  # Required: who is this machine for?
  hostSpec = {
    hostName = "minimaltest";
    primaryUsername = "rain";
  };

  # Required: hardware (would normally be hardware-configuration.nix)
  fileSystems."/" = {
    device = "/dev/sda1";
    fsType = "ext4";
  };
  boot.loader.grub.device = "/dev/sda";

  system.stateVersion = "25.05";
}
```

This host should:
- Be under 25 lines
- Inherit ALL desktop config from roles.desktop
- Get audio, fonts, hyprland, etc. without listing them
- Only specify what's unique to this host
  </action>
  <verify>nix eval .#nixosConfigurations.minimaltest.config.roles.desktop --json returns true</verify>
  <done>Minimal test host created</done>
</task>

<task type="auto">
  <name>Task 2: Verify role inheritance works</name>
  <files>none (verification task)</files>
  <action>
Verify the minimal host inherits everything from the desktop role:

1. **Check role is active:**
   ```bash
   nix eval .#nixosConfigurations.minimaltest.config.roles.desktop --json
   # Expected: true
   ```

2. **Check desktop services enabled:**
   ```bash
   nix eval .#nixosConfigurations.minimaltest.config.services.xserver.enable --json
   # Expected: true (from desktop role)

   nix eval .#nixosConfigurations.minimaltest.config.hardware.graphics.enable --json
   # Expected: true (from desktop role)
   ```

3. **Check modules enabled (if enable-gated pattern used):**
   ```bash
   nix eval .#nixosConfigurations.minimaltest.config.modules.audio.enable --json
   # Expected: true (from desktop role)
   ```

4. **Check hostSpec defaults from role:**
   ```bash
   nix eval .#nixosConfigurations.minimaltest.config.hostSpec.useWayland --json
   # Expected: true (default from desktop role)
   ```

Document all working inheritance points.
  </action>
  <verify>All eval commands return expected values</verify>
  <done>Role inheritance verified working</done>
</task>

<task type="auto">
  <name>Task 3: Document host override pattern</name>
  <files>hosts/nixos/minimaltest/default.nix</files>
  <action>
Add examples showing hosts can override role defaults:

```nix
{ lib, ... }:
{
  imports = [
    (lib.custom.relativeToRoot "hosts/common/core")
  ];

  roles.desktop = true;

  hostSpec = {
    hostName = "minimaltest";
    primaryUsername = "rain";

    # Override role defaults when needed:
    # useWayland = false;  # Use X11 instead
    # theme = "nord";      # Different theme
  };

  # Override module defaults:
  # modules.gaming.enable = false;  # No gaming on this machine

  # Hardware
  fileSystems."/" = { device = "/dev/sda1"; fsType = "ext4"; };
  boot.loader.grub.device = "/dev/sda";

  system.stateVersion = "25.05";
}
```

Test that overrides work:
```bash
# Add useWayland = false to hostSpec, then:
nix eval .#nixosConfigurations.minimaltest.config.hostSpec.useWayland --json
# Should return: false (override wins)
```
  </action>
  <verify>Override pattern documented and tested</verify>
  <done>Host override capability verified</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 3 Host-Spec & Inheritance: streamlined hostSpec, role-based inheritance, minimal host pattern</what-built>
  <how-to-verify>
    1. Check hostSpec is cleaner:
       - grep -c "username" modules/common/host-spec.nix
       - Should NOT have deprecated `username` option (only `primaryUsername`)

    2. Check minimal test host:
       - cat hosts/nixos/minimaltest/default.nix
       - Should be under 30 lines
       - Should only have role, hostSpec, hardware, stateVersion

    3. Verify inheritance:
       nix eval .#nixosConfigurations.minimaltest.config.roles.desktop
       # true

       nix eval .#nixosConfigurations.minimaltest.config.services.xserver.enable
       # true (inherited from desktop role)

    4. Verify override capability:
       - Temporarily add `hostSpec.useWayland = false;` to minimaltest
       - Eval should return false instead of true

    5. Compare to verbose host:
       - wc -l hosts/nixos/genoa/default.nix
       - wc -l hosts/nixos/minimaltest/default.nix
       - Minimal host should be much smaller
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 3, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Minimal test host created (<30 lines)
- [ ] roles.desktop = true provides full desktop environment
- [ ] hostSpec defaults come from role
- [ ] Host can override role defaults
- [ ] Pattern documented for future hosts
</verification>

<success_criteria>
- A new host can be created in under 10 minutes (just copy minimal template)
- Host file contains only: role, username, hostname, hardware, quirks
- Everything else inherited from role
- Override capability preserved for edge cases
</success_criteria>

<output>
After completion, create `.planning/phases/03-host-spec-inheritance/03-03-SUMMARY.md`

Include:
- Line count comparison (verbose host vs minimal host)
- All verified inheritance points
- Override pattern examples
- "Add a new machine" workflow
</output>
