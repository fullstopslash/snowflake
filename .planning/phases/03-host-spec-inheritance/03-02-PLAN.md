---
phase: 03-host-spec-inheritance
plan: 02
type: execute
---

<objective>
Create automatic module resolution so roles import the right modules, eliminating manual imports in host files.

Purpose: Hosts should only need `roles.desktop = true` to get all desktop modules - no manual imports.
Output: Role files import appropriate modules; hosts/common/optional content merged into module system.
</objective>

<execution_context>
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-host-spec-inheritance/03-01-SUMMARY.md
@roles/desktop.nix
@roles/laptop.nix
@hosts/common/optional/
@modules/apps/
@modules/services/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit hosts/common/optional vs modules/</name>
  <files>hosts/common/optional/</files>
  <action>
Compare hosts/common/optional/ content with modules/ to identify:

1. **Already migrated** - modules that exist in modules/ and can be removed from optional/
2. **Need migration** - useful modules in optional/ not yet in modules/
3. **Host-specific** - configs that should stay in hosts/common/ (hardware quirks, etc.)

Create a migration plan:
- List files in hosts/common/optional/
- Check if equivalent exists in modules/
- Determine if optional file adds value beyond module

Key files to analyze:
- bluetooth.nix, openssh.nix, printing.nix (services)
- audio.nix, fonts.nix, gaming.nix (apps)
- hyprland.nix, wayland.nix (desktop)
- stylix.nix, plymouth.nix (theming)
- wifi.nix, yubikey.nix (hardware)
  </action>
  <verify>Document findings in task output</verify>
  <done>Audit complete - know what to migrate vs keep</done>
</task>

<task type="auto">
  <name>Task 2: Enhance roles to import hosts/common/optional modules</name>
  <files>roles/desktop.nix, roles/laptop.nix</files>
  <action>
Update role files to import the appropriate hosts/common/optional modules:

**roles/desktop.nix** - add desktop-relevant optional imports:
```nix
imports = [
  # Existing module imports...

  # From hosts/common/optional (desktop-relevant)
  ../hosts/common/optional/audio.nix
  ../hosts/common/optional/fonts.nix
  ../hosts/common/optional/hyprland.nix
  ../hosts/common/optional/wayland.nix
  ../hosts/common/optional/stylix.nix
  ../hosts/common/optional/thunar.nix
  ../hosts/common/optional/services/greetd.nix
];
```

**roles/laptop.nix** - add laptop-specific imports:
```nix
imports = [
  # Desktop role content (laptop extends desktop)
  ./desktop.nix

  # Laptop-specific
  ../hosts/common/optional/wifi.nix
  ../hosts/common/optional/services/bluetooth.nix
];
```

**Note:** Use lib.mkIf in optional modules themselves so they only activate when enabled. OR ensure optional modules have enable options that roles set to true.
  </action>
  <verify>nix flake check --no-build</verify>
  <done>Roles import appropriate optional modules</done>
</task>

<task type="auto">
  <name>Task 3: Convert optional modules to enable-gated modules</name>
  <files>hosts/common/optional/*.nix</files>
  <action>
Where needed, convert optional modules to use enable options so they can be imported but only activate when enabled:

Example pattern for hosts/common/optional/audio.nix:
```nix
{ config, lib, pkgs, ... }:
let
  cfg = config.modules.audio;
in {
  options.modules.audio.enable = lib.mkEnableOption "Audio support";

  config = lib.mkIf cfg.enable {
    # Existing audio config...
  };
}
```

Then in roles/desktop.nix:
```nix
config = lib.mkIf cfg.desktop {
  modules.audio.enable = lib.mkDefault true;
  # ...
};
```

This allows:
1. All modules to be imported by roles (no evaluation errors)
2. Roles to enable relevant modules with defaults
3. Hosts to override (disable specific modules if needed)

Apply this pattern to key optional modules:
- audio.nix
- bluetooth.nix (services)
- gaming.nix
- hyprland.nix
- wayland.nix
- wifi.nix
  </action>
  <verify>nix eval .#nixosConfigurations.roletest.config.modules --json (should show module options)</verify>
  <done>Optional modules converted to enable-gated pattern</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Key optional modules converted to enable-gated pattern
- [ ] Roles import and enable appropriate modules
- [ ] A minimal host using roles.desktop gets audio, fonts, hyprland, etc. automatically
- [ ] Hosts can still override with enable = false
</verification>

<success_criteria>
- `roles.desktop = true` automatically enables audio, fonts, hyprland, gaming, etc.
- `roles.laptop = true` adds wifi, bluetooth to desktop set
- Manual imports in host files drastically reduced
- Override capability preserved (host can disable modules)
</success_criteria>

<output>
After completion, create `.planning/phases/03-host-spec-inheritance/03-02-SUMMARY.md`
</output>
