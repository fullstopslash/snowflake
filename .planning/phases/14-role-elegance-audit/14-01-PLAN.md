# Phase 14-01: Role Elegance Fixes

## Objective

Remove redundant direct `.enable` statements from roles that should use the unified module selection system. Ensure roles ONLY use `modules.<top>.<category> = [ "name" ]` for enabling functionality, with direct NixOS options reserved for hardware/boot config that has no corresponding module.

## Context

@file:roles/form-pi.nix
@file:roles/form-server.nix
@file:roles/task-test.nix
@file:modules/selection.nix

## Background

The filesystem-driven module selection system (Phase 13) established:
- `modules.services.<category> = [ "name" ]` enables `modules/services/<category>/<name>.nix`
- `extraModules` provides additive selection in hosts
- Roles should use `modules.*` for all module enables

Audit found inconsistencies where roles still use:
1. Direct NixOS enables (`services.openssh.enable`) alongside module selection
2. Direct `myModules.*.enable` instead of selection syntax

## Tasks

### Task 1: Remove redundant openssh enable from form-pi.nix
- **type**: edit
- **file**: `roles/form-pi.nix`
- **action**: Remove line 30 (`services.openssh.enable = lib.mkDefault true;`)
- **reason**: Line 20 already selects `modules.services.networking = [ "openssh" ]` which enables the module
- **verify**: `grep -n "openssh" roles/form-pi.nix` shows only the module selection line

### Task 2: Fix form-server.nix to use module selection
- **type**: edit
- **file**: `roles/form-server.nix`
- **action**:
  1. Add `modules.services.networking = [ "openssh" ];` to MODULE SELECTIONS section
  2. Remove line 32 (`services.openssh.enable = lib.mkDefault true;`)
- **verify**: `grep -n "openssh" roles/form-server.nix` shows only module selection

### Task 3: Convert task-test.nix to use module selection
- **type**: edit
- **file**: `roles/task-test.nix`
- **action**:
  1. Add MODULE SELECTIONS section with:
     ```nix
     modules = {
       services = {
         cli = [ "atuin" ];
         networking = [ "syncthing" ];
       };
     };
     ```
  2. Remove lines 33, 36 (direct `myModules.*.enable` statements)
  3. Keep line 30 (`myModules.services.nixConfigRepo.enable`) as nixConfigRepo is in `modules/common/` not `modules/services/`
- **verify**: `grep -n "myModules" roles/task-test.nix` shows only nixConfigRepo

## Verification

```bash
# No direct service enables in roles (except legitimate hardware/boot)
grep -rn "services\.\w\+\.enable\s*=" roles/*.nix | grep -v "xserver\|thermald\|power-profiles\|libinput\|qemuGuest\|spice"

# No direct myModules enables in roles (except common/ modules)
grep -rn "myModules\.\w\+\.\w\+\.enable" roles/*.nix | grep -v "nixConfigRepo"

# Build test
nix build .#nixosConfigurations.griefling.config.system.build.toplevel --dry-run
```

## Success Criteria

1. All roles use `modules.<top>.<category> = [ "name" ]` syntax for service enables
2. No redundant direct NixOS enables for services that have module wrappers
3. Direct `myModules.*.enable` only used for modules outside the selection system (e.g., `modules/common/`)
4. Configuration builds successfully

## Output

Create `14-01-SUMMARY.md` documenting:
- Files modified with line-level changes
- Verification results
- Any issues discovered
