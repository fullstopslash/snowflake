# Plan 16-01: Fix ISO Install Commands and VM Testing

## Objective

Fix the broken disko command in ISO bash history and create a one-command VM test workflow using nixos-anywhere from the host machine.

## Context

@hosts/nixos/iso/default.nix - ISO configuration with broken bash history
@scripts/test-fresh-install.sh - VM testing script (needs nixos-anywhere integration)
@scripts/bootstrap-nixos.sh - Reference for correct nixos-anywhere usage
@hosts/common/disks/ - Disko configurations
@justfile - Task automation

## Research Findings

The current ISO bash history has:
- Wrong path: `./disks/btrfs-luks-impermanence-disko.nix` (doesn't exist)
- Correct path: `hosts/common/disks/btrfs-luks-impermanence-disk.nix`
- Missing LUKS password setup (`/tmp/disko-password`)

The `bootstrap-nixos.sh` script is the gold standard - uses nixos-anywhere correctly.

For VM testing, nixos-anywhere from host is simpler than manual ISO commands.

## Tasks

### Task 1: Fix ISO bash history
**Type:** edit
**Files:** hosts/nixos/iso/default.nix
**Action:**
Update the bash history commands to be correct:
```nix
"skel/.bash_history" = {
  text = ''
    nix flake show /etc/nix-config
    cd /etc/nix-config && sudo nixos-install --flake .#griefling --no-root-passwd
    echo "your-luks-passphrase" | sudo tee /tmp/disko-password && cd /etc/nix-config && sudo nix --experimental-features "nix-command flakes" run github:nix-community/disko -- --mode format,mount hosts/common/disks/btrfs-luks-impermanence-disk.nix --arg disk '"/dev/vda"'
  '';
};
```

Note: The disko command now:
- Uses correct path
- Uses `--mode format,mount` (formats and mounts)
- Includes password setup inline

**Verify:** `nix build --impure .#nixosConfigurations.iso.config.system.build.isoImage` succeeds

### Task 2: Add nixos-anywhere mode to test-fresh-install.sh
**Type:** edit
**Files:** scripts/test-fresh-install.sh
**Action:**
The script already has `--anywhere` flag but may need fixes. Update the nixos-anywhere invocation to:
1. Wait for VM SSH to be available
2. Run nixos-anywhere with correct flags
3. Use the flake from the repo (not GitHub)

Reference bootstrap-nixos.sh for correct invocation:
```bash
nix run github:nix-community/nixos-anywhere -- \
  --ssh-port "$SSH_PORT" \
  --flake ".#${HOSTNAME}" \
  root@127.0.0.1
```

**Verify:** `./scripts/test-fresh-install.sh griefling --anywhere --force` completes successfully

### Task 3: Update justfile with one-command test recipes
**Type:** edit
**Files:** justfile
**Action:**
Add/update recipes:
```just
# One-command fresh install test via nixos-anywhere (fully automated)
test-install HOST=DEFAULT_VM_HOST:
  ./scripts/test-fresh-install.sh {{HOST}} --anywhere --force

# Interactive fresh install test (boots ISO, user runs commands)
test-install-manual HOST=DEFAULT_VM_HOST:
  ./scripts/test-fresh-install.sh {{HOST}} --gui --force
```

**Verify:** `just test-install griefling` runs one-command automated install

## Verification

1. ISO builds successfully with corrected bash history
2. `just test-install griefling` performs one-command automated VM install
3. After install, VM boots into griefling NixOS (not ISO)
4. SSH works: `ssh -p 22222 root@127.0.0.1`

## Success Criteria

- [ ] ISO bash history has correct disko path and includes password setup
- [ ] test-fresh-install.sh --anywhere mode works end-to-end
- [ ] One-command install: `just test-install griefling`
- [ ] VM boots into installed system after nixos-anywhere completes

## Output

Create SUMMARY.md documenting:
- What was broken (wrong paths, missing password)
- What was fixed
- The new one-command workflow
- Any deviations from plan
