# Phase 4 Plan 4: Shared Secrets & Multi-Host Access

## Context

Some secrets need to be shared across multiple hosts:
- SSH CA keys for host authentication
- Shared service credentials (e.g., backup server access)
- Family/shared passwords
- VPN configurations

Currently `shared.yaml` exists but isn't well integrated with the role system.

## Goal

Implement shared secrets that multiple hosts can access, with role-based access control.

## Tasks

### 1. Define shared secret categories
- [ ] `shared-infra` - Infrastructure secrets (backup credentials, monitoring)
- [ ] `shared-network` - VPN configs, wifi passwords all devices need
- [ ] `shared-family` - Shared family credentials
- [ ] Map categories to roles that need them

### 2. Update .sops.yaml creation rules
- [ ] shared.yaml should be decryptable by all hosts
- [ ] Category-specific shared files for role-limited access
- [ ] Ensure bootstrap adds new hosts to shared rules

### 3. Implement shared secrets in Nix
- [ ] `hosts/common/core/sops/shared.nix` - Load shared secrets
- [ ] Conditionally load based on role/host-spec
- [ ] Handle case where host doesn't have shared access yet

### 4. Document shared secrets workflow
- [ ] How to add a secret all hosts should access
- [ ] How to add a secret only certain roles access
- [ ] How to grant a specific host access to shared secrets

## Success Criteria

- Shared secrets work across roles
- New hosts automatically added to shared.yaml access
- Role-based filtering for sensitive shared secrets
- Clear documentation

## Files to Create/Modify

- `hosts/common/core/sops/shared.nix` - Shared secrets loader
- `scripts/helpers.sh` - Update `sops_add_shared_creation_rules`
- Documentation in `docs/secrets.md`
