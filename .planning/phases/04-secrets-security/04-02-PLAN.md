# Phase 4 Plan 2: Role-Based Secrets Structure

## Context

Different roles need different secrets:
- Desktop: user passwords, ssh keys, maybe yubikey
- Server: service credentials, API keys, database passwords
- Laptop: desktop secrets + wifi passwords
- Minimal/ISO: no secrets

Currently secrets are ad-hoc per host. We want role defaults with host overrides.

## Goal

Create role-based secrets structure where roles declare which secret categories they need.

## Tasks

### 1. Define secret categories
- [ ] `base` - user password, ssh keys (all roles except minimal)
- [ ] `desktop` - application secrets (browser sync, etc)
- [ ] `server` - service credentials (nginx certs, db passwords)
- [ ] `network` - wifi passwords, VPN configs
- [ ] `hardware` - yubikey, TPM secrets

### 2. Update sops module structure
- [ ] Create `hosts/common/core/sops/` directory structure:
  - `default.nix` - main sops config with category conditionals
  - `base.nix` - base secrets (passwords, ssh)
  - `desktop.nix` - desktop app secrets
  - `server.nix` - server service secrets
  - `network.nix` - network secrets
- [ ] Each category checks relevant host-spec flags

### 3. Update roles to set secret categories
- [ ] Desktop role: base + desktop + network
- [ ] Laptop role: desktop + network
- [ ] Server role: base + server
- [ ] VM/Test role: base only
- [ ] Minimal role: none

### 4. Document secrets structure
- [ ] Document which secrets each category includes
- [ ] Document how to add new secrets to appropriate category
- [ ] Document host-specific secret overrides

## Success Criteria

- Roles automatically enable appropriate secret categories
- Adding a new desktop host automatically gets desktop secrets
- Server hosts don't get desktop secrets they don't need
- Clear separation of secret categories

## Files to Create/Modify

- `hosts/common/core/sops/default.nix` - Main orchestrator
- `hosts/common/core/sops/base.nix` - Base secrets
- `hosts/common/core/sops/desktop.nix` - Desktop secrets
- `hosts/common/core/sops/server.nix` - Server secrets
- `hosts/common/core/sops/network.nix` - Network secrets
- `roles/*.nix` - Enable appropriate categories
