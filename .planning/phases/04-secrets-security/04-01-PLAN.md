# Phase 4 Plan 1: Audit & Fix Current SOPS Setup

## Context

The repo already has extensive sops-nix infrastructure:
- `hosts/common/core/sops.nix` - System-level sops config
- `home/common/optional/sops.nix` - Home-manager sops config
- `scripts/bootstrap-nixos.sh` - Bootstrap script with age key generation
- `scripts/helpers.sh` - SOPS helper functions for key management

However, there are gaps:
1. Some hosts have broken sops configs (missing secrets, undefined attributes)
2. No role-based secrets integration
3. Bootstrap process is manual-heavy

## Goal

Audit current sops setup, fix broken configs, ensure all hosts evaluate with sops enabled.

## Tasks

### 1. Audit sops.nix modules
- [ ] Read `hosts/common/core/sops.nix` - check for hardcoded paths, missing conditionals
- [ ] Read `modules/services/security/sops.nix` - verify integration with host-spec
- [ ] Read `home/common/optional/sops.nix` - check home-manager integration
- [ ] Identify any secrets referenced that don't exist

### 2. Fix evaluation errors
- [ ] Check which hosts import sops and which fail evaluation
- [ ] Add proper conditionals for optional secrets (yubikey, specific services)
- [ ] Ensure sops module gracefully handles missing per-host secrets files

### 3. Add host-spec integration
- [ ] Add `hostSpec.hasSecrets` option to enable/disable sops per host
- [ ] Roles should set sensible defaults (desktop: true, minimal: false)
- [ ] ISO should explicitly disable sops

### 4. Verify evaluation
- [ ] All hosts should evaluate without sops-related errors
- [ ] Hosts without nix-secrets access should still build (graceful fallback)

## Success Criteria

- All hosts in flake evaluate successfully
- sops configuration is conditional based on host-spec
- Clear documentation of which secrets each role/host needs

## Files to Modify

- `modules/common/host-spec.nix` - Add hasSecrets option
- `hosts/common/core/sops.nix` - Add conditionals
- `home/common/optional/sops.nix` - Add conditionals
- `roles/*.nix` - Set hasSecrets defaults
- `hosts/nixos/iso/default.nix` - Disable sops
