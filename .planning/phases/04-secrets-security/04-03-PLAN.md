# Phase 4 Plan 3: Bootstrap & Key Management

## Context

The current bootstrap process in `scripts/bootstrap-nixos.sh` handles:
1. nixos-anywhere installation
2. SSH host key generation
3. Age key derivation from SSH keys
4. User age key generation
5. .sops.yaml updates

This works but has friction points:
- Manual steps required
- Age key stored in nix-secrets but extraction is manual
- New host setup requires multiple script invocations

## Goal

Streamline bootstrap so adding a new machine is < 10 minutes with minimal manual steps.

## Tasks

### 1. Review and document current bootstrap flow
- [ ] Document exact steps from ISO boot to working secrets
- [ ] Identify manual intervention points
- [ ] Identify failure modes

### 2. Improve age key extraction
- [ ] Ensure `sops.age.keyFile` is auto-created from host secrets
- [ ] Add fallback if host.yaml doesn't exist yet
- [ ] Verify home-manager can access keys after first activation

### 3. Create bootstrap verification script
- [ ] Script to verify sops is working after bootstrap
- [ ] Check: age key exists and is valid
- [ ] Check: can decrypt host secrets
- [ ] Check: home-manager sops activated
- [ ] Integrate with existing `scripts/check-sops.sh`

### 4. Document streamlined bootstrap workflow
- [ ] Step-by-step guide for adding new host
- [ ] Checklist for required nix-secrets updates
- [ ] Troubleshooting common issues

### 5. Add role-aware bootstrap hints
- [ ] Desktop: needs display manager secrets?
- [ ] Server: needs service credentials before first boot?
- [ ] Generate minimal host.yaml template based on role

## Success Criteria

- New host from ISO to working sops in < 10 minutes
- Single script handles all age key setup
- Clear error messages if secrets missing
- Documentation covers common scenarios

## Files to Modify

- `scripts/bootstrap-nixos.sh` - Streamline flow
- `scripts/check-sops.sh` - Enhance verification
- `hosts/common/core/sops.nix` - Add fallbacks
- `docs/bootstrap.md` - Create/update documentation
