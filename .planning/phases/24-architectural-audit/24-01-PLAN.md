# Phase 24: Architectural Compliance Audit

## Objective

Conduct comprehensive audit of /modules, /roles, and /hosts to verify conformance with architectural style guidelines established in Phase 23 and identify violations requiring remediation.

## Context

After Phase 23 successfully eliminated `/modules/common/host.nix` and established proper separation of concerns, this audit verifies that the entire codebase conforms to the three-tier architecture:

- **Modules**: Universal functionality (125 files)
- **Roles**: Presets with role-appropriate defaults (14 files)
- **Hosts**: Identity layer only (8+ configurations)

## Architectural Guidelines

### /modules Guidelines
- **Purpose**: Individual units of functionality (services, apps, etc.)
- **Content**: Universal, reusable code organized by software/service
- **Settings**: Modular and reusable across any role/host
- **Preference**: Preferred method for setting anything
- **Organization**: By software/service category

### /roles Guidelines
- **Purpose**: Presets configuring modules + role-appropriate defaults
- **Types**:
  - Task-focused: desktop, mediacenter, dev, test
  - Form-based: vm, laptop, tablet, raspi, server, darwin
- **Behavior**:
  - Call modules and set defaults (using lib.mkDefault)
  - Can set form-factor specifics (touchscreen, boot loader)
  - Should NOT duplicate module functionality
  - Should NOT contain host-specific settings

### /hosts Guidelines
- **Purpose**: Identity layer - what makes each host unique
- **Content**:
  - hardware-configuration.nix (generated)
  - default.nix (~10-50 lines ideally)
  - Host-specific files (e.g., audio-tuning.nix)
- **Settings**:
  - Identity: hostname, users, role selection
  - Hardware facts: specific to this machine
  - All other settings delegated to modules/roles

## Audit Phases

### Phase 1: Automated Checks

#### 1.1 Hardcoded Values in Modules

**Critical Violation**: Modules with hardcoded usernames

```bash
# Check for hardcoded usernames
grep -rn 'User = "rain"' modules/
grep -rn '"rain"' modules/ --exclude-dir=users
```

**Expected Violations**:
- `modules/services/audio/pipewire.nix:54` - `User = "rain"`
- `modules/theming/stylix.nix:161` - `User = "rain"`

**Critical Violation**: Hardcoded IP addresses

```bash
# Check for hardcoded IPs
grep -rn '[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}' modules/
```

**Expected Violations**:
- `modules/services/networking/tailscale.nix:63,70` - `192.168.86.0/24`
- `modules/services/networking/sinkzone.nix:47` - `192.168.86.82`

**Moderate Violation**: Hardcoded paths

```bash
# Check for hardcoded home paths
grep -rn '/home/rain' modules/
```

#### 1.2 Role-Specific Logic in Modules

```bash
# Modules should NOT check config.roles
grep -rn 'config\.roles' modules/

# Modules should NOT check hostName (host-specific)
grep -rn 'identity\.hostName' modules/ | grep -v "# " | grep -v "description"
```

#### 1.3 Module-Level Functionality in Roles

```bash
# Roles should NOT define options
grep -rn 'mkOption\|mkEnableOption' roles/ | grep -v "# " | grep -v default.nix

# Roles should NOT directly configure services
grep -rn 'environment\.systemPackages' roles/
```

**Expected Findings**:
- `roles/task-fast-test.nix` may have `environment.systemPackages`

#### 1.4 Host File Size Check

```bash
# Hosts should be ~10-50 lines (max 80, excluding hardware-configuration.nix)
find hosts -name "default.nix" -exec wc -l {} \; | awk '{if ($1 > 80) print}'
```

**Expected Findings**:
- `iso/default.nix` (178 lines) - Special case: ISO builder
- `anguish/default.nix` (76 lines) - Borderline
- `template/default.nix` (80 lines) - Mostly comments

#### 1.5 Proper Option Namespacing

```bash
# No deprecated config.host.* references
grep -rn 'config\.host\.' . --exclude-dir=.planning

# Verify myModules.* namespace
grep -rn 'options\.' modules/apps/ | grep -v myModules
grep -rn 'options\.' modules/services/ | grep -v myModules
```

### Phase 2: Manual Review Areas

#### 2.1 Module Scope Review

**Checklist per module**:
- [ ] Universal/reusable code only?
- [ ] No hardcoded hostnames, usernames, paths?
- [ ] No role-specific conditionals?
- [ ] Proper options with types and descriptions?
- [ ] No host-specific configuration?

**Priority Modules**:
1. `modules/services/audio/pipewire.nix` - Hardcoded username
2. `modules/theming/stylix.nix` - Hardcoded username
3. `modules/services/networking/tailscale.nix` - Hardcoded network
4. `modules/services/networking/sinkzone.nix` - Hardcoded IP
5. `modules/services/desktop/common.nix` - Complex
6. `modules/common/golden-generation.nix` (435 lines) - Verify scope
7. `modules/common/auto-upgrade.nix` (365 lines) - Verify scope
8. `modules/services/storage/borg.nix` (557 lines) - Verify scope

#### 2.2 Role Purity Review

**Checklist per role**:
- [ ] Sets only defaults (lib.mkDefault)?
- [ ] No module-level functionality?
- [ ] No host-specific settings?
- [ ] Proper form vs task separation?
- [ ] Uses modules.* selection?
- [ ] Appropriate secret categories?

**Priority Roles**:
1. `roles/task-fast-test.nix` - Check for inline packages
2. `roles/form-vm.nix` - Boot config (verify acceptable)
3. `roles/form-pi.nix` - Boot config (verify acceptable)

#### 2.3 Host Minimalism Review

**Checklist per host**:
- [ ] Total lines ≤ 80 (excluding hardware-configuration.nix)?
- [ ] Only identity, roles, disk config, hardware quirks?
- [ ] No service configurations?
- [ ] No package lists?
- [ ] lib.mkForce only for overrides?

**Priority Hosts**:
1. `hosts/iso/default.nix` (178 lines) - Special case
2. `hosts/anguish/default.nix` (76 lines) - Service disables
3. `hosts/sorrow/default.nix` (67 lines) - Service disables

**Anti-Pattern Check**:
```bash
# Hosts disabling services (should be role concern)
grep -rn 'lib\.mkForce false' hosts/*/default.nix
```

### Phase 3: Cross-Cutting Concerns

#### 3.1 Duplicate Functionality Detection

```bash
# Find modules with similar names
find modules -name "*.nix" | sort | uniq -c | awk '{if ($1 > 1) print}'

# Check for duplicate package definitions
grep -rh 'environment\.systemPackages.*=' modules/ | sort | uniq -c | awk '{if ($1 > 3) print}'
```

**Manual Review**:
- Compare `modules/apps/cli/tools-core.nix` vs `tools-full.nix`
- Review display-manager modules for duplication
- Check networking modules for overlap

#### 3.2 Separation of Concerns Violations

**Identity Mixing**:
- Modules checking `identity.hostName` → VIOLATION (parameterize)
- Modules using `identity.primaryUsername` → ACCEPTABLE
- Modules hardcoding usernames → CRITICAL

**Platform Mixing**:
- Modules checking `system.isDarwin` → ACCEPTABLE
- Modules checking `system.architecture` → ACCEPTABLE
- Roles setting platform → ACCEPTABLE (form roles)

**Hardware Mixing**:
- Modules checking `hardware.host.wifi` → ACCEPTABLE
- Roles setting hardware.host.wifi → ACCEPTABLE (form roles)
- Hosts setting hardware configs → ACCEPTABLE

**Preference Mixing**:
- Modules defining preferences → Via myModules.* options
- Roles setting preferences → Via myModules.* options
- Hosts setting preferences → ACCEPTABLE (overrides)

#### 3.3 Option Namespace Consistency

```bash
# All app modules should use myModules.apps.*
find modules/apps -name "*.nix" -exec grep -l "options\." {} \; | while read f; do
  if ! grep -q "myModules\.apps\." "$f"; then
    echo "Missing myModules.apps namespace: $f"
  fi
done

# All service modules should use myModules.services.*
find modules/services -name "*.nix" -exec grep -l "options\." {} \; | while read f; do
  if ! grep -q "myModules\.services\." "$f"; then
    echo "Missing myModules.services namespace: $f"
  fi
done
```

## Findings Categorization System

### Critical Violations (Fix Immediately)

**Definition**: Major architectural violations breaking reusability

**Examples**:
- Hardcoded usernames in modules
- Hardcoded hostnames in modules
- Hardcoded secrets/passwords
- Modules checking config.roles
- Host-specific logic in modules

**Impact**: HIGH - Non-reusable, brittle, insecure

### Moderate Issues (Fix Soon)

**Definition**: Guideline violations but system works

**Examples**:
- Hardcoded IP addresses
- Hardcoded paths (should use identity.home)
- Roles defining options
- Hosts >80 lines
- Duplicate code

**Impact**: MEDIUM - Reduces maintainability

### Minor Improvements (Fix When Convenient)

**Definition**: Not violations but could improve

**Examples**:
- Missing option descriptions
- Inconsistent naming
- Modules lacking myModules namespace
- Overly complex modules
- Missing type definitions

**Impact**: LOW - Code quality

### Best Practices (Learn From)

**Definition**: Examples of correct implementation

**Examples**:
- `modules/common/identity.nix` - Clean options
- `modules/common/platform.nix` - Proper separation
- `hosts/malphas/audio-tuning.nix` - Hardware separation
- `modules/selection.nix` - Filesystem-driven discovery
- Roles using lib.mkDefault consistently

**Impact**: POSITIVE - Template for future

## Remediation Strategy

### Strategy 1: Parameterize Hardcoded Values

**Hardcoded usernames**:
```nix
# BEFORE
User = "rain";

# AFTER
User = config.identity.primaryUsername;
```

**Hardcoded IPs**:
```nix
# BEFORE
ip saddr 192.168.86.0/24

# AFTER - Add module option
localNetwork = lib.mkOption {
  type = lib.types.str;
  default = "192.168.0.0/16";
};
# Use: ip saddr ${cfg.localNetwork}
```

### Strategy 2: Extract Host-Specific to Separate Files

**Pattern from malphas**:
```
hosts/malphas/
  ├── default.nix (39 lines - minimal)
  ├── hardware-configuration.nix
  └── audio-tuning.nix (34 lines - hardware-specific)
```

**Apply to anguish/sorrow**:
- Move service disables to role or separate file
- Or fix roles to not enable in first place

### Strategy 3: Create Missing Module Options

**For hardcoded features**:
```nix
# Create modules/services/networking/local-network.nix
options.myModules.services.networking.localNetwork = {
  subnet = lib.mkOption {
    type = lib.types.str;
    default = "192.168.0.0/16";
    description = "Local network subnet for firewall";
  };
};
```

### Strategy 4: Move Inline Config to Modules

**Extract from roles**:
```nix
# BEFORE (in role)
environment.systemPackages = [ pkgs.somePackage ];

# AFTER
# Create modules/apps/category/somepackage.nix
# In role:
modules.apps.category = [ "somepackage" ];
```

## Success Criteria

### Automated Tests
- [ ] Zero hardcoded usernames in /modules
- [ ] Zero hardcoded IPs in /modules
- [ ] Zero config.roles checks in /modules
- [ ] Zero config.host.* references
- [ ] All hosts ≤ 80 lines (except ISO)
- [ ] All modules have descriptions
- [ ] All modules use myModules.* namespace

### Manual Review
- [ ] Each module truly universal/reusable
- [ ] Each role only sets defaults
- [ ] Each host only identity + hardware
- [ ] No duplicate code
- [ ] Proper namespacing throughout

### Build Verification
- [ ] All hosts build successfully
- [ ] nix flake check passes
- [ ] No deprecated option warnings

### Documentation
- [ ] Violations documented with severity
- [ ] Remediation plan for each
- [ ] Timeline for fixes
- [ ] Updated architecture docs

## Execution Timeline

### Week 1: Automated Discovery
- Run automated checks
- Categorize findings by severity
- Generate initial findings report

### Week 2: Manual Review
- Day 1-2: Review flagged modules
- Day 3-4: Review all roles
- Day 5: Review all hosts

### Week 3: Remediation
- Day 1-2: Fix critical violations
- Day 3-4: Fix moderate issues
- Day 5: Document minor improvements

### Week 4: Verification
- Build all hosts
- Re-run automated checks
- Document compliance
- Create maintenance runbook

## Audit Checklist Template

```markdown
## File: [path/to/file.nix]

### Scope Check
- [ ] Universal/reusable code only?
- [ ] No hardcoded values?
- [ ] Proper separation of concerns?

### Options Check
- [ ] Uses myModules.* namespace?
- [ ] All options have types?
- [ ] All options have descriptions?
- [ ] Options in correct module?

### Dependencies Check
- [ ] No inappropriate config.* checks?
- [ ] Uses identity.* for user info?
- [ ] Uses system.* for platform?
- [ ] Uses hardware.* for hardware?

### Quality Check
- [ ] No duplicate functionality?
- [ ] Follows existing patterns?
- [ ] Appropriate lib.mkDefault/mkForce?
- [ ] Well-organized and readable?

### Violations Found
[List with severity]

### Recommended Actions
[Specific fixes]
```

## Known Violations Summary

**Critical** (4 instances):
- 2 hardcoded username instances (pipewire.nix, stylix.nix)
- 2 hardcoded IP instances (tailscale.nix, sinkzone.nix)

**Moderate**:
- 2 hosts with excessive service disables (anguish, sorrow)
- 1 ISO host with 178 lines (special case)
- Possible inline packages in task-fast-test.nix

**Minor**:
- Various modules could use better descriptions
- Some modules are large (could split)

## Effort Estimate

- Automated checks: 2 hours (script writing)
- Manual review: 8-12 hours
- Remediation: 4-8 hours (critical/moderate)
- **Total**: 2-3 days focused work

## Recommended Priority

1. **Fix critical violations** (4 hours) - Hardcoded values
2. **Refactor host service disables** (2 hours) - Move to roles
3. **Document findings** (2 hours) - Create runbook
4. **Address moderate issues** (ongoing) - Over time

## Module Guidelines Compliance Matrix

| Aspect | Modules | Roles | Hosts |
|--------|---------|-------|-------|
| Define options | ✅ YES | ❌ NO | ❌ NO |
| Set defaults | N/A | ✅ mkDefault | ✅ override |
| Hardcoded values | ❌ NO | ❌ NO | ⚠️ SPARSE |
| Check config.roles | ❌ NO | ✅ YES | ❌ NO |
| Set packages | ✅ YES | ⚠️ VIA MODS | ⚠️ VIA MODS |
| Host-specific | ❌ NO | ❌ NO | ✅ YES |
| Hardware facts | ✅ OPTIONS | ✅ DEFAULTS | ✅ VALUES |

## Critical Files

1. `.planning/phases/24-architectural-audit/PLAN.md` - This document
2. `scripts/audit-architecture.sh` - Automated audit script
3. `.planning/phases/24-architectural-audit/findings.md` - Results
4. `modules/services/audio/pipewire.nix` - Fix username
5. `modules/theming/stylix.nix` - Fix username
6. `modules/services/networking/tailscale.nix` - Parameterize network
7. `modules/services/networking/sinkzone.nix` - Parameterize IP
8. `hosts/anguish/default.nix` - Reduce service disables
9. `hosts/sorrow/default.nix` - Reduce service disables
10. `.planning/phases/24-architectural-audit/remediation-plan.md` - Fixes

## Conclusion

This audit ensures architectural integrity post-Phase 23. The three-tier structure is fundamentally sound, but hardcoded values and host-specific configs need addressing for full compliance.

The audit will maintain clean separation of concerns and ensure the codebase remains maintainable and true to architectural principles.
