---
phase: 03-refactor-scripts
type: execute
---

<objective>
Refactor vikunja-direct.py to use shared module, reducing from 691 to ~200 lines.

Purpose: Eliminate duplicated code, improve maintainability, use tested shared components.
Output: vikunja-direct.py using Config, VikunjaClient, TaskwarriorClient from vikunja_common.
</objective>

<execution_context>
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@vikunja_common.py
@vikunja-direct.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace Config class and token loading</name>
  <files>vikunja-direct.py</files>
  <action>
  1. Add import at top:
     ```python
     from vikunja_common import Config, ConfigError, VikunjaClient, TaskwarriorClient, SyncLogger
     ```

  2. Remove the local Config class definition (the @dataclass with vikunja_url, api_token, etc.)

  3. Replace `config = Config(...)` initialization with:
     ```python
     try:
         config = Config.from_env()
     except ConfigError as e:
         log(f"Configuration error: {e}")
         sys.exit(1)
     ```

  4. Remove the token file reading code (the `if token_file and Path(token_file).exists()` pattern)

  Keep the rest of the file structure intact for now.
  </action>
  <verify>grep -n "from vikunja_common import" vikunja-direct.py</verify>
  <done>vikunja-direct.py imports and uses Config from shared module</done>
</task>

<task type="auto">
  <name>Task 2: Replace Vikunja API functions with VikunjaClient</name>
  <files>vikunja-direct.py</files>
  <action>
  1. Create VikunjaClient instance after config:
     ```python
     vikunja = VikunjaClient(config)
     ```

  2. Remove these local functions (they're now in VikunjaClient):
     - get_all_labels()
     - get_or_create_label()
     - get_vikunja_task()
     - detach_label()
     - Any other API helper functions

  3. Replace calls throughout the file:
     - `get_all_labels(config)` -> `vikunja.get_labels()`
     - `get_or_create_label(config, title)` -> `vikunja.get_or_create_label(title)`
     - `get_vikunja_task(config, task_id)` -> `vikunja.get_task(task_id)`
     - `detach_label(config, task_id, label_id)` -> `vikunja.detach_label(task_id, label_id)`

  4. Remove the global `_label_cache` variable (it's now in VikunjaClient)

  5. For direct API calls (create task, update task), either:
     - Use vikunja.put/post/get methods
     - Or keep inline if they have complex response handling

  Keep the business logic intact, just replace the HTTP mechanics.
  </action>
  <verify>grep -c "urlopen\|Request" vikunja-direct.py should show significantly fewer occurrences</verify>
  <done>Vikunja API calls use VikunjaClient methods, local helpers removed</done>
</task>

<task type="auto">
  <name>Task 3: Replace subprocess patterns with TaskwarriorClient</name>
  <files>vikunja-direct.py</files>
  <action>
  1. Create TaskwarriorClient instance:
     ```python
     tw = TaskwarriorClient()
     ```

  2. Remove the `SYNC_ENV` constant (it's now in TaskwarriorClient)

  3. Replace subprocess.run calls:
     - Task export: `subprocess.run(["task", uuid, "export"], ...)` -> `tw.export_task(uuid)`
     - Task delete: `subprocess.run(["task", uuid, "delete"], ...)` -> `tw.delete_task(uuid)`
     - Task done: `subprocess.run(["task", uuid, "done"], ...)` -> `tw.complete_task(uuid)`
     - Task modify: Build args then `subprocess.run(args, ...)` -> Use `tw.modify_task(uuid, **changes)` or keep modify if complex

  4. For tag operations specifically:
     - Adding tags: `tw.add_tags(uuid, tags_list)`
     - Removing tags: `tw.remove_tags(uuid, tags_list)`

  The subprocess return code checks we added in Phase 1 are now handled by TaskwarriorClient.
  </action>
  <verify>grep -c "subprocess.run" vikunja-direct.py should be 0 or near 0</verify>
  <done>Subprocess calls replaced with TaskwarriorClient methods</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] vikunja-direct.py imports from vikunja_common
- [ ] No local Config class definition
- [ ] No local API helper functions (get_all_labels, etc.)
- [ ] No direct subprocess.run calls (or minimal)
- [ ] No direct urlopen/Request calls (or minimal)
- [ ] `python3 -m py_compile vikunja-direct.py` passes
- [ ] `cd /home/rain/nix && sudo nixos-rebuild test --flake .#malphas` succeeds
- [ ] Test: `task add "refactor test" project:Test +testtag` syncs to Vikunja
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- vikunja-direct.py significantly smaller (~200 lines vs 691)
- Sync functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/03-refactor-scripts/03-01-SUMMARY.md`
</output>
