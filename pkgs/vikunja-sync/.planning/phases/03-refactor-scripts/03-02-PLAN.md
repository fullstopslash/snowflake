---
phase: 03-refactor-scripts
type: execute
---

<objective>
Refactor label-sync.py and correlate.py to use shared module.

Purpose: Complete the DRY refactoring across all Python scripts.
Output: All scripts using shared Config, VikunjaClient, TaskwarriorClient.
</objective>

<execution_context>
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@vikunja_common.py
@label-sync.py
@correlate.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor label-sync.py (184 -> ~80 lines)</name>
  <files>label-sync.py</files>
  <action>
  1. Add import:
     ```python
     from vikunja_common import Config, ConfigError, VikunjaClient, TaskwarriorClient, SyncLogger
     ```

  2. Remove local functions:
     - get_api_token() - replaced by Config.from_env()
     - api_get() - replaced by VikunjaClient.get()
     - Any TW subprocess patterns - replaced by TaskwarriorClient

  3. Initialize clients:
     ```python
     config = Config.from_env()
     vikunja = VikunjaClient(config)
     tw = TaskwarriorClient()
     logger = SyncLogger("label-sync")
     ```

  4. Replace API calls:
     - `api_get(url, token)` -> `vikunja.get(endpoint)`
     - Label operations -> use vikunja.get_labels(), vikunja.get_or_create_label()

  5. Replace TW operations:
     - `subprocess.run(["task", ..., "export"])` -> `tw.export_project(project)`
     - Tag modifications -> `tw.add_tags()`, `tw.remove_tags()`

  6. Keep the sync logic (matching labels to tags), just use shared clients.
  </action>
  <verify>wc -l label-sync.py should show significant reduction</verify>
  <done>label-sync.py uses shared module, reduced to ~80 lines</done>
</task>

<task type="auto">
  <name>Task 2: Refactor correlate.py (251 -> ~150 lines)</name>
  <files>correlate.py</files>
  <action>
  1. Add import:
     ```python
     from vikunja_common import TaskwarriorClient, SyncLogger
     ```

  2. Keep CalDAV-specific code (it's unique to this script):
     - CalDAV client setup
     - CalDAV task fetching
     - CalDAV UID parsing

  3. Replace TW operations with TaskwarriorClient:
     - Task export patterns -> `tw.export_project(project)`
     - UUID extraction (already fixed regex from Phase 1)

  4. Initialize logger:
     ```python
     logger = SyncLogger("correlate")
     ```

  5. Keep the atomic file write pattern added in Phase 1.

  6. Note: correlate.py uses CALDAV_PASSWORD env var (from Phase 1 fix),
     not the Config class (which is for Vikunja API).
  </action>
  <verify>wc -l correlate.py should show reduction</verify>
  <done>correlate.py uses TaskwarriorClient, reduced to ~150 lines</done>
</task>

<task type="auto">
  <name>Task 3: Verify all scripts work together</name>
  <files>vikunja-direct.py, label-sync.py, correlate.py</files>
  <action>
  1. Run syntax check on all files:
     ```bash
     python3 -m py_compile vikunja-direct.py label-sync.py correlate.py vikunja_common.py
     ```

  2. Count total lines (should be ~40% less than original ~1100):
     ```bash
     wc -l vikunja-direct.py label-sync.py correlate.py vikunja_common.py
     ```

  3. Verify no duplicate patterns remain:
     ```bash
     # Should find minimal direct subprocess/urlopen calls
     grep -c "subprocess.run\|urlopen" vikunja-direct.py label-sync.py correlate.py
     ```

  4. Rebuild and test:
     ```bash
     cd /home/rain/nix && sudo nixos-rebuild test --flake .#malphas
     ```
  </action>
  <verify>All scripts compile, total LOC reduced, nixos-rebuild succeeds</verify>
  <done>All scripts refactored, ~40% code reduction achieved</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] All scripts import from vikunja_common
- [ ] Total lines reduced by ~40% (from ~1100 to ~660)
- [ ] No duplicate subprocess/urlopen patterns across scripts
- [ ] `python3 -m py_compile *.py` passes for all files
- [ ] `cd /home/rain/nix && sudo nixos-rebuild test --flake .#malphas` succeeds
- [ ] Manual test: create task with tags, verify sync works
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Code significantly reduced through shared module
- All sync functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/03-refactor-scripts/03-02-SUMMARY.md`
</output>
