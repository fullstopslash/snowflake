---
phase: 04-resilience
type: execute
---

<objective>
Add subprocess timeouts and API retry logic to handle transient failures.

Purpose: Prevent hung processes and handle temporary network/API issues gracefully.
Output: All operations have timeouts, API calls retry on transient failures.
</objective>

<execution_context>
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@vikunja_common.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add timeout handling to TaskwarriorClient</name>
  <files>vikunja_common.py</files>
  <action>
  Update TaskwarriorClient._run() to handle TimeoutExpired:

  ```python
  def _run(self, args: list[str], input_text: str | None = None) -> subprocess.CompletedProcess:
      """Run task command with return code checking and timeout."""
      try:
          return subprocess.run(
              ["task", *args],
              input=input_text,
              capture_output=True,
              text=True,
              env=self.SYNC_ENV,
              timeout=self.timeout,
          )
      except subprocess.TimeoutExpired:
          # Return a fake CompletedProcess with error
          return subprocess.CompletedProcess(
              args=["task", *args],
              returncode=124,  # Standard timeout exit code
              stdout="",
              stderr=f"Command timed out after {self.timeout}s",
          )
  ```

  This ensures callers always get a CompletedProcess, not an exception.
  The returncode 124 will be handled as a failure by existing checks.
  </action>
  <verify>grep -A10 "TimeoutExpired" vikunja_common.py</verify>
  <done>TaskwarriorClient handles timeout gracefully, returns error CompletedProcess</done>
</task>

<task type="auto">
  <name>Task 2: Add retry logic to VikunjaClient</name>
  <files>vikunja_common.py</files>
  <action>
  Add retry helper and update _request method:

  ```python
  import time

  class VikunjaClient:
      def __init__(self, config: Config, timeout: int = 30, max_retries: int = 3):
          self.config = config
          self.timeout = timeout
          self.max_retries = max_retries
          self._label_cache: dict[str, int] = {}

      def _request(self, method: str, endpoint: str, data: dict | None = None) -> dict | list | None:
          """Make HTTP request with retry on transient failures."""
          url = f"{self.config.vikunja_url}/api/v1{endpoint}"
          headers = {"Authorization": f"Bearer {self.config.api_token}"}

          body = None
          if data is not None:
              body = json.dumps(data).encode()
              headers["Content-Type"] = "application/json"

          last_error = None
          for attempt in range(self.max_retries):
              req = Request(url, data=body, headers=headers, method=method)
              try:
                  with urlopen(req, timeout=self.timeout) as resp:
                      return json.loads(resp.read().decode())
              except HTTPError as e:
                  if e.code == 404:
                      return None
                  if e.code >= 500:
                      # Server error, retry
                      last_error = e
                      time.sleep(2 ** attempt)  # 1s, 2s, 4s
                      continue
                  raise  # 4xx errors don't retry
              except URLError as e:
                  # Connection error, retry
                  last_error = e
                  time.sleep(2 ** attempt)
                  continue
              except json.JSONDecodeError:
                  return None

          # All retries exhausted
          if last_error:
              raise last_error
          return None
  ```

  Key features:
  - Retry on 5xx server errors and connection errors
  - Don't retry on 4xx client errors (bad request, not found, etc.)
  - Exponential backoff: 1s, 2s, 4s
  - Max 3 attempts by default
  </action>
  <verify>grep -A5 "max_retries" vikunja_common.py</verify>
  <done>VikunjaClient retries on transient failures with exponential backoff</done>
</task>

<task type="auto">
  <name>Task 3: Add connection error handling to SyncLogger</name>
  <files>vikunja_common.py</files>
  <action>
  Add a method to log retries and connection issues:

  ```python
  class SyncLogger:
      # ... existing methods ...

      def retry(self, msg: str, attempt: int, max_attempts: int, **context):
          """Log retry attempt."""
          self._log("WARN", f"{msg} (attempt {attempt}/{max_attempts})", **context)

      def timeout(self, msg: str, seconds: int, **context):
          """Log timeout event."""
          self._log("ERROR", f"{msg} (timed out after {seconds}s)", **context)
  ```

  Then update VikunjaClient._request to optionally log retries:

  ```python
  def __init__(self, config: Config, timeout: int = 30, max_retries: int = 3, logger: SyncLogger | None = None):
      # ...
      self.logger = logger

  # In retry loop:
  if self.logger and attempt > 0:
      self.logger.retry(f"API request to {endpoint}", attempt + 1, self.max_retries)
  ```
  </action>
  <verify>grep "def retry\|def timeout" vikunja_common.py</verify>
  <done>SyncLogger has retry and timeout logging methods, VikunjaClient logs retries</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] TaskwarriorClient handles TimeoutExpired without raising
- [ ] VikunjaClient retries on 5xx and connection errors
- [ ] Exponential backoff implemented (1s, 2s, 4s)
- [ ] 4xx errors do NOT retry
- [ ] SyncLogger has retry and timeout methods
- [ ] `python3 -m py_compile vikunja_common.py` passes
- [ ] `cd /home/rain/nix && sudo nixos-rebuild test --flake .#malphas` succeeds
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Transient failures handled gracefully
- No hung processes possible
</success_criteria>

<output>
After completion, create `.planning/phases/04-resilience/04-01-SUMMARY.md`
</output>
