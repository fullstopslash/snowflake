---
phase: 01-critical-fixes
type: execute
---

<objective>
Fix credential exposure, add atomic file writes, and fix UUID regex patterns.

Purpose: Credentials visible in ps output, corrupted files on crash, and UUID matching bugs.
Output: Secure credential handling, atomic writes, and correct UUID validation.
</objective>

<execution_context>
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/workflows/execute-phase.md
@~/.claude/plugins/marketplaces/taches-cc-resources/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@correlate.py
@label-sync.py
@vikunja-sync.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix credential exposure in correlate.py</name>
  <files>correlate.py, vikunja-sync.sh</files>
  <action>
  In correlate.py (around line 244 in argument parsing):

  Current: Takes password as 4th CLI argument (visible in ps aux)
  ```python
  if len(sys.argv) != 5:
      print("Usage: correlate.py <project> <caldav_url> <user> <password>")
  ```

  Fix: Read password from environment variable
  ```python
  if len(sys.argv) != 4:
      print("Usage: correlate.py <project> <caldav_url> <user>")
      print("Set CALDAV_PASSWORD environment variable")
      sys.exit(1)

  project, caldav_url, user = sys.argv[1:4]
  password = os.environ.get("CALDAV_PASSWORD")
  if not password:
      print("Error: CALDAV_PASSWORD environment variable not set", file=sys.stderr)
      sys.exit(1)
  ```

  In vikunja-sync.sh (around line 100), change the call from:
  ```bash
  vikunja-sync-correlate "$project" "$CALDAV_URL" "$VIKUNJA_USER" "$caldav_pass"
  ```

  To:
  ```bash
  CALDAV_PASSWORD="$caldav_pass" vikunja-sync-correlate "$project" "$CALDAV_URL" "$VIKUNJA_USER"
  ```
  </action>
  <verify>grep -n "CALDAV_PASSWORD" correlate.py vikunja-sync.sh to confirm environment variable usage</verify>
  <done>Password read from CALDAV_PASSWORD env var, not CLI argument; shell script passes via env</done>
</task>

<task type="auto">
  <name>Task 2: Add atomic file writes to correlate.py</name>
  <files>correlate.py</files>
  <action>
  Find the file write around lines 112-114:
  ```python
  with open(filepath, "w") as f:
      f.write(content)
  ```

  Replace with atomic write using tempfile:
  ```python
  import tempfile

  # ... in the write function ...
  fd, temp_path = tempfile.mkstemp(dir=filepath.parent, prefix=".tmp_", suffix=".json")
  try:
      with os.fdopen(fd, "w") as f:
          f.write(content)
      os.rename(temp_path, filepath)
  except Exception:
      # Clean up temp file on failure
      try:
          os.unlink(temp_path)
      except OSError:
          pass
      raise
  ```

  Add the tempfile import at the top of the file if not present.
  The key is writing to a temp file in the same directory, then atomic rename.
  </action>
  <verify>Read the write function to confirm tempfile + rename pattern</verify>
  <done>File writes use tempfile.mkstemp + os.rename for atomicity</done>
</task>

<task type="auto">
  <name>Task 3: Fix UUID regex patterns</name>
  <files>correlate.py, label-sync.py</files>
  <action>
  In both files, find the UUID regex pattern (currently something like `[a-f0-9-]{36}` which matches "----...----").

  Replace with proper UUID pattern with case-insensitive flag:
  ```python
  UUID_PATTERN = re.compile(
      r"uuid:\s*([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})",
      re.IGNORECASE
  )
  ```

  In label-sync.py around line 79.
  In correlate.py around line 83.

  The pattern must:
  1. Match exactly 8-4-4-4-12 hex character groups
  2. Be case-insensitive (uppercase UUIDs exist)
  3. Not match invalid strings like all dashes
  </action>
  <verify>grep -n "uuid.*[0-9a-f]" correlate.py label-sync.py to confirm proper pattern</verify>
  <done>Both files use proper UUID pattern with IGNORECASE flag</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] correlate.py reads password from CALDAV_PASSWORD environment variable
- [ ] vikunja-sync.sh passes password via environment variable, not CLI
- [ ] correlate.py writes files atomically using tempfile + rename
- [ ] Both correlate.py and label-sync.py use proper UUID regex with IGNORECASE
- [ ] `cd /home/rain/nix && sudo nixos-rebuild test --flake .#malphas` succeeds

Test credential hiding:
```bash
# While correlate is running:
ps aux | grep correlate | grep -v grep
# Should NOT show any password values
```
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No credentials visible in process list
- NixOS rebuild succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-fixes/01-03-SUMMARY.md`
</output>
